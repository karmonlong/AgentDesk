<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center v2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script>
        // Markdown parser fallback
        function parseMarkdown(text) {
            if (typeof marked !== 'undefined') {
                try {
                    return marked.parse(text);
                } catch (e) {
                    console.error('Marked parse error:', e);
                }
            }
            // Simple fallback if marked is not loaded or fails
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        document.addEventListener("DOMContentLoaded", function () {
            mermaid.initialize({ startOnLoad: false, theme: 'dark' });
        });
    </script>
    <style>
        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #121212;
            --bg-tertiary: #1E1E1E;
            --primary: #FF6B00;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --border: #333;
            --activity-bar-width: 50px;
            --sidebar-width: 250px;
            --right-panel-width: 420px;
            --header-height: 40px;
            --status-bar-height: 25px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ==================== Landing Mode (Gemini Style) ==================== */
        #landing-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            background: radial-gradient(circle at 50% 50%, rgba(255, 107, 0, 0.05) 0%, transparent 60%);
        }

        .landing-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            opacity: 1;
        }
        
        .landing-logo:hover {
            transform: translateY(-2px);
            filter: brightness(1.2);
        }
        
        .landing-logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .landing-logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .landing-logo-text {
            background: linear-gradient(135deg, #FFFFFF 0%, #CCCCCC 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-input-wrapper {
            width: 600px;
            max-width: 90%;
            position: relative;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .landing-input {
            width: 100%;
            padding: 18px 24px;
            padding-right: 50px;
            font-size: 1.1rem;
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            color: #fff;
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .landing-input:focus {
            background: rgba(40, 40, 40, 0.8);
            border-color: rgba(255, 107, 0, 0.5);
            box-shadow: 0 8px 30px rgba(255, 107, 0, 0.15);
        }

        .landing-submit {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .landing-submit:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }

        /* Landing Agents */
        .landing-agents {
            display: flex;
            gap: 25px;
            margin-bottom: 40px;
            padding: 10px;
            max-width: 90%;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .landing-agents::-webkit-scrollbar {
            display: none;
        }

        .landing-agent-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0.7;
            min-width: 80px;
        }

        .landing-agent-item:hover {
            transform: translateY(-10px);
            opacity: 1;
        }

        .landing-agent-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .landing-agent-item:hover .landing-agent-avatar {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4);
        }

        .landing-agent-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color 0.3s;
        }

        .landing-agent-item:hover .landing-agent-name {
            color: var(--text-primary);
        }

        /* Hide agents in workspace mode */
        body.mode-workspace .landing-agents {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        /* ==================== Workspace Mode (VS Code Style) ==================== */
        #workspace-container {
            display: flex;
            flex: 1;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            /* ÂàùÂßã‰∏çÂèØÁÇπÂáª */
            transition: opacity 0.8s ease 0.3s;
            /* Âª∂ËøüÊòæÁ§∫ */
        }

        /* 1. Activity Bar (ÊúÄÂ∑¶‰æß) */
        .activity-bar {
            width: var(--activity-bar-width);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }

        .activity-item {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            cursor: pointer;
            margin-bottom: 10px;
            border-left: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            font-size: 1.2rem;
        }

        /* Tooltip styles */
        .activity-item::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, left 0.2s;
            z-index: 1000;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        .activity-item:hover::after {
            opacity: 1;
            left: 110%; /* Slight movement effect */
        }

        .activity-item:hover {
            transform: scale(1.1);
        }
        
        .activity-item:hover::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 107, 0, 0.1);
            border-radius: 8px;
        }

        .activity-item.active {
            border-left-color: var(--primary);
        }
        
        .activity-item.active::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 107, 0, 0.15);
            border-radius: 8px;
        }
        
        /* Unified Activity Bar Styles - Ceramic White Theme */
        .activity-item i {
            color: rgba(255, 255, 255, 0.5); /* Ceramic White (Unlit) */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 0 transparent);
        }
        
        .activity-item:hover i {
            color: rgba(255, 255, 255, 0.9); /* Ceramic White (Lit) */
            transform: scale(1.15);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }

        .activity-item.active i {
            color: #FFFFFF; /* Pure White */
            filter: drop-shadow(0 0 8px var(--primary)); /* Brand Glow */
        }

        /* Special Active Colors - Enhanced for Dark Background */
        /* MCP - Cyberpunk Cyan */
        #activity-mcp.active i {
            color: #00E5FF !important;
            filter: drop-shadow(0 0 12px rgba(0, 229, 255, 0.8));
        }
        
        /* NotebookLM - Deep Purple */
        #activity-notebooklm.active i {
            color: #E040FB !important;
            filter: drop-shadow(0 0 12px rgba(224, 64, 251, 0.8));
        }

        /* AI-Gist - Gold */
        #activity-aigist.active i {
            color: #FFD700 !important;
            filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.8));
        }
        
        /* Remove old specific ID colors to enforce uniformity */
        /* #activity-explorer i { color: ... } - REMOVED */
        /* #activity-scenarios i { color: ... } - REMOVED */
        /* #activity-market i { color: ... } - REMOVED */
        
        .activity-item .fa-search {
            /* Keep search icon generic if used elsewhere, or override here */
        }

        /* 2. Sidebar (‰æßËæπÊ†è) */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Fix: Create stacking context for absolute panels */
            z-index: 10;
        }

        .sidebar.expanded {
            width: 85vw !important;
            max-width: 1400px;
            position: absolute;
            left: var(--activity-bar-width);
            height: 100vh;
            z-index: 100;
            box-shadow: 10px 0 50px rgba(0,0,0,0.6);
        }

        .sidebar.collapsed {
            width: 0;
            margin-left: calc(var(--sidebar-width) * -1);
            overflow: hidden;
        }

        .sidebar-header {
            height: 35px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .collapse-btn {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .collapse-btn:hover {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .sidebar-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            /* ÈªòËÆ§ÈöêËóè */
            flex-direction: column;
        }

        .sidebar-panel.active {
            display: flex;
        }

        /* Prompt Studio Styles */
        .prompt-tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .prompt-tab.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }
        .prompt-tab:hover:not(.active) {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }
        .prompt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.2s;
        }
        .prompt-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .prompt-card-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .prompt-card-content {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .prompt-tag {
            display: inline-block;
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            margin-top: 8px;
        }

        /* Âú∫ÊôØÂç°ÁâáÊ†∑Âºè */
        .scenario-card {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 107, 0, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin: 12px 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .scenario-card:hover {
            background: rgba(255, 107, 0, 0.15);
            border-color: var(--primary);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.3);
        }

        .scenario-card.active {
            background: rgba(255, 107, 0, 0.25);
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(255, 107, 0, 0.4);
        }

        .scenario-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .scenario-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .scenario-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Êñá‰ª∂Ê†ëÊ†∑Âºè */
        .file-tree {
            padding: 10px 0;
        }

        .file-item {
            padding: 6px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-left: 2px solid transparent;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .file-item.active {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .file-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        /* Êô∫ËÉΩ‰ΩìÂ∏ÇÂú∫Ê†∑Âºè */
        .market-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: default;
            transition: background 0.2s;
        }

        .market-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .market-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .market-info {
            flex: 1;
            overflow: hidden;
        }

        .market-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .market-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .market-btn {
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid var(--primary);
            color: var(--primary);
            background: transparent;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
            white-space: nowrap;
        }

        .market-btn:hover {
            background: var(--primary);
            color: white;
        }

        .market-btn.subscribed {
            border-color: #333;
            color: #888;
            background: rgba(255, 255, 255, 0.05);
        }

        .market-btn.subscribed:hover {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 0, 0, 0.1);
        }

        .market-btn.subscribed:hover::after {
            content: "ÈÄÄËÆ¢";
            font-size: 0;
            /* Hide original text hack if needed, but simple text swap is better in JS */
        }

        /* @ ÊèêÂèä‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .mention-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            max-height: 280px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 107, 0, 0.3);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            display: none;
            z-index: 1000;
            margin-bottom: 2px;
        }

        .mention-dropdown.show {
            display: block;
            animation: slideUpFade 0.2s ease-out;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mention-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mention-item:last-child {
            border-bottom: none;
        }

        .mention-item:hover,
        .mention-item.selected {
            background: rgba(255, 107, 0, 0.15);
        }

        .mention-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .mention-item-info {
            flex: 1;
            overflow: hidden;
        }

        .mention-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .mention-item-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mention-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .mention-dropdown::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 12px 0 0;
        }

        .mention-dropdown::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 0, 0.5);
            border-radius: 3px;
        }

        .mention-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 0, 0.7);
        }

        /* 3. Main Content (‰∏≠Èó¥) */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-tertiary);
            position: relative;
            border-right: 1px solid var(--border);
        }

        .editor-tabs {
            height: 35px;
            background-color: var(--bg-primary);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20; /* Ensure tabs are above canvas */
        }

        .editor-area {
            flex: 1;
            min-height: 0;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
            background-color: var(--bg-tertiary);
        }
        
        /* Modal Styles */
        .settings-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 10% auto;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--bg-tertiary);
            border-radius: 0 0 12px 12px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary);
        }

        .provider-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .provider-option {
            padding: 10px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .provider-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .provider-option.active {
            background: rgba(255, 107, 0, 0.15);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-save {
            padding: 8px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel {
            padding: 8px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        /* Workflow Styles */
        .workflow-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid var(--primary);
        }
        .workflow-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: var(--primary);
        }
        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .workflow-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .workflow-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .workflow-status.active {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        .workflow-status.paused {
            background: rgba(158, 158, 158, 0.2);
            color: #9E9E9E;
        }
        .workflow-schedule {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .workflow-visual {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .wf-step {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .wf-arrow {
            font-size: 0.7rem;
            color: #666;
        }
        .workflow-actions {
            display: flex;
            gap: 8px;
        }
        .wf-btn-run {
            flex: 1;
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 4px 0;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wf-btn-run:hover {
            background: var(--primary);
            color: white;
        }
        .wf-btn-edit {
            width: 28px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
        }
        .wf-btn-edit:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        /* Êñ∞ÁöÑ Canvas ÂÖ®Â±èÊ†∑Âºè */
        .canvas-area {
            position: absolute;
            top: 35px; /* Below tabs */
            left: 0;
            width: 100%;
            height: calc(100% - 35px);
            background: linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 100%);
            z-index: 5; /* Below editor by default */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .canvas-area.active {
            z-index: 15; /* Above editor */
            opacity: 1;
            pointer-events: all;
        }

        /* Remove old collapsed styles */
        /* .canvas-area.collapsed ... */

        .canvas-header {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            color: #666;
            pointer-events: none; /* Let clicks pass through to canvas */
        }
        
        .canvas-header > * {
            pointer-events: all; /* Enable buttons */
        }

        .canvas-header.sticky {
            background: rgba(10, 10, 10, 0.9);
            padding: 8px 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        /* Êô∫ËÉΩ‰ΩìËäÇÁÇπÊ†∑Âºè (Enhanced) */
        .workflow-node {
            width: 65px;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 30% 30%, rgba(60, 60, 60, 0.9), rgba(30, 30, 30, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(12px);
            box-shadow: 
                0 10px 30px -10px rgba(0, 0, 0, 0.8),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 2;
        }

        /* Ë£ÖÈ•∞ÂÖâÁéØ */
        .workflow-node::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .workflow-node:hover {
            transform: translate(-50%, -50%) scale(1.15) !important;
            border-color: rgba(255, 107, 0, 0.5);
            box-shadow: 
                0 15px 40px -10px rgba(0, 0, 0, 0.9),
                0 0 20px rgba(255, 107, 0, 0.2),
                inset 0 0 20px rgba(255, 107, 0, 0.1);
        }
        
        .workflow-node:hover::before {
            opacity: 1;
        }

        .workflow-node.working {
            background: radial-gradient(circle at 30% 30%, rgba(255, 107, 0, 0.2), rgba(30, 30, 30, 0.95));
            border-color: var(--primary);
            box-shadow: 
                0 0 30px rgba(255, 107, 0, 0.4),
                inset 0 0 20px rgba(255, 107, 0, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }

        .workflow-node.dimmed {
            opacity: 0.4;
            filter: grayscale(0.8) blur(1px);
            transform: translate(-50%, -50%) scale(0.9);
        }

        .workflow-node i {
            font-size: 26px !important;
            transition: all 0.3s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .workflow-node.working i {
            color: var(--primary) !important;
            filter: drop-shadow(0 0 10px rgba(255, 107, 0, 0.6));
        }

        .agent-label {
            position: absolute;
            padding: 6px 12px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            pointer-events: none;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .workflow-node:hover ~ .agent-label,
        .workflow-node.working ~ .agent-label {
            color: var(--text-primary);
            border-color: var(--primary);
            background: rgba(255, 107, 0, 0.15);
            transform: translate(-50%, -50%) scale(1.05) !important;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 107, 0, 0.8);
            }
        }

        #workflowNodes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #workflowNodes>* {
            pointer-events: all;
        }

        /* HTML Preview Styles */
        .html-preview-container {
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .html-preview-header {
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .html-fullscreen-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .html-fullscreen-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        .html-preview {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }

        /* 4. Right Panel (Âè≥‰æß) */
        .right-panel {
            flex: 0 0 var(--right-panel-width);
            background-color: var(--bg-primary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, margin-right 0.3s ease;
        }

        .right-resizer {
            flex: 0 0 6px;
            cursor: col-resize;
            background: rgba(255,255,255,0.06);
            border-left: 1px solid var(--border);
            transition: background 0.2s;
        }

        .right-resizer:hover {
            background: rgba(255,255,255,0.12);
        }

        .sidebar-header-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .right-panel.collapsed {
            flex: 0 0 0;
            margin-right: calc(var(--right-panel-width) * -1);
            overflow: hidden;
        }

        /* Áä∂ÊÄÅÁ±ªÔºöÊøÄÊ¥ª Workspace Ê®°Âºè */
        body.mode-workspace #landing-container {
            top: 0;
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            padding: 0 20px;
            flex-direction: row;
            position: fixed;
            z-index: 100;
        }

        body.mode-workspace #workspace-container {
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

        body.mode-workspace .landing-logo {
            font-size: 1.1rem;
            margin-bottom: 0;
            margin-right: 20px;
        }
        
        body.mode-workspace .landing-logo-icon {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        /* ÂÖ®Â±ÄÊéßÂà∂ÊåâÈíÆ */
        .global-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        body.mode-workspace .global-controls {
            display: flex !important;
        }

        .global-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid rgba(255, 107, 0, 0.3);
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .global-control-btn:hover {
            background: rgba(255, 107, 0, 0.25);
            border-color: var(--primary);
            color: #FF8800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.4);
        }

        .global-control-btn:active {
            transform: translateY(0);
        }

        .global-control-btn.active {
            background: rgba(255, 107, 0, 0.3);
            border-color: #FF8800;
            color: #FF8800;
            box-shadow: 0 0 8px rgba(255, 107, 0, 0.5);
        }

        .global-control-btn i {
            color: inherit;
        }

        body.mode-workspace .landing-input-wrapper {
            width: 400px;
            transform: scale(0.9);
        }

        body.mode-workspace .landing-input {
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
        }

        body.mode-workspace #workspace-container {
            opacity: 1;
            pointer-events: all;
        }

        /* Command Palette (Hidden) */
        #command-palette {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid var(--primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        #command-palette.active {
            display: block;
            animation: fadeInDown 0.2s ease;
        }

        #command-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 1rem;
            outline: none;
        }

        #command-input:focus {
            border-color: var(--primary);
        }

        .shortcut-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.7rem;
            color: #666;
            pointer-events: none;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Loading Spinner */
        .typing-indicator {
            display: inline-block;
            width: 40px;
            height: 20px;
            padding: 5px 10px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 20px;
            margin-bottom: 15px;
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin-right: 3px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Chat Message Styles */
        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .agent-message .message-avatar {
            background: rgba(255, 107, 0, 0.2);
            color: var(--primary);
            border: 1px solid rgba(255, 107, 0, 0.3);
        }

        .user-message .message-avatar {
            background: rgba(100, 100, 255, 0.2);
            color: #6464FF;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }

        .message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .agent-message .message-content {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 107, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .user-message .message-content {
            background: rgba(255, 107, 0, 0.15);
            border: 1px solid rgba(255, 107, 0, 0.3);
            color: var(--text-primary);
        }

        .message-agent-name {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <!-- Landing / Top Bar -->
    <div id="landing-container">
        <div class="landing-logo" onclick="goToHomePage()" title="ËøîÂõûÈ¶ñÈ°µ">
            <div class="landing-logo-icon">
                <span>AD</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                <div style="font-size: 0.8rem; font-weight: 600; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 2px;">ÊãõÂïÜÂü∫Èáë</div>
                <span class="landing-logo-text">AgentDesk</span>
            </div>
        </div>
        
        <!-- ÂÖ®Â±ÄÊäòÂè†ÊéßÂà∂ÊåâÈíÆ -->
        <div class="global-controls" id="globalControls" style="display: none;">
            <button class="global-control-btn" onclick="toggleSidebar('left')" title="ÂàáÊç¢Â∑¶‰æßÊ†è (Ctrl+B)">
                <i class="fas fa-folder-open"></i>
            </button>
            <button class="global-control-btn" onclick="toggleCanvas()" title="ÂàáÊç¢Êô∫ËÉΩ‰ΩìÁîªÂ∏É">
                <i class="fas fa-project-diagram"></i>
            </button>
            <button class="global-control-btn" onclick="toggleSidebar('right')" title="ÂàáÊç¢Âè≥‰æßÈù¢Êùø">
                <i class="fas fa-comments"></i>
            </button>
            <button class="global-control-btn" onclick="toggleAllPanels()" title="Â±ïÂºÄ/ÊäòÂè†ÊâÄÊúâ">
                <i class="fas fa-expand-arrows-alt" id="expandAllIcon"></i>
            </button>
        </div>

        <!-- Agent Avatars -->
        <div class="landing-agents" id="landing-agents">
            <!-- Dynamic Agents -->
        </div>

        <div class="landing-input-wrapper">
            <input type="text" class="landing-input" id="globalInput" placeholder="ÊÉ≥ËÆ©ÊàëÂ∏Æ‰Ω†ÂÅö‰ªÄ‰πàÔºü(‰æãÂ¶ÇÔºöÂàÜÊûêËøô‰ªΩË¥¢Êä•)">
            <button class="landing-submit" onclick="enterWorkspace()">
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Main Workspace -->
    <div id="workspace-container">
        <!-- 1. Activity Bar -->
        <div class="activity-bar">
            <div id="activity-explorer" class="activity-item active" onclick="switchSidebar('explorer')" title="ËµÑÊ∫êÁÆ°ÁêÜÂô®">
                <i class="fas fa-copy"></i>
            </div>
            <div id="activity-scenarios" class="activity-item" onclick="switchSidebar('scenarios')" title="‰∏öÂä°Âú∫ÊôØ">
                <i class="fas fa-briefcase"></i>
            </div>
            <div id="activity-market" class="activity-item" onclick="switchSidebar('market')" title="Êô∫ËÉΩ‰ΩìÂ∏ÇÂú∫">
                <i class="fas fa-store"></i>
            </div>
            <div id="activity-drawing" class="activity-item" onclick="switchSidebar('drawing')" title="ÁªòÁîªÊô∫ËÉΩ‰Ωì">
                <i class="fas fa-palette"></i>
            </div>
            <div id="activity-notebooklm" class="activity-item" onclick="switchSidebar('notebooklm')" title="NotebookLM Pro">
                <i class="fas fa-brain"></i>
            </div>
            <div id="activity-aigist" class="activity-item" onclick="switchSidebar('aigist')" title="AI-Gist ÊèêÁ§∫ËØçÊô∫ËÉΩ‰Ωì">
                <i class="fas fa-lightbulb"></i>
            </div>
            <div id="activity-mcp" class="activity-item" onclick="switchSidebar('mcp')" title="MCP ÁîüÊÄÅËøûÊé• (Model Context Protocol)">
                <i class="fas fa-network-wired"></i>
            </div>
            
            <!-- Âä®ÊÄÅÊèíÂÖ•ÁöÑËÆ¢ÈòÖÊô∫ËÉΩ‰ΩìÂõæÊ†áÂ∞ÜÂá∫Áé∞Âú®ËøôÈáå -->
            <div id="subscribed-agents-bar">
                <!-- ËÆ¢ÈòÖÁöÑÊô∫ËÉΩ‰ΩìÂõæÊ†á‰ºöÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
            </div>
            
            <div style="flex: 1"></div>
            <div class="activity-item" title="ËÆæÁΩÆ" onclick="openSettingsModal()">
                <i class="fas fa-cog"></i>
            </div>
        </div>

        <!-- 2. Sidebar -->
        <div class="sidebar" id="leftSidebar">

            <!-- Panel: Open NotebookLM (Âä®ÊÄÅÊ∑ªÂä†) -->
            <div id="panel-notebooklm" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span>üéôÔ∏è NotebookLM</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                </div>
                <div class="sidebar-content" style="padding: 0; height: 100%;">
                    <iframe 
                        id="notebooklm-iframe"
                        src="about:blank" 
                        style="width: 100%; height: 100%; border: none; background: var(--bg-primary); display: none;"
                        frameborder="0">
                    </iframe>
                    <div id="notebooklm-placeholder" style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Ê≠£Âú®ÂêØÂä® Open NotebookLM...</p>
                        <p style="font-size: 0.85rem; margin-top: 10px;">
                            Â¶ÇÊûúÈïøÊó∂Èó¥Êú™Âä†ËΩΩÔºåËØ∑Á°Æ‰øùÊúçÂä°Â∑≤ÂêØÂä®Ôºö<br>
                            <code style="background: var(--bg-secondary); padding: 5px 10px; border-radius: 4px; margin-top: 5px; display: inline-block;">
                                cd open-notebooklm && ./start.sh
                            </code>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Panel: Prompt Studio (Replaces AI-Gist) -->
            <div id="panel-aigist" class="sidebar-panel" style="display: none; background: var(--bg-primary);">
                <div class="sidebar-header" style="border-bottom: 1px solid var(--border);">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span><i class="fas fa-magic" style="color: #FFD700; margin-right: 5px;"></i> ÊèêÁ§∫ËØçÂ∑•Âùä</span>
                        <!-- Tabs -->
                        <div style="display: flex; background: var(--bg-secondary); padding: 2px; border-radius: 6px; margin-left: 20px;">
                            <button class="prompt-tab active" onclick="switchPromptTab('optimize')">‰ºòÂåñ</button>
                            <button class="prompt-tab" onclick="switchPromptTab('library')">Â∫ì</button>
                            <button class="prompt-tab" onclick="switchPromptTab('best-practices')">ÊúÄ‰Ω≥ÂÆûË∑µ</button>
                        </div>
                    </div>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                </div>
                
                <div class="sidebar-content" style="padding: 20px; overflow-y: auto;">
                    
                    <!-- Tab 1: Optimize -->
                    <div id="prompt-tab-optimize" class="prompt-tab-content" style="display: block;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">ÂéüÂßãÊèêÁ§∫ËØç / ÈúÄÊ±Ç</label>
                            <textarea id="prompt-input" placeholder="ËæìÂÖ•‰Ω†ÊÉ≥Ë¶Å‰ºòÂåñÁöÑÊèêÁ§∫ËØçÊàñÁÆÄÂçïÊåá‰ª§..." 
                                style="width: 100%; height: 120px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; padding: 10px; font-family: monospace; resize: vertical; transition: border-color 0.3s;"></textarea>
                        </div>
                        
                        <!-- Optimization Options -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">ÁõÆÊ†áÊ®°Âûã</label>
                                <select id="prompt-model-select" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 4px; margin-top: 4px;">
                                    <option value="general">ÈÄöÁî®Ê®°Âûã</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="claude-3">Claude 3</option>
                                    <option value="midjourney">Midjourney</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">‰ºòÂåñÊ°ÜÊû∂</label>
                                <select id="prompt-framework-select" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 4px; margin-top: 4px;">
                                    <option value="auto">Ëá™Âä®ÈÄâÊã©</option>
                                    <option value="costar">CO-STAR (ÁªìÊûÑÂåñ)</option>
                                    <option value="crispe">CRISPE (ËßíËâ≤ÊâÆÊºî)</option>
                                    <option value="cot">ÊÄùÁª¥Èìæ (ÈÄªËæëÊé®ÁêÜ)</option>
                                    <option value="few-shot">Â∞ëÊ†∑Êú¨ (Á§∫‰æãÈ©±Âä®)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">ËØ≠Ê∞îÈ£éÊ†º</label>
                                <select id="prompt-tone-select" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 4px; margin-top: 4px;">
                                    <option value="professional">‰∏ì‰∏ö‰∏•Ë∞®</option>
                                    <option value="creative">ÂàõÊÑèÊ¥ªÊ≥º</option>
                                    <option value="concise">ÁÆÄÊ¥ÅÊòé‰∫Ü</option>
                                    <option value="friendly">‰∫≤ÂàáÂèãÂ•Ω</option>
                                </select>
                            </div>
                        </div>

                        <div style="text-align: right; margin-bottom: 15px;">
                            <button id="btn-optimize-prompt" onclick="optimizePrompt()" style="background: var(--primary); color: white; border: none; padding: 8px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3); transition: transform 0.2s;">
                                <i class="fas fa-magic"></i> Á´ãÂç≥‰ºòÂåñ
                            </button>
                        </div>
                        
                        <div id="prompt-output-container" style="display: none; animation: fadeIn 0.5s ease;">
                            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label style="display: block; color: var(--primary); font-size: 0.8rem; margin-bottom: 5px;">‰ºòÂåñÁªìÊûú</label>
                                </div>
                                <div style="flex: 1; text-align: right;">
                                    <button onclick="copyToClipboard(document.getElementById('prompt-output').value)" 
                                        style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 5px;">
                                        <i class="fas fa-copy"></i> Â§çÂà∂
                                    </button>
                                    <button onclick="saveToLibrary()" 
                                        style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 5px;">
                                        <i class="fas fa-save"></i> ‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Optimized Prompt -->
                            <textarea id="prompt-output" readonly
                                style="width: 100%; height: 250px; background: rgba(255, 107, 0, 0.05); border: 1px solid var(--primary); color: var(--text-primary); border-radius: 8px; padding: 15px; font-family: monospace; resize: vertical; line-height: 1.5; margin-bottom: 15px;"></textarea>
                            
                            <!-- Comparison & Explanation -->
                            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4CAF50;"><i class="fas fa-check-circle"></i> ‰ºòÂåñËØ¥Êòé</strong>
                                    <div id="prompt-explanation" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; line-height: 1.6;"></div>
                                </div>
                                <div style="border-top: 1px solid var(--border); padding-top: 10px; margin-top: 10px;">
                                    <strong style="color: #2196F3;"><i class="fas fa-exchange-alt"></i> ‰ºòÂåñÂØπÊØî</strong>
                                    <div id="prompt-comparison" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; line-height: 1.6;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Library -->
                    <div id="prompt-tab-library" class="prompt-tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <input type="text" id="prompt-search" placeholder="ÊêúÁ¥¢ÊèêÁ§∫ËØç..." oninput="filterPrompts()"
                                style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 6px; margin-right: 10px;">
                            <button onclick="switchPromptTab('optimize')" style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-plus"></i> Êñ∞Âª∫
                            </button>
                        </div>
                        <div id="prompt-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Dynamic content -->
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Âä†ËΩΩ‰∏≠...</div>
                        </div>
                    </div>

                    <!-- Tab 3: Best Practices -->
                    <div id="prompt-tab-best-practices" class="prompt-tab-content" style="display: none;">
                        <div id="best-practices-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel: ËµÑÊ∫êÁÆ°ÁêÜÂô® -->
            <div id="panel-explorer" class="sidebar-panel active">
                <div class="sidebar-header">
                    <span>ËµÑÊ∫êÁÆ°ÁêÜÂô®</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <i class="fas fa-sync-alt" style="cursor: pointer; font-size: 0.8rem;" onclick="loadFiles()"
                            title="Âà∑Êñ∞"></i>
                        <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="file-tree">
                        <div
                            style="padding: 0 15px; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: #888;">
                            <i class="fas fa-chevron-down"></i> UPLOADS
                        </div>
                        <div id="file-list-container">
                            <!-- Dynamic file list will be rendered here -->
                            <div style="padding: 10px 20px; color: #666; font-size: 0.8rem;">Âä†ËΩΩ‰∏≠...</div>
                        </div>
                    </div>
                </div>
                <!-- Upload Area at the bottom of explorer -->
                <div style="padding: 10px; border-top: 1px solid var(--border);">
                    <label for="file-upload"
                        style="display: block; width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 6px; text-align: center; cursor: pointer; color: var(--text-secondary); font-size: 0.8rem; transition: all 0.2s;">
                        <i class="fas fa-upload" style="margin-right: 5px;"></i> ‰∏ä‰º†Êñá‰ª∂
                    </label>
                    <input type="file" id="file-upload" style="display: none;" onchange="handleFileUpload(this)">
                </div>
            </div>

            <!-- Panel: Ëá™Âä®ÂåñÂ∑•‰ΩúÊµÅ (Replaces ‰∏öÂä°Âú∫ÊôØ) -->
            <div id="panel-scenarios" class="sidebar-panel">
                <div class="sidebar-header">
                    <span><i class="fas fa-cogs" style="color: #FFD700; margin-right: 8px;"></i> Ëá™Âä®ÂåñÂ∑•‰ΩúÊµÅ</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                </div>
                
                <div class="sidebar-content" style="padding: 15px;">
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #888; font-size: 0.8rem;">Â∑≤ÈÖçÁΩÆ 3 ‰∏™‰ªªÂä°</span>
                        <button style="background: var(--primary); border: none; border-radius: 4px; color: white; padding: 4px 8px; font-size: 0.75rem; cursor: pointer;">
                            <i class="fas fa-plus"></i> Êñ∞Âª∫
                        </button>
                    </div>

                    <!-- Workflow Card 1: Morning Report -->
                    <div class="workflow-card" onclick="previewWorkflow('morning-report')">
                        <div class="workflow-header">
                            <div class="workflow-title">ÊØèÊó•ËàÜÊÉÖÊó©Êä•</div>
                            <div class="workflow-status active">ËøêË°å‰∏≠</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="far fa-clock"></i> ÊØèÂ§© 08:30
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="ÂÖ®ÁΩëÊêúÁ¥¢"><i class="fas fa-globe"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="ËàÜÊÉÖÂàÜÊûê"><i class="fas fa-file-alt"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="ÁîüÊàêÊä•Âëä"><i class="fas fa-pen-fancy"></i></div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run" onclick="event.stopPropagation(); runWorkflow('ËàÜÊÉÖÊó©Êä•')"><i class="fas fa-play"></i> Á´ãÂç≥ËøêË°å</button>
                            <button class="wf-btn-edit" onclick="event.stopPropagation()"><i class="fas fa-cog"></i></button>
                        </div>
                    </div>

                    <!-- Workflow Card 2: Competitor Monitor -->
                    <div class="workflow-card" onclick="previewWorkflow('competitor')">
                        <div class="workflow-header">
                            <div class="workflow-title">Á´ûÂìÅÂä®ÊÄÅÁõëÊéß</div>
                            <div class="workflow-status active">ËøêË°å‰∏≠</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="far fa-clock"></i> ÊØè 4 Â∞èÊó∂
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="ÂÆòÁΩëÊäìÂèñ"><i class="fas fa-spider"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="Êï∞ÊçÆÊØîÂØπ"><i class="fas fa-exchange-alt"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="ÂèëÈÄÅÈ¢ÑË≠¶"><i class="fas fa-bell"></i></div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run" onclick="event.stopPropagation(); runWorkflow('Á´ûÂìÅÁõëÊéß')"><i class="fas fa-play"></i> Á´ãÂç≥ËøêË°å</button>
                            <button class="wf-btn-edit" onclick="event.stopPropagation()"><i class="fas fa-cog"></i></button>
                        </div>
                    </div>

                    <!-- Workflow Card 4: Document Review (NEW) -->
                    <div class="workflow-card" onclick="previewWorkflow('doc-review')">
                        <div class="workflow-header">
                            <div class="workflow-title">Êô∫ËÉΩÊñáÊ°£Â§öÁª¥ÂÆ°Êü•</div>
                            <div class="workflow-status active" style="color: var(--primary); background: rgba(255, 107, 0, 0.1);">Êé®Ëçê</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="fas fa-bolt"></i> Âç≥Êó∂ÊâßË°å
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="ÊñáÊ°£ÂàÜÊûêÂ∏à"><i class="fas fa-file-alt" style="color: #FF9800;"></i></div>
                            <div class="wf-step" title="ÂêàËßÑÂÆò" style="margin-left: -8px;"><i class="fas fa-balance-scale" style="color: #F44336;"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="ÂÜÖÂÆπÂàõ‰ΩúËÄÖ"><i class="fas fa-pen-fancy" style="color: #9C27B0;"></i></div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run" onclick="event.stopPropagation(); previewWorkflow('doc-review')"><i class="fas fa-play"></i> ÂºÄÂßã‰ΩøÁî®</button>
                        </div>
                    </div>

                    <!-- Workflow Card 5: Daily Tech Digest (NEW) -->
                    <div class="workflow-card" onclick="previewWorkflow('daily-tech')">
                        <div class="workflow-header">
                            <div class="workflow-title">ÊØèÊó•ÁßëÊäÄÂä®ÊÄÅ</div>
                            <div class="workflow-status active" style="color: #64B5F6; background: rgba(100, 181, 246, 0.15);">Êñ∞</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="far fa-clock"></i> ÊØèÂ§© 09:30
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="Êï∞ÊçÆ‰∏ìÂÆ∂"><i class="fas fa-chart-bar" style="color: #2196F3;"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="ÊñáÊ°£ÂàÜÊûêÂ∏à"><i class="fas fa-file-alt" style="color: #FF9800;"></i></div>
                            <div class="wf-arrow">‚Üí</div>
                            <div class="wf-step" title="ÂÜÖÂÆπÂàõ‰ΩúËÄÖ"><i class="fas fa-pen-fancy" style="color: #9C27B0;"></i></div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run" onclick="event.stopPropagation(); previewWorkflow('daily-tech')"><i class="fas fa-play"></i> ÂºÄÂßã‰ΩøÁî®</button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Panel: Êô∫ËÉΩ‰ΩìÂ∏ÇÂú∫ -->
            <div id="panel-market" class="sidebar-panel">
                <div class="sidebar-header">
                    <span>Êô∫ËÉΩ‰ΩìÂ∏ÇÂú∫</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                </div>
                <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                    <div style="position: relative;">
                        <i class="fas fa-search"
                            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.8rem;"></i>
                        <input type="text" placeholder="ÊêúÁ¥¢Êô∫ËÉΩ‰Ωì..."
                            style="width: 100%; padding: 6px 10px 6px 30px; background: var(--bg-secondary); border: 1px solid #333; border-radius: 4px; color: var(--text-primary); outline: none; font-size: 0.85rem;">
                    </div>
                </div>
                <div class="sidebar-content" id="market-list">
                    <!-- Dynamic Market Items -->
                </div>
            </div>

            <div id="panel-drawing" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span><i class="fas fa-palette" style="color: var(--primary); margin-right:6px;"></i> ÁªòÁîªÊô∫ËÉΩ‰Ωì</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                </div>
                <div class="sidebar-content" style="padding: 15px;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Âø´ÈÄüÁîüÊàê</div>
                    <textarea id="draw-prompt-sidebar" rows="3" style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">Áîª‰∏Ä‰∏™Âõ¢ÈòüÁªÑÁªáÊû∂ÊûÑÂõæÔºåÂåÖÂê´Á†îÂèë„ÄÅ‰∫ßÂìÅ„ÄÅËøêËê•</textarea>
                    <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-mermaid-sidebar"> Mermaid</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-plantuml-sidebar"> PlantUML</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-nanobanana-sidebar"> Nano Banana</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-excalidraw-sidebar"> Excalidraw</label>
                    </div>
                    <button onclick="runDrawingGeneratorFromSidebar()" style="margin-top: 10px; width: 100%; padding: 10px 12px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                        ÁîüÊàêÂπ∂Âú®Â∑•‰ΩúÂå∫ÊòæÁ§∫
                    </button>
                </div>
            </div>

            <!-- Panel: MCP Market -->
            <div id="panel-mcp" class="sidebar-panel">
                <div class="sidebar-header">
                    <span><i class="fas fa-network-wired" style="color: #00E5FF; margin-right: 8px;"></i> MCP ÁîüÊÄÅ</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="ÊäòÂè†"></i>
                </div>
                
                <!-- MCP Status / Toggle -->
                <div style="padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0, 229, 255, 0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 0.85rem; font-weight: 600; color: #00E5FF;">AgentDesk Server</span>
                        <label class="switch" style="position: relative; display: inline-block; width: 34px; height: 20px;">
                            <input type="checkbox" id="mcp-server-toggle" onchange="toggleMcpServer(this)">
                            <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px;"></span>
                            <style>
                                .switch input { opacity: 0; width: 0; height: 0; }
                                .switch input:checked + .slider { background-color: #00E5FF; }
                                .switch input:focus + .slider { box-shadow: 0 0 1px #00E5FF; }
                                .switch input:checked + .slider:before { transform: translateX(14px); }
                                .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
                            </style>
                        </label>
                    </div>
                    <div id="mcp-server-status" style="font-size: 0.75rem; color: var(--text-secondary);">
                        <i class="fas fa-circle" style="font-size: 6px; margin-right: 4px; color: #666;"></i> Êú™ÂêØÂä®
                    </div>
                    <div id="mcp-connect-info" style="display: none; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; font-family: monospace; font-size: 0.7rem; color: #aaa; word-break: break-all;">
                        npx -y @agentdesk/mcp-server connect
                    </div>
                </div>

                <!-- MCP Tabs -->
                <div style="display: flex; border-bottom: 1px solid var(--border);">
                    <div class="mcp-tab active" onclick="switchMcpTab('installed')" style="flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; cursor: pointer; border-bottom: 2px solid #00E5FF; color: var(--text-primary);">Â∑≤ËøûÊé•</div>
                    <div class="mcp-tab" onclick="switchMcpTab('market')" style="flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-secondary);">ÂèëÁé∞Â∏ÇÂú∫</div>
                </div>

                <div class="sidebar-content" style="padding: 0;">
                    
                    <!-- Tab: Installed -->
                    <div id="mcp-tab-installed" style="padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">Ëá™ÂÆö‰πâËøûÊé•</span>
                            <button onclick="showAddMcpModal()" style="background: transparent; border: 1px solid var(--border); color: var(--primary); border-radius: 4px; padding: 2px 8px; font-size: 0.7rem; cursor: pointer;">
                                <i class="fas fa-plus"></i> Ê∑ªÂä†
                            </button>
                        </div>

                        <!-- Demo Connected Item -->
                        <div class="mcp-item" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center;">
                            <div style="width: 32px; height: 32px; border-radius: 6px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-folder" style="color: #FFCA28;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.85rem; font-weight: 600;">Filesystem</div>
                                <div style="font-size: 0.7rem; color: #4CAF50;"><i class="fas fa-link"></i> Â∑≤ËøûÊé•</div>
                            </div>
                            <div style="font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Stdio</div>
                        </div>
                        
                        <div class="mcp-item" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center;">
                            <div style="width: 32px; height: 32px; border-radius: 6px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-search" style="color: #29B6F6;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.85rem; font-weight: 600;">Brave Search</div>
                                <div style="font-size: 0.7rem; color: #4CAF50;"><i class="fas fa-link"></i> Â∑≤ËøûÊé•</div>
                            </div>
                            <div style="font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">SSE</div>
                        </div>
                    </div>

                    <!-- Tab: Market -->
                    <div id="mcp-tab-market" style="display: none; padding: 15px;">
                         <input type="text" placeholder="ÊêúÁ¥¢ MCP ÊúçÂä°..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px; border-radius: 6px; color: white; margin-bottom: 15px; font-size: 0.85rem;">
                         
                         <!-- Market Items -->
                         <div class="market-list">
                            <!-- Item 1 -->
                            <div class="mcp-market-item" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fab fa-github" style="font-size: 1.2rem; margin-right: 10px;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">GitHub</div>
                                    <button style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">ÂÆâË£Ö</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    Êèê‰æõ‰ªìÂ∫ìÊêúÁ¥¢„ÄÅÊñá‰ª∂ËØªÂèñ„ÄÅPR ÁÆ°ÁêÜÁ≠âËÉΩÂäõ„ÄÇ
                                </div>
                            </div>
                            
                            <!-- Item 2 -->
                            <div class="mcp-market-item" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fas fa-database" style="font-size: 1.2rem; margin-right: 10px; color: #336791;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">PostgreSQL</div>
                                    <button style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">ÂÆâË£Ö</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    Âè™ËØªËÆøÈóÆÊï∞ÊçÆÂ∫ìÊ®°ÂºèÔºåÊâßË°åÂÆâÂÖ®Êü•ËØ¢„ÄÇ
                                </div>
                            </div>

                             <!-- Item 3 -->
                            <div class="mcp-market-item" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fab fa-google-drive" style="font-size: 1.2rem; margin-right: 10px; color: #1FA463;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Google Drive</div>
                                    <button style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">ÂÆâË£Ö</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    ËÆøÈóÆÊñáÊ°£„ÄÅË°®Ê†ºÂíåÂπªÁÅØÁâáÂÜÖÂÆπ„ÄÇ
                                </div>
                            </div>
                            
                            <!-- Item 4 -->
                            <div class="mcp-market-item" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fas fa-terminal" style="font-size: 1.2rem; margin-right: 10px; color: #ccc;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Local Commander</div>
                                    <button style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">ÂÆâË£Ö</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    Âú®ÂÆâÂÖ®Ê≤ôÁÆ±‰∏≠ÊâßË°åÊú¨Âú∞ shell ÂëΩ‰ª§„ÄÇ
                                </div>
                            </div>

                         </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- 3. Main Content -->
        <div class="main-content">
            <!-- Updated Tabs -->
            <div class="editor-tabs" style="padding: 0 10px; justify-content: flex-start; gap: 10px;">
                <button onclick="switchMainView('editor')" id="view-btn-editor" 
                    style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary); border: none; border-radius: 6px 6px 0 0; color: white; cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: all 0.2s; border-bottom: 2px solid var(--primary);">
                    <i class="fas fa-layer-group"></i> ÂÜÖÂÆπËßÜÂõæ
                </button>
                
                <button onclick="switchMainView('canvas')" id="view-btn-canvas" 
                    style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: transparent; border: none; border-radius: 6px 6px 0 0; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; font-weight: normal; transition: all 0.2s; border-bottom: 2px solid transparent;">
                    <i class="fas fa-project-diagram"></i> Êô∫ËÉΩ‰ΩìË∞ÉÂ∫¶È©æÈ©∂Ëà±
                </button>

                <div style="flex: 1;"></div>
                
                <div id="content-status-indicator" style="margin-right: 15px; font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 5px;">
                    <!-- Dynamic content label -->
                    <i class="fas fa-info-circle"></i> <span id="content-title-text">Ê¨¢ËøéÈ°µ</span>
                </div>

                <!-- Clear Buttons -->
                <button onclick="clearEditorContent()" title="Ê∏ÖÁ©∫ÂÜÖÂÆπÁîªÂ∏É" 
                    style="padding: 8px 12px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-eraser"></i>
                </button>
            </div>
            
            <!-- Editor Area -->
            <div class="editor-area" id="editorArea">
                <div class="welcome-message" style="max-width: 800px; margin: 50px auto; text-align: center;">
                    <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); position: relative; overflow: hidden;">
                        <span style="font-size: 48px; font-weight: 900; color: white;">AD</span>
                        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent); transform: rotate(45deg); animation: shine 3s infinite;"></div>
                    </div>
                    <h1 style="color: var(--text-primary); margin-bottom: 15px;">Ê¨¢Ëøé‰ΩøÁî® AgentDesk</h1>
                    <p style="color: var(--text-secondary); line-height: 1.8; font-size: 16px;">
                        Âú®Â∑¶‰æßÈÄâÊã©Êñá‰ª∂ÊàñÊô∫ËÉΩ‰ΩìÂºÄÂßãÂ∑•‰Ωú<br>
                        ‰ΩøÁî® <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px; color: #FF6B00;">@Êô∫ËÉΩ‰ΩìÂêçÁß∞</code> ÊèêÈóÆÔºåÊàñÁÇπÂáª‰∏ãÊñπÁöÑÊô∫ËÉΩ‰ΩìÂç°ÁâáÂø´ÈÄüÂºÄÂßã
                    </p>
                </div>
            </div>

            <!-- Canvas Area (Now overlay/fullscreen) -->
            <div class="canvas-area" id="canvasArea">
                <div class="canvas-header sticky">
                    <span>Êô∫ËÉΩ‰ΩìÂ∑•‰ΩúÊµÅ</span>
                    <div style="display: flex; gap: 10px;">
                         <span style="font-size: 0.8rem; color: #888;"><i class="fas fa-mouse-pointer"></i> ÊãñÊãΩËäÇÁÇπË∞ÉÊï¥‰ΩçÁΩÆ</span>
                    </div>
                </div>
                <canvas id="workflowCanvas"></canvas>
                <div id="workflowNodes"></div>
            </div>

            <!-- Workflow Detail View (Prototype) -->
            <div class="workflow-detail-area" id="workflowDetailArea" style="display: none; position: absolute; top: 35px; left: 0; width: 100%; height: calc(100% - 35px); background: var(--bg-primary); z-index: 20; padding: 20px; overflow-y: auto;">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- 4. Right Panel -->
        <div class="right-resizer" id="rightResizer"></div>
        <div class="right-panel" id="rightPanel">
            <div class="sidebar-header">
                <span>AIÊô∫ËÉΩ‰ΩìÂõ¢Èòü</span>
                <div class="sidebar-header-actions">
                    <i class="fas fa-trash-alt collapse-btn" onclick="clearChat()" title="Ê∏ÖÁ©∫ÂØπËØù"></i>
                    <i class="fas fa-angle-right collapse-btn" onclick="toggleSidebar('right')" title="ÊäòÂè†"></i>
                </div>
            </div>
            <div id="chat-messages"
                style="flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column;">
                <div class="chat-message agent-message">
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">‰Ω†Â•ΩÔºÅÊ¨¢Ëøé‰ΩøÁî® AgentDeskÔºåÊÇ®ÁöÑÊô∫ËÉΩÂõ¢ÈòüÈöèÊó∂ÂæÖÂëΩ„ÄÇÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†Ôºü</div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid var(--border); position: relative;">
                <div id="mentionDropdown" class="mention-dropdown"></div>
                <div style="display: flex; align-items: flex-end; gap: 8px;">
                    <!-- Prompt Optimization Buttons -->
                    <button id="optimizeBtn" onclick="optimizePrompt()" type="button" title="‰ºòÂåñÊèêÁ§∫ËØç"
                        style="width: 40px; height: 40px; background: rgba(156, 39, 176, 0.2); border: 1px solid rgba(156, 39, 176, 0.4); border-radius: 8px; color: #E040FB; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-magic"></i>
                    </button>
                    <button id="undoOptimizeBtn" onclick="undoOptimize()" type="button" title="Êí§Âõû‰ºòÂåñ"
                        style="display: none; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #bbb; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-undo"></i>
                    </button>

                    <textarea id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Enter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°åÔºåËæìÂÖ• @ ÂëºÂè´Êô∫ËÉΩ‰Ωì)" rows="1"
                        style="flex: 1; padding: 8px 15px; background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 107, 0, 0.3); color: #fff; border-radius: 8px; outline: none; transition: border-color 0.3s; resize: vertical; min-height: 40px; max-height: 200px; line-height: 1.5; font-family: inherit; overflow-y: auto;"></textarea>
                    
                    <button id="sendBtn" onclick="executeTask(document.getElementById('chatInput').value)" title="ÂèëÈÄÅÊ∂àÊÅØ"
                        style="width: 40px; height: 40px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button id="cancelBtn" onclick="cancelTask()" title="ÂÅúÊ≠¢ÁîüÊàê"
                        style="display: none; width: 40px; height: 40px; background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); border: none; border-radius: 8px; color: white; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div id="command-palette">
        <input type="text" id="command-input" placeholder="Type a command... (e.g., 'Switch to Investment')">
        <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
            <div><span style="color: var(--primary);">Enter</span> to execute</div>
            <div><span style="color: var(--primary);">Esc</span> to close</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Á≥ªÁªüËÆæÁΩÆ</h3>
                <span class="close-modal" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ê®°ÂûãÊèê‰æõÂïÜ</label>
                    <div class="provider-options">
                        <div class="provider-option active" onclick="selectProvider('gemini')" data-provider="gemini">
                            <i class="fas fa-gem"></i> Gemini
                        </div>
                        <div class="provider-option" onclick="selectProvider('deepseek')" data-provider="deepseek">
                            <i class="fas fa-brain"></i> DeepSeek
                        </div>
                        <div class="provider-option" onclick="selectProvider('openai')" data-provider="openai">
                            <i class="fas fa-robot"></i> OpenAI
                        </div>
                        <div class="provider-option" onclick="selectProvider('local')" data-provider="local">
                            <i class="fas fa-server"></i> Local
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="setting-api-key" class="form-control" placeholder="ËæìÂÖ• API Key">
                </div>
                <div class="form-group">
                    <label>Ê®°ÂûãÂêçÁß∞</label>
                    <input type="text" id="setting-model-name" class="form-control" placeholder="‰æãÂ¶Ç: gemini-2.5-flash, deepseek-chat">
                </div>
                <div class="form-group" id="base-url-group" style="display: none;">
                    <label>Base URL (API ‰ª£ÁêÜÂú∞ÂùÄ)</label>
                    <input type="text" id="setting-base-url" class="form-control" placeholder="‰æãÂ¶Ç: https://api.deepseek.com">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeSettingsModal()">ÂèñÊ∂à</button>
                <button class="btn-save" id="saveSettingsBtn" onclick="saveSettings()">‰øùÂ≠òÂπ∂ÈáçÂêØ</button>
            </div>
        </div>
    </div>

    <!-- Scripts for File Preview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        // ==================== Core Logic & State ====================
        const WorkflowManager = {
            currentScenario: 'all', // 'all', 'investment', 'compliance', 'operations'
            scenarios: {
                investment: {
                    name: 'Êô∫ËÉΩÊäïÁ†î',
                    agentIds: ['coordinator', 'doc_analyst', 'data_expert']
                },
                compliance: {
                    name: 'ÂêàËßÑËê•ÈîÄ',
                    agentIds: ['coordinator', 'content_creator', 'compliance_officer']
                },
                operations: {
                    name: 'Êô∫ËÉΩËøêËê•',
                    agentIds: ['coordinator', 'doc_analyst', 'translator']
                }
            },

            setScenario(type) {
                this.currentScenario = type;
                console.log(`Switched to scenario: ${type}`);
                renderAgents(); // Re-render agents based on filter

                // Update UI
                const title = type === 'all' ? 'ËµÑÊ∫êÁÆ°ÁêÜÂô®' : this.scenarios[type].name;
                // You might want to update some header text here
            }
        };

        let currentActiveFile = null; // ÂΩìÂâçÂú®ÂÜÖÂÆπËßÜÂõæ‰∏≠ÊâìÂºÄÁöÑÊñá‰ª∂
        let agents = [];
        let canvas, ctx;
        let workflowConnections = [];
        let particles = []; // Background particles
        let taskCounter = 0;
        let animationId = null;
        let currentAbortController = null; // Áî®‰∫éÂèñÊ∂àËØ∑Ê±Ç

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', function () {
            initCanvas();
            loadAgents();
            initCanvas();
            loadAgents();
            loadFiles(); // Load files on startup
            renderLandingAgents(); // Render landing page agents
            startAnimation();

            // Auto-focus landing input
            document.getElementById('globalInput').focus();
        });

        function initCanvas() {
            // The canvas needs to be visible for proper initialization sometimes, 
            // but since it's now absolute/overlay, we can init it directly.
            const container = document.querySelector('.canvas-area');
            container.innerHTML = '<canvas id="workflowCanvas"></canvas><div id="workflowNodes"></div>';

            canvas = document.getElementById('workflowCanvas');
            ctx = canvas.getContext('2d');
            
            // Initial resize (even if invisible)
            resizeCanvas();
            initParticles(); 
            
            window.addEventListener('resize', () => {
                resizeCanvas();
                initParticles();
            });
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawWorkflow();
        }

        // ==================== Agent Management ====================
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                if (data.success) {
                    agents = data.agents.map(agent => ({
                        ...agent,
                        status: 'idle',
                        tasksCompleted: 0,
                        position: null
                    }));
                    renderAgents();
                    buildMarketAgents();
                    renderMarket();
                    renderLandingAgents();
                }
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }

        function renderAgents() {
            // Filter agents based on current scenario
            let visibleAgents = agents;
            if (WorkflowManager.currentScenario !== 'all') {
                const allowedIds = WorkflowManager.scenarios[WorkflowManager.currentScenario].agentIds;
                visibleAgents = agents.filter(a => allowedIds.includes(a.id));
            }

            // Calculate positions (Circle Layout)
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // Enforce minimum radius to avoid overlap (reduced for smaller display)
            const minRadius = 100;
            const calculatedRadius = Math.min(canvas.width, canvas.height) * 0.28;
            const radius = Math.max(minRadius, calculatedRadius);

            const coordinator = visibleAgents.find(a => a.name === 'ÂçèË∞ÉËÄÖ');
            const others = visibleAgents.filter(a => a.name !== 'ÂçèË∞ÉËÄÖ');

            if (coordinator) {
                // Update original agent object
                const original = agents.find(a => a.name === coordinator.name);
                if (original) original.position = { x: centerX, y: centerY };
            }

            others.forEach((agent, index) => {
                const angle = (index / others.length) * Math.PI * 2 - Math.PI / 2;
                const original = agents.find(a => a.name === agent.name);
                if (original) {
                    original.position = {
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius
                    };
                }
            });

            renderWorkflowNodes(visibleAgents, centerX, centerY);
            drawWorkflow();
        }

        function renderWorkflowNodes(visibleAgents, centerX, centerY) {
            const container = document.getElementById('workflowNodes');
            container.innerHTML = visibleAgents.map((agent, index) => {
                if (!agent.position) return '';
                const iconColor = agent.status === 'working' ? '#FF6B00' : '#888';

                // Radial Label Positioning
                let labelStyle = '';
                const isCenter = agent.name === 'ÂçèË∞ÉËÄÖ';

                if (isCenter) {
                    // Center node: label directly below
                    labelStyle = `left: ${agent.position.x}px; top: ${agent.position.y + 40}px; transform: translateX(-50%);`;
                } else {
                    // Outer nodes: push label radially outward
                    const dx = agent.position.x - centerX;
                    const dy = agent.position.y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance > 0) {
                        // Normalize and scale
                        // The node radius is approx 30px. We want the label to be outside that.
                        // Let's push it 45px out from the node center (reduced for smaller display).
                        const offset = 45;
                        const labelX = agent.position.x + (dx / distance) * offset;
                        const labelY = agent.position.y + (dy / distance) * offset;

                        labelStyle = `left: ${labelX}px; top: ${labelY}px; transform: translate(-50%, -50%);`;
                    } else {
                        // Fallback
                        labelStyle = `left: ${agent.position.x}px; top: ${agent.position.y + 50}px; transform: translateX(-50%);`;
                    }
                }

                return `
                    <div class="workflow-node ${agent.status}" 
                         style="left: ${agent.position.x}px; top: ${agent.position.y}px; position: absolute; transform: translate(-50%, -50%);"
                         title="${agent.name}">
                        <i class="${agent.emoji}" style="color: ${iconColor};"></i>
                    </div>
                    <div class="agent-label" style="${labelStyle}">${agent.name}</div>
                `;
            }).join('');
        }

        // ==================== Canvas Drawing ====================
        function drawWorkflow() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Background Particles
            drawParticles();

            workflowConnections.forEach(conn => {
                drawConnection(conn);
            });
        }

        // ==================== Particle System ====================
        function initParticles() {
            particles = [];
            const count = 50;
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1,
                    alpha: Math.random() * 0.3 + 0.1
                });
            }
        }

        function drawParticles() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                // Bounce off walls
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
                ctx.fill();
            });
        }

        function drawConnection(conn) {
            const fromAgent = agents[conn.from];
            const toAgent = agents[conn.to];

            if (!fromAgent || !toAgent || !fromAgent.position || !toAgent.position) return;

            const from = fromAgent.position;
            const to = toAgent.position;
            const progress = conn.progress;

            // Gradient
            const gradient = ctx.createLinearGradient(from.x, from.y, to.x, to.y);
            gradient.addColorStop(0, 'rgba(255, 107, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 107, 0, 0.8)');

            ctx.beginPath();
            ctx.moveTo(from.x, from.y);

            const currentX = from.x + (to.x - from.x) * progress;
            const currentY = from.y + (to.y - from.y) * progress;

            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3; // Increased from 2
            ctx.lineCap = 'round';
            ctx.shadowBlur = 15; // Increased from 10
            ctx.shadowColor = 'rgba(255, 107, 0, 0.6)'; // Increased opacity
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Head Particle (larger)
            ctx.beginPath();
            ctx.arc(currentX, currentY, 4, 0, Math.PI * 2); // Increased from 3
            ctx.fillStyle = '#FF6B00';
            ctx.fill();

            // Glow around particle
            ctx.beginPath();
            ctx.arc(currentX, currentY, 8, 0, Math.PI * 2);
            const particleGlow = ctx.createRadialGradient(currentX, currentY, 2, currentX, currentY, 8);
            particleGlow.addColorStop(0, 'rgba(255, 107, 0, 0.4)');
            particleGlow.addColorStop(1, 'rgba(255, 107, 0, 0)');
            ctx.fillStyle = particleGlow;
            ctx.fill();
        }

        function startAnimation() {
            function animate() {
                drawWorkflow();
                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function addWorkflowConnection(fromIndex, toIndex) {
            const connection = {
                from: fromIndex,
                to: toIndex,
                progress: 0,
                id: Date.now()
            };
            workflowConnections.push(connection);

            const duration = 800;
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                connection.progress = Math.min(elapsed / duration, 1);
                if (connection.progress < 1) requestAnimationFrame(animate);
            }
            animate();
        }

        // ==================== Interaction Logic ====================
        const input = document.getElementById('globalInput');
        const chatInput = document.getElementById('chatInput');

        // Landing Page Input
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                enterWorkspace();
            }
        });

        function enterWorkspace() {
            const val = input.value.trim();
            document.body.classList.add('mode-workspace');

            if (val) {
                // Transfer value to chat input and execute
                chatInput.value = val;
                executeTask(val);
            }
        }
        
        // ËøîÂõûÈ¶ñÈ°µ
        function goToHomePage() {
            // ÁßªÈô§Â∑•‰ΩúÂå∫Ê®°Âºè
            document.body.classList.remove('mode-workspace');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            const input = document.getElementById('landing-input');
            if (input) input.value = '';
            
            // ÈáçÁΩÆÂÜÖÂÆπÂå∫
            const editorArea = document.getElementById('editorArea');
            if (editorArea) {
                editorArea.classList.remove('collapsed');
                editorArea.innerHTML = `
                    <div class="welcome-message" style="max-width: 800px; margin: 50px auto; text-align: center;">
                        <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); position: relative; overflow: hidden;">
                            <span style="font-size: 48px; font-weight: 900; color: white;">AD</span>
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent); transform: rotate(45deg); animation: shine 3s infinite;"></div>
                        </div>
                        <h1 style="color: var(--text-primary); margin-bottom: 15px;">Ê¨¢Ëøé‰ΩøÁî® AgentDesk</h1>
                        <p style="color: var(--text-secondary); line-height: 1.8; font-size: 16px;">
                            Âú®Â∑¶‰æßÈÄâÊã©Êñá‰ª∂ÊàñÊô∫ËÉΩ‰ΩìÂºÄÂßãÂ∑•‰Ωú<br>
                            ‰ΩøÁî® <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px; color: #FF6B00;">@Êô∫ËÉΩ‰ΩìÂêçÁß∞</code> ÊèêÈóÆÔºåÊàñÁÇπÂáª‰∏ãÊñπÁöÑÊô∫ËÉΩ‰ΩìÂç°ÁâáÂø´ÈÄüÂºÄÂßã
                        </p>
                    </div>
                `;
            }
            
            // Êõ¥Êñ∞Ê†áÈ¢ò
            updateContentTitle('AIÊô∫ËÉΩ‰ΩìÂõ¢ÈòüÂ∑•‰ΩúÂå∫', 'fas fa-comments');
            
            // Ê∏ÖÁ©∫ËÅäÂ§©Ê∂àÊÅØÔºåÂè™‰øùÁïôÊ¨¢ËøéÊ∂àÊÅØ
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="chat-message agent-message">
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">‰Ω†Â•ΩÔºÅÊ¨¢Ëøé‰ΩøÁî® AgentDeskÔºåÊÇ®ÁöÑÊô∫ËÉΩÂõ¢ÈòüÈöèÊó∂ÂæÖÂëΩ„ÄÇÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†Ôºü</div>
                    </div>
                `;
            }
            
            // ËÅöÁÑ¶Âà∞ÊêúÁ¥¢Ê°Ü
            setTimeout(() => {
                if (input) input.focus();
            }, 300);
        }

        // Chat Panel Input
        chatInput.addEventListener('keydown', (e) => {
            // Ê£ÄÊü•‰∏ãÊãâËèúÂçïÊòØÂê¶ÊòæÁ§∫
            const dropdown = document.getElementById('mentionDropdown');
            const isDropdownVisible = dropdown && dropdown.classList.contains('show');
            
            if (!isDropdownVisible && e.key === 'Enter') {
                const val = chatInput.value.trim();
                if (val) {
                    executeTask(val);
                    chatInput.value = '';
                }
            }
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + K: Open Command Palette
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                toggleCommandPalette();
            }
            // Cmd/Ctrl + /: Focus Chat
            if ((e.metaKey || e.ctrlKey) && e.key === '/') {
                e.preventDefault();
                chatInput.focus();
            }
            // Esc: Close Palette
            if (e.key === 'Escape') {
                document.getElementById('command-palette').classList.remove('active');
            }
        });

        function toggleCommandPalette() {
            const palette = document.getElementById('command-palette');
            const input = document.getElementById('command-input');
            palette.classList.toggle('active');
            if (palette.classList.contains('active')) {
                input.focus();
            }
        }

        // Command Palette Logic
        document.getElementById('command-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const cmd = e.target.value.trim().toLowerCase();
                if (cmd.includes('invest')) selectScenario(document.querySelectorAll('.scenario-card')[0], 'investment');
                if (cmd.includes('compli')) selectScenario(document.querySelectorAll('.scenario-card')[1], 'compliance');
                if (cmd.includes('oper')) selectScenario(document.querySelectorAll('.scenario-card')[2], 'operations');

                toggleCommandPalette();
                e.target.value = '';
            }
        });

        // Execute Task (Mock -> Real)
        function getAgentIdByName(name) {
            const found = agents.find(a => a.name === name);
            return found ? found.id : null;
        }

        async function executeTask(message, agentId = null) {
            if (!message || !message.trim()) return;
            
            console.log("Executing:", message);

            // ÂàáÊç¢ÊåâÈíÆÊòæÁ§∫
            const sendBtn = document.getElementById('sendBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            if (sendBtn && cancelBtn) {
                sendBtn.style.display = 'none';
                cancelBtn.style.display = 'block';
            }

            // Add User Message to Chat
            addChatMessage('user', message);

            // 1. Visual: Coordinator starts
            const coordinatorIndex = agents.findIndex(a => a.name === 'ÂçèË∞ÉËÄÖ');
            if (coordinatorIndex !== -1) {
                agents[coordinatorIndex].status = 'working';
                renderAgents(); // Update visual state
            }

            try {
                // Show loading indicator
                showLoading();

                // ÂàõÂª∫ AbortController
                currentAbortController = new AbortController();

                // 2. Call API
                const formData = new FormData();
                formData.append('message', message);

                // Add scenario context
                if (WorkflowManager.currentScenario !== 'all') {
                    formData.append('scenario', WorkflowManager.currentScenario);
                }
                if (!agentId) {
                    const m = message.match(/@([^\s@]+)/);
                    if (m && m[1]) {
                        const found = agents.find(a => a.name === m[1]);
                        if (found) agentId = found.id;
                    }
                }
                if (agentId) {
                    formData.append('agent_id', agentId);
                }
                
                // Add current file context if available
                if (currentActiveFile) {
                    formData.append('filename', currentActiveFile);
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData,
                    signal: currentAbortController.signal
                });
                const result = await response.json();

                if (result.success) {
                    const agentName = result.agent && result.agent.name ? result.agent.name : 'Âä©Êâã';
                    
                    // Ëß£ÊûêÁî®Êà∑Ê∂àÊÅØ‰∏≠ÁöÑÊâÄÊúâ@mention
                    const mentions = [];
                    try {
                        // ‰ΩøÁî® matchAll Êàñ fallback Âà∞ match
                        let mentionMatches;
                        if (String.prototype.matchAll) {
                            mentionMatches = message.matchAll(/@([^\s@]+)/g);
                            for (const match of mentionMatches) {
                                const mentionedName = match[1];
                                const found = agents.find(a => a.name === mentionedName);
                                if (found) {
                                    mentions.push(mentionedName);
                                }
                            }
                        } else {
                            // Fallback for older browsers
                            const regex = /@([^\s@]+)/g;
                            let match;
                            while ((match = regex.exec(message)) !== null) {
                                const mentionedName = match[1];
                                const found = agents.find(a => a.name === mentionedName);
                                if (found) {
                                    mentions.push(mentionedName);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing mentions:', e);
                    }
                    
                    // Â¶ÇÊûúAPIËøîÂõû‰∫Ümentions‰ø°ÊÅØÔºå‰πüÊ∑ªÂä†ËøõÂéª
                    try {
                        if (result.routing_info && Array.isArray(result.routing_info.mentions)) {
                            result.routing_info.mentions.forEach(mention => {
                                if (typeof mention === 'string' && !mentions.includes(mention)) {
                                    const found = agents.find(a => a.name === mention);
                                    if (found) mentions.push(mention);
                                } else if (mention && mention.name && !mentions.includes(mention.name)) {
                                    const found = agents.find(a => a.name === mention.name);
                                    if (found) mentions.push(mention.name);
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error processing routing_info mentions:', e);
                    }
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰ªª‰ΩïmentionÔºåËá≥Â∞ëËøûÊé•ËøîÂõûÁöÑagent
                    if (mentions.length === 0 && agentName) {
                        mentions.push(agentName);
                    }
                    
                    // ËøûÊé•ÊâÄÊúâË¢´ÊèêÂà∞ÁöÑÊô∫ËÉΩ‰Ωì
                    mentions.forEach(mentionedName => {
                        const agentIndex = agents.findIndex(a => a.name === mentionedName);
                        if (coordinatorIndex !== -1 && agentIndex !== -1 && coordinatorIndex !== agentIndex) {
                            addWorkflowConnection(coordinatorIndex, agentIndex);
                            
                            // Delay highlight
                            setTimeout(() => {
                                agents[agentIndex].status = 'working';
                                renderAgents();
                            }, 800);
                        }
                    });

                    // Hide loading and show response
                    setTimeout(() => {
                        hideLoading();
                        const responseText = result.response || result.error || 'Êó†ÂìçÂ∫î';
                        addChatMessage('agent', responseText, agentName);

                        // Update Center Panel Content (Mock for now)
                        updateCenterPanel(responseText, agentName);

                        // Reset status after a while (optional, or keep it)
                        // setTimeout(() => {
                        //     agents.forEach(a => a.status = 'idle');
                        //     workflowConnections = [];
                        //     renderAgents();
                        // }, 3000);
                    }, 1000);

                } else {
                    // Handle failure case
                    hideLoading();
                    const errorMsg = result.error || 'ËØ∑Ê±ÇÂ§±Ë¥•';
                    addChatMessage('system', 'ÈîôËØØ: ' + errorMsg);
                }
            } catch (e) {
                console.error(e);
                hideLoading();
                if (e.name === 'AbortError') {
                    addChatMessage('system', '‰ªªÂä°Â∑≤ÂèñÊ∂à');
                } else {
                addChatMessage('system', 'Error: ' + e.message);
                }
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const sendBtn = document.getElementById('sendBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                if (sendBtn && cancelBtn) {
                    sendBtn.style.display = 'block';
                    cancelBtn.style.display = 'none';
                }
                currentAbortController = null;
            }
        }

        // ÂèñÊ∂à‰ªªÂä°
        function cancelTask() {
            if (currentAbortController) {
                currentAbortController.abort();
                
                // Á´ãÂç≥ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                const sendBtn = document.getElementById('sendBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                if (sendBtn && cancelBtn) {
                    sendBtn.style.display = 'block';
                    cancelBtn.style.display = 'none';
                }
                
                // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                hideLoading();
                
                // ÊÅ¢Â§çÊô∫ËÉΩ‰ΩìÁä∂ÊÄÅ
                agents.forEach(a => a.status = 'idle');
                renderAgents();
                workflowConnections = [];
            }
        }

        function addChatMessage(role, text, agentName = null) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');

            if (role === 'user') {
                messageDiv.className = 'chat-message user-message';
                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-user"></i></div>
                    <div class="message-content">${text}</div>
                `;
                container.appendChild(messageDiv);
            } else if (role === 'agent') {
                messageDiv.className = 'chat-message agent-message';
                const agentIcon = getAgentIcon(agentName);
                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="${agentIcon}"></i></div>
                    <div class="message-content">
                        <div class="message-agent-name">${agentName}</div>
                        <div class="typing-content"></div>
                    </div>
                `;
                container.appendChild(messageDiv);

                // Start typewriter effect
                const contentDiv = messageDiv.querySelector('.typing-content');
                typeWriter(contentDiv, text);
            } else {
                messageDiv.className = 'chat-message agent-message';
                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-exclamation-triangle" style="color: #ff4444;"></i></div>
                    <div class="message-content" style="color: #ff4444;">${text}</div>
                `;
                container.appendChild(messageDiv);
            }

            container.scrollTop = container.scrollHeight;
        }

        function typeWriter(element, text, speed = 10) {
            let i = 0;
            element.innerHTML = '';

            function type() {
                if (i < text.length) {
                    // Handle simple markdown-like bolding for now
                    if (text.substring(i).startsWith('**')) {
                        const end = text.indexOf('**', i + 2);
                        if (end !== -1) {
                            element.innerHTML += '<strong>' + text.substring(i + 2, end) + '</strong>';
                            i = end + 2;
                            setTimeout(type, speed);
                            return;
                        }
                    }

                    if (text[i] === '\n') {
                        element.innerHTML += '<br>';
                    } else {
                        element.innerHTML += text[i];
                    }
                    i++;

                    // Auto scroll
                    const container = document.getElementById('chat-messages');
                    if (container) container.scrollTop = container.scrollHeight;

                    setTimeout(type, speed);
                }
            }
            type();
        }

        function showLoading() {
            const container = document.getElementById('chat-messages');
            // Check if existing indicator
            if (document.getElementById('loading-indicator')) return;

            const indicator = document.createElement('div');
            indicator.id = 'loading-indicator';
            indicator.className = 'typing-indicator';
            indicator.style.opacity = '1';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }
        }

        function getAgentIcon(agentName) {
            const agent = agents.find(a => a.name === agentName);
            return agent ? agent.emoji : 'fas fa-robot';
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function updateCenterPanel(content, agentName) {
            const editorArea = document.querySelector('.editor-area');

            // Êõ¥Êñ∞Ê†áÈ¢ò
            updateContentTitle('AI ÂØπËØù', 'fas fa-comments');

            // 1. Extract HTML blocks first (highest priority)
            const htmlBlocks = [];
            const htmlRegex = /```html\s*([\s\S]*?)```/g;
            let processedContent = content.replace(htmlRegex, (match, code) => {
                let cleanCode = code.trim();
                
                // Ëá™Âä®‰øÆÂ§çÂ∏∏ËßÅÁöÑ CDN ÈóÆÈ¢ò
                cleanCode = cleanCode.replace(
                    /https:\/\/cdn\.jsdelivr\.net\/npm\/mermaid.*\/mermaid(\.esm)?\.min\.js/g, 
                    'https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js'
                );
                
                htmlBlocks.push(`<div class="html-preview-container">
                    <div class="html-preview-header">
                        <i class="fas fa-chart-line" style="color: #FF6B00;"></i>
                        <span>‰∫§‰∫íÂºèÂèØËßÜÂåñ</span>
                        <button onclick="openHTMLFullscreen(${htmlBlocks.length})" class="html-fullscreen-btn" title="ÂÖ®Â±èÊü•Áúã">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <iframe class="html-preview" srcdoc="${escapeHtml(cleanCode)}" sandbox="allow-scripts allow-same-origin"></iframe>
                </div>`);
                return `__HTML_BLOCK_${htmlBlocks.length - 1}__`;
            });

            // 2. Extract Mermaid blocks
            const mermaidBlocks = [];
            const mermaidRegex = /```mermaid\s*([\s\S]*?)```/g;
            processedContent = processedContent.replace(mermaidRegex, (match, code) => {
                const cleanCode = escapeHtml(code.trim());
                mermaidBlocks.push(`<div class="mermaid">${cleanCode}</div>`);
                return `__MERMAID_BLOCK_${mermaidBlocks.length - 1}__`;
            });

            // 3. Simple markdown rendering
            let htmlContent = processedContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                .replace(/## (.*?)\n/g, '<h2>$1</h2>')
                .replace(/# (.*?)\n/g, '<h1>$1</h1>')
                .replace(/\n/g, '<br>');

            // 4. Restore HTML blocks
            htmlBlocks.forEach((block, index) => {
                htmlContent = htmlContent.replace(`__HTML_BLOCK_${index}__`, block);
            });

            // 5. Restore Mermaid blocks
            mermaidBlocks.forEach((block, index) => {
                htmlContent = htmlContent.replace(`__MERMAID_BLOCK_${index}__`, block);
            });

            editorArea.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 0.8rem; color: var(--primary); text-transform: uppercase;">AI ÁîüÊàêÂÜÖÂÆπ</span>
                    <h1 style="margin-top: 5px;">${agentName} ËæìÂá∫</h1>
                </div>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    ${htmlContent}
                </div>
            `;

            // 6. Render Mermaid
            if (mermaidBlocks.length > 0) {
                try {
                    mermaid.run({
                        nodes: editorArea.querySelectorAll('.mermaid')
                    });
                } catch (e) {
                    console.error('Mermaid rendering failed:', e);
                }
            }
            
            // 7. Store HTML blocks for fullscreen function
            window.htmlPreviewBlocks = htmlBlocks.map((_, index) => {
                const iframe = editorArea.querySelectorAll('.html-preview')[index];
                return iframe ? iframe.getAttribute('srcdoc') : '';
            });
        }
        
        // ÂÖ®Â±èÊü•Áúã HTML È¢ÑËßà
        function openHTMLFullscreen(index) {
            if (!window.htmlPreviewBlocks || !window.htmlPreviewBlocks[index]) return;
            
            const htmlContent = window.htmlPreviewBlocks[index];
            const newWindow = window.open('', '_blank', 'width=1200,height=800');
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        }

        // Sidebar Switching
        function switchSidebar(panelName) {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => item.classList.remove('active'));

            // ÊøÄÊ¥ªÂØπÂ∫îÁöÑÊ¥ªÂä®Ê†èÂõæÊ†á
            if (panelName === 'explorer') document.getElementById('activity-explorer').classList.add('active');
            if (panelName === 'scenarios') document.getElementById('activity-scenarios').classList.add('active');
            if (panelName === 'market') {
                document.getElementById('activity-market').classList.add('active');
                renderMarket();
            }
            // MCP Activation
            if (panelName === 'mcp') {
                const el = document.getElementById('activity-mcp');
                if (el) el.classList.add('active');
            }

            // Âä®ÊÄÅÊ∑ªÂä†ÁöÑÊô∫ËÉΩ‰Ωì
            const activityItem = document.getElementById(`activity-${panelName}`);
            if (activityItem) activityItem.classList.add('active');

            // ÂàáÊç¢‰æßËæπÊ†èÈù¢Êùø
            document.querySelectorAll('.sidebar-panel').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });

            // Handle expanded sidebar state (for NotebookLM and AI-Gist)
            const sidebar = document.getElementById('leftSidebar');
            if (panelName === 'notebooklm' || panelName === 'aigist') {
                sidebar.classList.add('expanded');
            } else {
                sidebar.classList.remove('expanded');
            }
            
            const targetPanel = document.getElementById(`panel-${panelName}`);
            if (targetPanel) {
                targetPanel.classList.add('active');
                targetPanel.style.display = 'flex';
                targetPanel.style.flexDirection = 'column';
            }
            
            // NotebookLM Special Handling: auto-load external iframe
            if (panelName === 'notebooklm') {
                const placeholder = document.getElementById('notebooklm-placeholder');
                const iframe = document.getElementById('notebooklm-iframe');
                if (placeholder && iframe) {
                    placeholder.style.display = 'none';
                    iframe.style.display = 'block';
                    if (iframe.src === 'about:blank') {
                        iframe.src = 'http://localhost:8502/';
                    }
                }
            }

            // AI-Gist Special Handling
            if (panelName === 'aigist') {
                setTimeout(() => {
                    const placeholder = document.getElementById('aigist-placeholder');
                    const iframe = document.getElementById('aigist-iframe');
                    if (placeholder && iframe) {
                         placeholder.style.display = 'none';
                         iframe.style.display = 'block';
                    }
                }, 500);
            }
        }

        // ==================== MCP Market Logic (Localized) ====================
        const mcpTools = [
            {
                id: 'amap',
                name: 'È´òÂæ∑Âú∞Âõæ',
                icon: 'fas fa-map-marked-alt',
                color: '#2874F0',
                desc: 'ËøûÊé•È´òÂæ∑ÂºÄÊîæÂπ≥Âè∞ÔºåÊèê‰æõÂú∞ÁêÜÁºñÁ†Å„ÄÅË∑ØÂæÑËßÑÂàí„ÄÅÂë®ËæπÊêúÁ¥¢ÂíåË°åÊîøÂå∫ÂàíÊü•ËØ¢ËÉΩÂäõ„ÄÇ',
                capabilities: ['POI ÊêúÁ¥¢', 'Ë∑ØÂæÑËßÑÂàí', 'Âú∞ÁêÜÁºñÁ†Å', 'IP ÂÆö‰Ωç', 'Â§©Ê∞îÊü•ËØ¢'],
                installCmd: 'npx -y @modelcontextprotocol/server-amap',
                example: 'Êü•ËØ¢Ê∑±Âú≥Â∏ÇÂçóÂ±±Âå∫ÁßëÊäÄÂõ≠ÈôÑËøëÁöÑÁëûÂπ∏ÂíñÂï°ÔºåÂπ∂ËßÑÂàí‰ªéËÖæËÆØÂ§ßÂé¶ËøáÂéªÁöÑÊ≠•Ë°åË∑ØÁ∫ø„ÄÇ',
                envVars: ['AMAP_API_KEY']
            },
            {
                id: 'feishu',
                name: 'È£û‰π¶ (Feishu)',
                icon: 'fas fa-paper-plane', // Using paper-plane as proxy for Lark
                color: '#00D6B9',
                desc: 'Ê∑±Â∫¶ÈõÜÊàêÈ£û‰π¶ÂäûÂÖ¨Â•ó‰ª∂ÔºåÊîØÊåÅÊ∂àÊÅØÈÄöÁü•„ÄÅÂ§öÁª¥Ë°®Ê†ºËØªÂèñ„ÄÅÊó•ÂéÜÁÆ°ÁêÜÂíåÊñáÊ°£Âçè‰Ωú„ÄÇ',
                capabilities: ['ÂèëÈÄÅÂØåÊñáÊú¨Ê∂àÊÅØ', 'ËØªÂÜôÂ§öÁª¥Ë°®Ê†º', 'ÁÆ°ÁêÜÊó•ÂéÜÊó•Á®ã', 'Áü•ËØÜÂ∫ìÊ£ÄÁ¥¢'],
                installCmd: 'npx -y @modelcontextprotocol/server-feishu',
                example: 'ËØªÂèñ‚ÄúQ4 È°πÁõÆËøõÂ∫¶Ë°®‚ÄùÂ§öÁª¥Ë°®Ê†ºÔºåÊâæÂá∫ÊâÄÊúâÁä∂ÊÄÅ‰∏∫‚ÄúÂª∂Êúü‚ÄùÁöÑ‰ªªÂä°Âπ∂ÂèëÈÄÅÁæ§ÈÄöÁü•„ÄÇ',
                envVars: ['FEISHU_APP_ID', 'FEISHU_APP_SECRET']
            },
            {
                id: 'wechat',
                name: '‰ºÅ‰∏öÂæÆ‰ø°',
                icon: 'fab fa-weixin',
                color: '#07C160',
                desc: 'ËøûÊé•‰ºÅ‰∏öÂæÆ‰ø° APIÔºåÂÆûÁé∞ÂÜÖÈÉ®Áæ§Êú∫Âô®‰∫∫Êé®ÈÄÅ„ÄÅÈÄöËÆØÂΩïÁÆ°ÁêÜÂíåÂ∫îÁî®Ê∂àÊÅØ‰∫§‰∫í„ÄÇ',
                capabilities: ['Áæ§Êú∫Âô®‰∫∫Êé®ÈÄÅ', 'Â∫îÁî®Ê∂àÊÅØÂèëÈÄÅ', 'ÈÄöËÆØÂΩïÊü•ËØ¢', 'Á¥†Êùê‰∏ä‰º†'],
                installCmd: 'npx -y @modelcontextprotocol/server-wechat-work',
                example: 'Âêë‚ÄúËøêÁª¥ÁõëÊéßÁæ§‚ÄùÂèëÈÄÅ‰∏ÄÊù°ÊúçÂä°Âô® CPU ÂëäË≠¶Ê∂àÊÅØÔºåÂπ∂@Áõ∏ÂÖ≥Ë¥üË¥£‰∫∫„ÄÇ',
                envVars: ['WECHAT_CORP_ID', 'WECHAT_CORP_SECRET']
            },
            {
                id: 'tushare',
                name: 'Tushare Pro',
                icon: 'fas fa-chart-line',
                color: '#E64A19',
                desc: '‰∏ì‰∏öÁöÑÈáëËûçÂ§ßÊï∞ÊçÆÂπ≥Âè∞Êé•Âè£ÔºåÊèê‰æõËÇ°Á•®„ÄÅÂü∫Èáë„ÄÅÊúüË¥ß„ÄÅÂ§ñÊ±áÁ≠âÂÖ®Áª¥Â∫¶Ë¥¢ÁªèÊï∞ÊçÆ„ÄÇ',
                capabilities: ['ËÇ°Á•®Ë°åÊÉÖËé∑Âèñ', 'Ë¥¢Âä°Êä•Ë°®ÂàÜÊûê', 'ÊåáÊï∞Êï∞ÊçÆ', 'ÂÖ¨ÂãüÂü∫ÈáëÂáÄÂÄº'],
                installCmd: 'npx -y @modelcontextprotocol/server-tushare',
                example: 'Ëé∑ÂèñË¥µÂ∑ûËåÖÂè∞ (600519.SH) Ëøë‰∏âÂπ¥ÁöÑËê•Êî∂Êï∞ÊçÆÔºåÂπ∂ËÆ°ÁÆóÂêåÊØîÂ¢ûÈïøÁéá„ÄÇ',
                envVars: ['TUSHARE_TOKEN']
            },
            {
                id: 'aliyun',
                name: 'ÈòøÈáå‰∫ë (Aliyun)',
                icon: 'fas fa-cloud',
                color: '#FF6A00',
                desc: 'ÁÆ°ÁêÜÈòøÈáå‰∫ëËµÑÊ∫êÔºåÊîØÊåÅ ECS ÂÆû‰æãÁÆ°Êéß„ÄÅOSS ÂØπË±°Â≠òÂÇ®Êìç‰ΩúÂíå SLB Ë¥üËΩΩÂùáË°°ÈÖçÁΩÆ„ÄÇ',
                capabilities: ['ECS ÂÆû‰æãÁÆ°ÁêÜ', 'OSS Êñá‰ª∂‰∏ä‰º†/‰∏ãËΩΩ', 'RDS ÂÆû‰æãÊü•ËØ¢', '‰∫ëÁõëÊéßÊåáÊ†á'],
                installCmd: 'npx -y @modelcontextprotocol/server-aliyun',
                example: 'ÂàóÂá∫ÂçéÂçó1Âå∫ÊâÄÊúâËøêË°å‰∏≠ÁöÑ ECS ÂÆû‰æãÔºåÂπ∂Ê£ÄÊü•ÂÖ∂ CPU ‰ΩøÁî®ÁéáÊòØÂê¶Ë∂ÖËøá 80%„ÄÇ',
                envVars: ['ALIYUN_ACCESS_KEY', 'ALIYUN_SECRET_KEY']
            },
            {
                id: 'deepseek',
                name: 'DeepSeek R1',
                icon: 'fas fa-brain',
                color: '#673AB7',
                desc: 'Êé•ÂÖ• DeepSeek Âº∫Â§ßÁöÑÊé®ÁêÜÊ®°ÂûãÔºåÁî®‰∫é‰ª£Á†ÅÁîüÊàê„ÄÅÂ§çÊùÇÈÄªËæëÊé®ÁêÜÂíåÈïøÊñáÊú¨ÂàÜÊûê„ÄÇ',
                capabilities: ['‰ª£Á†ÅÁîüÊàê', 'ÈÄªËæëÊé®ÁêÜ', 'ÈïøÊñáÊú¨ÊëòË¶Å', 'Êï∞Â≠¶Ëß£È¢ò'],
                installCmd: 'npx -y @modelcontextprotocol/server-deepseek',
                example: '‰ΩøÁî® R1 Ê®°Âûã‰ºòÂåñËøôÊÆµ Python Áà¨Ëô´‰ª£Á†ÅÔºåÂ¢ûÂä†ÂºÇÊ≠•Âπ∂ÂèëÂíåÈîôËØØÈáçËØïÊú∫Âà∂„ÄÇ',
                envVars: ['DEEPSEEK_API_KEY']
            }
        ];

        function renderMcpMarket() {
            const container = document.querySelector('.market-list');
            if (!container) return; // Guard if tab content not ready
            
            container.innerHTML = mcpTools.map((tool, index) => `
                <div class="mcp-market-item" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px; cursor: pointer;" onclick="showMcpToolDetails(${index})">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <i class="${tool.icon}" style="font-size: 1.2rem; margin-right: 10px; color: ${tool.color};"></i>
                        <div style="font-weight: 600; font-size: 0.9rem;">${tool.name}</div>
                        <button style="margin-left: auto; background: rgba(0, 229, 255, 0.1); border: 1px solid #00E5FF; color: #00E5FF; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">ËØ¶ÊÉÖ</button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${tool.desc}
                    </div>
                </div>
            `).join('');
        }

        function showMcpToolDetails(index) {
            const tool = mcpTools[index];
            const editorArea = document.querySelector('.editor-area');
            
            // Update Title
            updateContentTitle('MCP Â∑•ÂÖ∑ËØ¶ÊÉÖ', 'fas fa-network-wired');

            const capabilitiesHtml = tool.capabilities.map(cap => 
                `<span style="display: inline-block; padding: 4px 10px; background: rgba(0, 229, 255, 0.1); border: 1px solid rgba(0, 229, 255, 0.2); border-radius: 15px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 8px; color: #00E5FF;">${cap}</span>`
            ).join('');

            const envVarsHtml = tool.envVars.length > 0 
                ? tool.envVars.map(v => `<div style="background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; color: #FFAB40; margin-bottom: 5px;">${v}</div>`).join('')
                : '<div style="color: var(--text-secondary); font-size: 0.8rem;">Êó†ÁâπÊÆäÁéØÂ¢ÉÂèòÈáèË¶ÅÊ±Ç</div>';

            editorArea.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                    <!-- Header -->
                    <div style="display: flex; align-items: center; margin-bottom: 30px;">
                        <div style="width: 80px; height: 80px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: ${tool.color}; margin-right: 25px;">
                            <i class="${tool.icon}"></i>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                <h1 style="font-size: 2rem; color: var(--text-primary); margin: 0;">${tool.name}</h1>
                                <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #00E5FF; color: black; font-weight: bold;">MCP Server</span>
                            </div>
                            <p style="font-size: 1.1rem; color: var(--text-secondary);">${tool.desc}</p>
                        </div>
                    </div>

                    <!-- Capabilities -->
                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-bolt" style="margin-right: 8px; color: #FFCA28;"></i>Ê†∏ÂøÉËÉΩÂäõ</h3>
                        <div style="display: flex; flex-wrap: wrap;">
                            ${capabilitiesHtml}
                        </div>
                    </div>

                    <!-- Installation & Config -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; border: 1px solid var(--border);">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-download" style="margin-right: 8px; color: #4CAF50;"></i>ÂÆâË£ÖÂëΩ‰ª§</h3>
                            <div style="background: #111; padding: 15px; border-radius: 8px; font-family: monospace; color: #ccc; border: 1px solid #333; position: relative;">
                                ${tool.installCmd}
                                <button onclick="copyToClipboard('${tool.installCmd}')" style="position: absolute; right: 10px; top: 10px; background: transparent; border: none; color: #666; cursor: pointer;">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; border: 1px solid var(--border);">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-key" style="margin-right: 8px; color: #FF5722;"></i>ÊâÄÈúÄÈÖçÁΩÆ</h3>
                            ${envVarsHtml}
                        </div>
                    </div>

                    <!-- Usage Example -->
                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-comment-dots" style="margin-right: 8px; color: #29B6F6;"></i>ËØï‰∏ÄËØï</h3>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; color: var(--text-secondary); font-family: monospace; margin-bottom: 15px;">
                            "${tool.example}"
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="executeTask('${tool.example}')" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: opacity 0.2s; flex: 1;">
                                <i class="fas fa-play" style="margin-right: 8px;"></i> Ê®°ÊãüÊâßË°å
                            </button>
                            <button onclick="showAddMcpModal()" style="padding: 10px 20px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600; transition: opacity 0.2s;">
                                <i class="fas fa-plug" style="margin-right: 8px;"></i> ÈÖçÁΩÆËøûÊé•
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // MCP Logic
        function switchMcpTab(tabName) {
            const tabs = document.querySelectorAll('.mcp-tab');
            tabs.forEach(t => {
                t.style.borderBottom = '2px solid transparent';
                t.style.color = 'var(--text-secondary)';
            });
            
            // Highlight active tab
            const activeTab = Array.from(tabs).find(t => t.getAttribute('onclick').includes(tabName));
            if (activeTab) {
                activeTab.style.borderBottom = '2px solid #00E5FF';
                activeTab.style.color = 'var(--text-primary)';
            }
            
            const installedTab = document.getElementById('mcp-tab-installed');
            const marketTab = document.getElementById('mcp-tab-market');
            if (installedTab) installedTab.style.display = tabName === 'installed' ? 'block' : 'none';
            if (marketTab) {
                marketTab.style.display = tabName === 'market' ? 'block' : 'none';
                if (tabName === 'market') renderMcpMarket(); // Render when showing
            }
        }

        function toggleMcpServer(checkbox) {
            const statusText = document.getElementById('mcp-server-status');
            const connectInfo = document.getElementById('mcp-connect-info');
            
            if (checkbox.checked) {
                if (statusText) {
                    statusText.innerHTML = '<i class="fas fa-circle" style="font-size: 6px; margin-right: 4px; color: #00E5FF; box-shadow: 0 0 5px #00E5FF;"></i> ËøêË°å‰∏≠ (Port: 8080)';
                    statusText.style.color = '#00E5FF';
                }
                if (connectInfo) connectInfo.style.display = 'block';
                addChatMessage('system', 'AgentDesk MCP Server Â∑≤ÂêØÂä®ÔºåÂ§ñÈÉ®Â∫îÁî®Áé∞Âú®ÂèØ‰ª•ËøûÊé•Âà∞Êú¨Â∑•‰ΩúÂè∞„ÄÇ');
            } else {
                if (statusText) {
                    statusText.innerHTML = '<i class="fas fa-circle" style="font-size: 6px; margin-right: 4px; color: #666;"></i> Êú™ÂêØÂä®';
                    statusText.style.color = 'var(--text-secondary)';
                }
                if (connectInfo) connectInfo.style.display = 'none';
            }
        }
        
        function showAddMcpModal() {
            const url = prompt("ËØ∑ËæìÂÖ• MCP Server ËøûÊé•Âú∞ÂùÄÊàñÂëΩ‰ª§:", "npx -y @modelcontextprotocol/server-filesystem");
            if (url) {
                alert("ËøûÊé•ËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ (Ê®°Êãü): " + url);
            }
        }

        // ÂàáÊç¢Âà∞ NotebookLMÔºàÂú®‰∏ªÁ™óÂè£ÊòæÁ§∫ iframeÔºâ
        function switchToNotebookLM() {
            // È´ò‰∫ÆÊ¥ªÂä®Ê†èÂõæÊ†á
            document.querySelectorAll('.activity-item').forEach(item => item.classList.remove('active'));
            document.getElementById('activity-notebooklm').classList.add('active');
            
            // ÈöêËóèÊâÄÊúâ‰æßËæπÊ†èÈù¢Êùø
            document.querySelectorAll('.sidebar-panel').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            
            // Âú®‰∏ªÁ™óÂè£ÊòæÁ§∫ NotebookLM iframe
            const centerPanel = document.getElementById('centerPanel');
            centerPanel.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-tertiary);">
                    <div style="padding: 15px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-brain" style="color: #9C27B0; font-size: 24px;"></i>
                            <div>
                                <h3 style="margin: 0; color: var(--text-primary); font-size: 18px;">NotebookLM Pro</h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 12px;">PDF ÊñáÊ°£Ê∑±Â∫¶ÂàÜÊûê‰∏ìÂÆ∂ | Docker Áã¨Á´ãËøêË°å</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="color: var(--text-secondary); font-size: 12px;">
                                <i class="fas fa-circle" style="color: #FFC107; font-size: 8px; margin-right: 5px;"></i>
                                Êú™ËøûÊé•
                            </span>
                            <button onclick="connectNotebookLM('http://localhost:8502/Notebooks')" style="padding: 6px 12px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-plug"></i> ËøûÊé•
                            </button>
                            <button onclick="openNotebookLMNewTab()" style="padding: 6px 12px; background: #555; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-external-link-alt"></i> Êñ∞Á™óÂè£
                            </button>
                        </div>
                    </div>
                    <div id="notebooklm-loading" style="flex: 1; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary);">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #9C27B0; margin-bottom: 20px;"></i>
                            <p style="color: var(--text-secondary); font-size: 16px;">Ê≠£Âú®Âä†ËΩΩ NotebookLM...</p>
                        </div>
                    </div>
                    <iframe 
                        id="notebooklm-iframe" 
                        src="about:blank" 
                        style="flex: 1; width: 100%; border: none; background: white; display: none;"
                        onload="hideNotebookLMLoading()"
                    ></iframe>
                </div>
            `;
        }
        
        // Âà∑Êñ∞ NotebookLM iframe
        function connectNotebookLM(url) {
            const iframe = document.getElementById('notebooklm-iframe');
            const loading = document.getElementById('notebooklm-loading');
            if (iframe && loading) {
                loading.style.display = 'flex';
                iframe.style.display = 'none';
                iframe.src = url;
            }
        }
        
        // Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ NotebookLM
        function openNotebookLMNewTab() {
            window.open('http://localhost:8502/Notebooks', '_blank');
        }
        
        // ÈöêËóèÂä†ËΩΩÂä®Áîª
        function hideNotebookLMLoading() {
            const loading = document.getElementById('notebooklm-loading');
            const iframe = document.getElementById('notebooklm-iframe');
            if (loading && iframe) {
                loading.style.display = 'none';
                iframe.style.display = 'block';
            }
        }

        // ÊäòÂè†/Â±ïÂºÄ‰æßËæπÊ†è
        function toggleSidebar(side) {
            if (side === 'left') {
                const sidebar = document.getElementById('leftSidebar');
                sidebar.classList.toggle('collapsed');
                
                // Êõ¥Êñ∞ÊâÄÊúâÂ∑¶‰æßÈù¢ÊùøÁöÑÊäòÂè†ÊåâÈíÆÂõæÊ†á
                const buttons = sidebar.querySelectorAll('.collapse-btn');
                buttons.forEach(btn => {
                    if (sidebar.classList.contains('collapsed')) {
                        btn.classList.remove('fa-angle-left');
                        btn.classList.add('fa-angle-right');
                        btn.setAttribute('title', 'Â±ïÂºÄ');
                    } else {
                        btn.classList.remove('fa-angle-right');
                        btn.classList.add('fa-angle-left');
                        btn.setAttribute('title', 'ÊäòÂè†');
                    }
                });
            } else if (side === 'right') {
                const panel = document.getElementById('rightPanel');
                panel.classList.toggle('collapsed');
                
                // Êõ¥Êñ∞Âè≥‰æßÈù¢ÊùøÁöÑÊäòÂè†ÊåâÈíÆÂõæÊ†á
                const btn = panel.querySelector('.collapse-btn');
                if (panel.classList.contains('collapsed')) {
                    btn.classList.remove('fa-angle-right');
                    btn.classList.add('fa-angle-left');
                    btn.setAttribute('title', 'Â±ïÂºÄ');
                } else {
                    btn.classList.remove('fa-angle-left');
                    btn.classList.add('fa-angle-right');
                    btn.setAttribute('title', 'ÊäòÂè†');
                }
            }
            
            updateGlobalControlButtons();
        }
        
        // ÊäòÂè†/Â±ïÂºÄÂÜÖÂÆπÂå∫
        function toggleContentArea() {
            const editorArea = document.getElementById('editorArea');
            const icon = document.getElementById('contentAreaToggleIcon');
            
            editorArea.classList.toggle('collapsed');
            
            if (editorArea.classList.contains('collapsed')) {
                icon.classList.remove('fa-angle-down');
                icon.classList.add('fa-angle-up');
            } else {
                icon.classList.remove('fa-angle-up');
                icon.classList.add('fa-angle-down');
            }
        }
        
        // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫Ê†áÈ¢ò
        function updateContentTitle(title, icon = 'fas fa-comments') {
            const titleText = document.getElementById('content-title-text');
            // Use content-status-indicator as the tab container
            const titleTab = document.getElementById('content-status-indicator') || document.getElementById('content-title-tab');
            
            if (titleText) titleText.textContent = title;
            
            if (titleTab) {
                const iconElement = titleTab.querySelector('i');
                if (iconElement) iconElement.className = icon;
            }
        }

        // ÂàáÊç¢‰∏ªËßÜÂõæ (ÁºñËæëÂô® vs Êô∫ËÉΩ‰ΩìÁîªÂ∏É)
        function switchMainView(view) {
            const canvasArea = document.getElementById('canvasArea');
            const btnEditor = document.getElementById('view-btn-editor');
            const btnCanvas = document.getElementById('view-btn-canvas');
            
            if (view === 'canvas') {
                canvasArea.classList.add('active');
                
                // Update buttons
                btnEditor.style.background = 'transparent';
                btnEditor.style.color = 'var(--text-secondary)';
                btnEditor.style.fontWeight = 'normal';
                btnEditor.style.borderBottom = '2px solid transparent';

                btnCanvas.style.background = 'var(--bg-tertiary)'; // Slight bg for active tab
                btnCanvas.style.color = 'var(--primary)';
                btnCanvas.style.fontWeight = 'bold';
                btnCanvas.style.borderBottom = '2px solid var(--primary)';
                
                // Resize canvas
                setTimeout(() => {
                    resizeCanvas();
                    renderAgents();
                }, 50);
            } else {
                canvasArea.classList.remove('active');
                
                // Update buttons
                btnEditor.style.background = 'var(--bg-tertiary)';
                btnEditor.style.color = 'var(--primary)';
                btnEditor.style.fontWeight = 'bold';
                btnEditor.style.borderBottom = '2px solid var(--primary)';

                btnCanvas.style.background = 'transparent';
                btnCanvas.style.color = 'var(--text-secondary)';
                btnCanvas.style.fontWeight = 'normal';
                btnCanvas.style.borderBottom = '2px solid transparent';
            }
        }

        // ÂÖºÂÆπÊóßÁöÑ toggleCanvas ÂáΩÊï∞ (Áé∞Âú®Êò†Â∞ÑÂà∞ switchMainView)
        function toggleCanvas() {
             const canvasArea = document.getElementById('canvasArea');
             if (canvasArea.classList.contains('active')) {
                 switchMainView('editor');
             } else {
                 switchMainView('canvas');
             }
        }

        // ÊäòÂè†/Â±ïÂºÄÊâÄÊúâÈù¢Êùø (Updated Logic)
        let allPanelsCollapsed = false;
        function toggleAllPanels() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightPanel = document.getElementById('rightPanel');
            const icon = document.getElementById('expandAllIcon');
            
            allPanelsCollapsed = !allPanelsCollapsed;
            
            if (allPanelsCollapsed) {
                // ÂÖ®ÈÉ®ÊäòÂè†
                if (!leftSidebar.classList.contains('collapsed')) toggleSidebar('left');
                if (!rightPanel.classList.contains('collapsed')) toggleSidebar('right');
                
                icon.classList.remove('fa-expand-arrows-alt');
                icon.classList.add('fa-compress-arrows-alt');
            } else {
                // ÂÖ®ÈÉ®Â±ïÂºÄ
                if (leftSidebar.classList.contains('collapsed')) toggleSidebar('left');
                if (rightPanel.classList.contains('collapsed')) toggleSidebar('right');
                
                icon.classList.remove('fa-compress-arrows-alt');
                icon.classList.add('fa-expand-arrows-alt');
            }
        }

        // Êõ¥Êñ∞ÂÖ®Â±ÄÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅ
        function updateGlobalControlButtons() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightPanel = document.getElementById('rightPanel');
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈù¢ÊùøÈÉΩÊäòÂè†‰∫Ü
            const allCollapsed = leftSidebar.classList.contains('collapsed') && 
                                 rightPanel.classList.contains('collapsed');
            
            allPanelsCollapsed = allCollapsed;
            const icon = document.getElementById('expandAllIcon');
            if (allCollapsed) {
                icon.classList.remove('fa-expand-arrows-alt');
                icon.classList.add('fa-compress-arrows-alt');
            } else {
                icon.classList.remove('fa-compress-arrows-alt');
                icon.classList.add('fa-expand-arrows-alt');
            }
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + B: ÂàáÊç¢Â∑¶‰æßÊ†è
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleSidebar('left');
            }
            // Ctrl/Cmd + J: ÂàáÊç¢Â∫ïÈÉ®ÁîªÂ∏É
            if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
                e.preventDefault();
                toggleCanvas();
            }
            
            // Ctrl/Cmd + E: ÂàáÊç¢ÂÜÖÂÆπÂå∫
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                toggleContentArea();
            }
        });

        // ==================== Market Logic ====================
        let marketAgents = [];

        function buildMarketAgents() {
            // Map backend agents to market cards
            const coreAgents = (agents || []).map(a => ({
                id: a.id,
                name: a.name,
                desc: a.desc || a.role,
                icon: a.emoji,
                color: a.color || '#FF6B00',
                subscribed: false,
                capabilities: a.capabilities || [a.role],
                example: a.example || `@${a.name} ‰Ω†Â•Ω`
            }));

            // Keep external tool as a separate item
            const notebooklm = {
                name: 'NotebookLM',
                desc: 'PDF ÊñáÊ°£Ê∑±Â∫¶ÂàÜÊûê‰∏éÊí≠ÂÆ¢ÁîüÊàê',
                icon: 'fas fa-podcast',
                color: '#E91E63',
                subscribed: false,
                capabilities: ['Ê∑±Â∫¶ÊñáÊ°£ÂàÜÊûê', 'Âèå‰∫∫ÂØπËØùÊí≠ÂÆ¢', '13ÁßçËØ≠Ë®Ä', 'Êô∫ËÉΩËß£ËØª', 'MP3ÂØºÂá∫'],
                example: 'Â∞ÜËøô‰ªΩÊäïËµÑÊä•ÂëäËΩ¨Êç¢‰∏∫Êí≠ÂÆ¢ÔºåÁî®ËΩªÊùæÁöÑÊñπÂºèËÆ≤Ëß£Ê†∏ÂøÉËßÇÁÇπ„ÄÇ',
                externalUrl: 'http://localhost:7860',
                isExternal: true,
                activityBarId: 'activity-notebooklm',
                panelId: 'notebooklm'
            };

            marketAgents = [...coreAgents, notebooklm];
        }

        function renderMarket() {
            const container = document.getElementById('market-list');
            const scenario = WorkflowManager.currentScenario;
            let list = marketAgents;
            if (scenario !== 'all') {
                const allowed = WorkflowManager.scenarios[scenario].agentIds;
                list = marketAgents.filter(a => !a.id || allowed.includes(a.id));
            }

            const toolbar = `
                <div style="display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border);">
                    ${['all','investment','compliance','operations'].map(s => `
                        <button onclick="WorkflowManager.setScenario('${s}'); renderMarket();" 
                                style="padding: 6px 12px; border-radius: 16px; border: 1px solid var(--border); background: ${scenario===s?'var(--primary)':'var(--bg-secondary)'}; color: ${scenario===s?'white':'var(--text-primary)'};">
                            ${s==='all'?'ÂÖ®ÈÉ®':WorkflowManager.scenarios[s].name}
                        </button>
                    `).join('')}
                </div>
            `;

            const items = list.map((agent, index) => `
                <div class="market-item" onclick="showAgentDetails(${index})">
                    <div class="market-icon" style="color: ${agent.color}; background: ${agent.color}15;">
                        <i class="${agent.icon}"></i>
                    </div>
                    <div class="market-info">
                        <div class="market-name">${agent.name}</div>
                        <div class="market-desc">${agent.desc}</div>
                    </div>
                    <button class="market-btn ${agent.subscribed ? 'subscribed' : ''}" 
                            onclick="event.stopPropagation(); toggleSubscribe(this, ${index})"
                            onmouseover="${agent.subscribed ? "this.innerText='ÈÄÄËÆ¢'" : ""}"
                            onmouseout="${agent.subscribed ? "this.innerText='Â∑≤ËÆ¢ÈòÖ'" : ""}">
                        ${agent.subscribed ? 'Â∑≤ËÆ¢ÈòÖ' : 'Ëé∑Âèñ'}
                    </button>
                </div>
            `).join('');

            container.innerHTML = toolbar + items;
        }

        function showAgentDetails(index) {
            const agent = marketAgents[index];
            const editorArea = document.querySelector('.editor-area');
            
            // Â¶ÇÊûúÊòØÂ§ñÈÉ®Â∑•ÂÖ∑ÔºåÊòæÁ§∫ÁâπÊÆäÁïåÈù¢
            if (agent.isExternal) {
                editorArea.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 30px;">
                            <div style="width: 80px; height: 80px; border-radius: 20px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: ${agent.color}; margin-right: 25px;">
                                <i class="${agent.icon}"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 2rem; margin-bottom: 10px; color: var(--text-primary);">${agent.name}</h1>
                                <p style="font-size: 1.1rem; color: var(--text-secondary);">${agent.desc}</p>
                            </div>
                        </div>

                        <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                            <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-bolt" style="margin-right: 8px;"></i>Ê†∏ÂøÉËÉΩÂäõ</h3>
                            <div style="display: flex; flex-wrap: wrap;">
                                ${agent.capabilities.map(cap => 
                                    `<span style="display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 8px; color: var(--text-primary);">${cap}</span>`
                                ).join('')}
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, ${agent.color}20, ${agent.color}10); border-radius: 16px; padding: 30px; margin-bottom: 30px; border: 2px solid ${agent.color}40; text-align: center;">
                            <i class="fas fa-external-link-alt" style="font-size: 3rem; color: ${agent.color}; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">üéôÔ∏è Open NotebookLM</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">
                                ËøôÊòØ‰∏Ä‰∏™Áã¨Á´ãÁöÑ Web Â∫îÁî®ÔºåÈúÄË¶ÅÂçïÁã¨ÂêØÂä®„ÄÇ<br>
                                Â∞Ü PDF ÊñáÊ°£ËΩ¨Êç¢‰∏∫‰∏ì‰∏öÁöÑÊí≠ÂÆ¢Èü≥È¢ë„ÄÇ
                            </p>
                            
                            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                                <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-rocket" style="margin-right: 8px;"></i>ÂêØÂä®Ê≠•È™§Ôºö</h4>
                                <ol style="color: var(--text-secondary); line-height: 2; padding-left: 20px;">
                                    <li>ÊâìÂºÄÁªàÁ´ØÔºåËøõÂÖ•È°πÁõÆÁõÆÂΩï</li>
                                    <li>ËøêË°å: <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; color: var(--primary);">cd open-notebooklm && ./start.sh</code></li>
                                    <li>ÈÖçÁΩÆ Fireworks AI API ÂØÜÈí•ÔºàÈ¶ñÊ¨°‰ΩøÁî®Ôºâ</li>
                                    <li>ËÆøÈóÆ: <a href="${agent.externalUrl}" target="_blank" style="color: var(--primary); text-decoration: underline;">${agent.externalUrl}</a></li>
                                </ol>
                            </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="window.open('${agent.externalUrl}', '_blank')" 
                                    style="flex: 1; padding: 12px 20px; background: ${agent.color}; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 1rem; transition: opacity 0.2s;">
                                    <i class="fas fa-external-link-alt" style="margin-right: 8px;"></i> Êñ∞Á™óÂè£ÊâìÂºÄ
                            </button>
                            <button onclick="switchSidebar('${agent.panelId}'); event.stopPropagation();" 
                                    style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, ${agent.color}, ${agent.color}CC); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 1rem; transition: opacity 0.2s;">
                                    <i class="fas fa-sidebar" style="margin-right: 8px;"></i> ‰æßËæπÊ†èÊâìÂºÄ
                            </button>
                        </div>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 15px;">
                                üìñ <a href="docs/OPEN_NOTEBOOKLM_GUIDE.md" target="_blank" style="color: var(--primary);">Êü•ÁúãÂÆåÊï¥‰ΩøÁî®ÊåáÂçó</a>
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            // Highlight selected item
            document.querySelectorAll('.market-item').forEach((el, i) => {
                if (i === index) el.style.background = 'rgba(255, 255, 255, 0.05)';
                else el.style.background = 'transparent';
            });

            const capabilitiesHtml = agent.capabilities.map(cap =>
                `<span style="display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 8px; color: var(--text-primary);">${cap}</span>`
            ).join('');

            if (agent.id === 'image_generator') {
                editorArea.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 24px;">
                            <div style="width: 72px; height: 72px; border-radius: 18px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: ${agent.color}; margin-right: 20px;">
                                <i class="${agent.icon}"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 1.8rem; margin-bottom: 6px; color: var(--text-primary);">${agent.name}</h1>
                                <p style="font-size: 1rem; color: var(--text-secondary);">${agent.desc}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">ÊèêÁ§∫ËØç</label>
                                <textarea id="imggen-prompt" rows="4" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">${agent.example}</textarea>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                    <label style="color: var(--text-secondary); font-size: 0.9rem;">Ê®°Âûã</label>
                                    <select id="imggen-model" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                                        <option value="gemini-2.5-flash-image">gemini-2.5-flash-image</option>
                                        <option value="gemini-3-pro-image-preview" selected>gemini-3-pro-image-preview</option>
                                    </select>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                    <label style="color: var(--text-secondary); font-size: 0.9rem;">Â∞∫ÂØ∏</label>
                                    <select id="imggen-size" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                                        <option value="512x512">512x512</option>
                                        <option value="768x768">768x768</option>
                                        <option value="1024x1024" selected>1024x1024</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button onclick="runImageGenerator()" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-images" style="margin-right: 8px;"></i> ÁîüÊàêÂõæÁâá
                                </button>
                                <button onclick="executeTask(document.getElementById('imggen-prompt').value, getAgentIdByName('${agent.name}'))" style="padding: 10px 20px; background: #555; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-comments" style="margin-right: 8px;"></i> ÈÄöËøáËÅäÂ§©ÊâßË°å
                                </button>
                            </div>

                            <div id="imggen-result" style="min-height: 200px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center; color: var(--text-secondary);">
                                ÁîüÊàêÁªìÊûúÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (agent.id === 'drawing_agent') {
                editorArea.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 24px;">
                            <div style="width: 72px; height: 72px; border-radius: 18px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: ${agent.color}; margin-right: 20px;">
                                <i class="${agent.icon}"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 1.8rem; margin-bottom: 6px; color: var(--text-primary);">${agent.name}</h1>
                                <p style="font-size: 1rem; color: var(--text-secondary);">${agent.desc}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">ÊèêÁ§∫ËØç</label>
                                <textarea id="draw-prompt" rows="4" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">${agent.example}</textarea>
                            </div>

                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">ÈÄâÊã©ÁªòÁîªÂ∑•ÂÖ∑ÔºàÂèØÂ§öÈÄâÔºâ</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-mermaid"> Mermaid</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-plantuml"> PlantUML</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-nanobanana"> Nano Banana</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-excalidraw"> Excalidraw</label>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 8px;">Êú™ÈÄâÊã©Êó∂Áî± LLM Ëá™Âä®ÈÄâÊã©</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button onclick="runDrawingGenerator()" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-palette" style="margin-right: 8px;"></i> ÁîüÊàêÂõæÁâá
                                </button>
                            </div>

                            <div id="draw-result" style="min-height: 200px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center; color: var(--text-secondary);">
                                ÁîüÊàêÁªìÊûúÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            editorArea.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 30px;">
                        <div style="width: 80px; height: 80px; border-radius: 20px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: ${agent.color}; margin-right: 25px;">
                            <i class="${agent.icon}"></i>
                        </div>
                        <div>
                            <h1 style="font-size: 2rem; margin-bottom: 10px; color: var(--text-primary);">${agent.name}</h1>
                            <p style="font-size: 1.1rem; color: var(--text-secondary);">${agent.desc}</p>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-bolt" style="margin-right: 8px;"></i>Ê†∏ÂøÉËÉΩÂäõ</h3>
                        <div style="display: flex; flex-wrap: wrap;">
                            ${capabilitiesHtml}
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-comment-dots" style="margin-right: 8px;"></i>ËØï‰∏ÄËØï</h3>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; color: var(--text-secondary); font-family: monospace; margin-bottom: 15px;">
                            "${agent.example}"
                        </div>
                        <button onclick="executeTask('${agent.example}', getAgentIdByName('${agent.name}'))" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: opacity 0.2s;">
                            <i class="fas fa-play" style="margin-right: 8px;"></i> Á´ãÂç≥ËøêË°å
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleSubscribe(btn, index) {
            const agent = marketAgents[index];
            agent.subscribed = !agent.subscribed;

            // Visual feedback
            if (agent.subscribed) {
                addChatMessage('system', `Â∑≤ËÆ¢ÈòÖÊô∫ËÉΩ‰Ωì: ${agent.name}`);
                
                // Â¶ÇÊûúÊòØÂ§ñÈÉ®Â∑•ÂÖ∑ÔºåÊ∑ªÂä†Âà∞Ê¥ªÂä®Ê†è
                if (agent.isExternal && agent.activityBarId) {
                    addToActivityBar(agent);
                }
            } else {
                addChatMessage('system', `Â∑≤ÈÄÄËÆ¢Êô∫ËÉΩ‰Ωì: ${agent.name}`);
                
                // Â¶ÇÊûúÊòØÂ§ñÈÉ®Â∑•ÂÖ∑Ôºå‰ªéÊ¥ªÂä®Ê†èÁßªÈô§
                if (agent.isExternal && agent.activityBarId) {
                    removeFromActivityBar(agent.activityBarId);
                }
            }

            renderMarket();
        }
        
        // Ê∑ªÂä†Êô∫ËÉΩ‰ΩìÂà∞Ê¥ªÂä®Ê†è
        function addToActivityBar(agent) {
            const container = document.getElementById('subscribed-agents-bar');
            if (!container) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if (document.getElementById(agent.activityBarId)) {
                return;
            }
            
            // ÂàõÂª∫Ê¥ªÂä®Ê†èÂõæÊ†á
            const activityItem = document.createElement('div');
            activityItem.id = agent.activityBarId;
            activityItem.className = 'activity-item';
            activityItem.title = agent.name;
            activityItem.onclick = () => switchSidebar(agent.panelId);
            activityItem.innerHTML = `<i class="${agent.icon}" style="color: ${agent.color};"></i>`;
            
            container.appendChild(activityItem);
            
            // ÊòæÁ§∫ÊèêÁ§∫
            setTimeout(() => {
                activityItem.style.animation = 'bounce 0.5s ease';
            }, 100);
        }
        
        // ‰ªéÊ¥ªÂä®Ê†èÁßªÈô§Êô∫ËÉΩ‰Ωì
        function removeFromActivityBar(activityBarId) {
            const element = document.getElementById(activityBarId);
            if (element) {
                element.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => element.remove(), 300);
            }
        }

        // ==================== Landing Page Logic ====================
        function renderLandingAgents() {
            const container = document.getElementById('landing-agents');
            // Use top 5 agents or all
            const agentsToShow = marketAgents;

            container.innerHTML = agentsToShow.map((agent, index) => `
                <div class="landing-agent-item" onclick="selectLandingAgent(${index})">
                    <div class="landing-agent-avatar" style="color: ${agent.color}; background: ${agent.color}15;">
                        <i class="${agent.icon}"></i>
                    </div>
                    <div class="landing-agent-name">${agent.name}</div>
                </div>
            `).join('');
        }

        function selectLandingAgent(index) {
            const agent = marketAgents[index];

            // 1. Enter Workspace
            enterWorkspace();

            // 2. Simulate Agent Greeting
            setTimeout(() => {
                const greeting = `‰Ω†Â•ΩÔºÅÊàëÊòØ**${agent.name}**„ÄÇ\n${agent.desc}„ÄÇ\n\nÊàëÂèØ‰ª•Â∏Æ‰Ω†Ôºö\n${agent.capabilities.map(c => `- ${c}`).join('\n')}`;
                addChatMessage('agent', greeting, agent.name);

                // Optional: Open their details panel too?
                // showAgentDetails(index); 
            }, 600);
        }
        // Scenario Selection
        function selectScenario(card, type) {
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');

            WorkflowManager.setScenario(type);
        }

        // ==================== Resource Manager Logic ====================
        async function loadFiles() {
            const container = document.getElementById('file-list-container');
            // Don't wipe if it's just a refresh, maybe show a spinner overlay? 
            // For now simple is fine.
            container.innerHTML = '<div style="padding: 10px 20px; color: #666; font-size: 0.8rem;">Âä†ËΩΩ‰∏≠...</div>';

            try {
                const response = await fetch('/api/files');
                const data = await response.json();

                if (data.success) {
                    renderFiles(data.files);
                } else {
                    container.innerHTML = '<div style="padding: 10px 20px; color: #ff4444; font-size: 0.8rem;">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="padding: 10px 20px; color: #ff4444; font-size: 0.8rem;">ÁΩëÁªúÈîôËØØ</div>';
            }
        }

        function renderFiles(files) {
            const container = document.getElementById('file-list-container');
            if (files.length === 0) {
                container.innerHTML = '<div style="padding: 10px 20px; color: #666; font-size: 0.8rem;">ÊöÇÊó†Êñá‰ª∂</div>';
                return;
            }

            let html = '';
            files.forEach(file => {
                const iconClass = getFileIcon(file.type);
                const iconColor = getFileIconColor(file.type);

                html += `
                    <div class="file-item" onclick="previewFile('${file.name}')">
                        <i class="${iconClass}" style="color: ${iconColor};"></i>
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</span>
                        <i class="fas fa-trash" style="font-size: 0.7rem; color: #666; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s;" 
                           onclick="event.stopPropagation(); deleteFile('${file.name}')" 
                           onmouseover="this.style.opacity=1" 
                           onmouseout="this.style.opacity=0.5"
                           title="Âà†Èô§"></i>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'fas fa-file-pdf';
            if (type.includes('doc')) return 'fas fa-file-word';
            if (type.includes('xls') || type.includes('csv')) return 'fas fa-file-excel';
            if (type.includes('py') || type.includes('js') || type.includes('html')) return 'fas fa-file-code';
            if (type.includes('md') || type.includes('txt')) return 'fas fa-file-alt';
            if (type.includes('json')) return 'fas fa-file-code';
            return 'fas fa-file';
        }

        function getFileIconColor(type) {
            if (type.includes('pdf')) return '#E57373';
            if (type.includes('doc')) return '#42A5F5';
            if (type.includes('xls') || type.includes('csv')) return '#66BB6A';
            if (type.includes('py') || type.includes('js')) return '#FFCA28';
            if (type.includes('md')) return '#AB47BC';
            return '#A0A0A0';
        }

        async function deleteFile(filename) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ ${filename} ÂêóÔºü`)) return;

            try {
                const response = await fetch(`/api/files/${filename}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadFiles(); // Reload list
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + result.error);
                }
            } catch (e) {
                alert('Âà†Èô§Âá∫Èîô');
            }
        }

        async function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);

                // Show uploading state
                const container = document.getElementById('file-list-container');
                const originalContent = container.innerHTML;
                container.innerHTML = '<div style="padding: 10px 20px; color: #666; font-size: 0.8rem;"><i class="fas fa-spinner fa-spin"></i> ‰∏ä‰º†‰∏≠...</div>';

                try {
                    const response = await fetch('/api/upload/simple', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        loadFiles(); // Reload list
                    } else {
                        alert('‰∏ä‰º†Â§±Ë¥•: ' + result.error);
                        container.innerHTML = originalContent;
                    }
                } catch (e) {
                    console.error(e);
                    alert('‰∏ä‰º†Âá∫Èîô');
                    container.innerHTML = originalContent;
                }

                // Reset input
                input.value = '';
            }
        }

        async function previewFile(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const textExtensions = ['txt', 'md', 'py', 'js', 'json', 'html', 'css', 'csv', 'log'];
            const editorArea = document.querySelector('.editor-area');
            const encodedFilename = encodeURIComponent(filename);

            // Set current active file
            currentActiveFile = filename;

            // Show loading
            editorArea.innerHTML = '<div style="padding: 20px; color: #666;">Âä†ËΩΩ‰∏≠...</div>';
            updateContentTitle(filename, 'fas fa-file-alt');

            // 1. Text based files
            if (textExtensions.includes(ext)) {
                try {
                    const response = await fetch(`/download/${encodedFilename}`);
                    if (response.ok) {
                        const text = await response.text();
                        
                        let contentHtml = '';
                        if (ext === 'md') {
                             contentHtml = text
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                                .replace(/## (.*?)\n/g, '<h2>$1</h2>')
                                .replace(/# (.*?)\n/g, '<h1>$1</h1>')
                                .replace(/\n/g, '<br>');
                        } else {
                            contentHtml = `<pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow: auto; font-family: monospace; color: #ccc; white-space: pre-wrap;">${escapeHtml(text)}</pre>`;
                        }
                        
                        renderPreviewContainer(editorArea, filename, contentHtml);
                    } else {
                        renderError(editorArea, filename, "Êó†Ê≥ïËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ");
                    }
                } catch (e) {
                    renderError(editorArea, filename, "ËØªÂèñÂá∫Èîô");
                }
            } 
            // 2. PDF files
            else if (ext === 'pdf') {
                 const pdfUrl = `/download/${encodedFilename}?preview=true`;
                 const contentHtml = `
                    <iframe src="${pdfUrl}" style="width: 100%; height: calc(100vh - 200px); border: none; border-radius: 8px; background: #333;"></iframe>
                 `;
                 renderPreviewContainer(editorArea, filename, contentHtml);
            }
            // 3. Word files (docx)
            else if (ext === 'docx') {
                try {
                    const response = await fetch(`/download/${encodedFilename}`);
                    if (!response.ok) throw new Error('Fetch failed');
                    
                    const arrayBuffer = await response.arrayBuffer();
                    
                    if (typeof mammoth === 'undefined') {
                         throw new Error('Mammoth library not loaded');
                    }

                    mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                        .then(function(result){
                            const html = result.value; // The generated HTML
                            const messages = result.messages; // Any messages, such as warnings during conversion
                            
                            const contentHtml = `
                                <div class="docx-preview" style="background: white; color: black; padding: 40px; border-radius: 8px; overflow-y: auto; height: calc(100vh - 200px);">
                                    ${html}
                                </div>
                            `;
                            renderPreviewContainer(editorArea, filename, contentHtml);
                        })
                        .catch(function(error) {
                            console.error(error);
                            renderError(editorArea, filename, "Word ÊñáÊ°£Ëß£ÊûêÂ§±Ë¥•: " + error.message);
                        });
                } catch(e) {
                    console.error(e);
                    renderError(editorArea, filename, "Âä†ËΩΩ Word ÊñáÊ°£Â§±Ë¥•: " + e.message);
                }
            }
            // 4. Excel files (xlsx, xls)
            else if (ext === 'xlsx' || ext === 'xls') {
                try {
                    const response = await fetch(`/download/${encodedFilename}`);
                    if (!response.ok) throw new Error('Fetch failed');

                    const arrayBuffer = await response.arrayBuffer();
                    
                    if (typeof XLSX === 'undefined') {
                        throw new Error('XLSX library not loaded');
                    }

                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const html = XLSX.utils.sheet_to_html(worksheet);
                    
                    const contentHtml = `
                        <div class="excel-preview" style="background: white; color: black; padding: 20px; border-radius: 8px; overflow: auto; height: calc(100vh - 200px);">
                            <style>
                                .excel-preview table { border-collapse: collapse; width: 100%; }
                                .excel-preview td, .excel-preview th { border: 1px solid #ccc; padding: 4px 8px; font-size: 12px; }
                            </style>
                            ${html}
                        </div>
                    `;
                    renderPreviewContainer(editorArea, filename, contentHtml);
                } catch(e) {
                    console.error(e);
                    renderError(editorArea, filename, "Excel ÊñáÊ°£Ëß£ÊûêÂ§±Ë¥•: " + e.message);
                }
            }
            // 5. Unsupported
            else {
                renderUnsupported(editorArea, filename);
            }
        }
        
        function renderPreviewContainer(container, filename, content) {
             container.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.8rem; color: var(--primary); text-transform: uppercase;">FILE PREVIEW</span>
                        <h1 style="margin-top: 5px;">${filename}</h1>
                    </div>
                    <button onclick="resetWelcomeScreen()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 5px;" title="ÂÖ≥Èó≠È¢ÑËßà">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="line-height: 1.8; color: var(--text-primary); height: 100%;">
                    ${content}
                </div>
             `;
        }
        
        function renderError(container, filename, msg) {
             container.innerHTML = `
                <div style="padding: 20px; color: #ff4444; display: flex; justify-content: space-between; align-items: center;">
                    <span>${msg}</span>
                    <button onclick="resetWelcomeScreen()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
        }
        
        function renderUnsupported(container, filename) {
            container.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <div style="padding: 10px; text-align: right;">
                        <button onclick="resetWelcomeScreen()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666;">
                        <i class="fas fa-file" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">${filename}</div>
                        <p>Ê≠§Êñá‰ª∂‰∏çÊîØÊåÅÂú®Á∫øÈ¢ÑËßà</p>
                        <a href="/download/${filename}" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: inline-block;">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩÊñá‰ª∂
                        </a>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        // ==================== @ Mention Logic ====================
        const mentionDropdown = document.getElementById('mentionDropdown');
        let mentionIndex = -1;

        if (chatInput) {
            chatInput.addEventListener('input', function (e) {
                const value = this.value;
                const cursorPos = this.selectionStart;
                const lastAtPos = value.lastIndexOf('@', cursorPos - 1);

                // Auto resize logic
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if (this.value === '') {
                     this.style.height = 'auto';
                }

                if (lastAtPos !== -1) {
                    const query = value.substring(lastAtPos + 1, cursorPos);
                    // Check if there's a space after @, if so, close dropdown (unless query is empty which means just typed @)
                    if (query.includes(' ')) {
                        hideMentionDropdown();
                        return;
                    }

                    const matches = marketAgents.filter(agent =>
                        agent.name.toLowerCase().includes(query.toLowerCase()) ||
                        agent.desc.toLowerCase().includes(query.toLowerCase())
                    );

                    if (matches.length > 0) {
                        showMentionDropdown(matches, lastAtPos);
                    } else {
                        hideMentionDropdown();
                    }
                } else {
                    hideMentionDropdown();
                }
            });

            chatInput.addEventListener('keydown', function (e) {
                if (mentionDropdown.style.display === 'block') {
                    const items = mentionDropdown.querySelectorAll('.mention-item');
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        mentionIndex = (mentionIndex + 1) % items.length;
                        updateMentionSelection(items);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        mentionIndex = (mentionIndex - 1 + items.length) % items.length;
                        updateMentionSelection(items);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (mentionIndex !== -1) {
                            items[mentionIndex].click();
                        }
                    } else if (e.key === 'Escape') {
                        hideMentionDropdown();
                    }
                } else if (e.key === 'Enter') {
                    if (!e.shiftKey) {
                        // Send message
                        e.preventDefault();
                        executeTask(this.value);
                        this.value = '';
                        this.style.height = 'auto'; // Reset height
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (e.target !== chatInput && !mentionDropdown.contains(e.target)) {
                    hideMentionDropdown();
                }
            });
        }

        function showMentionDropdown(agents, atPos) {
            mentionDropdown.innerHTML = agents.map((agent, index) => `
                <div class="mention-item" onclick="selectMention('${agent.name}', ${atPos})">
                    <div class="mention-item-icon" style="color: ${agent.color}; background: ${agent.color}15;">
                        <i class="${agent.icon}"></i>
                    </div>
                    <div class="mention-item-info">
                        <div class="mention-item-name">${agent.name}</div>
                        <div class="mention-item-desc">${agent.desc}</div>
                    </div>
                </div>
            `).join('');

            mentionDropdown.classList.add('show');
            mentionDropdown.style.display = 'block';
            mentionIndex = 0;
            updateMentionSelection(mentionDropdown.querySelectorAll('.mention-item'));
        }

        function hideMentionDropdown() {
            mentionDropdown.classList.remove('show');
            mentionDropdown.style.display = 'none';
            mentionIndex = -1;
        }

        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                if (index === mentionIndex) item.classList.add('selected');
                else item.classList.remove('selected');
            });

            // Scroll to selected
            if (mentionIndex !== -1 && items[mentionIndex]) {
                items[mentionIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function selectMention(name, atPos) {
            const value = chatInput.value;
            const cursorPos = chatInput.selectionStart;
            const before = value.substring(0, atPos);
            const after = value.substring(cursorPos);

            chatInput.value = `${before}@${name} ${after}`;
            hideMentionDropdown();
            chatInput.focus();

            // Move cursor to after the inserted name
            const newCursorPos = atPos + name.length + 2; // @ + name + space
            chatInput.setSelectionRange(newCursorPos, newCursorPos);
        }

        // ==================== Prompt Studio Functions ====================

        function switchPromptTab(tabName) {
            // Update buttons
            document.querySelectorAll('.prompt-tab').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.prompt-tab[onclick="switchPromptTab('${tabName}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Update content visibility
            document.querySelectorAll('.prompt-tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`prompt-tab-${tabName}`).style.display = 'block';

            // Load data if needed
            if (tabName === 'library') loadPrompts();
            if (tabName === 'best-practices') loadBestPractices();
        }

        async function loadPrompts() {
            const list = document.getElementById('prompt-list');
            if (!list) return;
            list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Âä†ËΩΩ‰∏≠...</div>';
            try {
                const res = await fetch('/api/prompt/library');
                const data = await res.json();
                if (data && data.success) {
                    renderPrompts(data.prompts || []);
                } else {
                    list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            } catch (e) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        async function optimizePrompt() {
            console.log("optimizePrompt called");
            const prompt = document.getElementById('prompt-input').value;
            const model = document.getElementById('prompt-model-select').value;
            const framework = document.getElementById('prompt-framework-select').value;
            const tone = document.getElementById('prompt-tone-select').value;
            const btn = document.getElementById('btn-optimize-prompt');
            const originalText = btn.innerHTML;

            if (!prompt) return alert('ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØç');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰ºòÂåñ‰∏≠...';

            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('model', model);
                formData.append('framework', framework);
                formData.append('tone', tone);

                const res = await fetch('/api/prompt/optimize', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('prompt-output-container').style.display = 'block';
                    
                    const resultData = data.data || {};
                    document.getElementById('prompt-output').value = resultData.optimized_prompt || '';
                    
                    // Render Markdown for explanation and comparison
                    const explanation = resultData.explanation || 'Êó†ËØ¶ÁªÜËØ¥Êòé';
                    const comparison = resultData.comparison || 'Êó†ÂØπÊØîËØ¥Êòé';
                    
                    document.getElementById('prompt-explanation').innerHTML = parseMarkdown(explanation);
                    document.getElementById('prompt-comparison').innerHTML = parseMarkdown(comparison);
                    
                } else {
                    alert('‰ºòÂåñÂ§±Ë¥•: ' + data.error);
                }
            } catch (e) {
                alert('ËØ∑Ê±ÇÈîôËØØ: ' + e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function loadBestPractices() {
            const container = document.getElementById('best-practices-list');
            if (container.innerHTML.trim()) return; // already loaded

            try {
                const res = await fetch('/api/prompt/best-practices');
                const data = await res.json();
                
                if (data.success) {
                    // Group by category
                    const grouped = {};
                    data.practices.forEach(bp => {
                        const cat = bp.category || 'ÂÖ∂‰ªñ';
                        if (!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(bp);
                    });
                    
                    let html = '';
                    for (const [category, practices] of Object.entries(grouped)) {
                        html += `<h3 style="grid-column: 1 / -1; color: var(--text-secondary); font-size: 0.9rem; margin-top: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">${category}</h3>`;
                        html += practices.map(bp => `
                            <div class="prompt-card">
                                <div class="prompt-card-title" style="color: var(--primary);"><i class="fas fa-lightbulb"></i> ${bp.title}</div>
                                <div class="prompt-card-content" style="-webkit-line-clamp: unset; max-height: none; white-space: pre-wrap;">${parseMarkdown(bp.content)}</div>
                            </div>
                        `).join('');
                    }
                    
                    container.innerHTML = html;
                }
            } catch (e) {
                container.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
            }
        }

        function renderPrompts(prompts) {
            const list = document.getElementById('prompt-list');
            if (prompts.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ÊöÇÊó†‰øùÂ≠òÁöÑÊèêÁ§∫ËØç</div>';
                return;
            }

            list.innerHTML = prompts.map(p => `
                <div class="prompt-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div class="prompt-card-title">${escapeHtml(p.title)}</div>
                        <button onclick="deletePrompt('${p.id}')" style="background:none; border:none; color:#666; cursor:pointer; padding:0;"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="prompt-card-content">${escapeHtml(p.content)}</div>
                    <div>
                        ${(p.tags || []).map(t => `<span class="prompt-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <button onclick="usePrompt('${escapeHtml(p.content.replace(/'/g, "\\'"))}')" style="background:none; border:1px solid var(--border); color:var(--primary); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-pen"></i> ‰ΩøÁî®
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterPrompts() {
            const term = document.getElementById('prompt-search').value.toLowerCase();
            const cards = document.querySelectorAll('.prompt-card');
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        async function saveToLibrary() {
            const content = document.getElementById('prompt-output').value || document.getElementById('prompt-input').value;
            if (!content) return alert('Ê≤°ÊúâÂÜÖÂÆπÂèØ‰øùÂ≠ò');

            const title = prompt('ÁªôËøô‰∏™ÊèêÁ§∫ËØçËµ∑‰∏™ÂêçÂ≠óÔºö');
            if (!title) return;

            const tags = prompt('Ê∑ªÂä†Ê†áÁ≠æÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâÔºö', '‰ºòÂåñÁâà, ÈÄöÁî®');
            
            try {
                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('tags', tags || '');

                const res = await fetch('/api/prompt/library', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‰øùÂ≠òÊàêÂäüÔºÅ');
                    switchPromptTab('library');
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
                }
            } catch (e) {
                alert('‰øùÂ≠òÈîôËØØ: ' + e);
            }
        }

        async function deletePrompt(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊèêÁ§∫ËØçÂêóÔºü')) return;
            try {
                const res = await fetch(`/api/prompt/library/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    loadPrompts();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•');
                }
            } catch (e) {
                alert('Âà†Èô§ÈîôËØØ: ' + e);
            }
        }

        function usePrompt(content) {
            document.getElementById('prompt-input').value = content;
            switchPromptTab('optimize');
        }

        async function loadBestPractices() {
            const container = document.getElementById('best-practices-list');
            if (!container) return;
            if (container.innerHTML.trim()) return;
            try {
                const res = await fetch('/api/prompt/best-practices');
                const data = await res.json();
                if (data && data.success) {
                    const grouped = {};
                    (data.practices || []).forEach(bp => {
                        const cat = bp.category || 'ÂÖ∂‰ªñ';
                        if (!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(bp);
                    });
                    let html = '';
                    for (const [category, practices] of Object.entries(grouped)) {
                        html += `<h3 style="grid-column: 1 / -1; color: var(--text-secondary); font-size: 0.9rem; margin-top: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">${category}</h3>`;
                        html += practices.map(bp => `
                            <div class="prompt-card">
                                <div class="prompt-card-title" style="color: var(--primary);"><i class="fas fa-lightbulb"></i> ${bp.title}</div>
                                <div class="prompt-card-content" style="-webkit-line-clamp: unset; max-height: none; white-space: pre-wrap;">${parseMarkdown(bp.content)}</div>
                            </div>
                        `).join('');
                    }
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            });
        }

        // ==================== Prompt Optimization (Old Chat Integration) ====================
        // Function removed to avoid conflict with Prompt Studio
        // let originalPrompt = '';
        // async function optimizePrompt() { ... }

        function undoOptimize() {
            if (originalPrompt) {
                const input = document.getElementById('chatInput');
                input.value = originalPrompt;
                document.getElementById('undoOptimizeBtn').style.display = 'none';
                originalPrompt = '';
                input.focus();
            }
        }

        // ==================== Ê∏ÖÁ©∫ÂäüËÉΩ ====================
        
        async function clearChat() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂØπËØùËÆ∞ÂΩïÂêóÔºü')) return;
            
            try {
                await fetch('/api/chat/clear', { method: 'POST' });
                const container = document.getElementById('chat-messages');
                container.innerHTML = `
                    <div class="chat-message agent-message">
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">‰Ω†Â•ΩÔºÅÊ¨¢Ëøé‰ΩøÁî® AgentDeskÔºåÊÇ®ÁöÑÊô∫ËÉΩÂõ¢ÈòüÈöèÊó∂ÂæÖÂëΩ„ÄÇÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†Ôºü</div>
                    </div>
                `;
            } catch (e) {
                console.error('Failed to clear chat:', e);
            }
        }

        function resetWelcomeScreen() {
            const editorArea = document.getElementById('editorArea');
            // ÊÅ¢Â§çÊ¨¢ËøéÈ°µ
            editorArea.innerHTML = `
                <div class="welcome-message" style="max-width: 800px; margin: 50px auto; text-align: center;">
                    <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); position: relative; overflow: hidden;">
                        <span style="font-size: 48px; font-weight: 900; color: white;">AD</span>
                        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent); transform: rotate(45deg); animation: shine 3s infinite;"></div>
                    </div>
                    <h1 style="color: var(--text-primary); margin-bottom: 15px;">Ê¨¢Ëøé‰ΩøÁî® AgentDesk</h1>
                    <p style="color: var(--text-secondary); line-height: 1.8; font-size: 16px;">
                        Âú®Â∑¶‰æßÈÄâÊã©Êñá‰ª∂ÊàñÊô∫ËÉΩ‰ΩìÂºÄÂßãÂ∑•‰Ωú<br>
                        ‰ΩøÁî® <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px; color: #FF6B00;">@Êô∫ËÉΩ‰ΩìÂêçÁß∞</code> ÊèêÈóÆÔºåÊàñÁÇπÂáª‰∏ãÊñπÁöÑÊô∫ËÉΩ‰ΩìÂç°ÁâáÂø´ÈÄüÂºÄÂßã
                    </p>
                </div>
            `;
            // ÈáçÁΩÆÊ†áÈ¢ò
            updateContentTitle('ÂÜÖÂÆπÁîªÂ∏É', 'fas fa-layer-group');
        }

        function clearEditorContent() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂÜÖÂÆπÁîªÂ∏ÉÂêóÔºüËøôÂ∞ÜÁßªÈô§ÊâÄÊúâÁîüÊàêÁöÑÊñáÊ°£ÂíåÁªìÊûú„ÄÇ')) return;
            resetWelcomeScreen();
        }

        // ==================== Workflow Logic ====================
        function previewWorkflow(type) {
            console.log(`Previewing workflow: ${type}`);
            
            const detailArea = document.getElementById('workflowDetailArea');
            const editorArea = document.getElementById('editorArea');
            const canvasArea = document.getElementById('canvasArea');
            
            // Hide main areas
            editorArea.style.display = 'none';
            canvasArea.classList.remove('active');
            
            // Show detail area
            detailArea.style.display = 'block';
            
            // Update content based on type
            let content = '';
            
            if (type === 'doc-review') {
                content = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h2 style="color: var(--text-primary); margin-bottom: 5px;">Êô∫ËÉΩÊñáÊ°£Â§öÁª¥ÂÆ°Êü•</h2>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Áî± <span style="color: var(--primary);">ÊñáÊ°£ÂàÜÊûêÂ∏à</span> + <span style="color: #F44336;">ÂêàËßÑÂÆò</span> + <span style="color: #9C27B0;">ÂÜÖÂÆπÂàõ‰ΩúËÄÖ</span> ËÅîÂêàÊâßË°å</div>
                            </div>
                            <button class="wf-btn-edit" style="padding: 8px 12px; font-size: 0.9rem;" onclick="closeWorkflowDetail()"><i class="fas fa-times"></i></button>
                        </div>

                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 20px;">
                            <div style="margin-bottom: 20px;">
                                <i class="fas fa-file-upload" style="font-size: 3rem; color: var(--primary); opacity: 0.8;"></i>
                            </div>
                            <h3 style="margin-bottom: 10px;">‰∏ä‰º†ÂæÖÂÆ°Êü•ÊñáÊ°£</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">ÊîØÊåÅ PDF, DOCX, TXT Ê†ºÂºè„ÄÇÊñáÊ°£Â∞ÜÁî±Êô∫ËÉΩ‰ΩìÂõ¢ÈòüÂπ∂Ë°åÂ§ÑÁêÜ„ÄÇ</p>
                            
                            <input type="file" id="review-file-input" style="display: none;" onchange="handleReviewFileSelect(this)">
                            <button onclick="document.getElementById('review-file-input').click()" style="background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold;">
                                ÈÄâÊã©Êñá‰ª∂
                            </button>
                            <div id="review-file-name" style="margin-top: 10px; color: var(--primary); font-size: 0.9rem;"></div>
                        </div>

                        <div id="review-progress" style="display: none; margin-bottom: 20px;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">ÊâßË°åËøõÂ∫¶</h4>
                            <div style="background: #000; border-radius: 6px; padding: 15px; font-family: monospace; font-size: 0.85rem; color: #00ff00; height: 150px; overflow-y: auto;" id="review-logs">
                                <!-- Logs -->
                            </div>
                        </div>

                        <div id="review-result" style="display: none;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">ÂÆ°Êü•Êä•Âëä</h4>
                            <div id="review-report-content" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; color: var(--text-primary); line-height: 1.6; height: 400px; overflow-y: auto;"></div>
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px; display: none;" id="review-actions">
                            <button onclick="executeReviewWorkflow()" id="btn-start-review" style="background: linear-gradient(135deg, #FF6B00 0%, #FF8800 100%); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);">
                                <i class="fas fa-play"></i> ÂºÄÂßãÂÆ°Êü•
                            </button>
                        </div>
                    </div>
                `;
            } else if (type === 'morning-report') {
                content = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="color: var(--text-primary); margin-bottom: 5px;">ÊØèÊó•ËàÜÊÉÖÊó©Êä•</h2>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">‰∏äÊ¨°ËøêË°å: <span style="color: #4CAF50;">‰ªäÂ§© 08:30 (ÊàêÂäü)</span></div>
                        </div>
                        <div>
                            <button class="wf-btn-run" style="padding: 8px 20px; font-size: 0.9rem;" onclick="runWorkflow('ËàÜÊÉÖÊó©Êä•')"><i class="fas fa-play"></i> Á´ãÂç≥ËøêË°å</button>
                            <button class="wf-btn-edit" style="padding: 8px 12px; font-size: 0.9rem;" onclick="closeWorkflowDetail()"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="font-size: 0.95rem; color: #64B5F6; margin-bottom: 10px; display: flex; align-items: center;">
                            <i class="fas fa-info-circle" style="margin-right: 8px;"></i> Â∑•‰ΩúÊµÅËØ¥Êòé
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6; margin-bottom: 10px;">
                            ÊØèÊó•Ëá™Âä®ÊêúÈõÜÊåáÂÆöÂÖ≥ÈîÆËØçÁöÑÂ∏ÇÂú∫ËàÜÊÉÖÔºåÂàÜÊûêÊ≠£Ë¥üÈù¢ÊÉÖÁª™ÔºåÂπ∂ÁîüÊàêÁÆÄÊä•ÂèëÈÄÅÁªôËÆ¢ÈòÖËÄÖ„ÄÇÈÄÇÁî®‰∫éÊó©Èó¥Âø´ÈÄü‰∫ÜËß£Â∏ÇÂú∫Âä®ÊÄÅ„ÄÇ
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-chart-bar" style="color: #2196F3;"></i>
                                <span style="color: var(--text-primary);">Êï∞ÊçÆ‰∏ìÂÆ∂</span>
                                <span style="color: #666;">- ÊêúÁ¥¢/Ê∏ÖÊ¥óÊï∞ÊçÆ</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-file-alt" style="color: #FF9800;"></i>
                                <span style="color: var(--text-primary);">ÊñáÊ°£ÂàÜÊûêÂ∏à</span>
                                <span style="color: #666;">- ÊèêÂèñÂÖ≥ÈîÆ/ÊÉÖÁª™ÂàÜÊûê</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-pen-fancy" style="color: #9C27B0;"></i>
                                <span style="color: var(--text-primary);">ÂÜÖÂÆπÂàõ‰ΩúËÄÖ</span>
                                <span style="color: #666;">- Êí∞ÂÜô/Ê∂¶Ëâ≤Êó•Êä•</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-bullseye" style="color: #F44336;"></i>
                                <span style="color: var(--text-primary);">ÂçèË∞ÉËÄÖ</span>
                                <span style="color: #666;">- Ë∞ÉÂ∫¶/ÈÇÆ‰ª∂ÂàÜÂèë</span>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; border-left: 3px solid var(--primary); padding-left: 10px;">Âü∫Á°ÄÈÖçÁΩÆ</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">ÁõëÊéßÂÖ≥ÈîÆËØç</label>
                                <input type="text" value="ÊãõÂïÜÈì∂Ë°å, Êñ∞ËÉΩÊ∫ê, ÂÆèËßÇÁªèÊµé" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">Ëß¶ÂèëÊó∂Èó¥</label>
                                <input type="time" value="08:30" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Graph Editor (Mock) -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; height: 400px; position: relative; overflow: hidden;">
                        <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; border-left: 3px solid var(--primary); padding-left: 10px;">ÊµÅÁ®ãÁºñÊéí</h3>
                        
                        <!-- Nodes -->
                        <div style="position: absolute; top: 50%; left: 10%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #2196F3; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);">
                                <i class="fas fa-chart-bar" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">Êï∞ÊçÆ‰∏ìÂÆ∂</div>
                        </div>
                        
                        <div style="position: absolute; top: 50%; left: 25%; transform: translateY(-50%); width: 100px; height: 2px; background: #444;">
                            <div style="position: absolute; right: 0; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #444;"></div>
                        </div>

                        <div style="position: absolute; top: 50%; left: 35%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #FF9800; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);">
                                <i class="fas fa-file-alt" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">ÊñáÊ°£ÂàÜÊûêÂ∏à</div>
                        </div>

                        <div style="position: absolute; top: 50%; left: 50%; transform: translateY(-50%); width: 100px; height: 2px; background: #444;">
                            <div style="position: absolute; right: 0; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #444;"></div>
                        </div>

                        <div style="position: absolute; top: 50%; left: 60%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #9C27B0; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(156, 39, 176, 0.3);">
                                <i class="fas fa-pen-fancy" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">ÂÜÖÂÆπÂàõ‰ΩúËÄÖ</div>
                        </div>
                        
                        <div style="position: absolute; top: 50%; left: 75%; transform: translateY(-50%); width: 100px; height: 2px; background: #444;">
                            <div style="position: absolute; right: 0; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #444;"></div>
                        </div>
                        
                        <div style="position: absolute; top: 50%; left: 85%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #F44336; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.3);">
                                <i class="fas fa-bullseye" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">ÂçèË∞ÉËÄÖ</div>
                        </div>
                    </div>
                    
                    <!-- Logs -->
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 10px;">ËøêË°åÊó•Âøó</h3>
                        <div style="background: #000; padding: 15px; border-radius: 6px; font-family: monospace; color: #00ff00; font-size: 0.8rem; height: 150px; overflow-y: auto;">
                            [08:30:01] Job started: Daily Morning Report<br>
                            [08:30:02] Agent [Êï∞ÊçÆ‰∏ìÂÆ∂] searching for "ÊãõÂïÜÈì∂Ë°å"... found 12 results<br>
                            [08:30:05] Agent [Êï∞ÊçÆ‰∏ìÂÆ∂] searching for "Êñ∞ËÉΩÊ∫ê"... found 25 results<br>
                            [08:30:12] Agent [ÊñáÊ°£ÂàÜÊûêÂ∏à] processing content... sentiment: neutral<br>
                            [08:30:25] Agent [ÂÜÖÂÆπÂàõ‰ΩúËÄÖ] generating report draft...<br>
                            [08:30:30] Agent [ÂçèË∞ÉËÄÖ] Email sent to subscribers.<br>
                            [08:30:31] Job finished successfully.
                        </div>
                </div>
            `;
            } else if (type === 'daily-tech') {
                content = `
                    <div style="max-width: 900px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h2 style="color: var(--text-primary); margin-bottom: 5px;">ÊØèÊó•ÁßëÊäÄÂä®ÊÄÅ</h2>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Áî± <span style="color: #2196F3;">Êï∞ÊçÆ‰∏ìÂÆ∂</span> + <span style="color: #FF9800;">ÊñáÊ°£ÂàÜÊûêÂ∏à</span> + <span style="color: #9C27B0;">ÂÜÖÂÆπÂàõ‰ΩúËÄÖ</span> ËÅîÂêàÊâßË°å</div>
                            </div>
                            <button class="wf-btn-edit" style="padding: 8px 12px; font-size: 0.9rem;" onclick="closeWorkflowDetail()"><i class="fas fa-times"></i></button>
                        </div>

                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; border-left: 3px solid #64B5F6; padding-left: 10px;">Âü∫Á°ÄÈÖçÁΩÆ</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">ÂÖ≥ÈîÆËØç</label>
                                    <input type="text" id="daily-tech-keywords" value="AI, ËäØÁâá, Êú∫Âô®‰∫∫" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">ÊòØÂê¶ÁîüÊàêËã±ÊñáÁâà</label>
                                    <select id="daily-tech-need-en" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                                        <option value="false" selected>Âê¶</option>
                                        <option value="true">ÊòØ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="daily-tech-progress" style="display: none; margin-bottom: 20px;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">ÊâßË°åËøõÂ∫¶</h4>
                            <div style="background: #000; border-radius: 6px; padding: 15px; font-family: monospace; font-size: 0.85rem; color: #00ff00; height: 150px; overflow-y: auto;" id="daily-tech-logs"></div>
                        </div>

                        <div id="daily-tech-result" style="display: none;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">Êó•Êä•</h4>
                            <div id="daily-tech-report-content" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; color: var(--text-primary); line-height: 1.6; min-height: 300px; overflow-y: auto;"></div>
                        </div>

                        <div style="text-align: right; margin-top: 20px;" id="daily-tech-actions">
                            <button onclick="executeDailyTechWorkflow()" id="btn-start-daily-tech" style="background: linear-gradient(135deg, #64B5F6 0%, #2196F3 100%); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
                                <i class="fas fa-play"></i> ÂºÄÂßãÁîüÊàê
                            </button>
                        </div>
                    </div>
                `;
            } else {
                content = `<div style="text-align: center; padding: 50px; color: #666;">${type} ÁöÑËØ¶ÊÉÖÈ°µÊ≠£Âú®ÂºÄÂèë‰∏≠... <button onclick="closeWorkflowDetail()" style="margin-left: 10px; cursor: pointer; background: none; border: 1px solid #666; color: #aaa; padding: 2px 8px; border-radius: 4px;">ËøîÂõû</button></div>`;
            }
            
            detailArea.innerHTML = content;
        }

        function closeWorkflowDetail() {
            const detailArea = document.getElementById('workflowDetailArea');
            const editorArea = document.getElementById('editorArea');
            
            detailArea.style.display = 'none';
            editorArea.style.display = 'block';
        }

        function runWorkflow(name) {
            console.log(`Running workflow: ${name}`);
            const btn = event.target.closest('.wf-btn-run');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂêØÂä®‰∏≠...';
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> Â∑≤ÂêØÂä®';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                }, 1000);
            }
        }

        // Document Review Workflow Logic
        let selectedReviewFile = null;

        function handleReviewFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedReviewFile = input.files[0];
                document.getElementById('review-file-name').innerHTML = `<i class="fas fa-file-alt"></i> ${selectedReviewFile.name}`;
                document.getElementById('review-actions').style.display = 'block';
            }
        }

        async function executeReviewWorkflow() {
            if (!selectedReviewFile) return;

            const btn = document.getElementById('btn-start-review');
            const progress = document.getElementById('review-progress');
            const logs = document.getElementById('review-logs');
            const resultArea = document.getElementById('review-result');
            const resultContent = document.getElementById('review-report-content');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂÆ°Êü•‰∏≠...';
            progress.style.display = 'block';
            resultArea.style.display = 'none';
            
            logs.innerHTML = `[${new Date().toLocaleTimeString()}] ‰ªªÂä°ÂêØÂä®ÔºöÊô∫ËÉΩÊñáÊ°£Â§öÁª¥ÂÆ°Êü•<br>`;

            const formData = new FormData();
            formData.append('file', selectedReviewFile);

            try {
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] Ê≠£Âú®‰∏ä‰º†ÊñáÊ°£...<br>`;
                
                const response = await fetch('/api/workflow/review', {
                    method: 'POST',
                    body: formData
                });
                
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] ÊñáÊ°£ÂàÜÊûêÂ∏àÔºöÊ≠£Âú®ÊèêÂèñÊëòË¶Å...<br>`;
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] ÂêàËßÑÂÆòÔºöÊ≠£Âú®Êâ´ÊèèÈ£éÈô©ÁÇπ...<br>`;
                
                const data = await response.json();
                
                if (data.success) {
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] ÂÜÖÂÆπÂàõ‰ΩúËÄÖÔºöÊ≠£Âú®Ê±áÊÄªÊä•Âëä...<br>`;
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #4CAF50;">‰ªªÂä°ÂÆåÊàêÔºÅ</span><br>`;
                    
                    const visualHtml = renderVisualReviewReport(data);
                    resultContent.innerHTML = visualHtml;
                    resultArea.style.display = 'block';
                    if (window.mermaid) {
                        try {
                            mermaid.run({ nodes: resultContent.querySelectorAll('.mermaid') });
                        } catch (e) {}
                    }
                    btn.innerHTML = '<i class="fas fa-check"></i> ÂÆåÊàê';
                } else {
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">ÈîôËØØÔºö${data.error}</span><br>`;
                    btn.innerHTML = 'ÈáçËØï';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•</span><br>`;
                btn.innerHTML = 'ÈáçËØï';
                btn.disabled = false;
            }
        }
        async function executeDailyTechWorkflow() {
            const btn = document.getElementById('btn-start-daily-tech');
            const progress = document.getElementById('daily-tech-progress');
            const logs = document.getElementById('daily-tech-logs');
            const resultArea = document.getElementById('daily-tech-result');
            const resultContent = document.getElementById('daily-tech-report-content');
            const kwInput = document.getElementById('daily-tech-keywords');
            const needEn = document.getElementById('daily-tech-need-en');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÁîüÊàê‰∏≠...';
            progress.style.display = 'block';
            resultArea.style.display = 'none';
            logs.innerHTML = `[${new Date().toLocaleTimeString()}] ‰ªªÂä°ÂêØÂä®ÔºöÊØèÊó•ÁßëÊäÄÂä®ÊÄÅ<br>`;

            const payload = {
                keywords: kwInput.value,
                days: 1,
                need_en: needEn.value === 'true'
            };

            try {
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] Êï∞ÊçÆ‰∏ìÂÆ∂ÔºöÊî∂ÈõÜÁ¥†Êùê...<br>`;
                const response = await fetch('/api/workflow/daily_tech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] ÊñáÊ°£ÂàÜÊûêÂ∏àÔºöËÅöÁ±ª‰∏éÊëòË¶Å...<br>`;
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] Êï∞ÊçÆÂèØËßÜÂåñ‰∏ìÂÆ∂ÔºöÁîüÊàêÂõæË°®...<br>`;

                if (!response.ok) {
                    let errMsg = `HTTP ${response.status}`;
                    try {
                        const errData = await response.json();
                        errMsg = errData.error || errData.detail || errMsg;
                    } catch (e) {}
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">ÈîôËØØÔºö${escapeHtml(String(errMsg))}</span><br>`;
                    btn.innerHTML = 'ÈáçËØï';
                    btn.disabled = false;
                    return;
                }

                const data = await response.json();

                if (data && data.success) {
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] ÂÜÖÂÆπÂàõ‰ΩúËÄÖÔºöÊí∞ÂÜôÊó•Êä•...<br>`;
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #4CAF50;">‰ªªÂä°ÂÆåÊàêÔºÅ</span><br>`;
                    const html = renderVisualDailyTechReport(data);
                    resultContent.innerHTML = html;
                    resultArea.style.display = 'block';
                    if (window.mermaid) {
                        try {
                            mermaid.run({ nodes: resultContent.querySelectorAll('.mermaid') });
                        } catch (e) {}
                    }
                    btn.innerHTML = '<i class="fas fa-check"></i> ÂÆåÊàê';
                } else {
                    const errMsg = (data && (data.error || data.detail)) || 'Êú™Áü•ÈîôËØØ';
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">ÈîôËØØÔºö${escapeHtml(String(errMsg))}</span><br>`;
                    btn.innerHTML = 'ÈáçËØï';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•</span><br>`;
                btn.innerHTML = 'ÈáçËØï';
                btn.disabled = false;
            }
        }
        function renderVisualDailyTechReport(data) {
            const raw = data && data.report ? data.report : '';
            const steps = Array.isArray(data && data.steps) ? data.steps : [];
            const meta = data && data.meta ? data.meta : {};
            const timeStr = new Date().toLocaleString();
            const kwText = Array.isArray(meta.keywords) ? meta.keywords.join(', ') : '';
            const flowCode = 'flowchart LR\nA[Êï∞ÊçÆ‰∏ìÂÆ∂]-->B[ÊñáÊ°£ÂàÜÊûêÂ∏à]\nB-->C[ÂÜÖÂÆπÂàõ‰ΩúËÄÖ]';
            const rawWithMermaid = convertMermaidFences(raw || '');
            const rawHtml = marked.parse(rawWithMermaid);
            const stepsHtml = steps.map(s => {
                const name = s && s.step ? s.step : '';
                const outMd = s && s.output ? s.output : '';
                const outHtml = marked.parse(outMd);
                return (
                    `<details style="margin-bottom: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                        <summary style="cursor: pointer; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot" style="color: #64B5F6;"></i> ${name}
                        </summary>
                        <div style="margin-top: 10px; color: var(--text-primary); line-height: 1.7;">${outHtml}</div>
                    </details>`
                );
            }).join('');
            const dateText = meta && meta.report_date ? meta.report_date : new Date().toLocaleDateString();
            const metaCards = `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="background: linear-gradient(135deg, #64B5F6 0%, #2196F3 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">ÂÖ≥ÈîÆËØçÊï∞</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${(kwText || '').split(',').filter(x => x.trim()).length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">Êä•ÂëäÂ≠óÊï∞</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${(raw || '').length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00BCD4 0%, #00838F 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">Êó•Êúü</div>
                        <div style="font-size: 1rem; font-weight: 700;">${dateText}</div>
                    </div>
                </div>`;
            const html = `
                <div style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%); padding: 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:48px; height:48px; border-radius:12px; background: linear-gradient(135deg, #64B5F6 0%, #2196F3 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.2rem;"><i class="fas fa-microchip"></i></div>
                            <div>
                                <div style="font-size:1.2rem; color: var(--text-primary); font-weight:800;">ÊØèÊó•ÁßëÊäÄÂä®ÊÄÅ</div>
                                <div style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(kwText)}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; color:#ddd;">
                            <i class="fas fa-chart-bar" title="Êï∞ÊçÆ‰∏ìÂÆ∂"></i>
                            <i class="fas fa-file-alt" title="ÊñáÊ°£ÂàÜÊûêÂ∏à"></i>
                            <i class="fas fa-pen-fancy" title="ÂÜÖÂÆπÂàõ‰ΩúËÄÖ"></i>
                        </div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-secondary);">
                        ${metaCards}
                        <div style="margin-top: 20px; display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-chart-pie" style="color:#64B5F6;"></i>‰∏ªÈ¢òÊ¶ÇËßà</div>
                                <div class="mermaid">${flowCode}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-route" style="color:#9C27B0;"></i>ÊµÅÁ®ãÊ¶ÇËßà</div>
                                <div class="mermaid">flowchart LR\nA[Êï∞ÊçÆ‰∏ìÂÆ∂]-->B[ÊñáÊ°£ÂàÜÊûêÂ∏à]\nB-->C[ÂÜÖÂÆπÂàõ‰ΩúËÄÖ]</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-file-alt" style="color:#FF9800;"></i>ËØ¶ÁªÜÊó•Êä•</div>
                            <div style="color: var(--text-primary); line-height: 1.8;">${rawHtml}</div>
                        </div>
                        <div style="margin-top: 20px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-list" style="color:#00BCD4;"></i>ÂàÜÊ≠•ËæìÂá∫</div>
                            ${stepsHtml}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }
        function convertMermaidFences(md) {
            const regex = /```mermaid\n([\s\S]*?)```/g;
            return (md || '').replace(regex, (_, code) => {
                return `<div class="mermaid">${escapeHtml(code)}</div>`;
            });
        }
        function renderVisualReviewReport(data) {
            const raw = data && data.report ? data.report : '';
            const steps = Array.isArray(data && data.steps) ? data.steps : [];
            const fileName = selectedReviewFile && selectedReviewFile.name ? selectedReviewFile.name : '';
            const timeStr = new Date().toLocaleString();
            const risks = extractRiskItems(raw);
            const severityCounts = computeSeverityCounts(risks);
            const pieCode = buildMermaidRiskPie(severityCounts);
            const flowCode = 'flowchart LR\nA[ÊñáÊ°£ÂàÜÊûêÂ∏à]-->B[ÂêàËßÑÂÆò]\nB-->C[ÂÜÖÂÆπÂàõ‰ΩúËÄÖ]';
            const rawHtml = marked.parse(raw || '');
            const stepsHtml = steps.map(s => {
                const name = s && s.agent ? s.agent : '';
                const outMd = s && s.output ? s.output : '';
                const outHtml = marked.parse(outMd);
                return (
                    `<details style="margin-bottom: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                        <summary style="cursor: pointer; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot" style="color: var(--primary);"></i> ${name}
                        </summary>
                        <div style="margin-top: 10px; color: var(--text-primary); line-height: 1.7;">${outHtml}</div>
                    </details>`
                );
            }).join('');
            const riskBadges = risks.map(r => `<span style="display:inline-block; padding:6px 10px; border-radius:16px; margin:4px; border:1px solid var(--border); background: rgba(244, 67, 54, 0.12); color: #F44336; font-size: 0.85rem;">${escapeHtml(r.text)}${r.severity ? ` ¬∑ ${r.severity}` : ''}</span>`).join('');
            const metaCards = `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="background: linear-gradient(135deg, #FF6B00 0%, #FF8800 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">È£éÈô©È°πÊï∞</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${risks.length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">Êä•ÂëäÂ≠óÊï∞</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${(raw || '').length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00BCD4 0%, #00838F 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">Êó∂Èó¥</div>
                        <div style="font-size: 1rem; font-weight: 700;">${timeStr}</div>
                    </div>
                </div>`;
            const html = `
                <div style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%); padding: 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:48px; height:48px; border-radius:12px; background: linear-gradient(135deg, #FF6B00 0%, #FF8800 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.2rem;"><i class="fas fa-file-search"></i></div>
                            <div>
                                <div style="font-size:1.2rem; color: var(--text-primary); font-weight:800;">Êô∫ËÉΩÊñáÊ°£ÂÆ°Êü•Êä•Âëä</div>
                                <div style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(fileName)}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; color:#ddd;">
                            <i class="fas fa-file-alt" title="ÊñáÊ°£ÂàÜÊûêÂ∏à"></i>
                            <i class="fas fa-balance-scale" title="ÂêàËßÑÂÆò"></i>
                            <i class="fas fa-pen-fancy" title="ÂÜÖÂÆπÂàõ‰ΩúËÄÖ"></i>
                        </div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-secondary);">
                        ${metaCards}
                        <div style="margin-top: 20px; display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-exclamation-triangle" style="color:#F44336;"></i>È£éÈô©ÊèêÁ§∫</div>
                                <div>${riskBadges || '<span style="color: var(--text-secondary);">Êó†ÊòéÊòæÈ£éÈô©È°π</span>'}</div>
                                <div style="margin-top: 12px;">
                                    <div class="mermaid">${pieCode}</div>
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-route" style="color:#9C27B0;"></i>ÊµÅÁ®ãÊ¶ÇËßà</div>
                                <div class="mermaid">${flowCode}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-file-alt" style="color:#FF9800;"></i>ËØ¶ÁªÜÊä•Âëä</div>
                            <div style="color: var(--text-primary); line-height: 1.8;">${rawHtml}</div>
                        </div>
                        <div style="margin-top: 20px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-list" style="color:#00BCD4;"></i>ÂàÜÊ≠•ËæìÂá∫</div>
                            ${stepsHtml}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }
        function extractRiskItems(md) {
            const lines = (md || '').split('\n');
            const items = [];
            for (let i = 0; i < lines.length; i++) {
                const t = lines[i].trim();
                // Êõ¥ÂÆΩÊ≥õÁöÑÈ£éÈô©ÂåπÈÖçÊ®°Âºè
                const isRisk = /È£éÈô©|‚ö†Ô∏è|‰∏çÂΩì|ËøùËßÑ|ÊºèÊ¥û|ÈóÆÈ¢ò|Ë≠¶Âëä|Ê≥®ÊÑè|Á¶ÅÊ≠¢|‰∏•Á¶Å|È´òÈ£éÈô©|‰∏≠È£éÈô©|‰ΩéÈ£éÈô©|‰∏•Èáç|È´ò|‰∏≠|‰Ωé/.test(t);
                if (isRisk && t.length > 5) { // Ëá≥Â∞ë5‰∏™Â≠óÁ¨¶ÔºåÈÅøÂÖçËØØÂåπÈÖç
                    let severity = '';
                    if (/‰∏•Èáç|È´òÈ£éÈô©|È´ò/.test(t)) severity = 'È´ò';
                    else if (/‰∏≠È£éÈô©|‰∏≠/.test(t)) severity = '‰∏≠';
                    else if (/‰ΩéÈ£éÈô©|‰Ωé|‰∏ÄËà¨/.test(t)) severity = '‰Ωé';
                    // Â¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÁ∫ßÂà´ÔºåÊ†πÊçÆ‰∏ä‰∏ãÊñáÂà§Êñ≠
                    if (!severity) {
                        if (i > 0 && /È´ò|‰∏•Èáç/.test(lines[i-1])) severity = 'È´ò';
                        else if (i > 0 && /‰∏≠/.test(lines[i-1])) severity = '‰∏≠';
                        else severity = '‰∏≠'; // ÈªòËÆ§‰∏≠Á≠âÈ£éÈô©
                    }
                    const cleanText = t.replace(/^[-\*\s\d\.]+/, '').replace(/^[Ôºà(].*?[Ôºâ)]/, '');
                    if (cleanText.length > 3) {
                        items.push({ text: cleanText, severity });
                    }
                }
            }
            return items;
        }
        function computeSeverityCounts(items) {
            const c = { È´ò: 0, ‰∏≠: 0, ‰Ωé: 0 };
            items.forEach(it => {
                if (it.severity === 'È´ò') c['È´ò'] += 1;
                else if (it.severity === '‰∏≠') c['‰∏≠'] += 1;
                else c['‰Ωé'] += 1;
            });
            return c;
        }
        function buildMermaidRiskPie(counts) {
            const total = counts['È´ò'] + counts['‰∏≠'] + counts['‰Ωé'];
            const title = total > 0 ? 'È£éÈô©ÂàÜÂ∏É' : 'È£éÈô©ÂàÜÂ∏ÉÔºàÊó†Ôºâ';
            return `pie title ${title}\n"È´ò" : ${counts['È´ò']}\n"‰∏≠" : ${counts['‰∏≠']}\n"‰Ωé" : ${counts['‰Ωé']}`;
        }
        let settingsModalInstance = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            settingsModalInstance = document.getElementById('settingsModal');
        });
        
        function openSettingsModal() {
            // Re-query if null (sometimes DOMContentLoaded fires before dynamic elements are ready in some frameworks, though unlikely here)
            if (!settingsModalInstance) settingsModalInstance = document.getElementById('settingsModal');
            
            if (settingsModalInstance) {
                settingsModalInstance.style.display = 'block';
                
                // Fetch settings from backend
                fetch('/api/settings/model')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.settings) {
                            const s = data.settings;
                            // Use backend settings
                            selectProvider(s.provider || 'gemini');
                            
                            const apiKeyInput = document.getElementById('setting-api-key');
                            const modelNameInput = document.getElementById('setting-model-name');
                            const baseUrlInput = document.getElementById('setting-base-url');
                            
                            if(apiKeyInput) apiKeyInput.value = s.api_key || '';
                            if(modelNameInput) modelNameInput.value = s.model_name || '';
                            if(baseUrlInput) baseUrlInput.value = s.base_url || '';
                            
                            // Also update localStorage to keep them in sync
                            localStorage.setItem('llm_provider', s.provider);
                            if(s.api_key) localStorage.setItem('llm_api_key', s.api_key);
                            if(s.model_name) localStorage.setItem('llm_model_name', s.model_name);
                            if(s.base_url) localStorage.setItem('llm_base_url', s.base_url);
                        } else {
                            // Fallback to localStorage if fetch failed or no settings returned
                            loadSettingsFromLocal();
                        }
                    })
                    .catch(err => {
                        console.error("Failed to fetch settings:", err);
                        loadSettingsFromLocal();
                    });
            } else {
                console.error("Settings modal element not found!");
            }
        }
        
        function loadSettingsFromLocal() {
            const provider = localStorage.getItem('llm_provider') || 'gemini';
            selectProvider(provider);
            
            const apiKeyInput = document.getElementById('setting-api-key');
            const modelNameInput = document.getElementById('setting-model-name');
            const baseUrlInput = document.getElementById('setting-base-url');
            
            if(apiKeyInput) apiKeyInput.value = localStorage.getItem('llm_api_key') || '';
            if(modelNameInput) modelNameInput.value = localStorage.getItem('llm_model_name') || '';
            if(baseUrlInput) baseUrlInput.value = localStorage.getItem('llm_base_url') || '';
        }

        function closeSettingsModal() {
            if (!settingsModalInstance) settingsModalInstance = document.getElementById('settingsModal');
            if (settingsModalInstance) {
                settingsModalInstance.style.display = 'none';
            }
        }

        function selectProvider(provider) {
            // Update UI
            const options = document.querySelectorAll('.provider-option');
            if (options) {
                options.forEach(opt => {
                    if (opt.dataset.provider === provider) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }
            
            // Toggle Base URL field
            const baseUrlGroup = document.getElementById('base-url-group');
            if (baseUrlGroup) {
                if (provider === 'openai' || provider === 'deepseek' || provider === 'local') {
                    baseUrlGroup.style.display = 'block';
                } else {
                    baseUrlGroup.style.display = 'none';
                }
            }
            
            // Auto-fill defaults if empty
            const modelInput = document.getElementById('setting-model-name');
            const urlInput = document.getElementById('setting-base-url');
            
            if (modelInput && urlInput) {
                if (provider === 'deepseek') {
                    if (!modelInput.value) modelInput.value = 'deepseek-chat';
                    if (!urlInput.value) urlInput.value = 'https://api.deepseek.com';
                } else if (provider === 'gemini') {
                    if (!modelInput.value) modelInput.value = 'gemini-1.5-flash';
                } else if (provider === 'local') {
                    if (!urlInput.value) urlInput.value = 'http://localhost:1234/v1';
                }
            }
        }

        async function saveSettings() {
            const provider = document.querySelector('.provider-option.active').dataset.provider;
            const apiKey = document.getElementById('setting-api-key').value;
            const modelName = document.getElementById('setting-model-name').value;
            const baseUrl = document.getElementById('setting-base-url').value;
            
            if (!apiKey && provider !== 'local') {
                alert('ËØ∑ËæìÂÖ• API Key');
                return;
            }
            
            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰øùÂ≠ò‰∏≠...';
            
            try {
                // Save to backend
                const response = await fetch('/api/settings/model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        api_key: apiKey,
                        model_name: modelName,
                        base_url: baseUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Save to localStorage for persistence in UI
                    localStorage.setItem('llm_provider', provider);
                    localStorage.setItem('llm_api_key', apiKey);
                    localStorage.setItem('llm_model_name', modelName);
                    localStorage.setItem('llm_base_url', baseUrl);
                    
                    addChatMessage('system', `Á≥ªÁªüÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞: ${result.message}`);
                    closeSettingsModal();
                } else {
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                console.error(e);
                alert('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (modal && event.target == modal) {
                closeSettingsModal();
            }
        }
    </script>
    <script>
        async function runImageGenerator() {
            const prompt = document.getElementById('imggen-prompt').value;
            const model = document.getElementById('imggen-model').value;
            const size = document.getElementById('imggen-size').value;
            const result = document.getElementById('imggen-result');
            result.innerHTML = 'ÁîüÊàê‰∏≠...';
            try {
                const fd = new FormData();
                fd.append('prompt', prompt);
                fd.append('model', model);
                fd.append('size', size);
                const res = await fetch('/api/image/generate', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    result.innerHTML = data.html || 'ÁîüÊàêÊàêÂäü';
                } else {
                    result.innerHTML = (data.error || 'ÁîüÊàêÂ§±Ë¥•') + (data.hint ? ('Ôºå' + data.hint) : '');
                }
            } catch (e) {
                result.innerHTML = 'ÁîüÊàêÂ§±Ë¥•';
            }
        }
    </script>
    <script>
        async function runDrawingGenerator() {
            const prompt = document.getElementById('draw-prompt').value;
            const tools = [];
            if (document.getElementById('tool-mermaid').checked) tools.push('mermaid');
            if (document.getElementById('tool-plantuml').checked) tools.push('plantuml');
            if (document.getElementById('tool-nanobanana').checked) tools.push('nano-banana');
            if (document.getElementById('tool-excalidraw').checked) tools.push('excalidraw');
            const result = document.getElementById('draw-result');
            result.innerHTML = 'ÁîüÊàê‰∏≠...';
            try {
                const fd = new FormData();
                fd.append('prompt', prompt);
                if (tools.length) fd.append('tools', tools.join(','));
                const res = await fetch('/api/draw/generate', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    result.innerHTML = data.html || 'ÁîüÊàêÊàêÂäü';
                } else {
                    result.innerHTML = (data.error || 'ÁîüÊàêÂ§±Ë¥•') + (data.hint ? ('Ôºå' + data.hint) : '');
                }
            } catch (e) {
                result.innerHTML = 'ÁîüÊàêÂ§±Ë¥•';
            }
        }
    </script>
    <script>
        (function(){
            const root = document.documentElement;
            const el = document.getElementById('rightResizer');
            let startX = 0;
            let startW = 0;
            function onMove(e){
                const dx = e.clientX - startX;
                const w = Math.min(Math.max(startW - dx, 280), 720);
                root.style.setProperty('--right-panel-width', w + 'px');
            }
            function onUp(){
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onUp);
                try {
                    const v = getComputedStyle(root).getPropertyValue('--right-panel-width').trim();
                    localStorage.setItem('rightPanelWidth', v);
                } catch(e) {}
            }
            if (el){
                el.addEventListener('mousedown', (e)=>{
                    startX = e.clientX;
                    const v = parseInt(getComputedStyle(root).getPropertyValue('--right-panel-width')) || 420;
                    startW = v;
                    window.addEventListener('mousemove', onMove);
                    window.addEventListener('mouseup', onUp);
                });
                el.addEventListener('dblclick', ()=>{
                    const target = Math.round(Math.min(Math.max(window.innerWidth * 0.32, 420), 680));
                    root.style.setProperty('--right-panel-width', target + 'px');
                    try { localStorage.setItem('rightPanelWidth', target + 'px'); } catch(e) {}
                });
            }
            try {
                const saved = localStorage.getItem('rightPanelWidth');
                if (saved) root.style.setProperty('--right-panel-width', saved);
            } catch(e) {}
        })();
    </script>
    <script>
        async function runDrawingGeneratorFromSidebar() {
            switchMainView('editor');
            const prompt = document.getElementById('draw-prompt-sidebar').value;
            const mer = document.getElementById('tool-mermaid-sidebar').checked;
            const pu = document.getElementById('tool-plantuml-sidebar').checked;
            const nb = document.getElementById('tool-nanobanana-sidebar').checked;
            const ex = document.getElementById('tool-excalidraw-sidebar').checked;
            const tools = [];
            if (mer) tools.push('mermaid');
            if (pu) tools.push('plantuml');
            if (nb) tools.push('nano-banana');
            if (ex) tools.push('excalidraw');
            let result = document.getElementById('draw-result');
            if (!result) {
                const editorArea = document.getElementById('editorArea');
                editorArea.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">ÊèêÁ§∫ËØç</label>
                                <textarea id="draw-prompt" rows="4" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">${prompt}</textarea>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">ÈÄâÊã©ÁªòÁîªÂ∑•ÂÖ∑ÔºàÂèØÂ§öÈÄâÔºâ</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-mermaid" ${mer ? 'checked' : ''}> Mermaid</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-plantuml" ${pu ? 'checked' : ''}> PlantUML</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-nanobanana" ${nb ? 'checked' : ''}> Nano Banana</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-excalidraw" ${ex ? 'checked' : ''}> Excalidraw</label>
                                </div>
                                <button onclick="runDrawingGenerator()" style="margin-top: 10px; width: 100%; padding: 10px 12px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    ÈáçÊñ∞ÁîüÊàê
                                </button>
                            </div>
                            <div id="draw-result" style="min-height: 200px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center; color: var(--text-secondary);">ÁîüÊàêÁªìÊûúÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</div>
                        </div>
                    </div>`;
                result = document.getElementById('draw-result');
            }
            result.innerHTML = 'ÁîüÊàê‰∏≠...';
            try {
                const fd = new FormData();
                fd.append('prompt', prompt);
                if (tools.length) fd.append('tools', tools.join(','));
                const res = await fetch('/api/draw/generate', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    result.innerHTML = data.html || 'ÁîüÊàêÊàêÂäü';
                } else {
                    result.innerHTML = (data.error || 'ÁîüÊàêÂ§±Ë¥•') + (data.hint ? ('Ôºå' + data.hint) : '');
                }
            } catch (e) {
                result.innerHTML = 'ÁîüÊàêÂ§±Ë¥•';
            }
        }
    </script>
</body>

</html>
