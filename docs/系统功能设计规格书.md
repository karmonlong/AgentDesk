# 招商基金 AI 一体化资管平台 — 系统功能设计规格书（v1.0）

> 日期：2025-11-23
> 适用范围：office-assistant 项目（FastAPI + LangGraph + LangChain，多智能体文档/对话工作台）

## 1. 背景与目标
- 目标：打造面向基金行业的多智能体协作工作台，通过自然语言发起任务、工作流自动编排、人工审核闭环，提升文档处理、投研分析、营销合规、运营数据等场景的效率与质量。
- 设计理念：采用“首页发起、工作台执行”的双层结构；首页为零门槛入口与场景选择器，工作台为专业执行空间与协作指挥台。
- 技术栈：`FastAPI` 后端与模板、`LangGraph` 工作流、`LangChain` + Kimi LLM、Jinja2 模板 + Bootstrap 前端、文件工具与多智能体路由。依赖参见 `requirements.txt`。

## 2. 范围与非目标
- 范围：文档处理（总结/生成/转换/提取/分析）、多智能体协作、工作流编排与审核、会话与历史恢复、基础前端工作台与日志、下载与格式支持。
- 非目标：交易执行、最终投资决策、长期存储敏感客户数据、直接面向 C 端服务。

## 3. 用户与场景
- 用户角色：投研人员、合规/风控人员、市场营销人员、运营/行政人员。
- 场景分类：
  - 日常办公：文档总结与转换、邮件撰写、会议纪要整理。
  - 投研：研报分析、财报数据提取、行业研究、投资建议生成。
  - 营销：文案生成 + 合规审核闭环（违规词识别、风险揭示、法规引用）。
  - 运营：数据统计与报表、流程文档管理、知识库检索。

## 4. 架构概览
- 前端：`templates/chat.html`、`templates/command_center.html`，首页 `app.py:49` 内嵌 HTML；计划新增 `workbench.html` 作为工作台。
- 后端：`FastAPI` 路由与接口，文档上传/下载/格式查询/历史/健康/聊天。
- 工作流：`LangGraph` 状态机 `graph/document_graph.py`，节点包含读取、验证、AI 处理、人工审核、保存、错误处理。
- 智能体：`agents/multi_agents.py` 定义与注册 6 类智能体与路由器，会话管理与历史。
- LLM：Kimi（Moonshot AI），通过 `langchain-openai`；`.env` 配置键：`KIMI_API_KEY` 等。

## 5. 核心功能需求
### 5.1 首页（Landing Page）
- 需求：
  - 提供大输入框，支持自然语言发起任务。
  - 场景卡片快捷入口（投研/营销/办公/运营）。
  - 最近工作会话卡片，一键恢复。
- 行为（两段式）：
  - 轻任务：输入后解析任务与复杂度，直接在首页完成处理与结果预览/下载。
  - 重任务：当判定为需协作或审核的重任务时，选择智能体组合与工作台面板，进行转场进入工作台执行。
- 当前实现：`app.py:49-343` 首页 HTML 以“上传文档处理”为主；提供“对话模式”和“指挥中心”导航。
- 待改造：补齐输入发起与场景卡片、历史恢复卡片、0.8s 转场体验。

#### 轻重分流与转场规则
- 轻任务留在首页的条件：
  - `needs_review == False` 且结果长度 < 1500 字符。
  - 单次响应，无显式多智能体或复杂编排需求。
- 自动转工作台的条件：
  - `needs_review == True`。
  - 操作为 `generate` 或 `analyze` 且结果长度 ≥ 3000。
  - 检测到多智能体协作或多文件输入。
  - 用户主动选择“在工作台继续”。

#### 在首页的操作按钮
- 结果卡片显示：
  - 下载结果按钮：始终可用。
  - 审核按钮：当 `needs_review == True` 显示。
  - 在工作台继续按钮：当判定为重任务或用户选择时显示，跳转至工作台页面。

### 5.2 工作台（Workbench）
- 需求：左侧文件资源管理器、主编辑区多标签页、右侧智能体状态面板、底部日志与状态栏。
- 标签类型：文档编辑器、对话窗口、数据可视化、工作流视图、审核面板。
- 工作流可视化：展示当前节点与状态、审核分支与错误分支。
- 待实现：新增模板 `workbench.html` 与对应路由，联动工作流与智能体状态。

### 5.3 文档处理工作流
- 支持操作：`summarize`、`generate`、`convert`、`extract_table`、`extract_key_points`、`analyze`；提示词构造在 `tools/document_tools.py:12-130`。
- 状态结构：`DocumentState` 字段见 `graph/document_graph.py:20-34`。
- 节点：
  - 读取文件：`graph/document_graph.py:36-57`
  - 验证文件：`graph/document_graph.py:60-69`
  - AI 处理：`graph/document_graph.py:71-130`
  - 人工审核：`graph/document_graph.py:132-146`
  - 保存结果：`graph/document_graph.py:148-185`
  - 错误处理：`graph/document_graph.py:188-210`
- 条件与分支：
  - 是否审核：`graph/document_graph.py:214-221`（长度>3000、生成操作、低置信标记）
  - 审核后分支：`graph/document_graph.py:223-230`
- 编译与执行：`graph/document_graph.py:275-277`、`graph/document_graph.py:323-335`

### 5.4 多智能体协作与聊天
- 智能体角色：文档分析师、内容创作者、数据专家、校对编辑、翻译专家、协调者（定义与系统 Prompt 位于 `agents/multi_agents.py:103-299`）。
- 注册与信息：`agents/multi_agents.py:301-354`（注册中心与信息列表）。
- 路由策略：关键词启发式与 @ 提及解析，`agents/multi_agents.py:356-418`。
- 会话管理：`agents/multi_agents.py:420-467`，历史格式统一。
- 入口接口：对话 API `app.py:625-692`。
- 待增强：场景优先路由（配置 SCENARIO_ROUTING），新增投研分析师/风控专家与法规库。

### 5.5 审核闭环
- 需求：合规官主导的审核闭环；自动审核→修改建议→复审→通过/人工介入。
- 工作流联动：使用 `DocumentState.needs_review` 与 `review_approved`；前端提供审核面板；后端设置审批结果后走 `should_continue_after_review` 逻辑。
- 当前实现：标记审核与分支已具备，前端面板与审批接口待补齐。

### 5.6 文件与结果管理
- 上传限制：单文件最大 50MB，`app.py:370-377`。
- 存储目录：`uploads/`；结果文件与 `.metadata.json`，`graph/document_graph.py:148-176`。
- 下载：`app.py:454-479`（自动媒体类型）。
- 最近文件：`app.py:491-516`；清理：`app.py:526-549`。

## 6. API 规范
- 首页：`GET /`（HTML），`app.py:49-343`
- 文档上传处理：`POST /upload`，`app.py:346-453`
  - 表单字段：`file`、`operation`、`instruction`
  - 成功响应：`success`、`message`、`file_info`、`result_preview`、`output_file`、`needs_review`、`metadata`
- 下载结果：`GET /download/{filename}`，`app.py:454-479`
- 支持格式：`GET /supported-formats`，`app.py:482-488`
- 最近文件：`GET /recent-files`，`app.py:491-516`
- 清理上传：`DELETE /clear-uploads`，`app.py:526-549`
- 健康检查：`GET /health`，`app.py:553-561`
- API 信息：`GET /api/info`，`app.py:564-589`
- 聊天页面：`GET /chat`，`app.py:594-597`
- 指挥中心页面：`GET /command`，`app.py:600-603`
- 智能体列表：`GET /api/agents`，`app.py:606-615`
- 聊天：`POST /api/chat`（支持文档与纯文本），`app.py:625-692`
- 清除聊天：`POST /api/chat/clear`，`app.py:694-711`
- 聊天历史：`GET /api/chat/history`，`app.py:713-729`

## 7. 数据模型
- 文档状态：`DocumentState`，`graph/document_graph.py:20-34`
- 元数据结构：`graph/document_graph.py:162-169`
- 会话历史记录项：`agents/multi_agents.py:427-435`
- 智能体信息：`agents/multi_agents.py:343-353`

## 8. 配置与部署
- 环境变量：`.env`（示例见 `.env.example:8-13` Kimi；可选 OpenAI/Gemini/Vertex）。
- 运行：`uvicorn` 启动，`app.py:731-760`。
- 依赖：`requirements.txt:1-13`。

## 9. 安全与合规
- 秘钥管理：使用环境变量；不在代码中硬编码。
- 文件限制与清理：上传大小限制、结果文件下载类型校验、上传目录清理接口。
- 审核机制：敏感输出与长文本标记人工审核；提供复审与拒绝分支。
- 日志与隐私：异常打印与追踪，避免持久化敏感信息。

## 10. 性能与可用性
- 性能指标：API 响应时间、工作流处理耗时、文件大小影响；状态栏展示（工作台）。
- 可用性：转场与布局清晰、零学习成本入口、多标签页与智能体状态可视化。

## 11. 监控与可观察性
- 日志面板：输出/终端/问题/调试；工作流节点状态与结果长度提示。
- 统计：上传次数、成功/审核/失败计数，首页与工作台汇总展示。

## 12. 测试与验收
- 单元测试：文件类型检测与读取、提示词生成、工作流分支、API 响应格式。
- 集成测试：上传→处理→审核→保存→下载全链路；聊天路由与历史。
- 验收标准：各场景成功执行；审核闭环可用；工作台可视化正确；API 文档一致。

## 13. 迭代计划
- 迭代 1：场景化首页改造，工作台基础页面，场景路由表引入。
- 迭代 2：投研分析师/风控专家新增、合规官法规库接入，审核面板与复审流程。
- 迭代 3：工作流可视化完善、状态栏指标、最近会话恢复与项目上下文 `GEMINI.md`。

## 14. 风险与缓解
- LLM 配额与回退：模型容量不足时回退/重试；提示词长度控制与分段处理。
- 大文件处理：限制与分片；表格提取和解析失败时错误报告与重试策略。
- 合规风险：规则库更新与人工复审兜底。

## 15. 兼容与扩展
- MCP/扩展：指挥中心引入外部工具与服务（GitHub、数据源）；安全限制工具集。
- 模型可切换：保留 Gemini/OpenAI/Vertex 可选配置；默认 Kimi 实现。

---

### 附录 A：代码位置索引
- 首页：`app.py:49-343`
- 上传处理：`app.py:346-453`
- 下载：`app.py:454-479`
- 支持格式：`app.py:482-488`
- 最近文件：`app.py:491-516`
- 清理上传：`app.py:526-549`
- 健康检查：`app.py:553-561`
- API 信息：`app.py:564-589`
- 聊天页面：`app.py:594-597`
- 指挥中心：`app.py:600-603`
- 智能体列表：`app.py:606-615`
- 聊天：`app.py:625-692`
- 聊天清理：`app.py:694-711`
- 聊天历史：`app.py:713-729`
- 运行配置：`app.py:731-760`
- 文档工作流：`graph/document_graph.py:20-34`、`36-57`、`60-69`、`71-130`、`132-146`、`148-185`、`188-210`、`214-221`、`223-230`、`275-277`、`323-335`
- 智能体与路由：`agents/multi_agents.py:103-299`、`301-354`、`356-418`、`420-467`、`469-539`、`541-552`
- 文档智能体（Kimi）：`agents/document_agent.py:20-35`、`41-81`、`84-140`、`142-178`、`187-215`
- 提示词：`tools/document_tools.py:12-130`
