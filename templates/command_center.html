<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentDesk - 资管智能体工作台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #121212;
            --primary: #FF6B00;
            --primary-gradient: linear-gradient(135deg, #FF8800 0%, #FF6B00 100%);
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            --backdrop-blur: blur(16px);
            --radius-lg: 24px;
            --radius-md: 16px;
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* 背景动画 */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255, 107, 0, 0.05) 0%, transparent 50%);
            z-index: 0;
        }

        .grid-lines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(50px);
            }
        }

        /* 主容器 */
        .container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        /* 顶部栏 */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--radius-md);
            backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--glass-shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(255, 107, 0, 0.3);
        }

        .logo i {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .system-status {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            animation: blink 1.5s ease-in-out infinite;
        }

        /* 全局控制按钮 */
        .global-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 0 20px;
        }

        .global-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid rgba(255, 107, 0, 0.3);
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .global-control-btn:hover {
            background: rgba(255, 107, 0, 0.25);
            border-color: var(--primary);
            color: #FF8800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.4);
        }

        .global-control-btn:active {
            transform: translateY(0);
        }

        .global-control-btn.active {
            background: rgba(255, 107, 0, 0.3);
            border-color: #FF8800;
            color: #FF8800;
            box-shadow: 0 0 8px rgba(255, 107, 0, 0.5);
        }

        .global-control-btn i {
            color: inherit;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* 主要内容区 */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        /* 左侧：智能体列表 */
        .agents-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--radius-md);
            backdrop-filter: var(--backdrop-blur);
            padding: 20px;
            overflow-y: auto;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
        }

        .agents-panel.collapsed {
            width: 50px;
            min-width: 50px;
            padding: 10px 5px;
        }

        .agents-panel.collapsed .panel-header,
        .agents-panel.collapsed .agent-card,
        .agents-panel.collapsed button {
            display: none;
        }

        .panel-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapse-toggle {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .collapse-toggle:hover {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }

        .collapse-indicator {
            display: none;
            cursor: pointer;
            padding: 8px;
            color: var(--primary);
            font-size: 1.2rem;
            text-align: center;
            transition: all 0.2s;
        }

        .collapsed .collapse-indicator {
            display: block;
        }

        .collapse-indicator:hover {
            transform: scale(1.2);
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .agent-card:hover::before {
            left: 100%;
        }

        .agent-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.15);
            transform: translateY(-2px);
        }

        .agent-card.active {
            background: rgba(255, 107, 0, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.2);
        }

        .agent-card.working {
            animation: cardPulse 2s ease-in-out infinite;
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(255, 107, 0, 0.4);
        }

        .agent-card.dimmed {
            opacity: 0.2;
            filter: grayscale(100%) blur(1px);
            transform: scale(0.95);
            transition: all 0.5s ease;
        }

        .workflow-node.dimmed {
            opacity: 0.2;
            filter: grayscale(100%);
            border-color: rgba(255, 255, 255, 0.05);
            transition: all 0.5s ease;
        }

        @keyframes cardPulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(255, 107, 0, 0.2);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 107, 0, 0.5);
            }
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .agent-emoji {
            font-size: 2rem;
            filter: drop-shadow(0 0 5px var(--primary));
        }

        .agent-status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .agent-status-badge.idle {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        .agent-status-badge.working {
            background: rgba(255, 107, 0, 0.2);
            color: var(--primary);
            animation: badgePulse 1s ease-in-out infinite;
        }

        @keyframes badgePulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .agent-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .agent-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .agent-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* 中间：工作流可视化 */
        .workflow-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--radius-md);
            backdrop-filter: var(--backdrop-blur);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
        }

        .workflow-panel.collapsed {
            padding: 10px;
        }

        .workflow-panel.collapsed .workflow-canvas {
            height: 0;
            min-height: 0;
            overflow: hidden;
        }

        .workflow-panel.collapsed .workflow-controls {
            display: none;
        }

        .workflow-canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #workflowCanvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .workflow-nodes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .workflow-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #121212;
            border: 2px solid rgba(255, 107, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
            pointer-events: auto;
            cursor: pointer;
        }

        .workflow-node:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.3);
            z-index: 10;
        }

        .workflow-node.working {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            animation: nodePulse 1.5s infinite;
        }

        @keyframes nodePulse {
            0% {
                box-shadow: 0 0 10px rgba(255, 107, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 107, 0, 0.6);
            }

            100% {
                box-shadow: 0 0 10px rgba(255, 107, 0, 0.3);
            }
        }

        .workflow-node i {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .workflow-node span {
            font-size: 10px;
            color: #fff;
            text-align: center;
            white-space: nowrap;
        }

        .workflow-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .control-btn {
            flex: 1;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .control-btn:hover {
            background: rgba(255, 107, 0, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* 右侧：任务控制台 */
        .console-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--radius-md);
            backdrop-filter: var(--backdrop-blur);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
        }

        .console-panel.collapsed {
            width: 50px;
            min-width: 50px;
            padding: 10px 5px;
        }

        .console-panel.collapsed .panel-header,
        .console-panel.collapsed .quick-actions,
        .console-panel.collapsed .task-input-area,
        .console-panel.collapsed .execute-btn,
        .console-panel.collapsed .cancel-btn,
        .console-panel.collapsed .console-log {
            display: none;
        }

        .task-input-area {
            margin-bottom: 15px;
        }

        .task-input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .task-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.2);
        }

        .execute-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);
        }

        .execute-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.5);
            transform: translateY(-2px);
        }

        .execute-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cancel-btn {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .cancel-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        .cancel-btn:active {
            transform: translateY(0);
        }

        .console-log {
            flex: 1;
            max-height: 400px;
            min-height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        /* 自定义滚动条 */
        .console-log::-webkit-scrollbar {
            width: 8px;
        }

        .console-log::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .console-log::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 0, 0.3);
            border-radius: 4px;
        }

        .console-log::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 0, 0.5);
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 2px solid var(--border);
            padding-left: 12px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-timestamp {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-right: 10px;
        }

        .log-agent {
            color: var(--primary);
            font-weight: 600;
            margin-right: 10px;
        }

        .log-message {
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .log-entry.system {
            border-left-color: var(--secondary);
        }

        .log-entry.agent {
            border-left-color: var(--primary);
        }

        .log-entry.error {
            border-left-color: #ff4444;
            color: #ff4444;
        }

        .log-entry.success {
            border-left-color: var(--primary);
        }

        /* 快捷操作 */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-action {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .quick-action:hover {
            background: rgba(255, 107, 0, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* 粒子效果 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.5;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }

            10% {
                opacity: 0.5;
            }

            90% {
                opacity: 0.5;
            }

            100% {
                transform: translateY(-100vh) translateX(50px);
                opacity: 0;
            }
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* 响应式 */
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }

            .agents-panel {
                max-height: 200px;
            }
        }

        .file-upload-container {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload-label {
            cursor: pointer;
            color: var(--primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border: 1px solid var(--primary);
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 107, 0, 0.05);
        }

        .file-upload-label:hover {
            background: rgba(255, 107, 0, 0.15);
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.2);
        }

        .file-name {
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: none;
        }

        /* 智能体下拉菜单 */
        .agent-dropdown {
            position: absolute;
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 1000;
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .agent-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .agent-option:hover,
        .agent-option.selected {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }

        .agent-option i {
            width: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- 背景效果 -->
    <div class="background"></div>
    <div class="grid-lines"></div>
    <div class="particles" id="particles"></div>

    <!-- 主容器 -->
    <div class="container">
        <!-- 顶部状态栏 -->
        <div class="top-bar">
            <div class="logo">
                <i class="fas fa-brain"></i>
                <span>AGENTDESK</span>
            </div>
            
            <!-- 全局控制按钮 -->
            <div class="global-controls">
                <button class="global-control-btn" onclick="togglePanel('agents')" title="切换智能体面板 (Ctrl+B)">
                    <i class="fas fa-users"></i>
                </button>
                <button class="global-control-btn" onclick="togglePanel('workflow')" title="切换工作流画布 (Ctrl+J)">
                    <i class="fas fa-project-diagram"></i>
                </button>
                <button class="global-control-btn" onclick="togglePanel('console')" title="切换控制台">
                    <i class="fas fa-terminal"></i>
                </button>
                <button class="global-control-btn" onclick="toggleAllPanels()" title="展开/折叠所有">
                    <i class="fas fa-expand-arrows-alt" id="expandAllIcon"></i>
                </button>
            </div>
            
            <div class="system-status">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>系统在线</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-microchip"></i>
                    <span id="activeAgents">0/6</span> 活跃
                </div>
                <div class="status-item">
                    <i class="fas fa-tasks"></i>
                    <span id="taskCount">0</span> 任务
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span id="systemTime">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- 主要内容区 -->
        <div class="main-content">
            <!-- 左侧：智能体面板 -->
            <div class="agents-panel" id="agentsPanel">
                <div class="collapse-indicator" onclick="togglePanel('agents')">
                    <i class="fas fa-angle-right"></i>
                </div>
                <div class="panel-header">
                    <span><i class="fas fa-users"></i> 智能体团队</span>
                    <i class="fas fa-angle-left collapse-toggle" onclick="togglePanel('agents')" title="折叠"></i>
                </div>
                <div id="agentsList">
                    <!-- 智能体卡片将动态生成 -->
                </div>
            </div>

            <!-- 中间：工作流可视化 -->
            <div class="workflow-panel" id="workflowPanel">
                <div class="panel-header">
                    <span><i class="fas fa-project-diagram"></i> 工作流可视化</span>
                    <i class="fas fa-angle-down collapse-toggle" onclick="togglePanel('workflow')" title="折叠"></i>
                </div>
                <div class="workflow-canvas">
                    <canvas id="workflowCanvas"></canvas>
                    <div id="workflowNodes" class="workflow-nodes"></div>
                </div>
                <div class="workflow-controls">
                    <button class="control-btn" onclick="clearWorkflow()">
                        <i class="fas fa-eraser"></i> 清除
                    </button>
                    <button class="control-btn" onclick="exportWorkflow()">
                        <i class="fas fa-download"></i> 导出
                    </button>
                    <button class="control-btn" onclick="toggleAutoLayout()">
                        <i class="fas fa-magic"></i> 自动布局
                    </button>
                </div>
            </div>

            <!-- 右侧：任务控制台 -->
            <div class="console-panel" id="consolePanel">
                <div class="collapse-indicator" onclick="togglePanel('console')">
                    <i class="fas fa-angle-left"></i>
                </div>
                <div class="panel-header">
                    <span><i class="fas fa-terminal"></i> 任务控制台</span>
                    <i class="fas fa-angle-right collapse-toggle" onclick="togglePanel('console')" title="折叠"></i>
                </div>

                <!-- 快捷操作 -->
                <div class="quick-actions">
                    <div class="quick-action" onclick="useTemplate('analyze')">
                        <i class="fas fa-chart-line"></i> 文档分析
                    </div>
                    <div class="quick-action" onclick="useTemplate('write')">
                        <i class="fas fa-pen-fancy"></i> 内容创作
                    </div>
                    <div class="quick-action" onclick="window.location.href='/analytics'">
                        <i class="fas fa-chart-bar"></i> 数据分析
                    </div>
                    <div class="quick-action" onclick="useTemplate('translate')">
                        <i class="fas fa-language"></i> 翻译文档
                    </div>
                </div>

                <!-- 任务输入 -->
                <div class="task-input-area" style="position: relative;">
                    <div class="file-upload-container">
                        <label for="fileInput" class="file-upload-label">
                            <i class="fas fa-paperclip"></i> 上传文档 (可选)
                        </label>
                        <input type="file" id="fileInput" class="file-input" style="display: none;"
                            onchange="updateFileName(this)">
                        <span id="fileName" class="file-name"></span>
                    </div>
                    <textarea id="taskInput" class="task-input" rows="4"
                        placeholder="> 输入任务指令...&#10;> 可使用 @智能体名称 指定执行者&#10;> 示例：@文档分析师 分析季度报告"></textarea>
                    <!-- 智能体下拉菜单 -->
                    <div id="agentDropdown" class="agent-dropdown"></div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="execute-btn" id="executeBtn" onclick="executeTask()" style="flex: 1;">
                        <i class="fas fa-play"></i> 执行任务
                    </button>
                    <button class="cancel-btn" id="cancelBtn" onclick="cancelTask()" style="display: none;">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>

                <!-- 控制台日志 -->
                <div class="console-log" id="consoleLog">
                    <div class="log-entry system">
                        <span class="log-timestamp">[00:00:00]</span>
                        <span class="log-message">系统初始化完成，等待指令...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 全局变量
        let agents = [];
        let canvas, ctx;
        let workflowNodes = [];
        let workflowConnections = [];
        let taskCounter = 0;
        let animationId = null;
        let currentAbortController = null; // 用于取消请求

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            initParticles();
            initCanvas();
            loadAgents();
            startSystemTime();
            startAnimation();
        });

        // 初始化粒子效果
        function initParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // 初始化Canvas
        function initCanvas() {
            canvas = document.getElementById('workflowCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawWorkflow();
        }

        // 加载智能体
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                if (data.success) {
                    agents = data.agents.map(agent => ({
                        ...agent,
                        status: 'idle',
                        tasksCompleted: 0,
                        position: null
                    }));
                    renderAgents();
                    updateSystemStatus();
                }
            } catch (error) {
                logMessage('error', 'SYSTEM', '加载智能体失败: ' + error.message);
            }
        }

        // 渲染智能体列表
        function renderAgents() {
            const container = document.getElementById('agentsList');
            container.innerHTML = agents.map((agent, index) => `
                <div class="agent-card ${agent.status}" data-agent-id="${index}">
                    <div class="agent-header">
                        <div class="agent-emoji"><i class="${agent.emoji}"></i></div>
                        <div class="agent-status-badge ${agent.status}">${agent.status}</div>
                    </div>
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-role">${agent.role}</div>
                    <div class="agent-stats">
                        <span>任务: ${agent.tasksCompleted}</span>
                        <span>负载: 0%</span>
                    </div>
                </div>
            `).join('');

            // 初始化智能体位置
            initAgentPositions();
        }

        // 初始化智能体位置（协调者居中，其他环绕）
        function initAgentPositions() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;

            // 找到协调者
            const coordinatorIndex = agents.findIndex(a => a.name === '协调者');

            // 过滤出其他智能体
            const circleAgents = agents.filter(a => a.name !== '协调者');

            // 布局圆环上的智能体
            circleAgents.forEach((agent, index) => {
                const angle = (index / circleAgents.length) * Math.PI * 2 - Math.PI / 2;
                // 找到该智能体在原数组中的索引，更新其位置
                const originalIndex = agents.findIndex(a => a.name === agent.name);
                if (originalIndex !== -1) {
                    agents[originalIndex].position = {
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius
                    };
                }
            });

            // 设置协调者位置为中心
            if (coordinatorIndex !== -1) {
                agents[coordinatorIndex].position = { x: centerX, y: centerY };
            }

            drawWorkflow();
            renderWorkflowNodes();
        }

        // 渲染工作流节点（DOM）
        function renderWorkflowNodes() {
            const container = document.getElementById('workflowNodes');
            container.innerHTML = agents.map((agent, index) => {
                if (!agent.position) return '';
                return `
                    <div class="workflow-node ${agent.status}" 
                         style="left: ${agent.position.x}px; top: ${agent.position.y}px;"
                         onclick="selectAgent(${index})">
                        <i class="${agent.emoji}"></i>
                        <span>${agent.name}</span>
                    </div>
                `;
            }).join('');
        }

        // 绘制工作流（仅连线）
        function drawWorkflow() {
            if (!ctx) return;

            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制连接线
            workflowConnections.forEach(conn => {
                drawConnection(conn);
            });

            // 绘制智能体节点 - 改为 DOM 渲染，此处不再绘制
            // agents.forEach((agent, index) => {
            //     if (agent.position) {
            //         drawAgentNode(agent, index);
            //     }
            // });
        }

        // 绘制智能体节点
        function drawAgentNode(agent, index) {
            const x = agent.position.x;
            const y = agent.position.y;
            const radius = 40;

            // 外圈光晕
            if (agent.status === 'working') {
                const gradient = ctx.createRadialGradient(x, y, radius, x, y, radius + 20);
                gradient.addColorStop(0, 'rgba(0, 255, 136, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, radius + 20, 0, Math.PI * 2);
                ctx.fill();
            }

            // 主圆圈
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(15, 23, 42, 0.9)';
            ctx.fill();
            ctx.strokeStyle = agent.status === 'working' ? '#00ff88' : 'rgba(0, 255, 136, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 绘制emoji
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(agent.emoji, x, y);

            // 绘制名称
            ctx.font = '12px Arial';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(agent.name, x, y + radius + 20);
        }

        // 绘制连接线
        function drawConnection(conn) {
            const fromIndex = conn.from;
            const toIndex = conn.to;
            const progress = conn.progress;

            // 验证索引有效性
            if (fromIndex < 0 || toIndex < 0 || fromIndex >= agents.length || toIndex >= agents.length) {
                return;
            }

            const fromAgent = agents[fromIndex];
            const toAgent = agents[toIndex];

            if (!fromAgent || !toAgent || !fromAgent.position || !toAgent.position) {
                return;
            }

            const from = fromAgent.position;
            const to = toAgent.position;

            // 创建渐变色
            const gradient = ctx.createLinearGradient(from.x, from.y, to.x, to.y);
            gradient.addColorStop(0, 'rgba(255, 107, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 107, 0, 0.8)');

            // 绘制线条
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);

            const currentX = from.x + (to.x - from.x) * progress;
            const currentY = from.y + (to.y - from.y) * progress;
            ctx.lineTo(currentX, currentY);

            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            // 添加发光效果
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(255, 107, 0, 0.6)';

            ctx.stroke();

            // 重置阴影
            ctx.shadowBlur = 0;

            // 绘制流动的粒子效果 (仅当线条完全画出后)
            if (progress >= 1) {
                if (!conn.particles) conn.particles = [];

                // 添加新粒子
                if (Math.random() < 0.1) { // 控制粒子生成频率
                    conn.particles.push({ t: 0, speed: 0.02 + Math.random() * 0.02 });
                }

                // 更新和绘制粒子
                for (let i = conn.particles.length - 1; i >= 0; i--) {
                    const p = conn.particles[i];
                    p.t += p.speed;

                    if (p.t >= 1) {
                        conn.particles.splice(i, 1);
                        continue;
                    }

                    const px = from.x + (to.x - from.x) * p.t;
                    const py = from.y + (to.y - from.y) * p.t;

                    ctx.beginPath();
                    ctx.arc(px, py, 3, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${1 - p.t})`; // 渐隐
                    ctx.shadowBlur = 5;
                    ctx.shadowColor = '#fff';
                    ctx.fill();
                }
            } else {
                // 绘制头部的粒子
                ctx.beginPath();
                ctx.arc(currentX, currentY, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#FF6B00';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#FF6B00';
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // 更新文件名显示
        function updateFileName(input) {
            const fileNameSpan = document.getElementById('fileName');
            if (input.files && input.files.length > 0) {
                fileNameSpan.textContent = input.files[0].name;
                fileNameSpan.style.display = 'inline-block';
            } else {
                fileNameSpan.textContent = '';
                fileNameSpan.style.display = 'none';
            }
        }

        // 执行任务
        async function executeTask() {
            const input = document.getElementById('taskInput');
            const message = input.value.trim();
            const fileInput = document.getElementById('fileInput');
            const executeBtn = document.getElementById('executeBtn');

            if (!message && (!fileInput.files || fileInput.files.length === 0)) return;

            // 切换按钮显示
            executeBtn.style.display = 'none';
            const cancelBtn = document.getElementById('cancelBtn');
            cancelBtn.style.display = 'block';

            // 清除旧的连接和状态
            workflowConnections = [];
            agents.forEach(a => a.status = 'idle');
            renderAgents();
            renderWorkflowNodes();

            taskCounter++;
            updateSystemStatus();

            let userLogMessage = `任务 #${taskCounter}: ${message}`;
            if (fileInput.files.length > 0) {
                userLogMessage += ` [上传文件: ${fileInput.files[0].name}]`;
            }
            logMessage('system', 'USER', userLogMessage);

            // 进度提示定时器
            const progressMessages = [
                "正在分析文档结构...",
                "正在提取关键信息...",
                "正在识别用户意图...",
                "正在路由至合适智能体...",
                "智能体正在思考中..."
            ];
            let msgIndex = 0;
            const progressInterval = setInterval(() => {
                if (msgIndex < progressMessages.length) {
                    logMessage('system', 'SYSTEM', progressMessages[msgIndex++]);
                }
            }, 2000);

            // 视觉效果：协调者开始工作
            const coordinatorIndex = agents.findIndex(a => a.name === '协调者');
            if (coordinatorIndex !== -1) {
                agents[coordinatorIndex].status = 'working';
                // 变暗其他
                agents.forEach((a, idx) => {
                    if (idx !== coordinatorIndex) a.status = 'dimmed';
                });
                renderAgents();
                renderWorkflowNodes();
            }

            // 移除立即连接逻辑，等待任务结果返回后再连接

            try {
                // 创建 AbortController
                currentAbortController = new AbortController();
                const timeoutId = setTimeout(() => currentAbortController.abort(), 60000);

                const formData = new FormData();
                formData.append('message', message);

                if (fileInput.files.length > 0) {
                    formData.append('document', fileInput.files[0]);
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData,
                    signal: currentAbortController.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    const agent = agents.find(a => a.name === result.agent.name);

                    if (!agent) {
                        logMessage('success', result.agent.name, `任务完成`);
                        logMessage('success', result.agent.name, result.response);
                        return;
                    }

                    const agentIndex = agents.indexOf(agent);

                    // 视觉效果：
                    // 1. 保持协调者高亮
                    // 2. 其他智能体（包括目标智能体）先变暗
                    // 3. 连线到达后，目标智能体变亮

                    if (coordinatorIndex !== -1) {
                        agents[coordinatorIndex].status = 'working';
                    }

                    agents.forEach((a, idx) => {
                        if (idx !== coordinatorIndex) {
                            a.status = 'dimmed';
                        }
                    });
                    renderAgents();
                    renderWorkflowNodes();

                    // 如果不是协调者自己工作，则显示从协调者到该智能体的连线
                    if (coordinatorIndex !== -1 && coordinatorIndex !== agentIndex) {
                        addWorkflowConnection(coordinatorIndex, agentIndex);

                        // 等待连线动画到达 (800ms) 后点亮目标智能体
                        setTimeout(() => {
                            agent.status = 'working';
                            agent.tasksCompleted++;
                            renderAgents();
                            renderWorkflowNodes();
                        }, 800);
                    } else {
                        // 如果是协调者自己，或者没有协调者，直接点亮
                        agent.status = 'working';
                        agent.tasksCompleted++;
                        renderAgents();
                        renderWorkflowNodes();
                    }

                    updateSystemStatus();

                    logMessage('agent', result.agent.name, `开始处理任务...`);

                    // 模拟处理延迟后显示结果
                    setTimeout(() => {
                        // 不恢复状态，保持高亮和连接，直到下一次任务
                        // agents.forEach(a => a.status = 'idle');
                        // renderAgents();
                        // renderWorkflowNodes();
                        updateSystemStatus();

                        logMessage('success', result.agent.name, `任务完成`);
                        logMessage('agent', result.agent.name, result.response);

                        if (result.routing_info && result.routing_info.reason) {
                            logMessage('system', 'ROUTER', result.routing_info.reason);
                        }
                    }, 2000);
                } else {
                    logMessage('error', 'SYSTEM', '任务执行失败: ' + result.error);
                    // 恢复状态
                    agents.forEach(a => a.status = 'idle');
                    renderWorkflowNodes();
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    logMessage('error', 'SYSTEM', '任务已取消');
                } else if (error.message.includes('Failed to fetch')) {
                    logMessage('error', 'SYSTEM', '网络错误: 无法连接到服务器');
                } else {
                    logMessage('error', 'SYSTEM', '请求失败: ' + error.message);
                }
                // 恢复状态
                agents.forEach(a => a.status = 'idle');
                renderWorkflowNodes();
            } finally {
                clearInterval(progressInterval);
                // 恢复按钮状态
                executeBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                currentAbortController = null;
                input.value = '';
                fileInput.value = '';
                updateFileName(fileInput);
            }
        }

        // 取消任务
        function cancelTask() {
            if (currentAbortController) {
                currentAbortController.abort();
                
                // 立即恢复按钮状态
                const executeBtn = document.getElementById('executeBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                executeBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                
                // 恢复智能体状态
                agents.forEach(a => a.status = 'idle');
                renderAgents();
                renderWorkflowNodes();
                workflowConnections = [];
            }
        }

        // 添加工作流连接
        function addWorkflowConnection(fromIndex, toIndex) {
            // 检查是否已存在连接
            const exists = workflowConnections.find(c => c.from === fromIndex && c.to === toIndex);
            if (exists) return;

            const connection = {
                from: fromIndex,
                to: toIndex,
                progress: 0,
                particles: [],
                id: Date.now()
            };

            workflowConnections.push(connection);

            // 动画进度
            const duration = 800; // 0.8秒画线
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                connection.progress = Math.min(elapsed / duration, 1);

                if (connection.progress < 1) {
                    requestAnimationFrame(animate);
                }
                // 不再自动移除连接，保持显示直到下一次任务开始
            }

            animate();
        }

        // 记录日志
        function logMessage(type, agent, message) {
            const log = document.getElementById('consoleLog');
            const time = new Date().toLocaleTimeString();

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="log-timestamp">[${time}]</span>
                <span class="log-agent">${agent}:</span>
                <span class="log-message">${message}</span>
            `;

            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // 更新系统状态
        function updateSystemStatus() {
            const activeCount = agents.filter(a => a.status === 'working').length;
            document.getElementById('activeAgents').textContent = `${activeCount}/${agents.length}`;
            document.getElementById('taskCount').textContent = taskCounter;
        }

        // 系统时间
        function startSystemTime() {
            setInterval(() => {
                const now = new Date();
                const time = now.toLocaleTimeString('zh-CN', { hour12: false });
                document.getElementById('systemTime').textContent = time;
            }, 1000);
        }

        // 动画循环
        function startAnimation() {
            function animate() {
                drawWorkflow();
                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        // 使用模板
        function useTemplate(type) {
            const templates = {
                analyze: '@文档分析师 分析这份文档并提取关键信息',
                write: '@内容创作者 撰写一份专业的商务报告',
                data: '@数据专家 分析数据趋势并提供洞察',
                translate: '@翻译专家 将以下内容翻译成英文'
            };

            document.getElementById('taskInput').value = templates[type];
        }

        // 清除工作流
        function clearWorkflow() {
            workflowConnections = [];
            taskCounter = 0;
            updateSystemStatus();
            document.getElementById('consoleLog').innerHTML = `
                <div class="log-entry system">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="log-message">工作流已清除</span>
                </div>
            `;
        }

        // 导出工作流
        function exportWorkflow() {
            logMessage('system', 'SYSTEM', '导出功能开发中...');
        }

        // 切换自动布局
        function toggleAutoLayout() {
            initAgentPositions();
            logMessage('system', 'SYSTEM', '已应用自动布局');
        }

        // 键盘快捷键
        const taskInput = document.getElementById('taskInput');
        const dropdown = document.getElementById('agentDropdown');
        let selectedOptionIndex = -1;

        taskInput.addEventListener('keydown', function (e) {
            if (dropdown.style.display === 'block') {
                const options = dropdown.getElementsByClassName('agent-option');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedOptionIndex = (selectedOptionIndex + 1) % options.length;
                    updateDropdownSelection(options);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedOptionIndex = (selectedOptionIndex - 1 + options.length) % options.length;
                    updateDropdownSelection(options);
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    if (selectedOptionIndex > -1) {
                        options[selectedOptionIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
                return;
            }

            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                executeTask();
            }
        });

        // 监听输入以显示下拉菜单
        taskInput.addEventListener('input', function (e) {
            const value = this.value;
            const cursorPosition = this.selectionStart;
            const lastAtPos = value.lastIndexOf('@', cursorPosition - 1);

            if (lastAtPos !== -1) {
                const query = value.substring(lastAtPos + 1, cursorPosition);
                // 如果包含空格，则认为不是在输入用户名
                if (!query.includes(' ')) {
                    showAgentDropdown(query, lastAtPos);
                    return;
                }
            }
            dropdown.style.display = 'none';
        });

        function showAgentDropdown(query, atIndex) {
            const filteredAgents = agents.filter(a =>
                a.name.toLowerCase().includes(query.toLowerCase()) ||
                a.role.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredAgents.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = filteredAgents.map((agent, index) => `
                <div class="agent-option" onclick="insertAgentName('${agent.name}', ${atIndex})">
                    <i class="${agent.emoji}"></i>
                    <span>${agent.name}</span>
                    <span style="font-size: 0.8em; color: #666;">${agent.role}</span>
                </div>
            `).join('');

            // 定位下拉菜单 (简单定位，可优化)
            // 这里的定位比较简单，实际项目中可能需要计算光标的像素位置
            dropdown.style.top = (taskInput.offsetTop + taskInput.offsetHeight) + 'px';
            dropdown.style.left = taskInput.offsetLeft + 'px';
            dropdown.style.display = 'block';
            selectedOptionIndex = -1;
        }

        function updateDropdownSelection(options) {
            Array.from(options).forEach((opt, idx) => {
                if (idx === selectedOptionIndex) {
                    opt.classList.add('selected');
                    opt.scrollIntoView({ block: 'nearest' });
                } else {
                    opt.classList.remove('selected');
                }
            });
        }

        function insertAgentName(name, atIndex) {
            const input = document.getElementById('taskInput');
            const text = input.value;
            const before = text.substring(0, atIndex);
            const after = text.substring(input.selectionStart);

            input.value = `${before}@${name} ${after}`;
            input.focus();
            dropdown.style.display = 'none';
        }

        // 点击外部关闭下拉菜单
        document.addEventListener('click', function (e) {
            if (e.target !== taskInput && e.target !== dropdown) {
                dropdown.style.display = 'none';
            }
        });

        // 折叠/展开面板
        function togglePanel(panelType) {
            if (panelType === 'agents') {
                const panel = document.getElementById('agentsPanel');
                const toggle = panel.querySelector('.collapse-toggle');
                const indicator = panel.querySelector('.collapse-indicator i');
                
                panel.classList.toggle('collapsed');
                
                if (panel.classList.contains('collapsed')) {
                    toggle.classList.remove('fa-angle-left');
                    toggle.classList.add('fa-angle-right');
                    indicator.classList.remove('fa-angle-right');
                    indicator.classList.add('fa-angle-left');
                } else {
                    toggle.classList.remove('fa-angle-right');
                    toggle.classList.add('fa-angle-left');
                    indicator.classList.remove('fa-angle-left');
                    indicator.classList.add('fa-angle-right');
                }
            } else if (panelType === 'workflow') {
                const panel = document.getElementById('workflowPanel');
                const toggle = panel.querySelector('.collapse-toggle');
                
                panel.classList.toggle('collapsed');
                
                if (panel.classList.contains('collapsed')) {
                    toggle.classList.remove('fa-angle-down');
                    toggle.classList.add('fa-angle-up');
                    toggle.setAttribute('title', '展开');
                } else {
                    toggle.classList.remove('fa-angle-up');
                    toggle.classList.add('fa-angle-down');
                    toggle.setAttribute('title', '折叠');
                    
                    // 展开后重新渲染画布
                    setTimeout(() => {
                        resizeCanvas();
                    }, 300);
                }
            } else if (panelType === 'console') {
                const panel = document.getElementById('consolePanel');
                const toggle = panel.querySelector('.collapse-toggle');
                const indicator = panel.querySelector('.collapse-indicator i');
                
                panel.classList.toggle('collapsed');
                
                if (panel.classList.contains('collapsed')) {
                    toggle.classList.remove('fa-angle-right');
                    toggle.classList.add('fa-angle-left');
                    indicator.classList.remove('fa-angle-left');
                    indicator.classList.add('fa-angle-right');
                } else {
                    toggle.classList.remove('fa-angle-left');
                    toggle.classList.add('fa-angle-right');
                    indicator.classList.remove('fa-angle-right');
                    indicator.classList.add('fa-angle-left');
                }
            }
            
            updateGlobalControlButtons();
        }

        // 展开/折叠所有面板
        let allPanelsCollapsed = false;
        function toggleAllPanels() {
            const agentsPanel = document.getElementById('agentsPanel');
            const workflowPanel = document.getElementById('workflowPanel');
            const consolePanel = document.getElementById('consolePanel');
            const icon = document.getElementById('expandAllIcon');
            
            allPanelsCollapsed = !allPanelsCollapsed;
            
            if (allPanelsCollapsed) {
                // 全部折叠
                if (!agentsPanel.classList.contains('collapsed')) togglePanel('agents');
                if (!workflowPanel.classList.contains('collapsed')) togglePanel('workflow');
                if (!consolePanel.classList.contains('collapsed')) togglePanel('console');
                
                icon.classList.remove('fa-expand-arrows-alt');
                icon.classList.add('fa-compress-arrows-alt');
            } else {
                // 全部展开
                if (agentsPanel.classList.contains('collapsed')) togglePanel('agents');
                if (workflowPanel.classList.contains('collapsed')) togglePanel('workflow');
                if (consolePanel.classList.contains('collapsed')) togglePanel('console');
                
                icon.classList.remove('fa-compress-arrows-alt');
                icon.classList.add('fa-expand-arrows-alt');
            }
        }

        // 更新全局控制按钮状态
        function updateGlobalControlButtons() {
            const agentsPanel = document.getElementById('agentsPanel');
            const workflowPanel = document.getElementById('workflowPanel');
            const consolePanel = document.getElementById('consolePanel');
            
            // 检查是否所有面板都折叠了
            const allCollapsed = agentsPanel.classList.contains('collapsed') && 
                                 workflowPanel.classList.contains('collapsed') && 
                                 consolePanel.classList.contains('collapsed');
            
            allPanelsCollapsed = allCollapsed;
            const icon = document.getElementById('expandAllIcon');
            if (allCollapsed) {
                icon.classList.remove('fa-expand-arrows-alt');
                icon.classList.add('fa-compress-arrows-alt');
            } else {
                icon.classList.remove('fa-compress-arrows-alt');
                icon.classList.add('fa-expand-arrows-alt');
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + B: 切换智能体面板
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                togglePanel('agents');
            }
            // Ctrl/Cmd + J: 切换工作流画布
            if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
                e.preventDefault();
                togglePanel('workflow');
            }
        });
    </script>
</body>

</html>