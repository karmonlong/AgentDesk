<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center v2</title>
    <link href="/static/css/fontawesome.min.css" rel="stylesheet">
    <script src="/static/js/mermaid.min.js"></script>
    <script src="/static/js/mammoth.browser.min.js"></script>
    <script src="/static/js/xlsx.full.min.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <!-- PDF.js for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Markdown parser fallback
        function parseMarkdown(text) {
            if (typeof marked !== 'undefined') {
                try {
                    return marked.parse(text);
                } catch (e) {
                    console.error('Marked parse error:', e);
                }
            }
            // Simple fallback if marked is not loaded or fails
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        document.addEventListener("DOMContentLoaded", function () {
            mermaid.initialize({ startOnLoad: false, theme: 'dark' });
        });
    </script>
    <style>
        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #121212;
            --bg-tertiary: #1E1E1E;
            --primary: #FF6B00;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --border: #333;
            --activity-bar-width: 50px;
            --sidebar-width: 250px;
            --right-panel-width: 420px;
            --header-height: 40px;
            --status-bar-height: 25px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ==================== Landing Mode (Gemini Style) ==================== */
        #landing-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            background: radial-gradient(circle at 50% 50%, rgba(255, 107, 0, 0.05) 0%, transparent 60%);
        }

        .landing-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            opacity: 1;
        }

        .landing-logo:hover {
            transform: translateY(-2px);
            filter: brightness(1.2);
        }

        .landing-logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .landing-logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {

            0%,
            100% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            50% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .landing-logo-text {
            background: linear-gradient(135deg, #FFFFFF 0%, #CCCCCC 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-input-wrapper {
            width: 600px;
            max-width: 90%;
            position: relative;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .landing-input {
            width: 100%;
            padding: 18px 24px;
            padding-right: 50px;
            font-size: 1.1rem;
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            color: #fff;
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .landing-input:focus {
            background: rgba(40, 40, 40, 0.8);
            border-color: rgba(255, 107, 0, 0.5);
            box-shadow: 0 8px 30px rgba(255, 107, 0, 0.15);
        }

        .landing-submit {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .landing-submit:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }

        .landing-agent-mode-btn {
            position: absolute;
            right: -180px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #1a1a1a 30%, #FF6B00 100%);
            border: 1px solid rgba(255, 107, 0, 0.3);
            color: white;
            padding: 10px 24px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            opacity: 0.9;
            z-index: 10;
        }

        .landing-agent-mode-btn:hover {
            opacity: 1;
            transform: translateY(-52%) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 107, 0, 0.4);
            border-color: #FF6B00;
        }

        body.mode-workspace .landing-agent-mode-btn {
            display: none;
            pointer-events: none;
        }

        /* Landing Agents */
        .landing-agents {
            display: flex;
            gap: 25px;
            margin-bottom: 40px;
            padding: 10px;
            max-width: 90%;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .landing-agents::-webkit-scrollbar {
            display: none;
        }

        .landing-agent-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0.7;
            min-width: 80px;
        }

        .landing-agent-item:hover {
            transform: translateY(-10px);
            opacity: 1;
        }

        .landing-agent-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .landing-agent-item:hover .landing-agent-avatar {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4);
        }

        .landing-agent-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color 0.3s;
        }

        .landing-agent-item:hover .landing-agent-name {
            color: var(--text-primary);
        }

        /* Hide agents in workspace mode */
        body.mode-workspace .landing-agents {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        /* Landing Dropdown Override */
        .landing-dropdown {
            position: absolute !important;
            top: 100% !important;
            bottom: auto !important;
            left: 0 !important;
            right: 0 !important;
            border-radius: 0 0 12px 12px !important;
            margin-top: 4px !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            background: rgba(20, 20, 20, 0.98) !important;
            backdrop-filter: blur(20px) !important;
            border: 2px solid #FF6B00 !important;
            box-shadow: 0 8px 32px rgba(255, 107, 0, 0.5), 0 0 20px rgba(255, 107, 0, 0.3) !important;
            display: none !important;
            z-index: 999999 !important;
            pointer-events: auto !important;
        }

        .landing-dropdown.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            animation: slideDownFade 0.2s ease-out !important;
        }

        @keyframes slideDownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 确保 landing-input-wrapper 正确定位 */
        .landing-input-wrapper {
            position: relative !important;
            z-index: 100 !important;
        }

        /* ==================== Landing QA 整体布局 ==================== */
        .landing-qa-wrapper {
            display: flex;
            gap: 16px;
            width: 95%;
            max-width: 1200px;
            flex: 1;
            min-height: 0;
            margin-bottom: 20px;
            animation: fadeInUp 0.4s ease-out;
        }

        /* 问答模式下隐藏智能体图标区域和底部输入框，最大化内容空间 */
        body.qa-active .landing-agents {
            display: none !important;
        }

        body.qa-active .landing-input-wrapper {
            display: none !important;
        }

        body.qa-active .landing-content {
            justify-content: flex-start;
            padding-top: 20px;
        }

        /* 历史对话侧边栏 */
        .landing-qa-history {
            width: 260px;
            flex-shrink: 0;
            background: rgba(18, 18, 18, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .landing-qa-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .landing-qa-history-header h3 {
            margin: 0;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .landing-qa-history-header h3 svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .landing-qa-new-chat {
            background: linear-gradient(135deg, #FF8800 0%, #FF6B00 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .landing-qa-new-chat:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }

        .landing-qa-history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .landing-qa-history-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .landing-qa-history-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .landing-qa-history-item.active {
            background: rgba(255, 107, 0, 0.15);
            border: 1px solid rgba(255, 107, 0, 0.3);
        }

        .landing-qa-history-item-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .landing-qa-history-item-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* 主对话容器 - 拉宽 */
        .landing-qa-container {
            flex: 1;
            min-width: 0;
            background: rgba(18, 18, 18, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .landing-qa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .landing-qa-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .landing-qa-header-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .landing-qa-header-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .landing-qa-header-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .landing-qa-header-actions {
            display: flex;
            gap: 8px;
        }

        .landing-qa-action-btn {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .landing-qa-action-btn:hover {
            background: rgba(255, 107, 0, 0.15);
            border-color: rgba(255, 107, 0, 0.3);
            color: var(--primary);
        }

        .landing-qa-action-btn svg {
            width: 16px;
            height: 16px;
        }

        .landing-qa-messages {
            flex: 1;
            min-height: 0;
            /* 关键：允许 flex 子项收缩 */
            overflow-y: auto;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .landing-qa-message {
            display: flex;
            gap: 14px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .landing-qa-message.user {
            flex-direction: row-reverse;
        }

        .landing-qa-avatar {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .landing-qa-avatar svg {
            width: 20px;
            height: 20px;
        }

        .landing-qa-message.user .landing-qa-avatar {
            background: linear-gradient(135deg, #FF8800 0%, #FF6B00 100%);
            color: white;
        }

        .landing-qa-message.assistant .landing-qa-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .landing-qa-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .landing-qa-message.user .landing-qa-bubble {
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.2) 0%, rgba(255, 85, 0, 0.15) 100%);
            border: 1px solid rgba(255, 107, 0, 0.25);
            border-radius: 16px 16px 4px 16px;
        }

        .landing-qa-message.assistant .landing-qa-bubble {
            background: rgba(35, 35, 40, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px 16px 16px 4px;
        }

        /* AI 回答中的代码块样式 */
        .landing-qa-bubble code {
            background: rgba(255, 107, 0, 0.12);
            padding: 2px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85em;
        }

        .landing-qa-bubble pre {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 14px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .landing-qa-bubble pre code {
            background: transparent;
            padding: 0;
        }

        /* HTML 渲染区域 */
        .landing-qa-html-render {
            margin: 12px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }

        .landing-qa-html-render iframe {
            width: 100%;
            min-height: 200px;
            border: none;
            background: white;
            border-radius: 8px;
        }

        /* 预测问题区域 */
        .landing-qa-suggestions {
            flex-shrink: 0;
            /* 固定不收缩 */
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .landing-qa-suggestions-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .landing-qa-suggestions-title svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .landing-qa-suggestions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .landing-qa-suggestion {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.82rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .landing-qa-suggestion:hover {
            background: rgba(255, 107, 0, 0.12);
            border-color: rgba(255, 107, 0, 0.3);
            color: var(--primary);
            transform: translateY(-1px);
        }

        /* Agent 名称标签 */
        .landing-qa-agent-name {
            font-size: 0.75rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .landing-qa-agent-name svg {
            width: 12px;
            height: 12px;
        }

        /* 问答区域输入框 */
        .landing-qa-input-area {
            flex-shrink: 0;
            /* 固定不收缩 */
            padding: 16px 20px;
            background: rgba(30, 30, 30, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .landing-qa-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 12px;
            transition: all 0.2s;
        }

        .landing-qa-input-wrapper:focus-within {
            border-color: rgba(255, 107, 0, 0.4);
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        .landing-qa-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            padding: 8px 0;
        }

        .landing-qa-input::placeholder {
            color: var(--text-secondary);
        }

        .landing-qa-send-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #FF8800 0%, #FF6B00 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .landing-qa-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }

        .landing-qa-send-btn:active {
            transform: scale(0.95);
        }

        .landing-qa-send-btn svg {
            width: 18px;
            height: 18px;
        }

        .landing-qa-loading {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .landing-qa-loading span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .landing-qa-loading span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .landing-qa-loading span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .landing-qa-loading span:nth-child(3) {
            animation-delay: 0;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* 问答区域滚动条样式 */
        .landing-qa-messages::-webkit-scrollbar {
            width: 6px;
        }

        .landing-qa-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .landing-qa-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 0, 0.3);
            border-radius: 3px;
        }

        .landing-qa-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 0, 0.5);
        }

        /* 工作台建议提示 */
        .landing-qa-workspace-hint {
            margin-top: 12px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.1) 0%, rgba(255, 107, 0, 0.05) 100%);
            border: 1px solid rgba(255, 107, 0, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .landing-qa-workspace-hint a {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .landing-qa-workspace-hint a:hover {
            color: #FF8800;
        }

        /* workspace 模式下隐藏问答区域 */
        body.mode-workspace .landing-qa-wrapper {
            display: none !important;
        }

        /* 历史侧边栏滚动条样式 */
        .landing-qa-history-list::-webkit-scrollbar {
            width: 4px;
        }

        .landing-qa-history-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .landing-qa-history-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .landing-qa-history-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 响应式：小屏隐藏历史侧边栏 */
        @media (max-width: 900px) {
            .landing-qa-history {
                display: none;
            }

            .landing-qa-wrapper {
                max-width: 100%;
            }
        }

        /* ==================== Workspace Mode (VS Code Style) ==================== */
        #workspace-container {
            display: flex;
            flex: 1;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            /* 初始不可点击 */
            transition: opacity 0.8s ease 0.3s;
            /* 延迟显示 */
            min-width: 0;
            overflow: hidden;
        }

        /* 1. Activity Bar (最左侧) */
        .activity-bar {
            width: var(--activity-bar-width);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }

        .activity-item {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            cursor: pointer;
            margin-bottom: 10px;
            border-left: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            font-size: 1.2rem;
        }

        /* Tooltip styles */
        .activity-item::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, left 0.2s;
            z-index: 1000;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }

        .activity-item:hover::after {
            opacity: 1;
            left: 110%;
            /* Slight movement effect */
        }

        .activity-item:hover {
            transform: scale(1.1);
        }

        .activity-item:hover::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 107, 0, 0.1);
            border-radius: 8px;
        }

        .activity-item.active {
            border-left-color: var(--primary);
        }

        .activity-item.active::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 107, 0, 0.15);
            border-radius: 8px;
        }

        /* Unified Activity Bar Styles - Ceramic White Theme */
        .activity-item i {
            color: rgba(255, 255, 255, 0.5);
            /* Ceramic White (Unlit) */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 0 transparent);
        }

        .activity-item:hover i {
            color: rgba(255, 255, 255, 0.9);
            /* Ceramic White (Lit) */
            transform: scale(1.15);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }

        .activity-item.active i {
            color: #FFFFFF;
            /* Pure White */
            filter: drop-shadow(0 0 8px var(--primary));
            /* Brand Glow */
        }

        /* Special Active Colors - Enhanced for Dark Background */
        /* MCP - Cyberpunk Cyan */
        #activity-mcp.active i {
            color: #00E5FF !important;
            filter: drop-shadow(0 0 12px rgba(0, 229, 255, 0.8));
        }

        /* NotebookLM - Deep Purple */
        #activity-notebooklm.active i {
            color: #E040FB !important;
            filter: drop-shadow(0 0 12px rgba(224, 64, 251, 0.8));
        }

        /* AI-Gist - Gold */
        #activity-aigist.active i {
            color: #FFD700 !important;
            filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.8));
        }

        /* Remove old specific ID colors to enforce uniformity */
        /* #activity-explorer i { color: ... } - REMOVED */
        /* #activity-scenarios i { color: ... } - REMOVED */
        /* #activity-market i { color: ... } - REMOVED */

        .activity-item .fa-search {
            /* Keep search icon generic if used elsewhere, or override here */
        }

        /* 2. Sidebar (侧边栏) */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 0;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Fix: Create stacking context for absolute panels */
            z-index: 10;
            overflow: hidden;
        }

        .sidebar.expanded {
            width: 85vw !important;
            max-width: 1400px;
            position: absolute;
            left: var(--activity-bar-width);
            height: 100vh;
            z-index: 100;
            box-shadow: 10px 0 50px rgba(0, 0, 0, 0.6);
        }

        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0;
            overflow: hidden;
            border-right: none;
        }

        /* Left Sidebar Resizer */
        .left-resizer {
            flex: 0 0 6px;
            cursor: col-resize;
            background: rgba(255, 255, 255, 0.06);
            border-right: 1px solid var(--border);
            transition: background 0.2s;
            z-index: 20;
            position: relative;
        }

        .left-resizer:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .sidebar.collapsed+.left-resizer {
            display: none;
        }

        .sidebar-header {
            height: 35px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .collapse-btn {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .collapse-btn:hover {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .sidebar-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            /* 默认隐藏 */
            flex-direction: column;
        }

        .sidebar-panel.active {
            display: flex;
        }

        /* Prompt Studio Styles */
        .prompt-tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .prompt-tab.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .prompt-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .prompt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.2s;
        }

        .prompt-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .prompt-card-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .prompt-card-content {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .prompt-tag {
            display: inline-block;
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            margin-top: 8px;
        }

        /* 场景卡片样式 */
        .scenario-card {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 107, 0, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin: 12px 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .scenario-card:hover {
            background: rgba(255, 107, 0, 0.15);
            border-color: var(--primary);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 0, 0.3);
        }

        .scenario-card.active {
            background: rgba(255, 107, 0, 0.25);
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(255, 107, 0, 0.4);
        }

        .scenario-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .scenario-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .scenario-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* 文件树样式 */
        .file-tree {
            padding: 10px 0;
        }

        .file-item {
            padding: 6px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-left: 2px solid transparent;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .file-item.active {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .file-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        /* 智能体市场样式 */
        .market-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: default;
            transition: background 0.2s;
        }

        .market-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .market-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .market-info {
            flex: 1;
            overflow: hidden;
        }

        .market-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .market-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .market-btn {
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid var(--primary);
            color: var(--primary);
            background: transparent;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
            white-space: nowrap;
        }

        .market-btn:hover {
            background: var(--primary);
            color: white;
        }

        .market-btn.subscribed {
            border-color: #333;
            color: #888;
            background: rgba(255, 255, 255, 0.05);
        }

        .market-btn.subscribed:hover {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 0, 0, 0.1);
        }

        .market-btn.subscribed:hover::after {
            content: "退订";
            font-size: 0;
            /* Hide original text hack if needed, but simple text swap is better in JS */
        }

        /* @ 提及下拉菜单样式 */
        .mention-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            max-height: 280px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 107, 0, 0.3);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            display: none;
            z-index: 1000;
            margin-bottom: 2px;
        }

        .mention-dropdown.show {
            display: block;
            animation: slideUpFade 0.2s ease-out;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mention-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mention-item:last-child {
            border-bottom: none;
        }

        .mention-item:hover,
        .mention-item.selected {
            background: rgba(255, 107, 0, 0.15);
        }

        .mention-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .mention-item-info {
            flex: 1;
            overflow: hidden;
        }

        .mention-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .mention-item-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mention-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .mention-dropdown::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 12px 0 0;
        }

        .mention-dropdown::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 0, 0.5);
            border-radius: 3px;
        }

        .mention-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 0, 0.7);
        }

        /* 3. Main Content (中间) */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-tertiary);
            position: relative;
            border-right: 1px solid var(--border);
            min-width: 0;
            overflow: hidden;
        }

        .editor-tabs {
            height: 35px;
            background-color: var(--bg-primary);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
            /* Ensure tabs are above canvas */
        }

        .editor-area {
            flex: 1;
            min-height: 0;
            min-width: 0;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
            background-color: var(--bg-tertiary);
        }

        /* Modal Styles */
        .settings-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 10% auto;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--bg-tertiary);
            border-radius: 0 0 12px 12px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary);
        }

        .provider-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .provider-option {
            padding: 10px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .provider-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .provider-option.active {
            background: rgba(255, 107, 0, 0.15);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-save {
            padding: 8px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel {
            padding: 8px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        /* Workflow Styles */
        .workflow-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid var(--primary);
        }

        .workflow-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: var(--primary);
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .workflow-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .workflow-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .workflow-status.active {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .workflow-status.paused {
            background: rgba(158, 158, 158, 0.2);
            color: #9E9E9E;
        }

        .workflow-schedule {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .workflow-visual {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .wf-step {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .wf-arrow {
            font-size: 0.7rem;
            color: #666;
        }

        .workflow-actions {
            display: flex;
            gap: 8px;
        }

        .wf-btn-run {
            flex: 1;
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 4px 0;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wf-btn-run:hover {
            background: var(--primary);
            color: white;
        }

        .wf-btn-edit {
            width: 28px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
        }

        .wf-btn-edit:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        /* 新的 Canvas 全屏样式 */
        .canvas-area {
            position: absolute;
            top: 35px;
            /* Below tabs */
            left: 0;
            width: 100%;
            height: calc(100% - 35px);
            background: linear-gradient(135deg, #0A0A0A 0%, #1A1A1A 100%);
            z-index: 5;
            /* Below editor by default */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            overflow: hidden;
            min-width: 0;
            max-width: 100%;
        }

        .canvas-area.active {
            z-index: 15;
            /* Above editor */
            opacity: 1;
            pointer-events: all;
        }

        /* Remove old collapsed styles */
        /* .canvas-area.collapsed ... */

        .canvas-header {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            color: #666;
            pointer-events: none;
            /* Let clicks pass through to canvas */
        }

        .canvas-header>* {
            pointer-events: all;
            /* Enable buttons */
        }

        .canvas-header.sticky {
            background: rgba(10, 10, 10, 0.9);
            padding: 8px 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        /* 智能体节点样式 (Enhanced) */
        .workflow-node {
            width: 65px;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 30% 30%, rgba(60, 60, 60, 0.9), rgba(30, 30, 30, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(12px);
            box-shadow:
                0 10px 30px -10px rgba(0, 0, 0, 0.8),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 2;
        }

        /* 装饰光环 */
        .workflow-node::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .workflow-node:hover {
            transform: translate(-50%, -50%) scale(1.15) !important;
            border-color: rgba(255, 107, 0, 0.5);
            box-shadow:
                0 15px 40px -10px rgba(0, 0, 0, 0.9),
                0 0 20px rgba(255, 107, 0, 0.2),
                inset 0 0 20px rgba(255, 107, 0, 0.1);
        }

        .workflow-node:hover::before {
            opacity: 1;
        }

        .workflow-node.working {
            background: radial-gradient(circle at 30% 30%, rgba(255, 107, 0, 0.2), rgba(30, 30, 30, 0.95));
            border-color: var(--primary);
            box-shadow:
                0 0 30px rgba(255, 107, 0, 0.4),
                inset 0 0 20px rgba(255, 107, 0, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }

        .workflow-node.dimmed {
            opacity: 0.4;
            filter: grayscale(0.8) blur(1px);
            transform: translate(-50%, -50%) scale(0.9);
        }

        .workflow-node i {
            font-size: 26px !important;
            transition: all 0.3s;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        .workflow-node.working i {
            color: var(--primary) !important;
            filter: drop-shadow(0 0 10px rgba(255, 107, 0, 0.6));
        }

        .agent-label {
            position: absolute;
            padding: 6px 12px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            pointer-events: none;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .workflow-node:hover~.agent-label,
        .workflow-node.working~.agent-label {
            color: var(--text-primary);
            border-color: var(--primary);
            background: rgba(255, 107, 0, 0.15);
            transform: translate(-50%, -50%) scale(1.05) !important;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 107, 0, 0.8);
            }
        }

        #workflowNodes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #workflowNodes>* {
            pointer-events: all;
        }

        /* HTML Preview Styles */
        .html-preview-container {
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .html-preview-header {
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .html-fullscreen-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .html-fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .html-preview {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }

        /* 4. Right Panel (右侧) */
        .right-panel {
            flex: 0 0 var(--right-panel-width);
            min-width: 0;
            background-color: var(--bg-primary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, margin-right 0.3s ease;
            overflow: hidden;
        }

        .right-resizer {
            flex: 0 0 6px;
            cursor: col-resize;
            background: rgba(255, 255, 255, 0.06);
            border-left: 1px solid var(--border);
            transition: background 0.2s;
            z-index: 20;
            position: relative;
        }

        .right-resizer:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .sidebar-header-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .right-panel.collapsed {
            flex: 0 0 0 !important;
            min-width: 0;
            width: 0 !important;
            overflow: hidden;
            border-left: none;
        }

        .right-panel.collapsed+.right-resizer {
            display: none;
        }

        /* 状态类：激活 Workspace 模式 */
        body.mode-workspace #landing-container {
            top: 0;
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            padding: 0 20px;
            flex-direction: row;
            position: fixed;
            z-index: 100;
        }

        body.mode-workspace #workspace-container {
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

        body.mode-workspace .landing-logo {
            font-size: 1.1rem;
            margin-bottom: 0;
            margin-right: 20px;
        }

        body.mode-workspace .landing-logo-icon {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        /* 全局控制按钮 */
        .global-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        body.mode-workspace .global-controls {
            display: flex !important;
        }

        .global-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid rgba(255, 107, 0, 0.3);
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .global-control-btn:hover {
            background: rgba(255, 107, 0, 0.25);
            border-color: var(--primary);
            color: #FF8800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.4);
        }

        .global-control-btn:active {
            transform: translateY(0);
        }

        .global-control-btn.active {
            background: rgba(255, 107, 0, 0.3);
            border-color: #FF8800;
            color: #FF8800;
            box-shadow: 0 0 8px rgba(255, 107, 0, 0.5);
        }

        .global-control-btn i {
            color: inherit;
        }

        body.mode-workspace .landing-input-wrapper {
            display: none;
            /* 在 workspace 模式下隐藏搜索框 */
        }

        body.mode-workspace .landing-input {
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
        }

        body.mode-workspace #workspace-container {
            opacity: 1;
            pointer-events: all;
        }

        /* Command Palette (Hidden) */
        #command-palette {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid var(--primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        #command-palette.active {
            display: block;
            animation: fadeInDown 0.2s ease;
        }

        #command-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 1rem;
            outline: none;
        }

        #command-input:focus {
            border-color: var(--primary);
        }

        .shortcut-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.7rem;
            color: #666;
            pointer-events: none;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Loading Spinner */
        .typing-indicator {
            display: inline-block;
            width: 40px;
            height: 20px;
            padding: 5px 10px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 20px;
            margin-bottom: 15px;
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin-right: 3px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Chat Message Styles */
        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .agent-message .message-avatar {
            background: rgba(255, 107, 0, 0.2);
            color: var(--primary);
            border: 1px solid rgba(255, 107, 0, 0.3);
        }

        .user-message .message-avatar {
            background: rgba(100, 100, 255, 0.2);
            color: #6464FF;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }

        .message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .agent-message .message-content {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 107, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .user-message .message-content {
            background: rgba(255, 107, 0, 0.15);
            border: 1px solid rgba(255, 107, 0, 0.3);
            color: var(--text-primary);
        }

        .message-agent-name {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <!-- Landing / Top Bar -->
    <div id="landing-container">
        <div class="landing-logo" onclick="goToHomePage()" title="返回首页">
            <div class="landing-logo-icon">
                <span>AD</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                <div
                    style="font-size: 0.8rem; font-weight: 600; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 2px;">
                    招商基金</div>
                <span class="landing-logo-text">AgentDesk</span>
            </div>
        </div>

        <!-- 全局折叠控制按钮 -->
        <div class="global-controls" id="globalControls" style="display: none;">
            <button class="global-control-btn" onclick="toggleSidebar('left')" title="切换左侧栏 (Ctrl+B)">
                <i class="fas fa-folder-open"></i>
            </button>
            <button class="global-control-btn" onclick="toggleCanvas()" title="切换智能体画布">
                <i class="fas fa-project-diagram"></i>
            </button>
            <button class="global-control-btn" onclick="toggleSidebar('right')" title="切换右侧面板">
                <i class="fas fa-comments"></i>
            </button>
            <button class="global-control-btn" onclick="toggleAllPanels()" title="展开/折叠所有">
                <i class="fas fa-expand-arrows-alt" id="expandAllIcon"></i>
            </button>
        </div>

        <!-- Agent Avatars -->
        <div class="landing-agents" id="landing-agents">
            <!-- Dynamic Agents -->
        </div>

        <!-- 问答对话显示区域（渐进式工作模式 - ChatGPT 风格） -->
        <div class="landing-qa-wrapper" id="landingQaWrapper" style="display: none;">
            <!-- 历史对话侧边栏 -->
            <div class="landing-qa-history" id="landingQaHistory">
                <div class="landing-qa-history-header">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        历史对话
                    </h3>
                    <button class="landing-qa-new-chat" onclick="startNewQaSession()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14"
                            height="14">
                            <path d="M12 4v16m-8-8h16" />
                        </svg>
                        新对话
                    </button>
                </div>
                <div class="landing-qa-history-list" id="landingQaHistoryList">
                    <!-- 动态加载历史会话 -->
                </div>
            </div>

            <!-- 主对话容器 -->
            <div class="landing-qa-container" id="landingQaContainer">
                <div class="landing-qa-header">
                    <div class="landing-qa-header-left">
                        <div class="landing-qa-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path
                                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                        </div>
                        <span class="landing-qa-header-title">AgentDesk 智能助手</span>
                    </div>
                    <div class="landing-qa-header-actions">
                        <button class="landing-qa-action-btn" onclick="toggleQaHistory()" title="切换历史">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 6h16M4 12h16M4 18h7" />
                            </svg>
                        </button>
                        <button class="landing-qa-action-btn" onclick="clearLandingQa()" title="清空对话">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        <button class="landing-qa-action-btn" onclick="hideQaPanel()" title="关闭">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="landing-qa-messages" id="landingQaMessages">
                    <!-- 动态加载的对话消息 -->
                </div>
                <!-- 预测问题区域 -->
                <div class="landing-qa-suggestions" id="landingQaSuggestions" style="display: none;">
                    <div class="landing-qa-suggestions-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path
                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        您可能想问
                    </div>
                    <div class="landing-qa-suggestions-list" id="landingQaSuggestionsList">
                        <!-- 动态加载预测问题 -->
                    </div>
                </div>
                <!-- 问答区域输入框 -->
                <div class="landing-qa-input-area">
                    <div class="landing-qa-input-wrapper">
                        <input type="text" class="landing-qa-input" id="landingQaInput" placeholder="继续提问..."
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey && !event.isComposing) { event.preventDefault(); submitQaQuestion(); }">
                        <button class="landing-qa-send-btn" onclick="submitQaQuestion()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="landing-input-wrapper">
            <input type="text" class="landing-input" id="globalInput" placeholder="想让我帮你做什么？(例如：分析这份财报)">
            <!-- Mention Dropdown for Landing -->
            <div id="landingMentionDropdown" class="mention-dropdown landing-dropdown" style="display: none;"></div>

            <button class="landing-submit" onclick="enterWorkspace()" title="开始工作">
                <i class="fas fa-arrow-right"></i>
            </button>
            <!-- Agent Mode Entry Button -->
            <button class="landing-agent-mode-btn" onclick="enterWorkspace()">
                <i class="fas fa-cube"></i> Agent Mode
            </button>
        </div>
    </div>

    <!-- Main Workspace -->
    <div id="workspace-container">
        <!-- 1. Activity Bar -->
        <div class="activity-bar">
            <div id="activity-explorer" class="activity-item active" onclick="switchSidebar('explorer')" title="资源管理器">
                <i class="fas fa-copy"></i>
            </div>
            <div id="activity-scenarios" class="activity-item" onclick="switchSidebar('scenarios')" title="业务场景">
                <i class="fas fa-briefcase"></i>
            </div>
            <div id="activity-market" class="activity-item" onclick="switchSidebar('market')" title="智能体市场">
                <i class="fas fa-store"></i>
            </div>
            <div id="activity-drawing" class="activity-item" onclick="switchSidebar('drawing')" title="绘画智能体">
                <i class="fas fa-palette"></i>
            </div>
            <div id="activity-ppt" class="activity-item" onclick="switchSidebar('ppt')" title="PPT生成专家">
                <i class="fas fa-file-powerpoint"></i>
            </div>
            <div id="activity-akshare" class="activity-item" onclick="switchSidebar('akshare')" title="AKShare 数据专家">
                <i class="fas fa-chart-line"></i>
            </div>
            <div id="activity-alphafund" class="activity-item" onclick="switchSidebar('alphafund')"
                title="AlphaFund 投研智能体">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div id="activity-notebooklm" class="activity-item" onclick="switchSidebar('notebooklm')"
                title="NotebookLM Pro">
                <i class="fas fa-brain"></i>
            </div>
            <div id="activity-aigist" class="activity-item" onclick="switchSidebar('aigist')" title="AI-Gist 提示词智能体">
                <i class="fas fa-lightbulb"></i>
            </div>
            <div id="activity-mcp" class="activity-item" onclick="switchSidebar('mcp')"
                title="MCP 生态连接 (Model Context Protocol)">
                <i class="fas fa-network-wired"></i>
            </div>

            <!-- 动态插入的订阅智能体图标将出现在这里 -->
            <div id="subscribed-agents-bar">
                <!-- 订阅的智能体图标会动态添加到这里 -->
            </div>

            <div style="flex: 1"></div>
            <div class="activity-item" title="设置" onclick="openSettingsModal()">
                <i class="fas fa-cog"></i>
            </div>
        </div>

        <!-- 2. Sidebar -->
        <div class="sidebar" id="leftSidebar">

            <!-- Panel: Open NotebookLM (动态添加) -->
            <div id="panel-notebooklm" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span>🎙️ NotebookLM</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>
                <div class="sidebar-content" style="padding: 0; height: 100%;">
                    <iframe id="notebooklm-iframe" src="about:blank"
                        style="width: 100%; height: 100%; border: none; background: var(--bg-primary); display: none;"
                        frameborder="0">
                    </iframe>
                    <div id="notebooklm-placeholder"
                        style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>正在启动 Open NotebookLM...</p>
                        <p style="font-size: 0.85rem; margin-top: 10px;">
                            如果长时间未加载，请确保服务已启动：<br>
                            <code
                                style="background: var(--bg-secondary); padding: 5px 10px; border-radius: 4px; margin-top: 5px; display: inline-block;">
                                cd open-notebooklm && ./start.sh
                            </code>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Panel: Prompt Studio (Replaces AI-Gist) -->
            <div id="panel-aigist" class="sidebar-panel" style="display: none; background: var(--bg-primary);">
                <div class="sidebar-header" style="border-bottom: 1px solid var(--border);">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span><i class="fas fa-magic" style="color: #FFD700; margin-right: 5px;"></i> 提示词工坊</span>
                        <!-- Tabs -->
                        <div
                            style="display: flex; background: var(--bg-secondary); padding: 2px; border-radius: 6px; margin-left: 20px;">
                            <button class="prompt-tab active" onclick="switchPromptTab('optimize')">优化</button>
                            <button class="prompt-tab" onclick="switchPromptTab('library')">库</button>
                            <button class="prompt-tab" onclick="switchPromptTab('best-practices')">最佳实践</button>
                        </div>
                    </div>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>

                <div class="sidebar-content" style="padding: 20px; overflow-y: auto;">

                    <!-- Tab 1: Optimize -->
                    <div id="prompt-tab-optimize" class="prompt-tab-content" style="display: block;">
                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">原始提示词
                                / 需求</label>
                            <textarea id="prompt-input" placeholder="输入你想要优化的提示词或简单指令..."
                                style="width: 100%; height: 120px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; padding: 10px; font-family: monospace; resize: vertical; transition: border-color 0.3s;"></textarea>
                        </div>

                        <!-- Optimization Options -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">目标模型</label>
                                <select id="prompt-model-select"
                                    style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 4px; margin-top: 4px;">
                                    <option value="general">通用模型</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="claude-3">Claude 3</option>
                                    <option value="midjourney">Midjourney</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">优化框架</label>
                                <select id="prompt-framework-select"
                                    style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 4px; margin-top: 4px;">
                                    <option value="auto">自动选择</option>
                                    <option value="costar">CO-STAR (结构化)</option>
                                    <option value="crispe">CRISPE (角色扮演)</option>
                                    <option value="cot">思维链 (逻辑推理)</option>
                                    <option value="few-shot">少样本 (示例驱动)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">语气风格</label>
                                <select id="prompt-tone-select"
                                    style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 4px; margin-top: 4px;">
                                    <option value="professional">专业严谨</option>
                                    <option value="creative">创意活泼</option>
                                    <option value="concise">简洁明了</option>
                                    <option value="friendly">亲切友好</option>
                                </select>
                            </div>
                        </div>

                        <div style="text-align: right; margin-bottom: 15px;">
                            <button id="btn-optimize-prompt" onclick="optimizePrompt()"
                                style="background: var(--primary); color: white; border: none; padding: 8px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3); transition: transform 0.2s;">
                                <i class="fas fa-magic"></i> 立即优化
                            </button>
                        </div>

                        <div id="prompt-output-container" style="display: none; animation: fadeIn 0.5s ease;">
                            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <label
                                        style="display: block; color: var(--primary); font-size: 0.8rem; margin-bottom: 5px;">优化结果</label>
                                </div>
                                <div style="flex: 1; text-align: right;">
                                    <button onclick="copyToClipboard(document.getElementById('prompt-output').value)"
                                        style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 5px;">
                                        <i class="fas fa-copy"></i> 复制
                                    </button>
                                    <button onclick="saveToLibrary()"
                                        style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 5px;">
                                        <i class="fas fa-save"></i> 保存
                                    </button>
                                </div>
                            </div>

                            <!-- Optimized Prompt -->
                            <textarea id="prompt-output" readonly
                                style="width: 100%; height: 250px; background: rgba(255, 107, 0, 0.05); border: 1px solid var(--primary); color: var(--text-primary); border-radius: 8px; padding: 15px; font-family: monospace; resize: vertical; line-height: 1.5; margin-bottom: 15px;"></textarea>

                            <!-- Comparison & Explanation -->
                            <div
                                style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #4CAF50;"><i class="fas fa-check-circle"></i> 优化说明</strong>
                                    <div id="prompt-explanation"
                                        style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; line-height: 1.6;">
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--border); padding-top: 10px; margin-top: 10px;">
                                    <strong style="color: #2196F3;"><i class="fas fa-exchange-alt"></i> 优化对比</strong>
                                    <div id="prompt-comparison"
                                        style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; line-height: 1.6;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Library -->
                    <div id="prompt-tab-library" class="prompt-tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <input type="text" id="prompt-search" placeholder="搜索提示词..." oninput="filterPrompts()"
                                style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 6px; margin-right: 10px;">
                            <button onclick="switchPromptTab('optimize')"
                                style="background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-plus"></i> 新建
                            </button>
                        </div>
                        <div id="prompt-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Dynamic content -->
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">加载中...</div>
                        </div>
                    </div>

                    <!-- Tab 3: Best Practices -->
                    <div id="prompt-tab-best-practices" class="prompt-tab-content" style="display: none;">
                        <div id="best-practices-list"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel: 资源管理器 -->
            <div id="panel-explorer" class="sidebar-panel active">
                <div class="sidebar-header">
                    <span>资源管理器</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <i class="fas fa-sync-alt" style="cursor: pointer; font-size: 0.8rem;" onclick="loadFiles()"
                            title="刷新"></i>
                        <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="file-tree">
                        <div
                            style="padding: 0 15px; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: #888;">
                            <i class="fas fa-chevron-down"></i> UPLOADS
                        </div>
                        <div id="file-list-container">
                            <!-- Dynamic file list will be rendered here -->
                            <div style="padding: 10px 20px; color: #666; font-size: 0.8rem;">加载中...</div>
                        </div>
                    </div>
                </div>
                <!-- Upload Area at the bottom of explorer -->
                <div style="padding: 10px; border-top: 1px solid var(--border);">
                    <label for="file-upload"
                        style="display: block; width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 6px; text-align: center; cursor: pointer; color: var(--text-secondary); font-size: 0.8rem; transition: all 0.2s;">
                        <i class="fas fa-upload" style="margin-right: 5px;"></i> 上传文件
                    </label>
                    <input type="file" id="file-upload" style="display: none;" onchange="handleFileUpload(this)">
                </div>
            </div>

            <!-- Panel: 自动化工作流 (Replaces 业务场景) -->
            <div id="panel-scenarios" class="sidebar-panel">
                <div class="sidebar-header">
                    <span><i class="fas fa-cogs" style="color: #FFD700; margin-right: 8px;"></i> 自动化工作流</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>

                <div class="sidebar-content" style="padding: 15px;">
                    <div
                        style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #888; font-size: 0.8rem;">已配置 3 个任务</span>
                        <button
                            style="background: var(--primary); border: none; border-radius: 4px; color: white; padding: 4px 8px; font-size: 0.75rem; cursor: pointer;">
                            <i class="fas fa-plus"></i> 新建
                        </button>
                    </div>

                    <!-- Workflow Card 1: Morning Report -->
                    <div class="workflow-card" onclick="previewWorkflow('morning-report')">
                        <div class="workflow-header">
                            <div class="workflow-title">每日舆情早报</div>
                            <div class="workflow-status active">运行中</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="far fa-clock"></i> 每天 08:30
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="全网搜索"><i class="fas fa-globe"></i></div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="舆情分析"><i class="fas fa-file-alt"></i></div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="生成报告"><i class="fas fa-pen-fancy"></i></div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run" onclick="event.stopPropagation(); runWorkflow('舆情早报')"><i
                                    class="fas fa-play"></i> 立即运行</button>
                            <button class="wf-btn-edit" onclick="event.stopPropagation()"><i
                                    class="fas fa-cog"></i></button>
                        </div>
                    </div>

                    <!-- Workflow Card 2: Competitor Monitor -->
                    <div class="workflow-card" onclick="previewWorkflow('competitor')">
                        <div class="workflow-header">
                            <div class="workflow-title">竞品动态监控</div>
                            <div class="workflow-status active">运行中</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="far fa-clock"></i> 每 4 小时
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="官网抓取"><i class="fas fa-spider"></i></div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="数据比对"><i class="fas fa-exchange-alt"></i></div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="发送预警"><i class="fas fa-bell"></i></div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run" onclick="event.stopPropagation(); runWorkflow('竞品监控')"><i
                                    class="fas fa-play"></i> 立即运行</button>
                            <button class="wf-btn-edit" onclick="event.stopPropagation()"><i
                                    class="fas fa-cog"></i></button>
                        </div>
                    </div>

                    <!-- Workflow Card 4: Document Review (NEW) -->
                    <div class="workflow-card" onclick="previewWorkflow('doc-review')">
                        <div class="workflow-header">
                            <div class="workflow-title">智能文档多维审查</div>
                            <div class="workflow-status active"
                                style="color: var(--primary); background: rgba(255, 107, 0, 0.1);">推荐</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="fas fa-bolt"></i> 即时执行
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="文档分析师"><i class="fas fa-file-alt" style="color: #FF9800;"></i>
                            </div>
                            <div class="wf-step" title="合规官" style="margin-left: -8px;"><i class="fas fa-balance-scale"
                                    style="color: #F44336;"></i></div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="内容创作者"><i class="fas fa-pen-fancy" style="color: #9C27B0;"></i>
                            </div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run"
                                onclick="event.stopPropagation(); previewWorkflow('doc-review')"><i
                                    class="fas fa-play"></i> 开始使用</button>
                        </div>
                    </div>

                    <!-- Workflow Card 5: Daily Tech Digest (NEW) -->
                    <div class="workflow-card" onclick="previewWorkflow('daily-tech')">
                        <div class="workflow-header">
                            <div class="workflow-title">每日科技动态</div>
                            <div class="workflow-status active"
                                style="color: #64B5F6; background: rgba(100, 181, 246, 0.15);">新</div>
                        </div>
                        <div class="workflow-schedule">
                            <i class="far fa-clock"></i> 每天 09:30
                        </div>
                        <div class="workflow-visual">
                            <div class="wf-step" title="数据专家"><i class="fas fa-chart-bar" style="color: #2196F3;"></i>
                            </div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="文档分析师"><i class="fas fa-file-alt" style="color: #FF9800;"></i>
                            </div>
                            <div class="wf-arrow">→</div>
                            <div class="wf-step" title="内容创作者"><i class="fas fa-pen-fancy" style="color: #9C27B0;"></i>
                            </div>
                        </div>
                        <div class="workflow-actions">
                            <button class="wf-btn-run"
                                onclick="event.stopPropagation(); previewWorkflow('daily-tech')"><i
                                    class="fas fa-play"></i> 开始使用</button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Panel: 智能体市场 -->
            <div id="panel-market" class="sidebar-panel">
                <div class="sidebar-header">
                    <span>智能体市场</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>
                <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                    <div style="position: relative;">
                        <i class="fas fa-search"
                            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.8rem;"></i>
                        <input type="text" placeholder="搜索智能体..."
                            style="width: 100%; padding: 6px 10px 6px 30px; background: var(--bg-secondary); border: 1px solid #333; border-radius: 4px; color: var(--text-primary); outline: none; font-size: 0.85rem;">
                    </div>
                </div>
                <div class="sidebar-content" id="market-list">
                    <!-- Dynamic Market Items -->
                </div>
            </div>

            <div id="panel-drawing" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span><i class="fas fa-palette" style="color: var(--primary); margin-right:6px;"></i> 绘画智能体</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>
                <div class="sidebar-content" style="padding: 15px;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">快速生成</div>
                    <textarea id="draw-prompt-sidebar" rows="3"
                        style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">画一个团队组织架构图，包含研发、产品、运营</textarea>
                    <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox"
                                id="tool-mermaid-sidebar"> Mermaid</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox"
                                id="tool-plantuml-sidebar"> PlantUML</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox"
                                id="tool-nanobanana-sidebar"> Nano Banana</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox"
                                id="tool-excalidraw-sidebar"> Excalidraw</label>
                    </div>
                    <button onclick="runDrawingGeneratorFromSidebar()"
                        style="margin-top: 10px; width: 100%; padding: 10px 12px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                        生成并在工作区显示
                    </button>
                </div>
            </div>

            <!-- Panel: AKShare 数据专家 -->
            <div id="panel-akshare" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span><i class="fas fa-chart-line" style="color: #FF5722; margin-right:6px;"></i> AKShare
                        数据专家</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>
                <div class="sidebar-content" style="padding: 15px;">
                    <div
                        style="background: rgba(255,87,34,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,87,34,0.3); margin-bottom: 15px;">
                        <div style="font-size: 0.85rem; color: #FF5722; font-weight: 600; margin-bottom: 6px;">
                            <i class="fas fa-info-circle"></i> 查询说明
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.5;">
                            • 建议使用股票代码查询（如：600276）<br>
                            • 公司名称搜索可能受数据源限制<br>
                            • 支持股票信息、价格、新闻查询
                        </div>
                    </div>

                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">查询类型</div>
                    <select id="akshare-query-type"
                        style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 0.85rem; margin-bottom: 12px;">
                        <option value="stock_info">股票基本信息</option>
                        <option value="stock_prices">股票价格数据</option>
                        <option value="stock_news">股票相关新闻</option>
                        <option value="search">搜索股票代码</option>
                        <option value="get_current_time">当前时间/交易日</option>
                    </select>

                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">股票代码或关键词</div>
                    <input type="text" id="akshare-symbol" placeholder="例如：600276 或 平安银行"
                        style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 0.9rem; margin-bottom: 12px;">

                    <div id="akshare-advanced-options" style="margin-bottom: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">数据条数
                                </div>
                                <input type="number" id="akshare-limit" value="10" min="1" max="100"
                                    style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 6px; font-size: 0.85rem;">
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">周期
                                </div>
                                <select id="akshare-period"
                                    style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 6px; font-size: 0.85rem;">
                                    <option value="1d" selected>日线</option>
                                    <option value="1w">周线</option>
                                    <option value="1m">月线</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button onclick="queryAKShareFromSidebar()"
                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #FF5722 0%, #F44336 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;">
                        <i class="fas fa-search" style="margin-right: 6px;"></i> 查询数据
                    </button>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">
                            <i class="fas fa-lightbulb" style="color: #FFD700;"></i> 快速示例
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button
                                onclick="document.getElementById('akshare-query-type').value='stock_info'; document.getElementById('akshare-symbol').value='000001'; queryAKShareFromSidebar();"
                                style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem; text-align: left; transition: all 0.2s;">
                                <i class="fas fa-building" style="color: #4CAF50;"></i> 平安银行信息
                            </button>
                            <button
                                onclick="document.getElementById('akshare-query-type').value='stock_news'; document.getElementById('akshare-symbol').value='600036'; queryAKShareFromSidebar();"
                                style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem; text-align: left; transition: all 0.2s;">
                                <i class="fas fa-newspaper" style="color: #2196F3;"></i> 招商银行新闻
                            </button>
                            <button
                                onclick="document.getElementById('akshare-query-type').value='get_current_time'; queryAKShareFromSidebar();"
                                style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem; text-align: left; transition: all 0.2s;">
                                <i class="fas fa-clock" style="color: #FF9800;"></i> 交易日查询
                            </button>
                        </div>
                    </div>

                    <div id="akshare-status"
                        style="margin-top: 10px; font-size: 0.75rem; color: var(--text-secondary); display: none;">
                    </div>
                </div>
            </div>

            <!-- Panel: PPT生成专家 -->
            <div id="panel-ppt" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span><i class="fas fa-file-powerpoint" style="color: #FF6B00; margin-right:6px;"></i>
                        PPT生成专家</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>
                <div class="sidebar-content" style="padding: 15px;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">主题或内容</div>
                    <textarea id="ppt-topic-sidebar" rows="3"
                        style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-size: 0.9rem;"
                        placeholder="例如：人工智能在金融行业的应用"></textarea>

                    <div style="margin-top: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">幻灯片数量
                            </div>
                            <input type="number" id="ppt-slide-count" value="5" min="3" max="20"
                                style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 6px; font-size: 0.85rem;">
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">复杂度</div>
                            <select id="ppt-complexity"
                                style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 6px; font-size: 0.85rem;">
                                <option value="通用">通用</option>
                                <option value="专业" selected>专业</option>
                                <option value="学术">学术</option>
                                <option value="行政高管">行政高管</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">视觉风格</div>
                        <select id="ppt-style"
                            style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 6px; font-size: 0.85rem;">
                            <option value="现代简约" selected>现代简约</option>
                            <option value="商务科技">商务科技</option>
                            <option value="创意艺术">创意艺术</option>
                            <option value="深色模式">深色模式</option>
                            <option value="自然清新">自然清新</option>
                        </select>
                    </div>

                    <div style="margin-top: 10px;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">语言</div>
                        <select id="ppt-language"
                            style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 6px; font-size: 0.85rem;">
                            <option value="简体中文" selected>简体中文</option>
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Japanese">Japanese</option>
                        </select>
                    </div>

                    <button onclick="generatePPTFromSidebar()"
                        style="margin-top: 15px; width: 100%; padding: 12px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;">
                        <i class="fas fa-magic" style="margin-right: 6px;"></i> 生成PPT
                    </button>

                    <div id="ppt-status"
                        style="margin-top: 10px; font-size: 0.75rem; color: var(--text-secondary); display: none;">
                    </div>
                </div>
            </div>

            <!-- Panel: AlphaFund 投研智能体 -->
            <div id="panel-alphafund" class="sidebar-panel" style="display: none;">
                <div class="sidebar-header">
                    <span><i class="fas fa-chart-pie" style="color: #FF6B00; margin-right:6px;"></i> AlphaFund
                        投研智能体</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>
                <div class="sidebar-content" style="padding: 15px;">
                    <div
                        style="background: rgba(255,107,0,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,107,0,0.3); margin-bottom: 15px;">
                        <div style="font-size: 0.85rem; color: #FF6B00; font-weight: 600; margin-bottom: 6px;">
                            <i class="fas fa-info-circle"></i> 多智能体投研系统
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.5;">
                            • 7个专业智能体协同工作<br>
                            • 生成专业投资研究报告<br>
                            • 支持深度研究、市场分析、量化数据
                        </div>
                    </div>

                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">研究主题</div>
                    <input type="text" id="alphafund-topic" placeholder="例如：英伟达、新能源、半导体"
                        style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 0.9rem; margin-bottom: 12px;">

                    <div style="margin-bottom: 12px;">
                        <label
                            style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer;">
                            <input type="checkbox" id="alphafund-deep-research" style="cursor: pointer;">
                            <span>启用深度研究（逻辑智能体）</span>
                        </label>
                    </div>

                    <button onclick="startAlphaFundWorkflow()"
                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;">
                        <i class="fas fa-play" style="margin-right: 6px;"></i> 启动投研工作流
                    </button>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">
                            <i class="fas fa-lightbulb" style="color: #FFD700;"></i> 快速示例
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button
                                onclick="document.getElementById('alphafund-topic').value='英伟达'; startAlphaFundWorkflow();"
                                style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem; text-align: left; transition: all 0.2s;">
                                <i class="fas fa-microchip" style="color: #4CAF50;"></i> 英伟达分析
                            </button>
                            <button
                                onclick="document.getElementById('alphafund-topic').value='新能源'; startAlphaFundWorkflow();"
                                style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem; text-align: left; transition: all 0.2s;">
                                <i class="fas fa-bolt" style="color: #2196F3;"></i> 新能源板块
                            </button>
                            <button
                                onclick="document.getElementById('alphafund-topic').value='半导体'; startAlphaFundWorkflow();"
                                style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.75rem; text-align: left; transition: all 0.2s;">
                                <i class="fas fa-cog" style="color: #FF9800;"></i> 半导体行业
                            </button>
                        </div>
                    </div>

                    <div id="alphafund-status"
                        style="margin-top: 10px; font-size: 0.75rem; color: var(--text-secondary); display: none;">
                    </div>
                </div>
            </div>

            <!-- Panel: MCP Market -->
            <div id="panel-mcp" class="sidebar-panel">
                <div class="sidebar-header">
                    <span><i class="fas fa-network-wired" style="color: #00E5FF; margin-right: 8px;"></i> MCP 生态</span>
                    <i class="fas fa-angle-left collapse-btn" onclick="toggleSidebar('left')" title="折叠"></i>
                </div>

                <!-- MCP Status / Toggle -->
                <div
                    style="padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0, 229, 255, 0.05);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 0.85rem; font-weight: 600; color: #00E5FF;">AgentDesk Server</span>
                        <label class="switch"
                            style="position: relative; display: inline-block; width: 34px; height: 20px;">
                            <input type="checkbox" id="mcp-server-toggle" onchange="toggleMcpServer(this)">
                            <span class="slider round"
                                style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px;"></span>
                            <style>
                                .switch input {
                                    opacity: 0;
                                    width: 0;
                                    height: 0;
                                }

                                .switch input:checked+.slider {
                                    background-color: #00E5FF;
                                }

                                .switch input:focus+.slider {
                                    box-shadow: 0 0 1px #00E5FF;
                                }

                                .switch input:checked+.slider:before {
                                    transform: translateX(14px);
                                }

                                .slider:before {
                                    position: absolute;
                                    content: "";
                                    height: 12px;
                                    width: 12px;
                                    left: 4px;
                                    bottom: 4px;
                                    background-color: white;
                                    transition: .4s;
                                    border-radius: 50%;
                                }
                            </style>
                        </label>
                    </div>
                    <div id="mcp-server-status" style="font-size: 0.75rem; color: var(--text-secondary);">
                        <i class="fas fa-circle" style="font-size: 6px; margin-right: 4px; color: #666;"></i> 未启动
                    </div>
                    <div id="mcp-connect-info"
                        style="display: none; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; font-family: monospace; font-size: 0.7rem; color: #aaa; word-break: break-all;">
                        npx -y @agentdesk/mcp-server connect
                    </div>
                </div>

                <!-- MCP Tabs -->
                <div style="display: flex; border-bottom: 1px solid var(--border);">
                    <div class="mcp-tab active" onclick="switchMcpTab('installed')"
                        style="flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; cursor: pointer; border-bottom: 2px solid #00E5FF; color: var(--text-primary);">
                        已连接</div>
                    <div class="mcp-tab" onclick="switchMcpTab('market')"
                        style="flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-secondary);">
                        发现市场</div>
                </div>

                <div class="sidebar-content" style="padding: 0;">

                    <!-- Tab: Installed -->
                    <div id="mcp-tab-installed" style="padding: 15px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">自定义连接</span>
                            <button onclick="showAddMcpModal()"
                                style="background: transparent; border: 1px solid var(--border); color: var(--primary); border-radius: 4px; padding: 2px 8px; font-size: 0.7rem; cursor: pointer;">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>

                        <!-- Demo Connected Item -->
                        <div class="mcp-item"
                            style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center;">
                            <div
                                style="width: 32px; height: 32px; border-radius: 6px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-folder" style="color: #FFCA28;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.85rem; font-weight: 600;">Filesystem</div>
                                <div style="font-size: 0.7rem; color: #4CAF50;"><i class="fas fa-link"></i> 已连接</div>
                            </div>
                            <div
                                style="font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">
                                Stdio</div>
                        </div>

                        <div class="mcp-item"
                            style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center;">
                            <div
                                style="width: 32px; height: 32px; border-radius: 6px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="fas fa-search" style="color: #29B6F6;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.85rem; font-weight: 600;">Brave Search</div>
                                <div style="font-size: 0.7rem; color: #4CAF50;"><i class="fas fa-link"></i> 已连接</div>
                            </div>
                            <div
                                style="font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">
                                SSE</div>
                        </div>
                    </div>

                    <!-- Tab: Market -->
                    <div id="mcp-tab-market" style="display: none; padding: 15px;">
                        <input type="text" placeholder="搜索 MCP 服务..."
                            style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px; border-radius: 6px; color: white; margin-bottom: 15px; font-size: 0.85rem;">

                        <!-- Market Items -->
                        <div class="market-list">
                            <!-- Item 1 -->
                            <div class="mcp-market-item"
                                style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fab fa-github" style="font-size: 1.2rem; margin-right: 10px;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">GitHub</div>
                                    <button
                                        style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">安装</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    提供仓库搜索、文件读取、PR 管理等能力。
                                </div>
                            </div>

                            <!-- Item 2 -->
                            <div class="mcp-market-item"
                                style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fas fa-database"
                                        style="font-size: 1.2rem; margin-right: 10px; color: #336791;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">PostgreSQL</div>
                                    <button
                                        style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">安装</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    只读访问数据库模式，执行安全查询。
                                </div>
                            </div>

                            <!-- Item 3 -->
                            <div class="mcp-market-item"
                                style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fab fa-google-drive"
                                        style="font-size: 1.2rem; margin-right: 10px; color: #1FA463;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Google Drive</div>
                                    <button
                                        style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">安装</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    访问文档、表格和幻灯片内容。
                                </div>
                            </div>

                            <!-- Item 4 -->
                            <div class="mcp-market-item"
                                style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                    <i class="fas fa-terminal"
                                        style="font-size: 1.2rem; margin-right: 10px; color: #ccc;"></i>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Local Commander</div>
                                    <button
                                        style="margin-left: auto; background: var(--primary); border: none; color: white; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">安装</button>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                                    在安全沙箱中执行本地 shell 命令。
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- Left Sidebar Resizer -->
        <div class="left-resizer" id="leftResizer"></div>

        <!-- 3. Main Content -->
        <div class="main-content">
            <!-- Updated Tabs -->
            <div class="editor-tabs" style="padding: 0 10px; justify-content: flex-start; gap: 10px;">
                <button onclick="switchMainView('editor')" id="view-btn-editor"
                    style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary); border: none; border-radius: 6px 6px 0 0; color: white; cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: all 0.2s; border-bottom: 2px solid var(--primary);">
                    <i class="fas fa-layer-group"></i> 内容视图
                </button>

                <button onclick="switchMainView('canvas')" id="view-btn-canvas"
                    style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: transparent; border: none; border-radius: 6px 6px 0 0; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; font-weight: normal; transition: all 0.2s; border-bottom: 2px solid transparent;">
                    <i class="fas fa-project-diagram"></i> 智能体调度驾驶舱
                </button>

                <div style="flex: 1;"></div>

                <div id="content-status-indicator"
                    style="margin-right: 15px; font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 5px;">
                    <!-- Dynamic content label -->
                    <i class="fas fa-info-circle"></i> <span id="content-title-text">欢迎页</span>
                </div>

                <!-- Clear Buttons -->
                <button onclick="clearEditorContent()" title="清空内容画布"
                    style="padding: 8px 12px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-eraser"></i>
                </button>
            </div>

            <!-- Editor Area -->
            <div class="editor-area" id="editorArea">
                <div class="welcome-message" style="max-width: 800px; margin: 50px auto; text-align: center;">
                    <div
                        style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); position: relative; overflow: hidden;">
                        <span style="font-size: 48px; font-weight: 900; color: white;">AD</span>
                        <div
                            style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent); transform: rotate(45deg); animation: shine 3s infinite;">
                        </div>
                    </div>
                    <h1 style="color: var(--text-primary); margin-bottom: 15px;">欢迎使用 AgentDesk</h1>
                    <p style="color: var(--text-secondary); line-height: 1.8; font-size: 16px;">
                        在左侧选择文件或智能体开始工作<br>
                        使用 <code
                            style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px; color: #FF6B00;">@智能体名称</code>
                        提问，或点击下方的智能体卡片快速开始
                    </p>
                </div>
            </div>

            <!-- Canvas Area (Now overlay/fullscreen) -->
            <div class="canvas-area" id="canvasArea">
                <div class="canvas-header sticky">
                    <span>智能体工作流</span>
                    <div style="display: flex; gap: 10px;">
                        <span style="font-size: 0.8rem; color: #888;"><i class="fas fa-mouse-pointer"></i>
                            拖拽节点调整位置</span>
                    </div>
                </div>
                <canvas id="workflowCanvas"></canvas>
                <div id="workflowNodes"></div>
            </div>

            <!-- Workflow Detail View (Prototype) -->
            <div class="workflow-detail-area" id="workflowDetailArea"
                style="display: none; position: absolute; top: 35px; left: 0; width: 100%; height: calc(100% - 35px); background: var(--bg-primary); z-index: 20; padding: 20px; overflow-y: auto;">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- 4. Right Panel -->
        <div class="right-resizer" id="rightResizer"></div>
        <div class="right-panel" id="rightPanel">
            <div class="sidebar-header">
                <span>AI智能体团队</span>
                <div class="sidebar-header-actions">
                    <i class="fas fa-trash-alt collapse-btn" onclick="clearChat()" title="清空对话"></i>
                    <i class="fas fa-angle-right collapse-btn" onclick="toggleSidebar('right')" title="折叠"></i>
                </div>
            </div>
            <div id="chat-messages"
                style="flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; min-height: 0;">
                <div class="chat-message agent-message">
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">你好！欢迎使用 AgentDesk，您的智能团队随时待命。有什么可以帮你？</div>
                </div>
            </div>

            <!-- 可拖动的分隔线 -->
            <div id="chatInputResizer"
                style="height: 4px; background: var(--border); cursor: ns-resize; position: relative; transition: background 0.2s; flex-shrink: 0;"
                onmouseenter="this.style.background='var(--primary)'"
                onmouseleave="this.style.background='var(--border)'" title="拖动调整输入区域高度">
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 2px; background: var(--text-secondary); border-radius: 2px;">
                </div>
            </div>

            <div id="chatInputArea"
                style="padding: 15px; background: var(--bg-secondary); position: relative; flex-shrink: 0;">
                <div id="mentionDropdown" class="mention-dropdown"></div>

                <!-- 工具栏：功能按钮 -->
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">
                    <!-- 左侧功能按钮组 -->
                    <div style="display: flex; gap: 6px;">
                        <button id="optimizeBtn" onclick="optimizePrompt()" type="button" title="优化提示词"
                            style="width: 32px; height: 32px; background: rgba(156, 39, 176, 0.2); border: 1px solid rgba(156, 39, 176, 0.4); border-radius: 6px; color: #E040FB; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.85rem;">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button id="undoOptimizeBtn" onclick="undoOptimize()" type="button" title="撤回优化"
                            style="display: none; width: 32px; height: 32px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #bbb; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.85rem;">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button onclick="copyChatHistory()" type="button" title="复制对话内容"
                            style="width: 32px; height: 32px; background: rgba(33, 150, 243, 0.2); border: 1px solid rgba(33, 150, 243, 0.4); border-radius: 6px; color: #64B5F6; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.85rem;">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="downloadChatHistory()" type="button" title="下载对话到TXT"
                            style="width: 32px; height: 32px; background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.4); border-radius: 6px; color: #81C784; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.85rem;">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>

                    <!-- 右侧操作按钮组 -->
                    <div style="display: flex; gap: 6px; margin-left: auto;">
                        <button id="sendBtn" onclick="executeTask(document.getElementById('chatInput').value)"
                            title="发送消息 (Enter)"
                            style="width: 32px; height: 32px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(255, 107, 0, 0.3);">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button id="cancelBtn" onclick="cancelTask()" title="停止生成"
                            style="display: none; width: 32px; height: 32px; background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); border: none; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- 输入框 -->
                <div style="display: flex; align-items: flex-end; gap: 8px;">
                    <textarea id="chatInput" placeholder="输入消息... (Enter 发送，Shift+Enter 换行，输入 @ 呼叫智能体)" rows="1"
                        style="flex: 1; padding: 8px 15px; background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 107, 0, 0.3); color: #fff; border-radius: 8px; outline: none; transition: border-color 0.3s; resize: none; min-height: 40px; max-height: 200px; line-height: 1.5; font-family: inherit; overflow-y: auto; overflow-x: hidden; white-space: pre-wrap; word-wrap: break-word; scrollbar-width: thin; scrollbar-color: rgba(255, 107, 0, 0.3) transparent;"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div id="command-palette">
        <input type="text" id="command-input" placeholder="Type a command... (e.g., 'Switch to Investment')">
        <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
            <div><span style="color: var(--primary);">Enter</span> to execute</div>
            <div><span style="color: var(--primary);">Esc</span> to close</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> 系统设置</h3>
                <span class="close-modal" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>模型提供商</label>
                    <div class="provider-options">
                        <div class="provider-option active" onclick="selectProvider('gemini')" data-provider="gemini">
                            <i class="fas fa-gem"></i> Gemini
                        </div>
                        <div class="provider-option" onclick="selectProvider('deepseek')" data-provider="deepseek">
                            <i class="fas fa-brain"></i> DeepSeek
                        </div>
                        <div class="provider-option" onclick="selectProvider('openai')" data-provider="openai">
                            <i class="fas fa-robot"></i> OpenAI
                        </div>
                        <div class="provider-option" onclick="selectProvider('local')" data-provider="local">
                            <i class="fas fa-server"></i> Local
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="setting-api-key" class="form-control" placeholder="输入 API Key">
                </div>
                <div class="form-group">
                    <label>模型名称</label>
                    <input type="text" id="setting-model-name" class="form-control"
                        placeholder="例如: gemini-2.5-flash, deepseek-chat">
                </div>
                <div class="form-group" id="base-url-group" style="display: none;">
                    <label>Base URL (API 代理地址)</label>
                    <input type="text" id="setting-base-url" class="form-control"
                        placeholder="例如: https://api.deepseek.com">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeSettingsModal()">取消</button>
                <button class="btn-save" id="saveSettingsBtn" onclick="saveSettings()">保存并重启</button>
            </div>
        </div>
    </div>

    <!-- Scripts for File Preview -->
    <script src="/static/js/mammoth.browser.min.js"></script>
    <script src="/static/js/xlsx.full.min.js"></script>

    <script>
        // ==================== Core Logic & State ====================
        const WorkflowManager = {
            currentScenario: 'all', // 'all', 'investment', 'compliance', 'operations'
            scenarios: {
                investment: {
                    name: '智能投研',
                    agentIds: ['coordinator', 'doc_analyst', 'data_expert']
                },
                compliance: {
                    name: '合规营销',
                    agentIds: ['coordinator', 'content_creator', 'compliance_officer']
                },
                operations: {
                    name: '智能运营',
                    agentIds: ['coordinator', 'doc_analyst', 'translator']
                }
            },

            setScenario(type) {
                this.currentScenario = type;
                console.log(`Switched to scenario: ${type}`);
                renderAgents(); // Re-render agents based on filter

                // Update UI
                const title = type === 'all' ? '资源管理器' : this.scenarios[type].name;
                // You might want to update some header text here
            }
        };

        let currentActiveFile = null; // 当前在内容视图中打开的文件
        let agents = [];
        let canvas, ctx;
        let workflowConnections = [];
        let particles = []; // Background particles
        let taskCounter = 0;
        let animationId = null;
        let currentAbortController = null; // 用于取消请求
        let isDropdownActive = false; // 全局标记 @ 提及下拉框是否激活

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', function () {
            console.log('[Init] DOM Content Loaded');
            console.log('[Init] Elements check:', {
                globalInput: !!document.getElementById('globalInput'),
                landingMentionDropdown: !!document.getElementById('landingMentionDropdown'),
                chatInput: !!document.getElementById('chatInput'),
                mentionDropdown: !!document.getElementById('mentionDropdown')
            });

            initCanvas();
            loadAgents();
            loadFiles(); // Load files on startup
            startAnimation();

            // Auto-focus landing input
            const globalInput = document.getElementById('globalInput');
            if (globalInput) {
                globalInput.focus();
                console.log('[Init] Global input focused');
            }
        });

        function initCanvas() {
            // The canvas needs to be visible for proper initialization sometimes, 
            // but since it's now absolute/overlay, we can init it directly.
            const container = document.querySelector('.canvas-area');
            container.innerHTML = '<canvas id="workflowCanvas"></canvas><div id="workflowNodes"></div>';

            canvas = document.getElementById('workflowCanvas');
            ctx = canvas.getContext('2d');

            // Initial resize (even if invisible)
            resizeCanvas();
            initParticles();

            window.addEventListener('resize', () => {
                resizeCanvas();
                initParticles();
            });
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawWorkflow();
        }

        // ==================== Agent Management ====================
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                if (data.success) {
                    agents = data.agents.map(agent => ({
                        ...agent,
                        status: 'idle',
                        tasksCompleted: 0,
                        position: null
                    }));
                    renderAgents();
                    buildMarketAgents();
                    renderMarket();
                    renderLandingAgents();

                    // 初始化 mention 逻辑（需要在 marketAgents 构建完成后）
                    setupMentionLogic(document.getElementById('chatInput'), document.getElementById('mentionDropdown'));
                    setupMentionLogic(document.getElementById('globalInput'), document.getElementById('landingMentionDropdown'));
                }
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }

        function renderAgents() {
            // Filter agents based on current scenario
            let visibleAgents = agents;
            if (WorkflowManager.currentScenario !== 'all') {
                const allowedIds = WorkflowManager.scenarios[WorkflowManager.currentScenario].agentIds;
                visibleAgents = agents.filter(a => allowedIds.includes(a.id));
            }

            // Calculate positions (Circle Layout)
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // Enforce minimum radius to avoid overlap (reduced for smaller display)
            const minRadius = 100;
            const calculatedRadius = Math.min(canvas.width, canvas.height) * 0.28;
            const radius = Math.max(minRadius, calculatedRadius);

            const coordinator = visibleAgents.find(a => a.name === '协调者');
            const others = visibleAgents.filter(a => a.name !== '协调者');

            if (coordinator) {
                // Update original agent object
                const original = agents.find(a => a.name === coordinator.name);
                if (original) original.position = { x: centerX, y: centerY };
            }

            others.forEach((agent, index) => {
                const angle = (index / others.length) * Math.PI * 2 - Math.PI / 2;
                const original = agents.find(a => a.name === agent.name);
                if (original) {
                    original.position = {
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius
                    };
                }
            });

            renderWorkflowNodes(visibleAgents, centerX, centerY);
            drawWorkflow();
        }

        function renderWorkflowNodes(visibleAgents, centerX, centerY) {
            const container = document.getElementById('workflowNodes');
            container.innerHTML = visibleAgents.map((agent, index) => {
                if (!agent.position) return '';
                const iconColor = agent.status === 'working' ? '#FF6B00' : '#888';

                // Radial Label Positioning
                let labelStyle = '';
                const isCenter = agent.name === '协调者';

                if (isCenter) {
                    // Center node: label directly below
                    labelStyle = `left: ${agent.position.x}px; top: ${agent.position.y + 40}px; transform: translateX(-50%);`;
                } else {
                    // Outer nodes: push label radially outward
                    const dx = agent.position.x - centerX;
                    const dy = agent.position.y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance > 0) {
                        // Normalize and scale
                        // The node radius is approx 30px. We want the label to be outside that.
                        // Let's push it 45px out from the node center (reduced for smaller display).
                        const offset = 45;
                        const labelX = agent.position.x + (dx / distance) * offset;
                        const labelY = agent.position.y + (dy / distance) * offset;

                        labelStyle = `left: ${labelX}px; top: ${labelY}px; transform: translate(-50%, -50%);`;
                    } else {
                        // Fallback
                        labelStyle = `left: ${agent.position.x}px; top: ${agent.position.y + 50}px; transform: translateX(-50%);`;
                    }
                }

                return `
                    <div class="workflow-node ${agent.status}" 
                         style="left: ${agent.position.x}px; top: ${agent.position.y}px; position: absolute; transform: translate(-50%, -50%);"
                         title="${agent.name}">
                        <i class="${agent.emoji}" style="color: ${iconColor};"></i>
                    </div>
                    <div class="agent-label" style="${labelStyle}">${agent.name}</div>
                `;
            }).join('');
        }

        // ==================== Canvas Drawing ====================
        function drawWorkflow() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Background Particles
            drawParticles();

            workflowConnections.forEach(conn => {
                drawConnection(conn);
            });
        }

        // ==================== Particle System ====================
        function initParticles() {
            particles = [];
            const count = 50;
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1,
                    alpha: Math.random() * 0.3 + 0.1
                });
            }
        }

        function drawParticles() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                // Bounce off walls
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
                ctx.fill();
            });
        }

        function drawConnection(conn) {
            const fromAgent = agents[conn.from];
            const toAgent = agents[conn.to];

            if (!fromAgent || !toAgent || !fromAgent.position || !toAgent.position) return;

            const from = fromAgent.position;
            const to = toAgent.position;
            const progress = conn.progress;

            // Gradient
            const gradient = ctx.createLinearGradient(from.x, from.y, to.x, to.y);
            gradient.addColorStop(0, 'rgba(255, 107, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 107, 0, 0.8)');

            ctx.beginPath();
            ctx.moveTo(from.x, from.y);

            const currentX = from.x + (to.x - from.x) * progress;
            const currentY = from.y + (to.y - from.y) * progress;

            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3; // Increased from 2
            ctx.lineCap = 'round';
            ctx.shadowBlur = 15; // Increased from 10
            ctx.shadowColor = 'rgba(255, 107, 0, 0.6)'; // Increased opacity
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Head Particle (larger)
            ctx.beginPath();
            ctx.arc(currentX, currentY, 4, 0, Math.PI * 2); // Increased from 3
            ctx.fillStyle = '#FF6B00';
            ctx.fill();

            // Glow around particle
            ctx.beginPath();
            ctx.arc(currentX, currentY, 8, 0, Math.PI * 2);
            const particleGlow = ctx.createRadialGradient(currentX, currentY, 2, currentX, currentY, 8);
            particleGlow.addColorStop(0, 'rgba(255, 107, 0, 0.4)');
            particleGlow.addColorStop(1, 'rgba(255, 107, 0, 0)');
            ctx.fillStyle = particleGlow;
            ctx.fill();
        }

        function startAnimation() {
            function animate() {
                drawWorkflow();
                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function addWorkflowConnection(fromIndex, toIndex) {
            const connection = {
                from: fromIndex,
                to: toIndex,
                progress: 0,
                id: Date.now()
            };
            workflowConnections.push(connection);

            const duration = 800;
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                connection.progress = Math.min(elapsed / duration, 1);
                if (connection.progress < 1) requestAnimationFrame(animate);
            }
            animate();
        }

        // ==================== Interaction Logic ====================
        const input = document.getElementById('globalInput');
        const chatInput = document.getElementById('chatInput');

        // 当前问答会话 ID
        let currentQaSessionId = null;

        // 问答模式状态
        let isQaMode = false;

        // Landing Page Input - 处理 Enter 键
        input.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                // 如果输入法正在组合中（如中文输入法确认文字），不触发提交
                if (e.isComposing) {
                    return;
                }
                // 如果 @ 提及下拉框激活，不在这里处理 Enter 键
                // 让 setupMentionLogic 中的监听器处理选择逻辑
                if (isDropdownActive) {
                    return;
                }
                e.preventDefault();
                await handleLandingInput();
            }
        });

        /**
         * 处理首页输入：先进行意图识别，再决定是问答还是进入工作台
         */
        async function handleLandingInput() {
            const val = input.value.trim();
            if (!val) return;

            try {
                // 1. 调用意图识别 API
                const intentRes = await fetch('/api/parse-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: val })
                });
                const intentData = await intentRes.json();

                console.log('[意图识别]', intentData);

                // 2. 根据意图决定行为
                if (intentData.intent === 'qa') {
                    // 问答模式：在首页直接回答
                    await handleLandingQa(val);
                } else {
                    // 任务模式：进入工作台
                    enterWorkspaceWithTask(val);
                }
            } catch (error) {
                console.error('[意图识别失败]', error);
                // 降级处理：默认进入工作台
                enterWorkspaceWithTask(val);
            }
        }

        /**
         * 处理首页问答
         */
        async function handleLandingQa(question) {
            const qaWrapper = document.getElementById('landingQaWrapper');
            const qaMessages = document.getElementById('landingQaMessages');

            // 显示问答区域，并进入问答模式（隐藏智能体图标）
            qaWrapper.style.display = 'flex';
            document.body.classList.add('qa-active');
            isQaMode = true;

            // 首次显示时加载历史记录
            if (!currentQaSessionId) {
                loadQaHistory();
            }

            // 添加用户消息
            addLandingQaMessage('user', question);

            // 清空输入框
            input.value = '';

            // 隐藏预测问题
            document.getElementById('landingQaSuggestions').style.display = 'none';

            // 添加加载动画
            const loadingId = 'loading-' + Date.now();
            qaMessages.innerHTML += `
                <div class="landing-qa-message assistant" id="${loadingId}">
                    <div class="landing-qa-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="landing-qa-bubble">
                        <div class="landing-qa-loading">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            scrollQaToBottom();

            try {
                // 调用问答 API
                const res = await fetch('/api/landing-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: question,
                        session_id: currentQaSessionId
                    })
                });

                const data = await res.json();

                // 保存会话 ID
                if (data.session_id) {
                    currentQaSessionId = data.session_id;
                    // 刷新历史列表
                    loadQaHistory();
                }

                // 移除加载动画
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                // 添加 AI 回答
                if (data.success) {
                    addLandingQaMessage('assistant', data.answer, data.agent);
                    // 生成预测问题
                    generateSuggestions(question, data.answer);
                } else {
                    addLandingQaMessage('assistant', '抱歉，暂时无法回答您的问题。');
                }

            } catch (error) {
                console.error('[问答失败]', error);
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                addLandingQaMessage('assistant', '网络错误，请稍后重试。');
            }
        }

        /**
         * 添加问答消息到界面 - 使用高级 SVG 图标
         */
        function addLandingQaMessage(role, content, agent = null) {
            const qaMessages = document.getElementById('landingQaMessages');

            const agentName = agent?.name || '';

            // 格式化内容（支持 Markdown 和 HTML 渲染）
            const formattedContent = formatQaContent(content);

            // 用户图标 SVG
            const userAvatar = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            `;

            // AI 助手图标 SVG
            const assistantAvatar = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1a7 7 0 01-14 0H5a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/>
                    <circle cx="9" cy="13" r="1.5" fill="currentColor"/>
                    <circle cx="15" cy="13" r="1.5" fill="currentColor"/>
                </svg>
            `;

            const messageHtml = `
                <div class="landing-qa-message ${role}">
                    <div class="landing-qa-avatar">
                        ${role === 'user' ? userAvatar : assistantAvatar}
                    </div>
                    <div class="landing-qa-bubble">
                        ${agentName ? `
                            <div class="landing-qa-agent-name">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707"/>
                                </svg>
                                ${agentName}
                            </div>
                        ` : ''}
                        <div class="landing-qa-content">${formattedContent}</div>
                    </div>
                </div>
            `;

            qaMessages.innerHTML += messageHtml;
            scrollQaToBottom();

            // 处理 HTML 渲染
            processHtmlBlocks();
        }

        /**
         * 格式化问答内容 - 支持 Markdown 和 HTML 代码块
         */
        function formatQaContent(text) {
            if (!text) return '';

            // 检测并处理 HTML 代码块
            text = text.replace(/```html\n([\s\S]*?)```/g, (match, code) => {
                const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<div class="landing-qa-html-render" data-html="${btoa(encodeURIComponent(code))}">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">HTML 预览</div>
                    <iframe sandbox="allow-scripts" srcdoc=""></iframe>
                    <details style="margin-top: 8px;">
                        <summary style="cursor: pointer; font-size: 0.75rem; color: var(--text-secondary);">查看代码</summary>
                        <pre><code>${escapedCode}</code></pre>
                    </details>
                </div>`;
            });

            // 普通代码块
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<pre><code class="language-${lang}">${escapedCode}</code></pre>`;
            });

            // Markdown 格式化
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        /**
         * 处理 HTML 代码块渲染
         */
        function processHtmlBlocks() {
            document.querySelectorAll('.landing-qa-html-render[data-html]').forEach(el => {
                const htmlData = el.getAttribute('data-html');
                if (htmlData) {
                    try {
                        const html = decodeURIComponent(atob(htmlData));
                        const iframe = el.querySelector('iframe');
                        if (iframe && !iframe.srcdoc) {
                            iframe.srcdoc = `<!DOCTYPE html><html><head><style>body{margin:16px;font-family:system-ui;}</style></head><body>${html}</body></html>`;
                        }
                    } catch (e) {
                        console.error('HTML 渲染失败:', e);
                    }
                }
            });
        }

        /**
         * 生成预测问题
         */
        function generateSuggestions(question, answer) {
            const suggestionsContainer = document.getElementById('landingQaSuggestions');
            const suggestionsList = document.getElementById('landingQaSuggestionsList');

            // 基于回答内容生成相关问题
            const suggestions = [];

            // 简单的规则生成
            if (answer.includes('ETF') || answer.includes('基金')) {
                suggestions.push('如何选择适合自己的基金？');
                suggestions.push('基金定投有什么优势？');
            }
            if (answer.includes('投资') || answer.includes('理财')) {
                suggestions.push('有哪些常见的投资策略？');
                suggestions.push('如何控制投资风险？');
            }
            if (answer.includes('股票') || answer.includes('股市')) {
                suggestions.push('如何进行基本面分析？');
                suggestions.push('技术分析有哪些常用指标？');
            }
            if (answer.includes('量化')) {
                suggestions.push('量化策略有哪些类型？');
                suggestions.push('个人投资者如何入门量化？');
            }

            // 默认建议
            if (suggestions.length === 0) {
                suggestions.push('帮我分析一下最近的市场行情');
                suggestions.push('推荐一些入门投资书籍');
                suggestions.push('什么是资产配置？');
            }

            // 只显示前3个
            const displaySuggestions = suggestions.slice(0, 3);

            suggestionsList.innerHTML = displaySuggestions.map(s =>
                `<div class="landing-qa-suggestion" onclick="askSuggestion('${s.replace(/'/g, "\\'")}')">${s}</div>`
            ).join('');

            suggestionsContainer.style.display = 'block';
        }

        /**
         * 点击预测问题
         */
        function askSuggestion(question) {
            handleLandingQa(question);
        }

        /**
         * 加载历史对话列表
         */
        async function loadQaHistory() {
            const historyList = document.getElementById('landingQaHistoryList');

            try {
                const res = await fetch('/api/qa/sessions?limit=15');
                const data = await res.json();

                if (data.sessions && data.sessions.length > 0) {
                    historyList.innerHTML = data.sessions.map(session => `
                        <div class="landing-qa-history-item ${session.session_id === currentQaSessionId ? 'active' : ''}" 
                             onclick="loadQaSession('${session.session_id}')">
                            <div class="landing-qa-history-item-title">${escapeHtml(session.title || '新对话')}</div>
                            <div class="landing-qa-history-item-time">${formatTime(session.updated_at)} · ${session.message_count || 0} 条消息</div>
                        </div>
                    `).join('');
                } else {
                    historyList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.85rem;">
                            暂无历史对话
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载历史失败:', error);
                historyList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.85rem;">
                        加载失败
                    </div>
                `;
            }
        }

        /**
         * 加载指定会话
         */
        async function loadQaSession(sessionId) {
            const qaMessages = document.getElementById('landingQaMessages');

            try {
                const res = await fetch(`/api/qa/history/${sessionId}`);
                const data = await res.json();

                // 清空当前消息
                qaMessages.innerHTML = '';
                currentQaSessionId = sessionId;

                // 渲染历史消息
                if (data.history && data.history.length > 0) {
                    data.history.forEach(item => {
                        addLandingQaMessage('user', item.question);
                        addLandingQaMessage('assistant', item.answer, { name: item.agent_name });
                    });
                }

                // 刷新历史列表高亮
                loadQaHistory();

                // 隐藏预测问题
                document.getElementById('landingQaSuggestions').style.display = 'none';

            } catch (error) {
                console.error('加载会话失败:', error);
            }
        }

        /**
         * 开始新会话
         */
        function startNewQaSession() {
            const qaMessages = document.getElementById('landingQaMessages');
            qaMessages.innerHTML = '';
            currentQaSessionId = null;

            // 刷新历史列表
            loadQaHistory();

            // 显示预测问题
            const suggestionsContainer = document.getElementById('landingQaSuggestions');
            const suggestionsList = document.getElementById('landingQaSuggestionsList');
            suggestionsList.innerHTML = `
                <div class="landing-qa-suggestion" onclick="askSuggestion('什么是ETF？')">什么是ETF？</div>
                <div class="landing-qa-suggestion" onclick="askSuggestion('如何选择基金？')">如何选择基金？</div>
                <div class="landing-qa-suggestion" onclick="askSuggestion('量化投资入门')">量化投资入门</div>
            `;
            suggestionsContainer.style.display = 'block';

            // 聚焦输入框
            input.focus();
        }

        /**
         * 切换历史侧边栏
         */
        function toggleQaHistory() {
            const history = document.getElementById('landingQaHistory');
            history.style.display = history.style.display === 'none' ? 'flex' : 'none';
        }

        /**
         * 提交问答区域的问题
         */
        function submitQaQuestion() {
            const qaInput = document.getElementById('landingQaInput');
            const question = qaInput.value.trim();

            if (!question) return;

            // 清空输入框
            qaInput.value = '';

            // 调用问答处理函数
            handleLandingQa(question);
        }

        /**
         * 隐藏问答面板
         */
        function hideQaPanel() {
            const qaWrapper = document.getElementById('landingQaWrapper');
            qaWrapper.style.display = 'none';
            document.body.classList.remove('qa-active');
            isQaMode = false;
        }

        /**
         * 格式化时间
         */
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' 分钟前';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' 小时前';
            if (diff < 604800000) return Math.floor(diff / 86400000) + ' 天前';

            return date.toLocaleDateString('zh-CN');
        }

        /**
         * 转义 HTML
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * 滚动问答区域到底部
         */
        function scrollQaToBottom() {
            const qaMessages = document.getElementById('landingQaMessages');
            setTimeout(() => {
                qaMessages.scrollTop = qaMessages.scrollHeight;
            }, 100);
        }

        /**
         * 清空首页问答
         */
        function clearLandingQa() {
            const qaMessages = document.getElementById('landingQaMessages');
            qaMessages.innerHTML = '';
            currentQaSessionId = null;

            // 显示欢迎消息
            startNewQaSession();
        }

        /**
         * 带任务进入工作台
         */
        function enterWorkspaceWithTask(task) {
            document.body.classList.add('mode-workspace');

            if (task) {
                chatInput.value = task;
                executeTask(task);
            }

            // 清空输入框
            input.value = '';
        }

        /**
         * 直接进入工作台（点击按钮时）
         */
        function enterWorkspace() {
            const val = input.value.trim();

            // 如果有输入内容，走意图识别流程
            if (val) {
                handleLandingInput();
            } else {
                // 没有输入，直接进入工作台
                document.body.classList.add('mode-workspace');
            }
        }

        // 返回首页
        function goToHomePage() {
            // 移除工作区模式
            document.body.classList.remove('mode-workspace');

            // 清空输入框
            const input = document.getElementById('landing-input');
            if (input) input.value = '';

            // 重置内容区
            const editorArea = document.getElementById('editorArea');
            if (editorArea) {
                editorArea.classList.remove('collapsed');
                editorArea.innerHTML = `
                    <div class="welcome-message" style="max-width: 800px; margin: 50px auto; text-align: center;">
                        <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); position: relative; overflow: hidden;">
                            <span style="font-size: 48px; font-weight: 900; color: white;">AD</span>
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent); transform: rotate(45deg); animation: shine 3s infinite;"></div>
                        </div>
                        <h1 style="color: var(--text-primary); margin-bottom: 15px;">欢迎使用 AgentDesk</h1>
                        <p style="color: var(--text-secondary); line-height: 1.8; font-size: 16px;">
                            在左侧选择文件或智能体开始工作<br>
                            使用 <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px; color: #FF6B00;">@智能体名称</code> 提问，或点击下方的智能体卡片快速开始
                        </p>
                    </div>
                `;
            }

            // 更新标题
            updateContentTitle('AI智能体团队工作区', 'fas fa-comments');

            // 清空聊天消息，只保留欢迎消息
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="chat-message agent-message">
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">你好！欢迎使用 AgentDesk，您的智能团队随时待命。有什么可以帮你？</div>
                    </div>
                `;
            }

            // 聚焦到搜索框
            setTimeout(() => {
                if (input) input.focus();
            }, 300);
        }

        // Chat Panel Input - 自动调整高度（根据内容，最大200px）
        function adjustChatInputHeight() {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput) return;

            // 重置高度以获取正确的 scrollHeight
            chatInput.style.height = 'auto';

            // 计算内容高度
            const scrollHeight = chatInput.scrollHeight;
            const minHeight = 40; // 最小高度（1行）
            const maxHeight = 200; // 最大高度（约10行）

            // 设置高度，在最小和最大之间
            if (scrollHeight < minHeight) {
                chatInput.style.height = minHeight + 'px';
            } else if (scrollHeight > maxHeight) {
                chatInput.style.height = maxHeight + 'px';
                // 超过最大高度时，确保可以滚动
                chatInput.style.overflowY = 'auto';
            } else {
                chatInput.style.height = scrollHeight + 'px';
                // 如果内容不超过最大高度，不需要滚动
                if (scrollHeight <= maxHeight) {
                    chatInput.style.overflowY = 'hidden';
                }
            }
        }

        // 监听输入变化，自动调整高度
        chatInput.addEventListener('input', adjustChatInputHeight);

        // 初始化时调整一次高度
        setTimeout(adjustChatInputHeight, 100);

        // Chat Panel Input - 键盘事件
        chatInput.addEventListener('keydown', (e) => {
            // 如果输入法正在组合中（如中文输入法确认文字），不触发提交
            if (e.isComposing) {
                return;
            }
            
            // 检查下拉菜单是否显示
            const dropdown = document.getElementById('mentionDropdown');
            const isDropdownVisible = dropdown && dropdown.classList.contains('show');

            if (!isDropdownVisible && e.key === 'Enter' && !e.shiftKey) {
                const val = chatInput.value.trim();
                if (val) {
                    executeTask(val);
                    chatInput.value = '';
                    chatInput.style.height = '40px'; // 重置高度
                    chatInput.style.overflowY = 'hidden'; // 重置滚动
                }
                e.preventDefault();
            }
        });

        // 可拖动分隔线 - 调整输入区域高度
        (function () {
            const resizer = document.getElementById('chatInputResizer');
            const chatInputArea = document.getElementById('chatInputArea');

            if (resizer && chatInputArea) {
                let isResizing = false;
                let startY = 0;
                let startHeight = 0;

                resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = chatInputArea.offsetHeight;
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const deltaY = startY - e.clientY; // 向上拖动，输入区域变大
                    const newHeight = Math.max(80, Math.min(400, startHeight + deltaY));
                    chatInputArea.style.height = newHeight + 'px';
                    chatInputArea.style.maxHeight = newHeight + 'px';
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                });
            }
        })();

        // 复制对话内容
        function copyChatHistory() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;

            const messages = chatMessages.querySelectorAll('.chat-message');
            let text = '';

            messages.forEach(msg => {
                const role = msg.classList.contains('user-message') ? '用户' :
                    msg.classList.contains('agent-message') ? '智能体' : '系统';
                const content = msg.querySelector('.message-content')?.textContent ||
                    msg.querySelector('.typing-content')?.textContent || '';
                const agentName = msg.querySelector('.message-agent-name')?.textContent || '';

                if (agentName) {
                    text += `[${role}: ${agentName}]\n${content}\n\n`;
                } else {
                    text += `[${role}]\n${content}\n\n`;
                }
            });

            if (text.trim()) {
                navigator.clipboard.writeText(text.trim()).then(() => {
                    showToast('对话内容已复制到剪贴板', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showToast('复制失败，请手动选择文本复制', 'error');
                });
            } else {
                showToast('没有可复制的内容', 'info');
            }
        }

        // 下载对话到TXT
        function downloadChatHistory() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return;

            const messages = chatMessages.querySelectorAll('.chat-message');
            let text = 'AgentDesk 对话记录\n';
            text += '='.repeat(50) + '\n';
            text += `生成时间: ${new Date().toLocaleString('zh-CN')}\n`;
            text += '='.repeat(50) + '\n\n';

            messages.forEach((msg, index) => {
                const role = msg.classList.contains('user-message') ? '用户' :
                    msg.classList.contains('agent-message') ? '智能体' : '系统';
                const content = msg.querySelector('.message-content')?.textContent ||
                    msg.querySelector('.typing-content')?.textContent || '';
                const agentName = msg.querySelector('.message-agent-name')?.textContent || '';

                if (agentName) {
                    text += `[${index + 1}] ${role}: ${agentName}\n`;
                } else {
                    text += `[${index + 1}] ${role}\n`;
                }
                text += '-'.repeat(30) + '\n';
                text += content + '\n\n';
            });

            // 创建下载链接
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.href = url;
            a.download = `AgentDesk_对话记录_${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('对话记录已下载', 'success');
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: '#4CAF50',
                error: '#F44336',
                info: '#2196F3'
            };
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${colors[type] || colors.info};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // 添加动画样式
        if (!document.getElementById('toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + K: Open Command Palette
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                toggleCommandPalette();
            }
            // Cmd/Ctrl + /: Focus Chat
            if ((e.metaKey || e.ctrlKey) && e.key === '/') {
                e.preventDefault();
                chatInput.focus();
            }
            // Esc: Close Palette
            if (e.key === 'Escape') {
                document.getElementById('command-palette').classList.remove('active');
            }
        });

        function toggleCommandPalette() {
            const palette = document.getElementById('command-palette');
            const input = document.getElementById('command-input');
            palette.classList.toggle('active');
            if (palette.classList.contains('active')) {
                input.focus();
            }
        }

        // Command Palette Logic
        document.getElementById('command-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const cmd = e.target.value.trim().toLowerCase();
                if (cmd.includes('invest')) selectScenario(document.querySelectorAll('.scenario-card')[0], 'investment');
                if (cmd.includes('compli')) selectScenario(document.querySelectorAll('.scenario-card')[1], 'compliance');
                if (cmd.includes('oper')) selectScenario(document.querySelectorAll('.scenario-card')[2], 'operations');

                toggleCommandPalette();
                e.target.value = '';
            }
        });

        // Execute Task (Mock -> Real)
        function getAgentIdByName(name) {
            const found = agents.find(a => a.name === name);
            return found ? found.id : null;
        }

        async function executeTask(message, agentId = null) {
            if (!message || !message.trim()) return;

            console.log("Executing:", message);

            // 切换按钮显示
            const sendBtn = document.getElementById('sendBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            if (sendBtn && cancelBtn) {
                sendBtn.style.display = 'none';
                cancelBtn.style.display = 'block';
            }

            // Add User Message to Chat
            addChatMessage('user', message);

            // 1. Visual: Coordinator starts
            const coordinatorIndex = agents.findIndex(a => a.name === '协调者');
            if (coordinatorIndex !== -1) {
                agents[coordinatorIndex].status = 'working';
                renderAgents(); // Update visual state
            }

            try {
                // Show loading indicator
                showLoading();

                // 创建 AbortController
                currentAbortController = new AbortController();

                // 2. Call API
                const formData = new FormData();
                formData.append('message', message);

                // Add scenario context
                if (WorkflowManager.currentScenario !== 'all') {
                    formData.append('scenario', WorkflowManager.currentScenario);
                }
                if (!agentId) {
                    const m = message.match(/@([^\s@]+)/);
                    if (m && m[1]) {
                        const found = agents.find(a => a.name === m[1]);
                        if (found) agentId = found.id;
                    }
                }
                if (agentId) {
                    formData.append('agent_id', agentId);
                }

                // Add current file context if available
                if (currentActiveFile) {
                    formData.append('filename', currentActiveFile);
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData,
                    signal: currentAbortController.signal
                });
                const result = await response.json();

                if (result.success) {
                    const agentName = result.agent && result.agent.name ? result.agent.name : '助手';

                    // 解析用户消息中的所有@mention
                    const mentions = [];
                    try {
                        // 使用 matchAll 或 fallback 到 match
                        let mentionMatches;
                        if (String.prototype.matchAll) {
                            mentionMatches = message.matchAll(/@([^\s@]+)/g);
                            for (const match of mentionMatches) {
                                const mentionedName = match[1];
                                const found = agents.find(a => a.name === mentionedName);
                                if (found) {
                                    mentions.push(mentionedName);
                                }
                            }
                        } else {
                            // Fallback for older browsers
                            const regex = /@([^\s@]+)/g;
                            let match;
                            while ((match = regex.exec(message)) !== null) {
                                const mentionedName = match[1];
                                const found = agents.find(a => a.name === mentionedName);
                                if (found) {
                                    mentions.push(mentionedName);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing mentions:', e);
                    }

                    // 如果API返回了mentions信息，也添加进去
                    try {
                        if (result.routing_info && Array.isArray(result.routing_info.mentions)) {
                            result.routing_info.mentions.forEach(mention => {
                                if (typeof mention === 'string' && !mentions.includes(mention)) {
                                    const found = agents.find(a => a.name === mention);
                                    if (found) mentions.push(mention);
                                } else if (mention && mention.name && !mentions.includes(mention.name)) {
                                    const found = agents.find(a => a.name === mention.name);
                                    if (found) mentions.push(mention.name);
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error processing routing_info mentions:', e);
                    }

                    // 如果没有找到任何mention，至少连接返回的agent
                    if (mentions.length === 0 && agentName) {
                        mentions.push(agentName);
                    }

                    // 连接所有被提到的智能体
                    mentions.forEach(mentionedName => {
                        const agentIndex = agents.findIndex(a => a.name === mentionedName);
                        if (coordinatorIndex !== -1 && agentIndex !== -1 && coordinatorIndex !== agentIndex) {
                            addWorkflowConnection(coordinatorIndex, agentIndex);

                            // Delay highlight
                            setTimeout(() => {
                                agents[agentIndex].status = 'working';
                                renderAgents();
                            }, 800);
                        }
                    });

                    // Hide loading and show response
                    setTimeout(() => {
                        hideLoading();
                        const responseText = result.response || result.error || '无响应';
                        addChatMessage('agent', responseText, agentName);

                        // Update Center Panel Content (Mock for now)
                        updateCenterPanel(responseText, agentName);

                        // Reset status after a while (optional, or keep it)
                        // setTimeout(() => {
                        //     agents.forEach(a => a.status = 'idle');
                        //     workflowConnections = [];
                        //     renderAgents();
                        // }, 3000);
                    }, 1000);

                } else {
                    // Handle failure case
                    hideLoading();
                    const errorMsg = result.error || '请求失败';
                    addChatMessage('system', '错误: ' + errorMsg);
                }
            } catch (e) {
                console.error(e);
                hideLoading();
                if (e.name === 'AbortError') {
                    addChatMessage('system', '任务已取消');
                } else {
                    addChatMessage('system', 'Error: ' + e.message);
                }
            } finally {
                // 恢复按钮状态
                const sendBtn = document.getElementById('sendBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                if (sendBtn && cancelBtn) {
                    sendBtn.style.display = 'block';
                    cancelBtn.style.display = 'none';
                }
                currentAbortController = null;
            }
        }

        // 取消任务
        function cancelTask() {
            if (currentAbortController) {
                currentAbortController.abort();

                // 立即恢复按钮状态
                const sendBtn = document.getElementById('sendBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                if (sendBtn && cancelBtn) {
                    sendBtn.style.display = 'block';
                    cancelBtn.style.display = 'none';
                }

                // 隐藏加载状态
                hideLoading();

                // 恢复智能体状态
                agents.forEach(a => a.status = 'idle');
                renderAgents();
                workflowConnections = [];
            }
        }

        function addChatMessage(role, text, agentName = null) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');

            if (role === 'user') {
                messageDiv.className = 'chat-message user-message';
                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-user"></i></div>
                    <div class="message-content">${text}</div>
                `;
                container.appendChild(messageDiv);
            } else if (role === 'agent') {
                messageDiv.className = 'chat-message agent-message';
                const agentIcon = getAgentIcon(agentName);
                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="${agentIcon}"></i></div>
                    <div class="message-content">
                        <div class="message-agent-name">${agentName}</div>
                        <div class="typing-content"></div>
                    </div>
                `;
                container.appendChild(messageDiv);

                // Start typewriter effect
                const contentDiv = messageDiv.querySelector('.typing-content');
                typeWriter(contentDiv, text);
            } else {
                messageDiv.className = 'chat-message agent-message';
                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-exclamation-triangle" style="color: #ff4444;"></i></div>
                    <div class="message-content" style="color: #ff4444;">${text}</div>
                `;
                container.appendChild(messageDiv);
            }

            container.scrollTop = container.scrollHeight;
        }

        function typeWriter(element, text, speed = 10) {
            // 如果文本包含 HTML 标签（如 <img>），直接渲染，不使用打字机效果
            if (text.includes('<img') || text.includes('<div') || text.includes('<iframe')) {
                // 使用 parseMarkdown 处理 markdown，然后直接设置 HTML
                let processedText = text;

                // 处理 Markdown 格式
                if (typeof parseMarkdown === 'function') {
                    try {
                        processedText = parseMarkdown(text);
                    } catch (e) {
                        console.warn('Markdown parsing failed, using raw text:', e);
                    }
                } else {
                    // 简单的 markdown 处理
                    processedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                        .replace(/## (.*?)\n/g, '<h2>$1</h2>')
                        .replace(/# (.*?)\n/g, '<h1>$1</h1>')
                        .replace(/\n/g, '<br>');
                }

                element.innerHTML = processedText;

                // 滚动到底部
                const container = element.closest('.chat-messages') || element.closest('#chat-messages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
                return;
            }

            let i = 0;
            element.innerHTML = '';

            function type() {
                if (i < text.length) {
                    // Handle simple markdown-like bolding for now
                    if (text.substring(i).startsWith('**')) {
                        const end = text.indexOf('**', i + 2);
                        if (end !== -1) {
                            element.innerHTML += '<strong>' + text.substring(i + 2, end) + '</strong>';
                            i = end + 2;
                            setTimeout(type, speed);
                            return;
                        }
                    }

                    if (text[i] === '\n') {
                        element.innerHTML += '<br>';
                    } else {
                        element.innerHTML += text[i];
                    }
                    i++;

                    // Auto scroll
                    const container = document.getElementById('chat-messages');
                    if (container) container.scrollTop = container.scrollHeight;

                    setTimeout(type, speed);
                }
            }
            type();
        }

        function showLoading() {
            const container = document.getElementById('chat-messages');
            // Check if existing indicator
            if (document.getElementById('loading-indicator')) return;

            const indicator = document.createElement('div');
            indicator.id = 'loading-indicator';
            indicator.className = 'typing-indicator';
            indicator.style.opacity = '1';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }
        }

        function getAgentIcon(agentName) {
            const agent = agents.find(a => a.name === agentName);
            return agent ? agent.emoji : 'fas fa-robot';
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function updateCenterPanel(content, agentName) {
            const editorArea = document.querySelector('.editor-area');

            // 更新标题
            updateContentTitle('AI 对话', 'fas fa-comments');

            // 1. Extract HTML blocks first (highest priority)
            const htmlBlocks = [];
            const htmlRegex = /```html\s*([\s\S]*?)```/g;
            let processedContent = content.replace(htmlRegex, (match, code) => {
                let cleanCode = code.trim();

                // 自动修复常见的 CDN 问题 - 使用本地资源
                cleanCode = cleanCode.replace(
                    /https:\/\/cdn\.jsdelivr\.net\/npm\/mermaid.*\/mermaid(\.esm)?\.min\.js/g,
                    '/static/js/mermaid.min.js'
                );
                cleanCode = cleanCode.replace(
                    /https:\/\/cdnjs\.cloudflare\.com\/ajax\/libs\/mermaid\/[^"']+/g,
                    '/static/js/mermaid.min.js'
                );

                htmlBlocks.push(`<div class="html-preview-container">
                    <div class="html-preview-header">
                        <i class="fas fa-chart-line" style="color: #FF6B00;"></i>
                        <span>交互式可视化</span>
                        <button onclick="openHTMLFullscreen(${htmlBlocks.length})" class="html-fullscreen-btn" title="全屏查看">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <iframe class="html-preview" srcdoc="${escapeHtml(cleanCode)}" sandbox="allow-scripts allow-same-origin"></iframe>
                </div>`);
                return `__HTML_BLOCK_${htmlBlocks.length - 1}__`;
            });

            // 2. Extract Mermaid blocks
            const mermaidBlocks = [];
            const mermaidRegex = /```mermaid\s*([\s\S]*?)```/g;
            processedContent = processedContent.replace(mermaidRegex, (match, code) => {
                const cleanCode = escapeHtml(code.trim());
                mermaidBlocks.push(`<div class="mermaid">${cleanCode}</div>`);
                return `__MERMAID_BLOCK_${mermaidBlocks.length - 1}__`;
            });

            // 3. Simple markdown rendering (保留已有的 HTML 标签，如 <img>)
            // 先提取所有 HTML 标签（如 <img>），避免被后续处理破坏
            const htmlTags = [];
            const htmlTagRegex = /<[^>]+>/g;
            let tempContent = processedContent;
            let match;
            while ((match = htmlTagRegex.exec(processedContent)) !== null) {
                htmlTags.push(match[0]);
                tempContent = tempContent.replace(match[0], `__HTML_TAG_${htmlTags.length - 1}__`);
            }

            let htmlContent = tempContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                .replace(/## (.*?)\n/g, '<h2>$1</h2>')
                .replace(/# (.*?)\n/g, '<h1>$1</h1>')
                .replace(/\n/g, '<br>');

            // 恢复 HTML 标签
            htmlTags.forEach((tag, index) => {
                htmlContent = htmlContent.replace(`__HTML_TAG_${index}__`, tag);
            });

            // 4. Restore HTML blocks
            htmlBlocks.forEach((block, index) => {
                htmlContent = htmlContent.replace(`__HTML_BLOCK_${index}__`, block);
            });

            // 5. Restore Mermaid blocks
            mermaidBlocks.forEach((block, index) => {
                htmlContent = htmlContent.replace(`__MERMAID_BLOCK_${index}__`, block);
            });

            editorArea.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 0.8rem; color: var(--primary); text-transform: uppercase;">AI 生成内容</span>
                    <h1 style="margin-top: 5px;">${agentName} 输出</h1>
                </div>
                <div style="line-height: 1.8; color: var(--text-primary);">
                    ${htmlContent}
                </div>
            `;

            // 6. Render Mermaid
            if (mermaidBlocks.length > 0) {
                try {
                    mermaid.run({
                        nodes: editorArea.querySelectorAll('.mermaid')
                    });
                } catch (e) {
                    console.error('Mermaid rendering failed:', e);
                }
            }

            // 7. Store HTML blocks for fullscreen function
            window.htmlPreviewBlocks = htmlBlocks.map((_, index) => {
                const iframe = editorArea.querySelectorAll('.html-preview')[index];
                return iframe ? iframe.getAttribute('srcdoc') : '';
            });
        }

        // 全屏查看 HTML 预览
        function openHTMLFullscreen(index) {
            if (!window.htmlPreviewBlocks || !window.htmlPreviewBlocks[index]) return;

            const htmlContent = window.htmlPreviewBlocks[index];
            const newWindow = window.open('', '_blank', 'width=1200,height=800');
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        }

        // Sidebar Switching
        function switchSidebar(panelName) {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => item.classList.remove('active'));

            // **重要**：如果sidebar是折叠状态，先展开它
            const sidebar = document.getElementById('leftSidebar');
            if (sidebar && sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                // 更新折叠按钮图标
                const buttons = sidebar.querySelectorAll('.collapse-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('fa-angle-right');
                    btn.classList.add('fa-angle-left');
                    btn.setAttribute('title', '折叠');
                });
                // 显示resizer
                const resizer = document.getElementById('leftResizer');
                if (resizer) resizer.style.display = 'block';
            }

            // 激活对应的活动栏图标
            if (panelName === 'explorer') document.getElementById('activity-explorer').classList.add('active');
            if (panelName === 'scenarios') document.getElementById('activity-scenarios').classList.add('active');
            if (panelName === 'market') {
                document.getElementById('activity-market').classList.add('active');
                renderMarket();
            }
            // MCP Activation
            if (panelName === 'mcp') {
                const el = document.getElementById('activity-mcp');
                if (el) el.classList.add('active');
            }

            // 动态添加的智能体
            const activityItem = document.getElementById(`activity-${panelName}`);
            if (activityItem) activityItem.classList.add('active');

            // 切换侧边栏面板 - 确保所有面板都隐藏
            document.querySelectorAll('.sidebar-panel').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none'; // 强制设置内联样式
            });

            // Handle expanded sidebar state (for NotebookLM and AI-Gist)
            if (panelName === 'notebooklm' || panelName === 'aigist') {
                sidebar.classList.add('expanded');
            } else {
                sidebar.classList.remove('expanded');
            }

            // 显示目标面板 - 确保移除内联样式并使用CSS类
            const targetPanel = document.getElementById(`panel-${panelName}`);
            if (targetPanel) {
                targetPanel.classList.add('active');
                // 移除内联的 display: none，让CSS类生效
                targetPanel.style.display = '';
                // 如果CSS类没有生效，强制设置
                if (getComputedStyle(targetPanel).display === 'none') {
                    targetPanel.style.display = 'flex';
                }
                targetPanel.style.flexDirection = 'column';
            } else {
                console.warn(`Panel not found: panel-${panelName}`);
            }

            // NotebookLM Special Handling: auto-load external iframe
            if (panelName === 'notebooklm') {
                const placeholder = document.getElementById('notebooklm-placeholder');
                const iframe = document.getElementById('notebooklm-iframe');
                if (placeholder && iframe) {
                    placeholder.style.display = 'none';
                    iframe.style.display = 'block';
                    if (iframe.src === 'about:blank') {
                        iframe.src = 'http://localhost:8502/';
                    }
                }
            }

            // AI-Gist Special Handling
            if (panelName === 'aigist') {
                setTimeout(() => {
                    const placeholder = document.getElementById('aigist-placeholder');
                    const iframe = document.getElementById('aigist-iframe');
                    if (placeholder && iframe) {
                        placeholder.style.display = 'none';
                        iframe.style.display = 'block';
                    }
                }, 500);
            }

            // AlphaFund Special Handling: open workspace in main content area
            if (panelName === 'alphafund') {
                openAlphaFundWorkspace();
            }
        }

        // ==================== MCP Market Logic (Localized) ====================
        const mcpTools = [
            {
                id: 'amap',
                name: '高德地图',
                icon: 'fas fa-map-marked-alt',
                color: '#2874F0',
                desc: '连接高德开放平台，提供地理编码、路径规划、周边搜索和行政区划查询能力。',
                capabilities: ['POI 搜索', '路径规划', '地理编码', 'IP 定位', '天气查询'],
                installCmd: 'npx -y @modelcontextprotocol/server-amap',
                example: '查询深圳市南山区科技园附近的瑞幸咖啡，并规划从腾讯大厦过去的步行路线。',
                envVars: ['AMAP_API_KEY']
            },
            {
                id: 'feishu',
                name: '飞书 (Feishu)',
                icon: 'fas fa-paper-plane', // Using paper-plane as proxy for Lark
                color: '#00D6B9',
                desc: '深度集成飞书办公套件，支持消息通知、多维表格读取、日历管理和文档协作。',
                capabilities: ['发送富文本消息', '读写多维表格', '管理日历日程', '知识库检索'],
                installCmd: 'npx -y @modelcontextprotocol/server-feishu',
                example: '读取“Q4 项目进度表”多维表格，找出所有状态为“延期”的任务并发送群通知。',
                envVars: ['FEISHU_APP_ID', 'FEISHU_APP_SECRET']
            },
            {
                id: 'wechat',
                name: '企业微信',
                icon: 'fab fa-weixin',
                color: '#07C160',
                desc: '连接企业微信 API，实现内部群机器人推送、通讯录管理和应用消息交互。',
                capabilities: ['群机器人推送', '应用消息发送', '通讯录查询', '素材上传'],
                installCmd: 'npx -y @modelcontextprotocol/server-wechat-work',
                example: '向“运维监控群”发送一条服务器 CPU 告警消息，并@相关负责人。',
                envVars: ['WECHAT_CORP_ID', 'WECHAT_CORP_SECRET']
            },
            {
                id: 'tushare',
                name: 'Tushare Pro',
                icon: 'fas fa-chart-line',
                color: '#E64A19',
                desc: '专业的金融大数据平台接口，提供股票、基金、期货、外汇等全维度财经数据。',
                capabilities: ['股票行情获取', '财务报表分析', '指数数据', '公募基金净值'],
                installCmd: 'npx -y @modelcontextprotocol/server-tushare',
                example: '获取贵州茅台 (600519.SH) 近三年的营收数据，并计算同比增长率。',
                envVars: ['TUSHARE_TOKEN']
            },
            {
                id: 'aliyun',
                name: '阿里云 (Aliyun)',
                icon: 'fas fa-cloud',
                color: '#FF6A00',
                desc: '管理阿里云资源，支持 ECS 实例管控、OSS 对象存储操作和 SLB 负载均衡配置。',
                capabilities: ['ECS 实例管理', 'OSS 文件上传/下载', 'RDS 实例查询', '云监控指标'],
                installCmd: 'npx -y @modelcontextprotocol/server-aliyun',
                example: '列出华南1区所有运行中的 ECS 实例，并检查其 CPU 使用率是否超过 80%。',
                envVars: ['ALIYUN_ACCESS_KEY', 'ALIYUN_SECRET_KEY']
            },
            {
                id: 'deepseek',
                name: 'DeepSeek R1',
                icon: 'fas fa-brain',
                color: '#673AB7',
                desc: '接入 DeepSeek 强大的推理模型，用于代码生成、复杂逻辑推理和长文本分析。',
                capabilities: ['代码生成', '逻辑推理', '长文本摘要', '数学解题'],
                installCmd: 'npx -y @modelcontextprotocol/server-deepseek',
                example: '使用 R1 模型优化这段 Python 爬虫代码，增加异步并发和错误重试机制。',
                envVars: ['DEEPSEEK_API_KEY']
            }
        ];

        function renderMcpMarket() {
            const container = document.querySelector('.market-list');
            if (!container) return; // Guard if tab content not ready

            container.innerHTML = mcpTools.map((tool, index) => `
                <div class="mcp-market-item" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px; cursor: pointer;" onclick="showMcpToolDetails(${index})">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <i class="${tool.icon}" style="font-size: 1.2rem; margin-right: 10px; color: ${tool.color};"></i>
                        <div style="font-weight: 600; font-size: 0.9rem;">${tool.name}</div>
                        <button style="margin-left: auto; background: rgba(0, 229, 255, 0.1); border: 1px solid #00E5FF; color: #00E5FF; border-radius: 12px; padding: 2px 10px; font-size: 0.7rem; cursor: pointer;">详情</button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${tool.desc}
                    </div>
                </div>
            `).join('');
        }

        function showMcpToolDetails(index) {
            const tool = mcpTools[index];
            const editorArea = document.querySelector('.editor-area');

            // Update Title
            updateContentTitle('MCP 工具详情', 'fas fa-network-wired');

            const capabilitiesHtml = tool.capabilities.map(cap =>
                `<span style="display: inline-block; padding: 4px 10px; background: rgba(0, 229, 255, 0.1); border: 1px solid rgba(0, 229, 255, 0.2); border-radius: 15px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 8px; color: #00E5FF;">${cap}</span>`
            ).join('');

            const envVarsHtml = tool.envVars.length > 0
                ? tool.envVars.map(v => `<div style="background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; color: #FFAB40; margin-bottom: 5px;">${v}</div>`).join('')
                : '<div style="color: var(--text-secondary); font-size: 0.8rem;">无特殊环境变量要求</div>';

            editorArea.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                    <!-- Header -->
                    <div style="display: flex; align-items: center; margin-bottom: 30px;">
                        <div style="width: 80px; height: 80px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: ${tool.color}; margin-right: 25px;">
                            <i class="${tool.icon}"></i>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                <h1 style="font-size: 2rem; color: var(--text-primary); margin: 0;">${tool.name}</h1>
                                <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #00E5FF; color: black; font-weight: bold;">MCP Server</span>
                            </div>
                            <p style="font-size: 1.1rem; color: var(--text-secondary);">${tool.desc}</p>
                        </div>
                    </div>

                    <!-- Capabilities -->
                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-bolt" style="margin-right: 8px; color: #FFCA28;"></i>核心能力</h3>
                        <div style="display: flex; flex-wrap: wrap;">
                            ${capabilitiesHtml}
                        </div>
                    </div>

                    <!-- Installation & Config -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; border: 1px solid var(--border);">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-download" style="margin-right: 8px; color: #4CAF50;"></i>安装命令</h3>
                            <div style="background: #111; padding: 15px; border-radius: 8px; font-family: monospace; color: #ccc; border: 1px solid #333; position: relative;">
                                ${tool.installCmd}
                                <button onclick="copyToClipboard('${tool.installCmd}')" style="position: absolute; right: 10px; top: 10px; background: transparent; border: none; color: #666; cursor: pointer;">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; border: 1px solid var(--border);">
                            <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-key" style="margin-right: 8px; color: #FF5722;"></i>所需配置</h3>
                            ${envVarsHtml}
                        </div>
                    </div>

                    <!-- Usage Example -->
                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;"><i class="fas fa-comment-dots" style="margin-right: 8px; color: #29B6F6;"></i>试一试</h3>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; color: var(--text-secondary); font-family: monospace; margin-bottom: 15px;">
                            "${tool.example}"
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="executeTask('${tool.example}')" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: opacity 0.2s; flex: 1;">
                                <i class="fas fa-play" style="margin-right: 8px;"></i> 模拟执行
                            </button>
                            <button onclick="showAddMcpModal()" style="padding: 10px 20px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600; transition: opacity 0.2s;">
                                <i class="fas fa-plug" style="margin-right: 8px;"></i> 配置连接
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // MCP Logic
        function switchMcpTab(tabName) {
            const tabs = document.querySelectorAll('.mcp-tab');
            tabs.forEach(t => {
                t.style.borderBottom = '2px solid transparent';
                t.style.color = 'var(--text-secondary)';
            });

            // Highlight active tab
            const activeTab = Array.from(tabs).find(t => t.getAttribute('onclick').includes(tabName));
            if (activeTab) {
                activeTab.style.borderBottom = '2px solid #00E5FF';
                activeTab.style.color = 'var(--text-primary)';
            }

            const installedTab = document.getElementById('mcp-tab-installed');
            const marketTab = document.getElementById('mcp-tab-market');
            if (installedTab) installedTab.style.display = tabName === 'installed' ? 'block' : 'none';
            if (marketTab) {
                marketTab.style.display = tabName === 'market' ? 'block' : 'none';
                if (tabName === 'market') renderMcpMarket(); // Render when showing
            }
        }

        function toggleMcpServer(checkbox) {
            const statusText = document.getElementById('mcp-server-status');
            const connectInfo = document.getElementById('mcp-connect-info');

            if (checkbox.checked) {
                if (statusText) {
                    statusText.innerHTML = '<i class="fas fa-circle" style="font-size: 6px; margin-right: 4px; color: #00E5FF; box-shadow: 0 0 5px #00E5FF;"></i> 运行中 (Port: 8080)';
                    statusText.style.color = '#00E5FF';
                }
                if (connectInfo) connectInfo.style.display = 'block';
                addChatMessage('system', 'AgentDesk MCP Server 已启动，外部应用现在可以连接到本工作台。');
            } else {
                if (statusText) {
                    statusText.innerHTML = '<i class="fas fa-circle" style="font-size: 6px; margin-right: 4px; color: #666;"></i> 未启动';
                    statusText.style.color = 'var(--text-secondary)';
                }
                if (connectInfo) connectInfo.style.display = 'none';
            }
        }

        function showAddMcpModal() {
            const url = prompt("请输入 MCP Server 连接地址或命令:", "npx -y @modelcontextprotocol/server-filesystem");
            if (url) {
                alert("连接请求已发送 (模拟): " + url);
            }
        }

        // 切换到 NotebookLM（在主窗口显示 iframe）
        function switchToNotebookLM() {
            // 高亮活动栏图标
            document.querySelectorAll('.activity-item').forEach(item => item.classList.remove('active'));
            document.getElementById('activity-notebooklm').classList.add('active');

            // 隐藏所有侧边栏面板
            document.querySelectorAll('.sidebar-panel').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });

            // 在主窗口显示 NotebookLM iframe
            const centerPanel = document.getElementById('centerPanel');
            centerPanel.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-tertiary);">
                    <div style="padding: 15px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-brain" style="color: #9C27B0; font-size: 24px;"></i>
                            <div>
                                <h3 style="margin: 0; color: var(--text-primary); font-size: 18px;">NotebookLM Pro</h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 12px;">PDF 文档深度分析专家 | Docker 独立运行</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="color: var(--text-secondary); font-size: 12px;">
                                <i class="fas fa-circle" style="color: #FFC107; font-size: 8px; margin-right: 5px;"></i>
                                未连接
                            </span>
                            <button onclick="connectNotebookLM('http://localhost:8502/Notebooks')" style="padding: 6px 12px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-plug"></i> 连接
                            </button>
                            <button onclick="openNotebookLMNewTab()" style="padding: 6px 12px; background: #555; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-external-link-alt"></i> 新窗口
                            </button>
                        </div>
                    </div>
                    <div id="notebooklm-loading" style="flex: 1; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary);">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #9C27B0; margin-bottom: 20px;"></i>
                            <p style="color: var(--text-secondary); font-size: 16px;">正在加载 NotebookLM...</p>
                        </div>
                    </div>
                    <iframe 
                        id="notebooklm-iframe" 
                        src="about:blank" 
                        style="flex: 1; width: 100%; border: none; background: white; display: none;"
                        onload="hideNotebookLMLoading()"
                    ></iframe>
                </div>
            `;
        }

        // 刷新 NotebookLM iframe
        function connectNotebookLM(url) {
            const iframe = document.getElementById('notebooklm-iframe');
            const loading = document.getElementById('notebooklm-loading');
            if (iframe && loading) {
                loading.style.display = 'flex';
                iframe.style.display = 'none';
                iframe.src = url;
            }
        }

        // 在新标签页打开 NotebookLM
        function openNotebookLMNewTab() {
            window.open('http://localhost:8502/Notebooks', '_blank');
        }

        // 隐藏加载动画
        function hideNotebookLMLoading() {
            const loading = document.getElementById('notebooklm-loading');
            const iframe = document.getElementById('notebooklm-iframe');
            if (loading && iframe) {
                loading.style.display = 'none';
                iframe.style.display = 'block';
            }
        }

        // 折叠/展开侧边栏
        function toggleSidebar(side) {
            if (side === 'left') {
                const sidebar = document.getElementById('leftSidebar');
                const resizer = document.getElementById('leftResizer');
                sidebar.classList.toggle('collapsed');

                // 隐藏/显示resizer
                if (resizer) {
                    if (sidebar.classList.contains('collapsed')) {
                        resizer.style.display = 'none';
                    } else {
                        resizer.style.display = 'block';
                    }
                }

                // 更新所有左侧面板的折叠按钮图标
                const buttons = sidebar.querySelectorAll('.collapse-btn');
                buttons.forEach(btn => {
                    if (sidebar.classList.contains('collapsed')) {
                        btn.classList.remove('fa-angle-left');
                        btn.classList.add('fa-angle-right');
                        btn.setAttribute('title', '展开');
                    } else {
                        btn.classList.remove('fa-angle-right');
                        btn.classList.add('fa-angle-left');
                        btn.setAttribute('title', '折叠');
                    }
                });
            } else if (side === 'right') {
                const panel = document.getElementById('rightPanel');
                const resizer = document.getElementById('rightResizer');
                panel.classList.toggle('collapsed');

                // 隐藏/显示resizer
                if (resizer) {
                    if (panel.classList.contains('collapsed')) {
                        resizer.style.display = 'none';
                    } else {
                        resizer.style.display = 'block';
                    }
                }

                // 更新右侧面板的折叠按钮图标
                const btn = panel.querySelector('.collapse-btn');
                if (btn) {
                    if (panel.classList.contains('collapsed')) {
                        btn.classList.remove('fa-angle-right');
                        btn.classList.add('fa-angle-left');
                        btn.setAttribute('title', '展开');
                    } else {
                        btn.classList.remove('fa-angle-left');
                        btn.classList.add('fa-angle-right');
                        btn.setAttribute('title', '折叠');
                    }
                }
            }

            updateGlobalControlButtons();
        }

        // 折叠/展开内容区
        function toggleContentArea() {
            const editorArea = document.getElementById('editorArea');
            const icon = document.getElementById('contentAreaToggleIcon');

            editorArea.classList.toggle('collapsed');

            if (editorArea.classList.contains('collapsed')) {
                icon.classList.remove('fa-angle-down');
                icon.classList.add('fa-angle-up');
            } else {
                icon.classList.remove('fa-angle-up');
                icon.classList.add('fa-angle-down');
            }
        }

        // 更新内容区标题
        function updateContentTitle(title, icon = 'fas fa-comments') {
            const titleText = document.getElementById('content-title-text');
            // Use content-status-indicator as the tab container
            const titleTab = document.getElementById('content-status-indicator') || document.getElementById('content-title-tab');

            if (titleText) titleText.textContent = title;

            if (titleTab) {
                const iconElement = titleTab.querySelector('i');
                if (iconElement) iconElement.className = icon;
            }
        }

        // 切换主视图 (编辑器 vs 智能体画布)
        function switchMainView(view) {
            const canvasArea = document.getElementById('canvasArea');
            const editorArea = document.getElementById('editorArea');
            const btnEditor = document.getElementById('view-btn-editor');
            const btnCanvas = document.getElementById('view-btn-canvas');

            if (view === 'canvas') {
                // 显示画布，隐藏编辑器
                canvasArea.classList.add('active');
                if (editorArea) {
                    editorArea.style.display = 'none';
                }

                // Update buttons
                btnEditor.style.background = 'transparent';
                btnEditor.style.color = 'var(--text-secondary)';
                btnEditor.style.fontWeight = 'normal';
                btnEditor.style.borderBottom = '2px solid transparent';

                btnCanvas.style.background = 'var(--bg-tertiary)'; // Slight bg for active tab
                btnCanvas.style.color = 'var(--primary)';
                btnCanvas.style.fontWeight = 'bold';
                btnCanvas.style.borderBottom = '2px solid var(--primary)';

                // Resize canvas
                setTimeout(() => {
                    resizeCanvas();
                    renderAgents();
                }, 50);
            } else {
                // 显示编辑器，隐藏画布
                canvasArea.classList.remove('active');
                if (editorArea) {
                    editorArea.style.display = 'block';
                }

                // Update buttons
                btnEditor.style.background = 'var(--bg-tertiary)';
                btnEditor.style.color = 'var(--primary)';
                btnEditor.style.fontWeight = 'bold';
                btnEditor.style.borderBottom = '2px solid var(--primary)';

                btnCanvas.style.background = 'transparent';
                btnCanvas.style.color = 'var(--text-secondary)';
                btnCanvas.style.fontWeight = 'normal';
                btnCanvas.style.borderBottom = '2px solid transparent';
            }
        }

        // 兼容旧的 toggleCanvas 函数 (现在映射到 switchMainView)
        function toggleCanvas() {
            const canvasArea = document.getElementById('canvasArea');
            if (canvasArea.classList.contains('active')) {
                switchMainView('editor');
            } else {
                switchMainView('canvas');
            }
        }

        // 折叠/展开所有面板 (Updated Logic)
        let allPanelsCollapsed = false;
        function toggleAllPanels() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightPanel = document.getElementById('rightPanel');
            const icon = document.getElementById('expandAllIcon');

            allPanelsCollapsed = !allPanelsCollapsed;

            if (allPanelsCollapsed) {
                // 全部折叠
                if (!leftSidebar.classList.contains('collapsed')) toggleSidebar('left');
                if (!rightPanel.classList.contains('collapsed')) toggleSidebar('right');

                icon.classList.remove('fa-expand-arrows-alt');
                icon.classList.add('fa-compress-arrows-alt');
            } else {
                // 全部展开
                if (leftSidebar.classList.contains('collapsed')) toggleSidebar('left');
                if (rightPanel.classList.contains('collapsed')) toggleSidebar('right');

                icon.classList.remove('fa-compress-arrows-alt');
                icon.classList.add('fa-expand-arrows-alt');
            }
        }

        // 更新全局控制按钮状态
        function updateGlobalControlButtons() {
            const leftSidebar = document.getElementById('leftSidebar');
            const rightPanel = document.getElementById('rightPanel');

            // 检查是否所有面板都折叠了
            const allCollapsed = leftSidebar.classList.contains('collapsed') &&
                rightPanel.classList.contains('collapsed');

            allPanelsCollapsed = allCollapsed;
            const icon = document.getElementById('expandAllIcon');
            if (allCollapsed) {
                icon.classList.remove('fa-expand-arrows-alt');
                icon.classList.add('fa-compress-arrows-alt');
            } else {
                icon.classList.remove('fa-compress-arrows-alt');
                icon.classList.add('fa-expand-arrows-alt');
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + B: 切换左侧栏
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleSidebar('left');
            }
            // Ctrl/Cmd + J: 切换底部画布
            if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
                e.preventDefault();
                toggleCanvas();
            }

            // Ctrl/Cmd + E: 切换内容区
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                toggleContentArea();
            }
        });

        // ==================== Market Logic ====================
        let marketAgents = [];

        function buildMarketAgents() {
            // Map backend agents to market cards
            const coreAgents = (agents || []).map(a => ({
                id: a.id,
                name: a.name,
                desc: a.desc || a.role,
                icon: a.emoji,
                color: a.color || '#FF6B00',
                subscribed: false,
                capabilities: a.capabilities || [a.role],
                example: a.example || `@${a.name} 你好`
            }));

            // Keep external tool as a separate item
            const notebooklm = {
                name: 'NotebookLM',
                desc: 'PDF 文档深度分析与播客生成',
                icon: 'fas fa-podcast',
                color: '#E91E63',
                subscribed: false,
                capabilities: ['深度文档分析', '双人对话播客', '13种语言', '智能解读', 'MP3导出'],
                example: '将这份投资报告转换为播客，用轻松的方式讲解核心观点。',
                externalUrl: 'http://localhost:7860',
                isExternal: true,
                activityBarId: 'activity-notebooklm',
                panelId: 'notebooklm'
            };

            marketAgents = [...coreAgents, notebooklm];
        }

        function renderMarket() {
            const container = document.getElementById('market-list');
            const scenario = WorkflowManager.currentScenario;
            let list = marketAgents;
            if (scenario !== 'all') {
                const allowed = WorkflowManager.scenarios[scenario].agentIds;
                list = marketAgents.filter(a => !a.id || allowed.includes(a.id));
            }

            const toolbar = `
                <div style="display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border);">
                    ${['all', 'investment', 'compliance', 'operations'].map(s => `
                        <button onclick="WorkflowManager.setScenario('${s}'); renderMarket();" 
                                style="padding: 6px 12px; border-radius: 16px; border: 1px solid var(--border); background: ${scenario === s ? 'var(--primary)' : 'var(--bg-secondary)'}; color: ${scenario === s ? 'white' : 'var(--text-primary)'};">
                            ${s === 'all' ? '全部' : WorkflowManager.scenarios[s].name}
                        </button>
                    `).join('')}
                </div>
            `;

            const items = list.map((agent, index) => `
                <div class="market-item" onclick="showAgentDetails(${index})">
                    <div class="market-icon" style="color: ${agent.color}; background: ${agent.color}15;">
                        <i class="${agent.icon}"></i>
                    </div>
                    <div class="market-info">
                        <div class="market-name">${agent.name}</div>
                        <div class="market-desc">${agent.desc}</div>
                    </div>
                    <button class="market-btn ${agent.subscribed ? 'subscribed' : ''}" 
                            onclick="event.stopPropagation(); toggleSubscribe(this, ${index})"
                            onmouseover="${agent.subscribed ? "this.innerText='退订'" : ""}"
                            onmouseout="${agent.subscribed ? "this.innerText='已订阅'" : ""}">
                        ${agent.subscribed ? '已订阅' : '获取'}
                    </button>
                </div>
            `).join('');

            container.innerHTML = toolbar + items;
        }

        function showAgentDetails(index) {
            const agent = marketAgents[index];
            const editorArea = document.querySelector('.editor-area');

            // 如果是外部工具，显示特殊界面
            if (agent.isExternal) {
                editorArea.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 30px;">
                            <div style="width: 80px; height: 80px; border-radius: 20px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: ${agent.color}; margin-right: 25px;">
                                <i class="${agent.icon}"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 2rem; margin-bottom: 10px; color: var(--text-primary);">${agent.name}</h1>
                                <p style="font-size: 1.1rem; color: var(--text-secondary);">${agent.desc}</p>
                            </div>
                        </div>

                        <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                            <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-bolt" style="margin-right: 8px;"></i>核心能力</h3>
                            <div style="display: flex; flex-wrap: wrap;">
                                ${agent.capabilities.map(cap =>
                    `<span style="display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 8px; color: var(--text-primary);">${cap}</span>`
                ).join('')}
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, ${agent.color}20, ${agent.color}10); border-radius: 16px; padding: 30px; margin-bottom: 30px; border: 2px solid ${agent.color}40; text-align: center;">
                            <i class="fas fa-external-link-alt" style="font-size: 3rem; color: ${agent.color}; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">🎙️ Open NotebookLM</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">
                                这是一个独立的 Web 应用，需要单独启动。<br>
                                将 PDF 文档转换为专业的播客音频。
                            </p>
                            
                            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                                <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-rocket" style="margin-right: 8px;"></i>启动步骤：</h4>
                                <ol style="color: var(--text-secondary); line-height: 2; padding-left: 20px;">
                                    <li>打开终端，进入项目目录</li>
                                    <li>运行: <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; color: var(--primary);">cd open-notebooklm && ./start.sh</code></li>
                                    <li>配置 Fireworks AI API 密钥（首次使用）</li>
                                    <li>访问: <a href="${agent.externalUrl}" target="_blank" style="color: var(--primary); text-decoration: underline;">${agent.externalUrl}</a></li>
                                </ol>
                            </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="window.open('${agent.externalUrl}', '_blank')" 
                                    style="flex: 1; padding: 12px 20px; background: ${agent.color}; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 1rem; transition: opacity 0.2s;">
                                    <i class="fas fa-external-link-alt" style="margin-right: 8px;"></i> 新窗口打开
                            </button>
                            <button onclick="switchSidebar('${agent.panelId}'); event.stopPropagation();" 
                                    style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, ${agent.color}, ${agent.color}CC); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 1rem; transition: opacity 0.2s;">
                                    <i class="fas fa-sidebar" style="margin-right: 8px;"></i> 侧边栏打开
                            </button>
                        </div>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 15px;">
                                📖 <a href="docs/OPEN_NOTEBOOKLM_GUIDE.md" target="_blank" style="color: var(--primary);">查看完整使用指南</a>
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            // Highlight selected item
            document.querySelectorAll('.market-item').forEach((el, i) => {
                if (i === index) el.style.background = 'rgba(255, 255, 255, 0.05)';
                else el.style.background = 'transparent';
            });

            const capabilitiesHtml = agent.capabilities.map(cap =>
                `<span style="display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 8px; color: var(--text-primary);">${cap}</span>`
            ).join('');

            if (agent.id === 'image_generator') {
                editorArea.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 24px;">
                            <div style="width: 72px; height: 72px; border-radius: 18px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: ${agent.color}; margin-right: 20px;">
                                <i class="${agent.icon}"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 1.8rem; margin-bottom: 6px; color: var(--text-primary);">${agent.name}</h1>
                                <p style="font-size: 1rem; color: var(--text-secondary);">${agent.desc}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">提示词</label>
                                <textarea id="imggen-prompt" rows="4" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">${agent.example}</textarea>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                    <label style="color: var(--text-secondary); font-size: 0.9rem;">模型</label>
                                    <select id="imggen-model" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                                        <option value="gemini-2.5-flash-image">gemini-2.5-flash-image</option>
                                        <option value="gemini-3-pro-image-preview" selected>gemini-3-pro-image-preview</option>
                                    </select>
                                </div>
                                <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                    <label style="color: var(--text-secondary); font-size: 0.9rem;">尺寸</label>
                                    <select id="imggen-size" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                                        <option value="512x512">512x512</option>
                                        <option value="768x768">768x768</option>
                                        <option value="1024x1024" selected>1024x1024</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button onclick="runImageGenerator()" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-images" style="margin-right: 8px;"></i> 生成图片
                                </button>
                                <button onclick="executeTask(document.getElementById('imggen-prompt').value, getAgentIdByName('${agent.name}'))" style="padding: 10px 20px; background: #555; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-comments" style="margin-right: 8px;"></i> 通过聊天执行
                                </button>
                            </div>

                            <div id="imggen-result" style="min-height: 200px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center; color: var(--text-secondary);">
                                生成结果将显示在这里
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (agent.id === 'drawing_agent') {
                editorArea.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 24px;">
                            <div style="width: 72px; height: 72px; border-radius: 18px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: ${agent.color}; margin-right: 20px;">
                                <i class="${agent.icon}"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 1.8rem; margin-bottom: 6px; color: var(--text-primary);">${agent.name}</h1>
                                <p style="font-size: 1rem; color: var(--text-secondary);">${agent.desc}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">提示词</label>
                                <textarea id="draw-prompt" rows="4" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">${agent.example}</textarea>
                            </div>

                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">选择绘画工具（可多选）</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-mermaid"> Mermaid</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-plantuml"> PlantUML</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-nanobanana"> Nano Banana</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-excalidraw"> Excalidraw</label>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 8px;">未选择时由 LLM 自动选择</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button onclick="runDrawingGenerator()" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-palette" style="margin-right: 8px;"></i> 生成图片
                                </button>
                            </div>

                            <div id="draw-result" style="min-height: 200px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center; color: var(--text-secondary);">
                                生成结果将显示在这里
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            editorArea.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 30px;">
                        <div style="width: 80px; height: 80px; border-radius: 20px; background: ${agent.color}20; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: ${agent.color}; margin-right: 25px;">
                            <i class="${agent.icon}"></i>
                        </div>
                        <div>
                            <h1 style="font-size: 2rem; margin-bottom: 10px; color: var(--text-primary);">${agent.name}</h1>
                            <p style="font-size: 1.1rem; color: var(--text-secondary);">${agent.desc}</p>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-bolt" style="margin-right: 8px;"></i>核心能力</h3>
                        <div style="display: flex; flex-wrap: wrap;">
                            ${capabilitiesHtml}
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-comment-dots" style="margin-right: 8px;"></i>试一试</h3>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; color: var(--text-secondary); font-family: monospace; margin-bottom: 15px;">
                            "${agent.example}"
                        </div>
                        <button onclick="executeTask('${agent.example}', getAgentIdByName('${agent.name}'))" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: opacity 0.2s;">
                            <i class="fas fa-play" style="margin-right: 8px;"></i> 立即运行
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleSubscribe(btn, index) {
            const agent = marketAgents[index];
            agent.subscribed = !agent.subscribed;

            // Visual feedback
            if (agent.subscribed) {
                addChatMessage('system', `已订阅智能体: ${agent.name}`);

                // 如果是外部工具，添加到活动栏
                if (agent.isExternal && agent.activityBarId) {
                    addToActivityBar(agent);
                }
            } else {
                addChatMessage('system', `已退订智能体: ${agent.name}`);

                // 如果是外部工具，从活动栏移除
                if (agent.isExternal && agent.activityBarId) {
                    removeFromActivityBar(agent.activityBarId);
                }
            }

            renderMarket();
        }

        // 添加智能体到活动栏
        function addToActivityBar(agent) {
            const container = document.getElementById('subscribed-agents-bar');
            if (!container) return;

            // 检查是否已存在
            if (document.getElementById(agent.activityBarId)) {
                return;
            }

            // 创建活动栏图标
            const activityItem = document.createElement('div');
            activityItem.id = agent.activityBarId;
            activityItem.className = 'activity-item';
            activityItem.title = agent.name;
            activityItem.onclick = () => switchSidebar(agent.panelId);
            activityItem.innerHTML = `<i class="${agent.icon}" style="color: ${agent.color};"></i>`;

            container.appendChild(activityItem);

            // 显示提示
            setTimeout(() => {
                activityItem.style.animation = 'bounce 0.5s ease';
            }, 100);
        }

        // 从活动栏移除智能体
        function removeFromActivityBar(activityBarId) {
            const element = document.getElementById(activityBarId);
            if (element) {
                element.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => element.remove(), 300);
            }
        }

        // ==================== Landing Page Logic ====================
        function renderLandingAgents() {
            const container = document.getElementById('landing-agents');
            // Use top 5 agents or all
            const agentsToShow = marketAgents;

            container.innerHTML = agentsToShow.map((agent, index) => `
                <div class="landing-agent-item" onclick="selectLandingAgent(${index})">
                    <div class="landing-agent-avatar" style="color: ${agent.color}; background: ${agent.color}15;">
                        <i class="${agent.icon}"></i>
                    </div>
                    <div class="landing-agent-name">${agent.name}</div>
                </div>
            `).join('');
        }

        function selectLandingAgent(index) {
            const agent = marketAgents[index];
            const input = document.getElementById('globalInput');
            const mention = `@${agent.name} `;
            input.value += mention;
            input.focus();

            // Animation feedback
            const items = document.querySelectorAll('.landing-agent-item');
            if (items[index]) {
                items[index].style.transform = 'scale(0.9)';
                setTimeout(() => items[index].style.transform = '', 150);
            }
        }
        // Scenario Selection
        function selectScenario(card, type) {
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');

            WorkflowManager.setScenario(type);
        }

        // ==================== Resource Manager Logic ====================
        async function loadFiles() {
            const container = document.getElementById('file-list-container');
            // Don't wipe if it's just a refresh, maybe show a spinner overlay? 
            // For now simple is fine.
            container.innerHTML = '<div style="padding: 10px 20px; color: #666; font-size: 0.8rem;">加载中...</div>';

            try {
                const response = await fetch('/api/files');
                const data = await response.json();

                if (data.success) {
                    renderFiles(data.files);
                } else {
                    container.innerHTML = '<div style="padding: 10px 20px; color: #ff4444; font-size: 0.8rem;">加载失败</div>';
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="padding: 10px 20px; color: #ff4444; font-size: 0.8rem;">网络错误</div>';
            }
        }

        function renderFiles(files) {
            const container = document.getElementById('file-list-container');
            if (files.length === 0) {
                container.innerHTML = '<div style="padding: 10px 20px; color: #666; font-size: 0.8rem;">暂无文件</div>';
                return;
            }

            let html = '';
            files.forEach(file => {
                const iconClass = getFileIcon(file.type);
                const iconColor = getFileIconColor(file.type);

                html += `
                    <div class="file-item" onclick="previewFile('${file.name}')">
                        <i class="${iconClass}" style="color: ${iconColor};"></i>
                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</span>
                        <i class="fas fa-trash" style="font-size: 0.7rem; color: #666; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s;" 
                           onclick="event.stopPropagation(); deleteFile('${file.name}')" 
                           onmouseover="this.style.opacity=1" 
                           onmouseout="this.style.opacity=0.5"
                           title="删除"></i>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'fas fa-file-pdf';
            if (type.includes('doc')) return 'fas fa-file-word';
            if (type.includes('xls') || type.includes('csv')) return 'fas fa-file-excel';
            if (type.includes('py') || type.includes('js') || type.includes('html')) return 'fas fa-file-code';
            if (type.includes('md') || type.includes('txt')) return 'fas fa-file-alt';
            if (type.includes('json')) return 'fas fa-file-code';
            return 'fas fa-file';
        }

        function getFileIconColor(type) {
            if (type.includes('pdf')) return '#E57373';
            if (type.includes('doc')) return '#42A5F5';
            if (type.includes('xls') || type.includes('csv')) return '#66BB6A';
            if (type.includes('py') || type.includes('js')) return '#FFCA28';
            if (type.includes('md')) return '#AB47BC';
            return '#A0A0A0';
        }

        async function deleteFile(filename) {
            if (!confirm(`确定要删除 ${filename} 吗？`)) return;

            try {
                const response = await fetch(`/api/files/${filename}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadFiles(); // Reload list
                } else {
                    alert('删除失败: ' + result.error);
                }
            } catch (e) {
                alert('删除出错');
            }
        }

        async function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);

                // Show uploading state
                const container = document.getElementById('file-list-container');
                const originalContent = container.innerHTML;
                container.innerHTML = '<div style="padding: 10px 20px; color: #666; font-size: 0.8rem;"><i class="fas fa-spinner fa-spin"></i> 上传中...</div>';

                try {
                    const response = await fetch('/api/upload/simple', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        loadFiles(); // Reload list
                    } else {
                        alert('上传失败: ' + result.error);
                        container.innerHTML = originalContent;
                    }
                } catch (e) {
                    console.error(e);
                    alert('上传出错');
                    container.innerHTML = originalContent;
                }

                // Reset input
                input.value = '';
            }
        }

        async function previewFile(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const textExtensions = ['txt', 'md', 'py', 'js', 'json', 'html', 'css', 'csv', 'log'];
            const editorArea = document.querySelector('.editor-area');
            const encodedFilename = encodeURIComponent(filename);

            // Set current active file
            currentActiveFile = filename;

            // Show loading
            editorArea.innerHTML = '<div style="padding: 20px; color: #666;">加载中...</div>';
            updateContentTitle(filename, 'fas fa-file-alt');

            // 1. Text based files
            if (textExtensions.includes(ext)) {
                try {
                    const response = await fetch(`/download/${encodedFilename}`);
                    if (response.ok) {
                        const text = await response.text();

                        let contentHtml = '';
                        if (ext === 'md') {
                            contentHtml = text
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                                .replace(/## (.*?)\n/g, '<h2>$1</h2>')
                                .replace(/# (.*?)\n/g, '<h1>$1</h1>')
                                .replace(/\n/g, '<br>');
                        } else {
                            contentHtml = `<pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow: auto; font-family: monospace; color: #ccc; white-space: pre-wrap;">${escapeHtml(text)}</pre>`;
                        }

                        renderPreviewContainer(editorArea, filename, contentHtml);
                    } else {
                        renderError(editorArea, filename, "无法读取文件内容");
                    }
                } catch (e) {
                    renderError(editorArea, filename, "读取出错");
                }
            }
            // 2. PDF files
            else if (ext === 'pdf') {
                const pdfUrl = `/download/${encodedFilename}?preview=true`;
                const contentHtml = `
                    <div style="position: relative; width: 100%; height: calc(100vh - 200px);">
                        <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none; border-radius: 8px; background: #333;"></iframe>
                        <div style="position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px;">
                            <button onclick="window.open('${pdfUrl}', '_blank')" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-external-link-alt"></i> 新窗口打开
                            </button>
                            <button onclick="downloadFile('${filename}')" style="padding: 10px 20px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-download"></i> 下载
                            </button>
                        </div>
                    </div>
                 `;
                renderPreviewContainer(editorArea, filename, contentHtml);
            }
            // 3. Word files (docx)
            else if (ext === 'docx') {
                try {
                    const response = await fetch(`/download/${encodedFilename}`);
                    if (!response.ok) throw new Error('Fetch failed');

                    const arrayBuffer = await response.arrayBuffer();

                    if (typeof mammoth === 'undefined') {
                        throw new Error('Mammoth library not loaded');
                    }

                    mammoth.convertToHtml({ arrayBuffer: arrayBuffer })
                        .then(function (result) {
                            const html = result.value; // The generated HTML
                            const messages = result.messages; // Any messages, such as warnings during conversion

                            const contentHtml = `
                                <div class="docx-preview" style="background: white; color: black; padding: 40px; border-radius: 8px; overflow-y: auto; height: calc(100vh - 200px);">
                                    ${html}
                                </div>
                            `;
                            renderPreviewContainer(editorArea, filename, contentHtml);
                        })
                        .catch(function (error) {
                            console.error(error);
                            renderError(editorArea, filename, "Word 文档解析失败: " + error.message);
                        });
                } catch (e) {
                    console.error(e);
                    renderError(editorArea, filename, "加载 Word 文档失败: " + e.message);
                }
            }
            // 4. Excel files (xlsx, xls)
            else if (ext === 'xlsx' || ext === 'xls') {
                try {
                    const response = await fetch(`/download/${encodedFilename}`);
                    if (!response.ok) throw new Error('Fetch failed');

                    const arrayBuffer = await response.arrayBuffer();

                    if (typeof XLSX === 'undefined') {
                        throw new Error('XLSX library not loaded');
                    }

                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const html = XLSX.utils.sheet_to_html(worksheet);

                    const contentHtml = `
                        <div class="excel-preview" style="background: white; color: black; padding: 20px; border-radius: 8px; overflow: auto; height: calc(100vh - 200px);">
                            <style>
                                .excel-preview table { border-collapse: collapse; width: 100%; }
                                .excel-preview td, .excel-preview th { border: 1px solid #ccc; padding: 4px 8px; font-size: 12px; }
                            </style>
                            ${html}
                        </div>
                    `;
                    renderPreviewContainer(editorArea, filename, contentHtml);
                } catch (e) {
                    console.error(e);
                    renderError(editorArea, filename, "Excel 文档解析失败: " + e.message);
                }
            }
            // 5. Unsupported
            else {
                renderUnsupported(editorArea, filename);
            }
        }

        function renderPreviewContainer(container, filename, content) {
            container.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.8rem; color: var(--primary); text-transform: uppercase;">FILE PREVIEW</span>
                        <h1 style="margin-top: 5px;">${filename}</h1>
                    </div>
                    <button onclick="resetWelcomeScreen()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 5px;" title="关闭预览">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="line-height: 1.8; color: var(--text-primary); height: 100%;">
                    ${content}
                </div>
             `;
        }

        function renderError(container, filename, msg) {
            container.innerHTML = `
                <div style="padding: 20px; color: #ff4444; display: flex; justify-content: space-between; align-items: center;">
                    <span>${msg}</span>
                    <button onclick="resetWelcomeScreen()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
        }

        function renderUnsupported(container, filename) {
            container.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <div style="padding: 10px; text-align: right;">
                        <button onclick="resetWelcomeScreen()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666;">
                        <i class="fas fa-file" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">${filename}</div>
                        <p>此文件不支持在线预览</p>
                        <a href="/download/${filename}" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: inline-block;">
                            <i class="fas fa-download"></i> 下载文件
                        </a>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        // ==================== @ Mention Logic ====================
        const mentionDropdown = document.getElementById('mentionDropdown');
        const landingMentionDropdown = document.getElementById('landingMentionDropdown');
        let mentionIndex = -1;
        // isDropdownActive 已在顶部全局状态变量区声明

        function setupMentionLogic(inputElement, dropdownElement) {
            if (!inputElement || !dropdownElement) {
                console.warn('[Mention] Setup failed - missing element:', {
                    input: !!inputElement,
                    dropdown: !!dropdownElement
                });
                return;
            }

            console.log('[Mention] Setup complete for:', {
                inputId: inputElement.id,
                dropdownId: dropdownElement.id,
                marketAgentsCount: marketAgents.length
            });

            inputElement.addEventListener('input', function (e) {
                const value = this.value;
                const cursorPos = this.selectionStart;
                const lastAtPos = value.lastIndexOf('@', cursorPos - 1);

                console.log('[Mention] Input event:', {
                    value,
                    lastAtPos,
                    marketAgentsCount: marketAgents.length
                });

                // Auto resize logic only for textarea
                if (this.tagName.toLowerCase() === 'textarea') {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    if (this.value === '') {
                        this.style.height = 'auto';
                    }
                }

                if (lastAtPos !== -1) {
                    const query = value.substring(lastAtPos + 1, cursorPos);
                    console.log('[Mention] Found @, query:', query);

                    // Check if there's a space after @, if so, close dropdown
                    if (query.includes(' ')) {
                        console.log('[Mention] Space found, hiding dropdown');
                        hideMentionDropdown(dropdownElement);
                        return;
                    }

                    const matches = marketAgents.filter(agent =>
                        agent.name.toLowerCase().includes(query.toLowerCase()) ||
                        agent.desc.toLowerCase().includes(query.toLowerCase())
                    );

                    console.log('[Mention] Matches found:', matches.length);

                    if (matches.length > 0) {
                        showMentionDropdown(matches, lastAtPos, dropdownElement, inputElement);
                    } else {
                        hideMentionDropdown(dropdownElement);
                    }
                } else {
                    hideMentionDropdown(dropdownElement);
                }
            });

            inputElement.addEventListener('keydown', function (e) {
                // 使用全局标记判断，更可靠
                const isDropdownVisible = isDropdownActive;

                console.log('[Mention] Keydown:', {
                    key: e.key,
                    isDropdownVisible,
                    isDropdownActive,
                    mentionIndex,
                    hasShowClass: dropdownElement.classList.contains('show'),
                    displayStyle: dropdownElement.style.display
                });

                if (isDropdownVisible) {
                    const items = dropdownElement.querySelectorAll('.mention-item');
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        mentionIndex = (mentionIndex + 1) % items.length;
                        updateMentionSelection(items);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        mentionIndex = (mentionIndex - 1 + items.length) % items.length;
                        updateMentionSelection(items);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        e.stopPropagation();
                        if (mentionIndex !== -1 && items[mentionIndex]) {
                            console.log('[Mention] Selecting agent at index:', mentionIndex);
                            items[mentionIndex].click();
                        }
                        return false;
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        hideMentionDropdown(dropdownElement);
                    }
                } else if (e.key === 'Enter') {
                    if (!e.shiftKey) {
                        // Only prevent default if it's the landing input or chat input (no shift)
                        if (this.id === 'globalInput') {
                            // 由 handleLandingInput() 中的监听器处理，这里不再处理
                            // 避免重复触发
                            return;
                        } else {
                            e.preventDefault();
                            executeTask(this.value);
                            this.value = '';
                            this.style.height = 'auto';
                        }
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (e.target !== inputElement && !dropdownElement.contains(e.target)) {
                    hideMentionDropdown(dropdownElement);
                }
            });
        }

        // Initialize for both inputs (moved to loadAgents after marketAgents is built)
        // setupMentionLogic will be called after agents are loaded

        function showMentionDropdown(agents, atPos, dropdownElement, inputElement) {
            console.log('[Mention] Showing dropdown:', {
                agentsCount: agents.length,
                dropdownId: dropdownElement.id,
                inputId: inputElement.id,
                dropdownElement: dropdownElement
            });

            dropdownElement.innerHTML = agents.map((agent, index) => `
                <div class="mention-item" onclick="selectMention('${agent.name}', ${atPos}, document.getElementById('${inputElement.id}'), document.getElementById('${dropdownElement.id}'))">
                    <div class="mention-item-icon" style="color: ${agent.color}; background: ${agent.color}15;">
                        <i class="${agent.icon}"></i>
                    </div>
                    <div class="mention-item-info">
                        <div class="mention-item-name">${agent.name}</div>
                        <div class="mention-item-desc">${agent.desc}</div>
                    </div>
                </div>
            `).join('');

            // 强制显示
            dropdownElement.classList.add('show');
            dropdownElement.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: absolute !important;
                z-index: 999999 !important;
                pointer-events: auto !important;
            `;

            // 设置全局标记
            isDropdownActive = true;

            mentionIndex = 0;
            updateMentionSelection(dropdownElement.querySelectorAll('.mention-item'));

            // 验证显示状态
            setTimeout(() => {
                const computed = window.getComputedStyle(dropdownElement);
                console.log('[Mention] Dropdown computed styles:', {
                    display: computed.display,
                    visibility: computed.visibility,
                    opacity: computed.opacity,
                    zIndex: computed.zIndex,
                    position: computed.position,
                    isDropdownActive: isDropdownActive
                });
            }, 100);

            console.log('[Mention] Dropdown should be visible now, isDropdownActive:', isDropdownActive);
        }

        function hideMentionDropdown(dropdownElement) {
            if (!dropdownElement) return;
            dropdownElement.classList.remove('show');
            dropdownElement.style.display = 'none';
            mentionIndex = -1;
            isDropdownActive = false; // 重置全局标记
            console.log('[Mention] Dropdown hidden, isDropdownActive:', isDropdownActive);
        }

        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                if (index === mentionIndex) item.classList.add('selected');
                else item.classList.remove('selected');
            });

            if (mentionIndex !== -1 && items[mentionIndex]) {
                items[mentionIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function selectMention(name, atPos, inputElement, dropdownElement) {
            console.log('[Mention] Selecting mention:', name);
            const value = inputElement.value;
            const cursorPos = inputElement.selectionStart;
            const before = value.substring(0, atPos);
            const after = value.substring(cursorPos);

            inputElement.value = `${before}@${name} ${after}`;
            hideMentionDropdown(dropdownElement);
            inputElement.focus();

            const newCursorPos = atPos + name.length + 2;
            inputElement.setSelectionRange(newCursorPos, newCursorPos);

            console.log('[Mention] Mention selected, dropdown hidden, isDropdownActive:', isDropdownActive);
        }

        // ==================== Prompt Studio Functions ====================

        function switchPromptTab(tabName) {
            // Update buttons
            document.querySelectorAll('.prompt-tab').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.prompt-tab[onclick="switchPromptTab('${tabName}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Update content visibility
            document.querySelectorAll('.prompt-tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`prompt-tab-${tabName}`).style.display = 'block';

            // Load data if needed
            if (tabName === 'library') loadPrompts();
            if (tabName === 'best-practices') loadBestPractices();
        }

        async function loadPrompts() {
            const list = document.getElementById('prompt-list');
            if (!list) return;
            list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">加载中...</div>';
            try {
                const res = await fetch('/api/prompt/library');
                const data = await res.json();
                if (data && data.success) {
                    renderPrompts(data.prompts || []);
                } else {
                    list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">加载失败</div>';
                }
            } catch (e) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">加载失败</div>';
            }
        }

        async function optimizePrompt() {
            console.log("optimizePrompt called");
            const prompt = document.getElementById('prompt-input').value;
            const model = document.getElementById('prompt-model-select').value;
            const framework = document.getElementById('prompt-framework-select').value;
            const tone = document.getElementById('prompt-tone-select').value;
            const btn = document.getElementById('btn-optimize-prompt');
            const originalText = btn.innerHTML;

            if (!prompt) return alert('请输入提示词');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 优化中...';

            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('model', model);
                formData.append('framework', framework);
                formData.append('tone', tone);

                const res = await fetch('/api/prompt/optimize', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('prompt-output-container').style.display = 'block';

                    const resultData = data.data || {};
                    document.getElementById('prompt-output').value = resultData.optimized_prompt || '';

                    // Render Markdown for explanation and comparison
                    const explanation = resultData.explanation || '无详细说明';
                    const comparison = resultData.comparison || '无对比说明';

                    document.getElementById('prompt-explanation').innerHTML = parseMarkdown(explanation);
                    document.getElementById('prompt-comparison').innerHTML = parseMarkdown(comparison);

                } else {
                    alert('优化失败: ' + data.error);
                }
            } catch (e) {
                alert('请求错误: ' + e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function loadBestPractices() {
            const container = document.getElementById('best-practices-list');
            if (container.innerHTML.trim()) return; // already loaded

            try {
                const res = await fetch('/api/prompt/best-practices');
                const data = await res.json();

                if (data.success) {
                    // Group by category
                    const grouped = {};
                    data.practices.forEach(bp => {
                        const cat = bp.category || '其他';
                        if (!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(bp);
                    });

                    let html = '';
                    for (const [category, practices] of Object.entries(grouped)) {
                        html += `<h3 style="grid-column: 1 / -1; color: var(--text-secondary); font-size: 0.9rem; margin-top: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">${category}</h3>`;
                        html += practices.map(bp => `
                            <div class="prompt-card">
                                <div class="prompt-card-title" style="color: var(--primary);"><i class="fas fa-lightbulb"></i> ${bp.title}</div>
                                <div class="prompt-card-content" style="-webkit-line-clamp: unset; max-height: none; white-space: pre-wrap;">${parseMarkdown(bp.content)}</div>
                            </div>
                        `).join('');
                    }

                    container.innerHTML = html;
                }
            } catch (e) {
                container.innerHTML = '加载失败';
            }
        }

        function renderPrompts(prompts) {
            const list = document.getElementById('prompt-list');
            if (prompts.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">暂无保存的提示词</div>';
                return;
            }

            list.innerHTML = prompts.map(p => `
                <div class="prompt-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div class="prompt-card-title">${escapeHtml(p.title)}</div>
                        <button onclick="deletePrompt('${p.id}')" style="background:none; border:none; color:#666; cursor:pointer; padding:0;"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="prompt-card-content">${escapeHtml(p.content)}</div>
                    <div>
                        ${(p.tags || []).map(t => `<span class="prompt-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <button onclick="usePrompt('${escapeHtml(p.content.replace(/'/g, "\\'"))}')" style="background:none; border:1px solid var(--border); color:var(--primary); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-pen"></i> 使用
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterPrompts() {
            const term = document.getElementById('prompt-search').value.toLowerCase();
            const cards = document.querySelectorAll('.prompt-card');
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        async function saveToLibrary() {
            const content = document.getElementById('prompt-output').value || document.getElementById('prompt-input').value;
            if (!content) return alert('没有内容可保存');

            const title = prompt('给这个提示词起个名字：');
            if (!title) return;

            const tags = prompt('添加标签（用逗号分隔）：', '优化版, 通用');

            try {
                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('tags', tags || '');

                const res = await fetch('/api/prompt/library', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    alert('保存成功！');
                    switchPromptTab('library');
                } else {
                    alert('保存失败: ' + data.error);
                }
            } catch (e) {
                alert('保存错误: ' + e);
            }
        }

        async function deletePrompt(id) {
            if (!confirm('确定要删除这个提示词吗？')) return;
            try {
                const res = await fetch(`/api/prompt/library/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    loadPrompts();
                } else {
                    alert('删除失败');
                }
            } catch (e) {
                alert('删除错误: ' + e);
            }
        }

        function usePrompt(content) {
            document.getElementById('prompt-input').value = content;
            switchPromptTab('optimize');
        }

        async function loadBestPractices() {
            const container = document.getElementById('best-practices-list');
            if (!container) return;
            if (container.innerHTML.trim()) return;
            try {
                const res = await fetch('/api/prompt/best-practices');
                const data = await res.json();
                if (data && data.success) {
                    const grouped = {};
                    (data.practices || []).forEach(bp => {
                        const cat = bp.category || '其他';
                        if (!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(bp);
                    });
                    let html = '';
                    for (const [category, practices] of Object.entries(grouped)) {
                        html += `<h3 style="grid-column: 1 / -1; color: var(--text-secondary); font-size: 0.9rem; margin-top: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">${category}</h3>`;
                        html += practices.map(bp => `
                            <div class="prompt-card">
                                <div class="prompt-card-title" style="color: var(--primary);"><i class="fas fa-lightbulb"></i> ${bp.title}</div>
                                <div class="prompt-card-content" style="-webkit-line-clamp: unset; max-height: none; white-space: pre-wrap;">${parseMarkdown(bp.content)}</div>
                            </div>
                        `).join('');
                    }
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">加载失败</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">加载失败</div>';
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板');
            });
        }

        // ==================== Prompt Optimization (Old Chat Integration) ====================
        // Function removed to avoid conflict with Prompt Studio
        // let originalPrompt = '';
        // async function optimizePrompt() { ... }

        function undoOptimize() {
            if (originalPrompt) {
                const input = document.getElementById('chatInput');
                input.value = originalPrompt;
                document.getElementById('undoOptimizeBtn').style.display = 'none';
                originalPrompt = '';
                input.focus();
            }
        }

        // ==================== 清空功能 ====================

        async function clearChat() {
            if (!confirm('确定要清空对话记录吗？')) return;

            try {
                await fetch('/api/chat/clear', { method: 'POST' });
                const container = document.getElementById('chat-messages');
                container.innerHTML = `
                    <div class="chat-message agent-message">
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">你好！欢迎使用 AgentDesk，您的智能团队随时待命。有什么可以帮你？</div>
                    </div>
                `;
            } catch (e) {
                console.error('Failed to clear chat:', e);
            }
        }

        function resetWelcomeScreen() {
            const editorArea = document.getElementById('editorArea');
            // 恢复欢迎页
            editorArea.innerHTML = `
                <div class="welcome-message" style="max-width: 800px; margin: 50px auto; text-align: center;">
                    <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #FF8800 0%, #FF6B00 50%, #FF5500 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); position: relative; overflow: hidden;">
                        <span style="font-size: 48px; font-weight: 900; color: white;">AD</span>
                        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent); transform: rotate(45deg); animation: shine 3s infinite;"></div>
                    </div>
                    <h1 style="color: var(--text-primary); margin-bottom: 15px;">欢迎使用 AgentDesk</h1>
                    <p style="color: var(--text-secondary); line-height: 1.8; font-size: 16px;">
                        在左侧选择文件或智能体开始工作<br>
                        使用 <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px; color: #FF6B00;">@智能体名称</code> 提问，或点击下方的智能体卡片快速开始
                    </p>
                </div>
            `;
            // 重置标题
            updateContentTitle('内容画布', 'fas fa-layer-group');
        }

        function clearEditorContent() {
            if (!confirm('确定要清空内容画布吗？这将移除所有生成的文档和结果。')) return;
            resetWelcomeScreen();
        }

        // ==================== Workflow Logic ====================
        function previewWorkflow(type) {
            console.log(`Previewing workflow: ${type}`);

            const detailArea = document.getElementById('workflowDetailArea');
            const editorArea = document.getElementById('editorArea');
            const canvasArea = document.getElementById('canvasArea');

            // Hide main areas
            editorArea.style.display = 'none';
            canvasArea.classList.remove('active');

            // Show detail area
            detailArea.style.display = 'block';

            // Update content based on type
            let content = '';

            if (type === 'doc-review') {
                content = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h2 style="color: var(--text-primary); margin-bottom: 5px;">智能文档多维审查</h2>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">由 <span style="color: var(--primary);">文档分析师</span> + <span style="color: #F44336;">合规官</span> + <span style="color: #9C27B0;">内容创作者</span> 联合执行</div>
                            </div>
                            <button class="wf-btn-edit" style="padding: 8px 12px; font-size: 0.9rem;" onclick="closeWorkflowDetail()"><i class="fas fa-times"></i></button>
                        </div>

                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 20px;">
                            <div style="margin-bottom: 20px;">
                                <i class="fas fa-file-upload" style="font-size: 3rem; color: var(--primary); opacity: 0.8;"></i>
                            </div>
                            <h3 style="margin-bottom: 10px;">上传待审查文档</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">支持 PDF, DOCX, TXT 格式。文档将由智能体团队并行处理。</p>
                            
                            <input type="file" id="review-file-input" style="display: none;" onchange="handleReviewFileSelect(this)">
                            <button onclick="document.getElementById('review-file-input').click()" style="background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold;">
                                选择文件
                            </button>
                            <div id="review-file-name" style="margin-top: 10px; color: var(--primary); font-size: 0.9rem;"></div>
                        </div>

                        <div id="review-progress" style="display: none; margin-bottom: 20px;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">执行进度</h4>
                            <div style="background: #000; border-radius: 6px; padding: 15px; font-family: monospace; font-size: 0.85rem; color: #00ff00; height: 150px; overflow-y: auto;" id="review-logs">
                                <!-- Logs -->
                            </div>
                        </div>

                        <div id="review-result" style="display: none;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">审查报告</h4>
                            <div id="review-report-content" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; color: var(--text-primary); line-height: 1.6; height: 400px; overflow-y: auto;"></div>
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px; display: none;" id="review-actions">
                            <button onclick="executeReviewWorkflow()" id="btn-start-review" style="background: linear-gradient(135deg, #FF6B00 0%, #FF8800 100%); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);">
                                <i class="fas fa-play"></i> 开始审查
                            </button>
                        </div>
                    </div>
                `;
            } else if (type === 'morning-report') {
                content = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="color: var(--text-primary); margin-bottom: 5px;">每日舆情早报</h2>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">上次运行: <span style="color: #4CAF50;">今天 08:30 (成功)</span></div>
                        </div>
                        <div>
                            <button class="wf-btn-run" style="padding: 8px 20px; font-size: 0.9rem;" onclick="runWorkflow('舆情早报')"><i class="fas fa-play"></i> 立即运行</button>
                            <button class="wf-btn-edit" style="padding: 8px 12px; font-size: 0.9rem;" onclick="closeWorkflowDetail()"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="font-size: 0.95rem; color: #64B5F6; margin-bottom: 10px; display: flex; align-items: center;">
                            <i class="fas fa-info-circle" style="margin-right: 8px;"></i> 工作流说明
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6; margin-bottom: 10px;">
                            每日自动搜集指定关键词的市场舆情，分析正负面情绪，并生成简报发送给订阅者。适用于早间快速了解市场动态。
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-chart-bar" style="color: #2196F3;"></i>
                                <span style="color: var(--text-primary);">数据专家</span>
                                <span style="color: #666;">- 搜索/清洗数据</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-file-alt" style="color: #FF9800;"></i>
                                <span style="color: var(--text-primary);">文档分析师</span>
                                <span style="color: #666;">- 提取关键/情绪分析</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-pen-fancy" style="color: #9C27B0;"></i>
                                <span style="color: var(--text-primary);">内容创作者</span>
                                <span style="color: #666;">- 撰写/润色日报</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-bullseye" style="color: #F44336;"></i>
                                <span style="color: var(--text-primary);">协调者</span>
                                <span style="color: #666;">- 调度/邮件分发</span>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; border-left: 3px solid var(--primary); padding-left: 10px;">基础配置</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">监控关键词</label>
                                <input type="text" value="招商银行, 新能源, 宏观经济" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">触发时间</label>
                                <input type="time" value="08:30" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Graph Editor (Mock) -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; height: 400px; position: relative; overflow: hidden;">
                        <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; border-left: 3px solid var(--primary); padding-left: 10px;">流程编排</h3>
                        
                        <!-- Nodes -->
                        <div style="position: absolute; top: 50%; left: 10%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #2196F3; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);">
                                <i class="fas fa-chart-bar" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">数据专家</div>
                        </div>
                        
                        <div style="position: absolute; top: 50%; left: 25%; transform: translateY(-50%); width: 100px; height: 2px; background: #444;">
                            <div style="position: absolute; right: 0; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #444;"></div>
                        </div>

                        <div style="position: absolute; top: 50%; left: 35%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #FF9800; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);">
                                <i class="fas fa-file-alt" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">文档分析师</div>
                        </div>

                        <div style="position: absolute; top: 50%; left: 50%; transform: translateY(-50%); width: 100px; height: 2px; background: #444;">
                            <div style="position: absolute; right: 0; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #444;"></div>
                        </div>

                        <div style="position: absolute; top: 50%; left: 60%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #9C27B0; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(156, 39, 176, 0.3);">
                                <i class="fas fa-pen-fancy" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">内容创作者</div>
                        </div>
                        
                        <div style="position: absolute; top: 50%; left: 75%; transform: translateY(-50%); width: 100px; height: 2px; background: #444;">
                            <div style="position: absolute; right: 0; top: -4px; width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #444;"></div>
                        </div>
                        
                        <div style="position: absolute; top: 50%; left: 85%; transform: translateY(-50%); text-align: center;">
                            <div style="width: 60px; height: 60px; background: #F44336; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.3);">
                                <i class="fas fa-bullseye" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem;">协调者</div>
                        </div>
                    </div>
                    
                    <!-- Logs -->
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 10px;">运行日志</h3>
                        <div style="background: #000; padding: 15px; border-radius: 6px; font-family: monospace; color: #00ff00; font-size: 0.8rem; height: 150px; overflow-y: auto;">
                            [08:30:01] Job started: Daily Morning Report<br>
                            [08:30:02] Agent [数据专家] searching for "招商银行"... found 12 results<br>
                            [08:30:05] Agent [数据专家] searching for "新能源"... found 25 results<br>
                            [08:30:12] Agent [文档分析师] processing content... sentiment: neutral<br>
                            [08:30:25] Agent [内容创作者] generating report draft...<br>
                            [08:30:30] Agent [协调者] Email sent to subscribers.<br>
                            [08:30:31] Job finished successfully.
                        </div>
                </div>
            `;
            } else if (type === 'daily-tech') {
                content = `
                    <div style="max-width: 900px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h2 style="color: var(--text-primary); margin-bottom: 5px;">每日科技动态</h2>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">由 <span style="color: #2196F3;">数据专家</span> + <span style="color: #FF9800;">文档分析师</span> + <span style="color: #9C27B0;">内容创作者</span> 联合执行</div>
                            </div>
                            <button class="wf-btn-edit" style="padding: 8px 12px; font-size: 0.9rem;" onclick="closeWorkflowDetail()"><i class="fas fa-times"></i></button>
                        </div>

                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; border-left: 3px solid #64B5F6; padding-left: 10px;">基础配置</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">关键词</label>
                                    <input type="text" id="daily-tech-keywords" value="AI, 芯片, 机器人" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.8rem;">是否生成英文版</label>
                                    <select id="daily-tech-need-en" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; border-radius: 4px;">
                                        <option value="false" selected>否</option>
                                        <option value="true">是</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="daily-tech-progress" style="display: none; margin-bottom: 20px;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">执行进度</h4>
                            <div style="background: #000; border-radius: 6px; padding: 15px; font-family: monospace; font-size: 0.85rem; color: #00ff00; height: 150px; overflow-y: auto;" id="daily-tech-logs"></div>
                        </div>

                        <div id="daily-tech-result" style="display: none;">
                            <h4 style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 10px;">日报</h4>
                            <div id="daily-tech-report-content" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; color: var(--text-primary); line-height: 1.6; min-height: 300px; overflow-y: auto;"></div>
                        </div>

                        <div style="text-align: right; margin-top: 20px;" id="daily-tech-actions">
                            <button onclick="executeDailyTechWorkflow()" id="btn-start-daily-tech" style="background: linear-gradient(135deg, #64B5F6 0%, #2196F3 100%); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
                                <i class="fas fa-play"></i> 开始生成
                            </button>
                        </div>
                    </div>
                `;
            } else {
                content = `<div style="text-align: center; padding: 50px; color: #666;">${type} 的详情页正在开发中... <button onclick="closeWorkflowDetail()" style="margin-left: 10px; cursor: pointer; background: none; border: 1px solid #666; color: #aaa; padding: 2px 8px; border-radius: 4px;">返回</button></div>`;
            }

            detailArea.innerHTML = content;
        }

        function closeWorkflowDetail() {
            const detailArea = document.getElementById('workflowDetailArea');
            const editorArea = document.getElementById('editorArea');

            detailArea.style.display = 'none';
            editorArea.style.display = 'block';
        }

        function runWorkflow(name) {
            console.log(`Running workflow: ${name}`);
            const btn = event.target.closest('.wf-btn-run');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';
                btn.disabled = true;

                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> 已启动';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                }, 1000);
            }
        }

        // Document Review Workflow Logic
        let selectedReviewFile = null;

        function handleReviewFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedReviewFile = input.files[0];
                document.getElementById('review-file-name').innerHTML = `<i class="fas fa-file-alt"></i> ${selectedReviewFile.name}`;
                document.getElementById('review-actions').style.display = 'block';
            }
        }

        async function executeReviewWorkflow() {
            if (!selectedReviewFile) return;

            const btn = document.getElementById('btn-start-review');
            const progress = document.getElementById('review-progress');
            const logs = document.getElementById('review-logs');
            const resultArea = document.getElementById('review-result');
            const resultContent = document.getElementById('review-report-content');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 审查中...';
            progress.style.display = 'block';
            resultArea.style.display = 'none';

            logs.innerHTML = `[${new Date().toLocaleTimeString()}] 任务启动：智能文档多维审查<br>`;

            const formData = new FormData();
            formData.append('file', selectedReviewFile);

            try {
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] 正在上传文档...<br>`;

                const response = await fetch('/api/workflow/review', {
                    method: 'POST',
                    body: formData
                });

                logs.innerHTML += `[${new Date().toLocaleTimeString()}] 文档分析师：正在提取摘要...<br>`;
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] 合规官：正在扫描风险点...<br>`;

                const data = await response.json();

                if (data.success) {
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] 内容创作者：正在汇总报告...<br>`;
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #4CAF50;">任务完成！</span><br>`;

                    const visualHtml = renderVisualReviewReport(data);
                    resultContent.innerHTML = visualHtml;
                    resultArea.style.display = 'block';
                    if (window.mermaid) {
                        try {
                            mermaid.run({ nodes: resultContent.querySelectorAll('.mermaid') });
                        } catch (e) { }
                    }
                    btn.innerHTML = '<i class="fas fa-check"></i> 完成';
                } else {
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">错误：${data.error}</span><br>`;
                    btn.innerHTML = '重试';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">网络请求失败</span><br>`;
                btn.innerHTML = '重试';
                btn.disabled = false;
            }
        }
        async function executeDailyTechWorkflow() {
            const btn = document.getElementById('btn-start-daily-tech');
            const progress = document.getElementById('daily-tech-progress');
            const logs = document.getElementById('daily-tech-logs');
            const resultArea = document.getElementById('daily-tech-result');
            const resultContent = document.getElementById('daily-tech-report-content');
            const kwInput = document.getElementById('daily-tech-keywords');
            const needEn = document.getElementById('daily-tech-need-en');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            progress.style.display = 'block';
            resultArea.style.display = 'none';
            logs.innerHTML = `[${new Date().toLocaleTimeString()}] 任务启动：每日科技动态<br>`;

            const payload = {
                keywords: kwInput.value,
                days: 1,
                need_en: needEn.value === 'true'
            };

            try {
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] 数据专家：收集素材...<br>`;
                const response = await fetch('/api/workflow/daily_tech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] 文档分析师：聚类与摘要...<br>`;
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] 数据可视化专家：生成图表...<br>`;

                if (!response.ok) {
                    let errMsg = `HTTP ${response.status}`;
                    try {
                        const errData = await response.json();
                        errMsg = errData.error || errData.detail || errMsg;
                    } catch (e) { }
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">错误：${escapeHtml(String(errMsg))}</span><br>`;
                    btn.innerHTML = '重试';
                    btn.disabled = false;
                    return;
                }

                const data = await response.json();

                if (data && data.success) {
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] 内容创作者：撰写日报...<br>`;
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #4CAF50;">任务完成！</span><br>`;
                    const html = renderVisualDailyTechReport(data);
                    resultContent.innerHTML = html;
                    resultArea.style.display = 'block';
                    if (window.mermaid) {
                        try {
                            mermaid.run({ nodes: resultContent.querySelectorAll('.mermaid') });
                        } catch (e) { }
                    }
                    btn.innerHTML = '<i class="fas fa-check"></i> 完成';
                } else {
                    const errMsg = (data && (data.error || data.detail)) || '未知错误';
                    logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">错误：${escapeHtml(String(errMsg))}</span><br>`;
                    btn.innerHTML = '重试';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] <span style="color: #F44336;">网络请求失败</span><br>`;
                btn.innerHTML = '重试';
                btn.disabled = false;
            }
        }
        function renderVisualDailyTechReport(data) {
            const raw = data && data.report ? data.report : '';
            const steps = Array.isArray(data && data.steps) ? data.steps : [];
            const meta = data && data.meta ? data.meta : {};
            const timeStr = new Date().toLocaleString();
            const kwText = Array.isArray(meta.keywords) ? meta.keywords.join(', ') : '';
            const flowCode = 'flowchart LR\nA[数据专家]-->B[文档分析师]\nB-->C[内容创作者]';
            const rawWithMermaid = convertMermaidFences(raw || '');
            const rawHtml = marked.parse(rawWithMermaid);
            const stepsHtml = steps.map(s => {
                const name = s && s.step ? s.step : '';
                const outMd = s && s.output ? s.output : '';
                const outHtml = marked.parse(outMd);
                return (
                    `<details style="margin-bottom: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                        <summary style="cursor: pointer; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot" style="color: #64B5F6;"></i> ${name}
                        </summary>
                        <div style="margin-top: 10px; color: var(--text-primary); line-height: 1.7;">${outHtml}</div>
                    </details>`
                );
            }).join('');
            const dateText = meta && meta.report_date ? meta.report_date : new Date().toLocaleDateString();
            const metaCards = `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="background: linear-gradient(135deg, #64B5F6 0%, #2196F3 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">关键词数</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${(kwText || '').split(',').filter(x => x.trim()).length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">报告字数</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${(raw || '').length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00BCD4 0%, #00838F 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">日期</div>
                        <div style="font-size: 1rem; font-weight: 700;">${dateText}</div>
                    </div>
                </div>`;
            const html = `
                <div style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%); padding: 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:48px; height:48px; border-radius:12px; background: linear-gradient(135deg, #64B5F6 0%, #2196F3 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.2rem;"><i class="fas fa-microchip"></i></div>
                            <div>
                                <div style="font-size:1.2rem; color: var(--text-primary); font-weight:800;">每日科技动态</div>
                                <div style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(kwText)}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; color:#ddd;">
                            <i class="fas fa-chart-bar" title="数据专家"></i>
                            <i class="fas fa-file-alt" title="文档分析师"></i>
                            <i class="fas fa-pen-fancy" title="内容创作者"></i>
                        </div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-secondary);">
                        ${metaCards}
                        <div style="margin-top: 20px; display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-chart-pie" style="color:#64B5F6;"></i>主题概览</div>
                                <div class="mermaid">${flowCode}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-route" style="color:#9C27B0;"></i>流程概览</div>
                                <div class="mermaid">flowchart LR\nA[数据专家]-->B[文档分析师]\nB-->C[内容创作者]</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-file-alt" style="color:#FF9800;"></i>详细日报</div>
                            <div style="color: var(--text-primary); line-height: 1.8;">${rawHtml}</div>
                        </div>
                        <div style="margin-top: 20px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-list" style="color:#00BCD4;"></i>分步输出</div>
                            ${stepsHtml}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }
        function convertMermaidFences(md) {
            const regex = /```mermaid\n([\s\S]*?)```/g;
            return (md || '').replace(regex, (_, code) => {
                return `<div class="mermaid">${escapeHtml(code)}</div>`;
            });
        }
        function renderVisualReviewReport(data) {
            const raw = data && data.report ? data.report : '';
            const steps = Array.isArray(data && data.steps) ? data.steps : [];
            const fileName = selectedReviewFile && selectedReviewFile.name ? selectedReviewFile.name : '';
            const timeStr = new Date().toLocaleString();
            const risks = extractRiskItems(raw);
            const severityCounts = computeSeverityCounts(risks);
            const pieCode = buildMermaidRiskPie(severityCounts);
            const flowCode = 'flowchart LR\nA[文档分析师]-->B[合规官]\nB-->C[内容创作者]';
            const rawHtml = marked.parse(raw || '');
            const stepsHtml = steps.map(s => {
                const name = s && s.agent ? s.agent : '';
                const outMd = s && s.output ? s.output : '';
                const outHtml = marked.parse(outMd);
                return (
                    `<details style="margin-bottom: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                        <summary style="cursor: pointer; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot" style="color: var(--primary);"></i> ${name}
                        </summary>
                        <div style="margin-top: 10px; color: var(--text-primary); line-height: 1.7;">${outHtml}</div>
                    </details>`
                );
            }).join('');
            const riskBadges = risks.map(r => `<span style="display:inline-block; padding:6px 10px; border-radius:16px; margin:4px; border:1px solid var(--border); background: rgba(244, 67, 54, 0.12); color: #F44336; font-size: 0.85rem;">${escapeHtml(r.text)}${r.severity ? ` · ${r.severity}` : ''}</span>`).join('');
            const metaCards = `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="background: linear-gradient(135deg, #FF6B00 0%, #FF8800 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">风险项数</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${risks.length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">报告字数</div>
                        <div style="font-size: 1.4rem; font-weight: 800;">${(raw || '').length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00BCD4 0%, #00838F 100%); border-radius: 10px; padding: 12px; color: white;">
                        <div style="font-size: 0.8rem; opacity: 0.9;">时间</div>
                        <div style="font-size: 1rem; font-weight: 700;">${timeStr}</div>
                    </div>
                </div>`;
            const html = `
                <div style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%); padding: 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:48px; height:48px; border-radius:12px; background: linear-gradient(135deg, #FF6B00 0%, #FF8800 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.2rem;"><i class="fas fa-file-search"></i></div>
                            <div>
                                <div style="font-size:1.2rem; color: var(--text-primary); font-weight:800;">智能文档审查报告</div>
                                <div style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(fileName)}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; color:#ddd;">
                            <i class="fas fa-file-alt" title="文档分析师"></i>
                            <i class="fas fa-balance-scale" title="合规官"></i>
                            <i class="fas fa-pen-fancy" title="内容创作者"></i>
                        </div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-secondary);">
                        ${metaCards}
                        <div style="margin-top: 20px; display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-exclamation-triangle" style="color:#F44336;"></i>风险提示</div>
                                <div>${riskBadges || '<span style="color: var(--text-secondary);">无明显风险项</span>'}</div>
                                <div style="margin-top: 12px;">
                                    <div class="mermaid">${pieCode}</div>
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-route" style="color:#9C27B0;"></i>流程概览</div>
                                <div class="mermaid">${flowCode}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-file-alt" style="color:#FF9800;"></i>详细报告</div>
                            <div style="color: var(--text-primary); line-height: 1.8;">${rawHtml}</div>
                        </div>
                        <div style="margin-top: 20px;">
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:8px;"><i class="fas fa-list" style="color:#00BCD4;"></i>分步输出</div>
                            ${stepsHtml}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }
        function extractRiskItems(md) {
            const lines = (md || '').split('\n');
            const items = [];
            for (let i = 0; i < lines.length; i++) {
                const t = lines[i].trim();
                // 更宽泛的风险匹配模式
                const isRisk = /风险|⚠️|不当|违规|漏洞|问题|警告|注意|禁止|严禁|高风险|中风险|低风险|严重|高|中|低/.test(t);
                if (isRisk && t.length > 5) { // 至少5个字符，避免误匹配
                    let severity = '';
                    if (/严重|高风险|高/.test(t)) severity = '高';
                    else if (/中风险|中/.test(t)) severity = '中';
                    else if (/低风险|低|一般/.test(t)) severity = '低';
                    // 如果没有明确级别，根据上下文判断
                    if (!severity) {
                        if (i > 0 && /高|严重/.test(lines[i - 1])) severity = '高';
                        else if (i > 0 && /中/.test(lines[i - 1])) severity = '中';
                        else severity = '中'; // 默认中等风险
                    }
                    const cleanText = t.replace(/^[-\*\s\d\.]+/, '').replace(/^[（(].*?[）)]/, '');
                    if (cleanText.length > 3) {
                        items.push({ text: cleanText, severity });
                    }
                }
            }
            return items;
        }
        function computeSeverityCounts(items) {
            const c = { 高: 0, 中: 0, 低: 0 };
            items.forEach(it => {
                if (it.severity === '高') c['高'] += 1;
                else if (it.severity === '中') c['中'] += 1;
                else c['低'] += 1;
            });
            return c;
        }
        function buildMermaidRiskPie(counts) {
            const total = counts['高'] + counts['中'] + counts['低'];
            const title = total > 0 ? '风险分布' : '风险分布（无）';
            return `pie title ${title}\n"高" : ${counts['高']}\n"中" : ${counts['中']}\n"低" : ${counts['低']}`;
        }
        let settingsModalInstance = null;

        document.addEventListener('DOMContentLoaded', function () {
            settingsModalInstance = document.getElementById('settingsModal');
        });

        function openSettingsModal() {
            // Re-query if null (sometimes DOMContentLoaded fires before dynamic elements are ready in some frameworks, though unlikely here)
            if (!settingsModalInstance) settingsModalInstance = document.getElementById('settingsModal');

            if (settingsModalInstance) {
                settingsModalInstance.style.display = 'block';

                // Fetch settings from backend
                fetch('/api/settings/model')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.settings) {
                            const s = data.settings;
                            // Use backend settings
                            selectProvider(s.provider || 'gemini');

                            const apiKeyInput = document.getElementById('setting-api-key');
                            const modelNameInput = document.getElementById('setting-model-name');
                            const baseUrlInput = document.getElementById('setting-base-url');

                            if (apiKeyInput) apiKeyInput.value = s.api_key || '';
                            if (modelNameInput) modelNameInput.value = s.model_name || '';
                            if (baseUrlInput) baseUrlInput.value = s.base_url || '';

                            // Also update localStorage to keep them in sync
                            localStorage.setItem('llm_provider', s.provider);
                            if (s.api_key) localStorage.setItem('llm_api_key', s.api_key);
                            if (s.model_name) localStorage.setItem('llm_model_name', s.model_name);
                            if (s.base_url) localStorage.setItem('llm_base_url', s.base_url);
                        } else {
                            // Fallback to localStorage if fetch failed or no settings returned
                            loadSettingsFromLocal();
                        }
                    })
                    .catch(err => {
                        console.error("Failed to fetch settings:", err);
                        loadSettingsFromLocal();
                    });
            } else {
                console.error("Settings modal element not found!");
            }
        }

        function loadSettingsFromLocal() {
            const provider = localStorage.getItem('llm_provider') || 'gemini';
            selectProvider(provider);

            const apiKeyInput = document.getElementById('setting-api-key');
            const modelNameInput = document.getElementById('setting-model-name');
            const baseUrlInput = document.getElementById('setting-base-url');

            if (apiKeyInput) apiKeyInput.value = localStorage.getItem('llm_api_key') || '';
            if (modelNameInput) modelNameInput.value = localStorage.getItem('llm_model_name') || '';
            if (baseUrlInput) baseUrlInput.value = localStorage.getItem('llm_base_url') || '';
        }

        function closeSettingsModal() {
            if (!settingsModalInstance) settingsModalInstance = document.getElementById('settingsModal');
            if (settingsModalInstance) {
                settingsModalInstance.style.display = 'none';
            }
        }

        function selectProvider(provider) {
            // Update UI
            const options = document.querySelectorAll('.provider-option');
            if (options) {
                options.forEach(opt => {
                    if (opt.dataset.provider === provider) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }

            // Toggle Base URL field
            const baseUrlGroup = document.getElementById('base-url-group');
            if (baseUrlGroup) {
                if (provider === 'openai' || provider === 'deepseek' || provider === 'local') {
                    baseUrlGroup.style.display = 'block';
                } else {
                    baseUrlGroup.style.display = 'none';
                }
            }

            // Auto-fill defaults if empty
            const modelInput = document.getElementById('setting-model-name');
            const urlInput = document.getElementById('setting-base-url');

            if (modelInput && urlInput) {
                if (provider === 'deepseek') {
                    if (!modelInput.value) modelInput.value = 'deepseek-chat';
                    if (!urlInput.value) urlInput.value = 'https://api.deepseek.com';
                } else if (provider === 'gemini') {
                    if (!modelInput.value) modelInput.value = 'gemini-1.5-flash';
                } else if (provider === 'local') {
                    if (!urlInput.value) urlInput.value = 'http://localhost:1234/v1';
                }
            }
        }

        async function saveSettings() {
            const provider = document.querySelector('.provider-option.active').dataset.provider;
            const apiKey = document.getElementById('setting-api-key').value;
            const modelName = document.getElementById('setting-model-name').value;
            const baseUrl = document.getElementById('setting-base-url').value;

            if (!apiKey && provider !== 'local') {
                alert('请输入 API Key');
                return;
            }

            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

            try {
                // Save to backend
                const response = await fetch('/api/settings/model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        api_key: apiKey,
                        model_name: modelName,
                        base_url: baseUrl
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Save to localStorage for persistence in UI
                    localStorage.setItem('llm_provider', provider);
                    localStorage.setItem('llm_api_key', apiKey);
                    localStorage.setItem('llm_model_name', modelName);
                    localStorage.setItem('llm_base_url', baseUrl);

                    addChatMessage('system', `系统配置已更新: ${result.message}`);
                    closeSettingsModal();
                } else {
                    alert('保存失败: ' + (result.error || '未知错误'));
                }
            } catch (e) {
                console.error(e);
                alert('请求失败，请检查网络');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('settingsModal');
            if (modal && event.target == modal) {
                closeSettingsModal();
            }
        }
    </script>
    <script>
        async function runImageGenerator() {
            const prompt = document.getElementById('imggen-prompt').value;
            const model = document.getElementById('imggen-model').value;
            const size = document.getElementById('imggen-size').value;
            const result = document.getElementById('imggen-result');
            result.innerHTML = '生成中...';
            try {
                const fd = new FormData();
                fd.append('prompt', prompt);
                fd.append('model', model);
                fd.append('size', size);
                const res = await fetch('/api/image/generate', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    result.innerHTML = data.html || '生成成功';
                } else {
                    result.innerHTML = (data.error || '生成失败') + (data.hint ? ('，' + data.hint) : '');
                }
            } catch (e) {
                result.innerHTML = '生成失败';
            }
        }
    </script>
    <script>
        async function runDrawingGenerator() {
            const prompt = document.getElementById('draw-prompt').value;
            const tools = [];
            if (document.getElementById('tool-mermaid').checked) tools.push('mermaid');
            if (document.getElementById('tool-plantuml').checked) tools.push('plantuml');
            if (document.getElementById('tool-nanobanana').checked) tools.push('nano-banana');
            if (document.getElementById('tool-excalidraw').checked) tools.push('excalidraw');
            const result = document.getElementById('draw-result');
            result.innerHTML = '生成中...';
            try {
                const fd = new FormData();
                fd.append('prompt', prompt);
                if (tools.length) fd.append('tools', tools.join(','));
                const res = await fetch('/api/draw/generate', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    result.innerHTML = data.html || '生成成功';
                } else {
                    result.innerHTML = (data.error || '生成失败') + (data.hint ? ('，' + data.hint) : '');
                }
            } catch (e) {
                result.innerHTML = '生成失败';
            }
        }
    </script>
    <script>
        (function () {
            const root = document.documentElement;
            const el = document.getElementById('rightResizer');
            let startX = 0;
            let startW = 0;
            function onMove(e) {
                const dx = e.clientX - startX;
                const w = Math.min(Math.max(startW - dx, 280), 720);
                root.style.setProperty('--right-panel-width', w + 'px');
            }
            function onUp() {
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onUp);
                try {
                    const v = getComputedStyle(root).getPropertyValue('--right-panel-width').trim();
                    localStorage.setItem('rightPanelWidth', v);
                } catch (e) { }
            }
            if (el) {
                el.addEventListener('mousedown', (e) => {
                    startX = e.clientX;
                    const v = parseInt(getComputedStyle(root).getPropertyValue('--right-panel-width')) || 420;
                    startW = v;
                    window.addEventListener('mousemove', onMove);
                    window.addEventListener('mouseup', onUp);
                });
                el.addEventListener('dblclick', () => {
                    const target = Math.round(Math.min(Math.max(window.innerWidth * 0.32, 420), 680));
                    root.style.setProperty('--right-panel-width', target + 'px');
                    try { localStorage.setItem('rightPanelWidth', target + 'px'); } catch (e) { }
                });
            }
            try {
                const saved = localStorage.getItem('rightPanelWidth');
                if (saved) root.style.setProperty('--right-panel-width', saved);
            } catch (e) { }
        })();
    </script>
    <script>
        // Left Sidebar Resizer
        (function () {
            const root = document.documentElement;
            const el = document.getElementById('leftResizer');
            let startX = 0;
            let startW = 0;
            function onMove(e) {
                const dx = e.clientX - startX;
                const w = Math.min(Math.max(startW + dx, 200), 600);
                root.style.setProperty('--sidebar-width', w + 'px');
            }
            function onUp() {
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onUp);
                try {
                    const v = getComputedStyle(root).getPropertyValue('--sidebar-width').trim();
                    localStorage.setItem('leftSidebarWidth', v);
                } catch (e) { }
            }
            if (el) {
                el.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startX = e.clientX;
                    const v = parseInt(getComputedStyle(root).getPropertyValue('--sidebar-width')) || 250;
                    startW = v;
                    window.addEventListener('mousemove', onMove);
                    window.addEventListener('mouseup', onUp);
                });
                el.addEventListener('dblclick', () => {
                    const target = Math.round(Math.min(Math.max(window.innerWidth * 0.15, 200), 400));
                    root.style.setProperty('--sidebar-width', target + 'px');
                    try { localStorage.setItem('leftSidebarWidth', target + 'px'); } catch (e) { }
                });
            }
            try {
                const saved = localStorage.getItem('leftSidebarWidth');
                if (saved) root.style.setProperty('--sidebar-width', saved);
            } catch (e) { }
        })();
    </script>
    <script>
        // PPT PDF 预览和下载函数（横向翻页模式）
        function showPPTPDFPreview(filename) {
            const encodedFilename = encodeURIComponent(filename);
            const pdfUrl = `/download/${encodedFilename}?preview=true`;

            // 切换到编辑器视图
            switchMainView('editor');

            // 更新中间面板显示 PDF
            const editorArea = document.querySelector('.editor-area');
            updateContentTitle(filename, 'fas fa-file-pdf');

            // 创建横向翻页的 PDF 预览界面
            const contentHtml = `
                <div style="display: flex; flex-direction: column; height: calc(100vh - 150px);">
                    <!-- 工具栏 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px 8px 0 0; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <button onclick="prevPDFPage()" id="prevPageBtn" style="padding: 8px 16px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-chevron-left"></i> 上一页
                            </button>
                            <span id="pageInfo" style="color: var(--text-secondary); font-size: 0.9rem;">第 <span id="currentPage">1</span> 页 / 共 <span id="totalPages">-</span> 页</span>
                            <button onclick="nextPDFPage()" id="nextPageBtn" style="padding: 8px 16px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600;">
                                下一页 <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="window.open('${pdfUrl}', '_blank')" style="padding: 8px 16px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-external-link-alt"></i> 新窗口打开
                            </button>
                            <button onclick="downloadPPT('${filename}')" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-download"></i> 下载 PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- PDF 预览区域（横向滚动） -->
                    <div id="pdfContainer" style="flex: 1; overflow-x: auto; overflow-y: hidden; background: #2a2a2a; position: relative; scroll-behavior: smooth;">
                        <div id="pdfPages" style="display: flex; height: 100%; align-items: center; padding: 20px; gap: 20px;">
                            <!-- PDF 页面将通过 JavaScript 动态加载 -->
                        </div>
                    </div>
                </div>
            `;

            editorArea.innerHTML = contentHtml;

            // 加载 PDF 并显示页面
            loadPDFPages(pdfUrl, filename);
        }

        // 加载 PDF 页面（使用 PDF.js，支持横向翻页）
        async function loadPDFPages(pdfUrl, filename) {
            const pdfPages = document.getElementById('pdfPages');
            const container = document.getElementById('pdfContainer');

            // 显示加载中
            pdfPages.innerHTML = '<div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 50px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i><p style="margin-top: 15px;">正在加载 PDF...</p></div>';

            try {
                // 设置 PDF.js worker
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                    // 加载 PDF 文档
                    const loadingTask = pdfjsLib.getDocument(pdfUrl);
                    const pdf = await loadingTask.promise;

                    window.currentPDF = pdf;
                    window.currentPDFPage = 1;
                    window.currentPDFTotalPages = pdf.numPages;
                    window.currentPDFUrl = pdfUrl;
                    window.currentPDFFilename = filename;

                    // 渲染所有页面（横向排列）
                    pdfPages.innerHTML = '';

                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        await renderPDFPage(pdf, pageNum, pdfPages);
                    }

                    // 更新页面信息
                    updatePageInfo(1, pdf.numPages);

                    // 滚动到第一页
                    container.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                    // 如果 PDF.js 未加载，使用 iframe 作为后备方案
                    fallbackPDFViewer(pdfUrl);
                }
            } catch (error) {
                console.error('PDF 加载失败:', error);
                // 使用 iframe 作为后备方案
                fallbackPDFViewer(pdfUrl);
            }
        }

        // 渲染单个 PDF 页面
        async function renderPDFPage(pdf, pageNum, container) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });

            // 创建 canvas
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            canvas.style.borderRadius = '8px';
            canvas.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';

            // 渲染页面
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            await page.render(renderContext).promise;

            // 创建页面容器
            const pageContainer = document.createElement('div');
            pageContainer.style.flex = '0 0 auto';
            pageContainer.style.width = `${viewport.width}px`;
            pageContainer.style.height = '100%';
            pageContainer.style.display = 'flex';
            pageContainer.style.alignItems = 'center';
            pageContainer.style.marginRight = '20px';
            pageContainer.id = `pdf-page-${pageNum}`;

            pageContainer.appendChild(canvas);
            container.appendChild(pageContainer);
        }

        // 后备方案：使用 iframe
        function fallbackPDFViewer(pdfUrl) {
            const pdfPages = document.getElementById('pdfPages');
            pdfPages.innerHTML = `
                <div style="flex: 0 0 auto; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <iframe id="pdfViewer" src="${pdfUrl}" style="width: 100%; height: 100%; border: none; border-radius: 8px; background: #333;"></iframe>
                </div>
            `;
            updatePageInfo(1, '?');
        }

        // 更新页面信息
        function updatePageInfo(current, total) {
            document.getElementById('currentPage').textContent = current;
            document.getElementById('totalPages').textContent = total;

            // 更新按钮状态
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            if (current <= 1) {
                prevBtn.disabled = true;
                prevBtn.style.opacity = '0.5';
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.disabled = false;
                prevBtn.style.opacity = '1';
                prevBtn.style.cursor = 'pointer';
            }

            if (total !== '?' && current >= parseInt(total)) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }

        // 上一页
        function prevPDFPage() {
            if (window.currentPDFPage > 1) {
                window.currentPDFPage--;
                navigatePDFPage(window.currentPDFPage);
            }
        }

        // 下一页
        function nextPDFPage() {
            window.currentPDFPage++;
            navigatePDFPage(window.currentPDFPage);
        }

        // 导航到指定页面（滚动到对应页面）
        function navigatePDFPage(pageNum) {
            const container = document.getElementById('pdfContainer');
            const pageElement = document.getElementById(`pdf-page-${pageNum}`);

            if (pageElement && container) {
                // 滚动到指定页面
                const containerRect = container.getBoundingClientRect();
                const pageRect = pageElement.getBoundingClientRect();
                const scrollLeft = pageElement.offsetLeft - (containerRect.width / 2) + (pageRect.width / 2);

                container.scrollTo({
                    left: scrollLeft,
                    behavior: 'smooth'
                });

                window.currentPDFPage = pageNum;
                const totalPages = window.currentPDFTotalPages || document.getElementById('totalPages').textContent;
                updatePageInfo(pageNum, totalPages);
            } else if (window.currentPDFUrl) {
                // 如果使用 iframe 后备方案
                const iframe = document.getElementById('pdfViewer');
                if (iframe) {
                    const newUrl = window.currentPDFUrl.split('#')[0] + `#page=${pageNum}`;
                    iframe.src = newUrl;
                    updatePageInfo(pageNum, document.getElementById('totalPages').textContent);
                }
            }
        }

        // 兼容旧的 previewPPT 函数
        function previewPPT(filename) {
            showPPTPDFPreview(filename);
        }

        function downloadPPT(filename) {
            const encodedFilename = encodeURIComponent(filename);
            window.location.href = `/download/${encodedFilename}`;
        }

        async function generatePPTFromSidebar() {
            const topic = document.getElementById('ppt-topic-sidebar').value.trim();
            if (!topic) {
                alert('请输入主题或内容');
                return;
            }

            const slideCount = parseInt(document.getElementById('ppt-slide-count').value) || 5;
            const complexity = document.getElementById('ppt-complexity').value;
            const style = document.getElementById('ppt-style').value;
            const language = document.getElementById('ppt-language').value;

            const statusEl = document.getElementById('ppt-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在生成PPT，请稍候...';
            statusEl.style.color = 'var(--primary)';

            try {
                // 调用后端 API 生成 PPT（使用 FormData 格式）
                const formData = new FormData();
                formData.append('message', `@PPT生成专家 请为"${topic}"生成一个${slideCount}页的PPT，复杂度使用${complexity}，风格使用${style}，语言使用${language}`);

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || '请求失败'}`);
                }

                const data = await response.json();

                if (data.response) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i> PPT生成完成！';
                    statusEl.style.color = '#4CAF50';

                    // 将结果添加到聊天区
                    addChatMessage('agent', data.response, 'PPT生成专家');

                    // 如果有 PDF 文件名，优先显示 PDF 预览
                    if (data.pdf_filename) {
                        window.currentPPT_PDF = data.pdf_filename;
                        // 自动显示 PDF 预览（横向翻页模式）
                        showPPTPDFPreview(data.pdf_filename);
                    } else {
                        // 如果没有 PDF，显示文本结果
                        updateCenterPanel(data.response, 'PPT生成专家');
                    }

                    // 切换到主视图（确保中间面板可见）
                    switchMainView('editor');

                    // 切换到聊天面板查看结果
                    setTimeout(() => {
                        const chatPanel = document.getElementById('rightSidebar');
                        if (chatPanel) {
                            chatPanel.style.display = 'flex';
                        }
                    }, 500);
                } else {
                    throw new Error(data.error || '生成失败');
                }
            } catch (error) {
                console.error('PPT生成失败:', error);
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #F44336;"></i> 生成失败: ${error.message}`;
                statusEl.style.color = '#F44336';
            }
        }

        // AKShare 数据查询函数
        async function queryAKShareFromSidebar() {
            const queryType = document.getElementById('akshare-query-type').value;
            const symbol = document.getElementById('akshare-symbol').value.trim();
            const limit = document.getElementById('akshare-limit').value;
            const period = document.getElementById('akshare-period').value;
            const statusDiv = document.getElementById('akshare-status');

            // 构建查询消息
            let message = '';
            if (queryType === 'stock_info') {
                if (!symbol) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.color = '#ff4444';
                    statusDiv.textContent = '⚠️ 请输入股票代码';
                    return;
                }
                message = `@AKShare数据专家 查询 ${symbol} 的股票信息`;
            } else if (queryType === 'stock_prices') {
                if (!symbol) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.color = '#ff4444';
                    statusDiv.textContent = '⚠️ 请输入股票代码';
                    return;
                }
                message = `@AKShare数据专家 查询 ${symbol} 的最近 ${limit} 条价格数据，周期为 ${period}`;
            } else if (queryType === 'stock_news') {
                if (!symbol) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.color = '#ff4444';
                    statusDiv.textContent = '⚠️ 请输入股票代码';
                    return;
                }
                message = `@AKShare数据专家 查询 ${symbol} 的最新 ${limit} 条新闻`;
            } else if (queryType === 'search') {
                if (!symbol) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.color = '#ff4444';
                    statusDiv.textContent = '⚠️ 请输入搜索关键词';
                    return;
                }
                message = `@AKShare数据专家 搜索"${symbol}"相关的股票`;
            } else if (queryType === 'get_current_time') {
                message = `@AKShare数据专家 查询当前时间和交易日信息`;
            }

            try {
                statusDiv.style.display = 'block';
                statusDiv.style.color = 'var(--primary)';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在查询数据...';

                const formData = new FormData();
                formData.append('message', message);
                formData.append('agent_id', 'akshare_expert');

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.style.color = '#4CAF50';
                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> 查询完成！';

                    // 显示在聊天区域
                    addChatMessage('user', message, 'user');
                    addChatMessage('agent', data.response, 'AKShare数据专家');

                    // 更新中央面板
                    if (data.response) {
                        switchMainView('editor');
                        updateCenterPanel(data.response, 'AKShare数据专家');
                    }

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    statusDiv.style.color = '#ff4444';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> 查询失败：' + (data.error || '未知错误');
                }
            } catch (error) {
                console.error('AKShare 查询失败:', error);
                statusDiv.style.color = '#ff4444';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> 查询失败：' + error.message;
            }
        }

        async function startAlphaFundWorkflow() {
            const topic = document.getElementById('alphafund-topic').value.trim();
            if (!topic) {
                alert('请输入研究主题');
                return;
            }

            const deepResearch = document.getElementById('alphafund-deep-research').checked;
            const statusDiv = document.getElementById('alphafund-status');

            try {
                statusDiv.style.display = 'block';
                statusDiv.style.color = 'var(--primary)';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在打开工作区...';

                // 打开 AlphaFund 工作区（工作区页面会自己处理 API 调用）
                openAlphaFundWorkspace(topic, deepResearch);

                // 将参数传递给工作区页面
                setTimeout(() => {
                    const workspace = document.getElementById('alphafund-workspace');
                    if (workspace && workspace.contentWindow) {
                        // 通过 postMessage 传递参数，或者让工作区页面从 URL 参数读取
                        workspace.contentWindow.postMessage({
                            type: 'alphafund-init',
                            topic: topic,
                            deepResearch: deepResearch
                        }, '*');
                    }
                }, 500);

                statusDiv.style.color = '#4CAF50';
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> 工作区已打开，请在主内容区操作';

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('AlphaFund 工作区打开失败:', error);
                statusDiv.style.color = '#ff4444';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> 打开失败：' + error.message;
            }
        }

        function openAlphaFundWorkspace(topic, deepResearch) {
            // 切换到主内容视图
            switchMainView('editor');

            // 创建或显示 AlphaFund 工作区 iframe
            let workspace = document.getElementById('alphafund-workspace');
            if (!workspace) {
                workspace = document.createElement('iframe');
                workspace.id = 'alphafund-workspace';
                workspace.src = '/alphafund';
                workspace.style.width = '100%';
                workspace.style.height = '100%';
                workspace.style.border = 'none';
                workspace.style.background = 'var(--bg-primary)';

                const editorArea = document.getElementById('editorArea');
                if (editorArea) {
                    editorArea.innerHTML = '';
                    editorArea.appendChild(workspace);
                }
            } else {
                workspace.style.display = 'block';
                // 如果 iframe 已存在但未加载，重新加载
                if (workspace.src === 'about:blank' || !workspace.src) {
                    workspace.src = '/alphafund';
                }
            }

            // 更新内容标题
            const titleText = document.getElementById('content-title-text');
            if (titleText) {
                titleText.textContent = 'AlphaFund 投研工作区';
            }
        }

        function updateAlphaFundWorkspace(data) {
            const content = document.getElementById('alphafund-content');
            if (!content) return;

            // 更新工作区内容
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary);">研究主题：${data.topic || ''}</h3>
                    <p style="color: var(--text-secondary);">状态：${data.status || '进行中'}</p>
                </div>
                <div id="alphafund-agents" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- 智能体卡片将在这里动态生成 -->
                </div>
                <div id="alphafund-report" style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px; min-height: 400px;">
                    <!-- 报告内容将在这里显示 -->
                </div>
            `;
        }

        async function runDrawingGeneratorFromSidebar() {
            switchMainView('editor');
            const prompt = document.getElementById('draw-prompt-sidebar').value;
            const mer = document.getElementById('tool-mermaid-sidebar').checked;
            const pu = document.getElementById('tool-plantuml-sidebar').checked;
            const nb = document.getElementById('tool-nanobanana-sidebar').checked;
            const ex = document.getElementById('tool-excalidraw-sidebar').checked;
            const tools = [];
            if (mer) tools.push('mermaid');
            if (pu) tools.push('plantuml');
            if (nb) tools.push('nano-banana');
            if (ex) tools.push('excalidraw');
            let result = document.getElementById('draw-result');
            if (!result) {
                const editorArea = document.getElementById('editorArea');
                editorArea.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">提示词</label>
                                <textarea id="draw-prompt" rows="4" style="width: 100%; margin-top: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px;">${prompt}</textarea>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px; border: 1px solid var(--border);">
                                <label style="color: var(--text-secondary); font-size: 0.9rem;">选择绘画工具（可多选）</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-mermaid" ${mer ? 'checked' : ''}> Mermaid</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-plantuml" ${pu ? 'checked' : ''}> PlantUML</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-nanobanana" ${nb ? 'checked' : ''}> Nano Banana</label>
                                    <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="tool-excalidraw" ${ex ? 'checked' : ''}> Excalidraw</label>
                                </div>
                                <button onclick="runDrawingGenerator()" style="margin-top: 10px; width: 100%; padding: 10px 12px; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                                    重新生成
                                </button>
                            </div>
                            <div id="draw-result" style="min-height: 200px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border); border-radius: 12px; display: grid; place-items: center; color: var(--text-secondary);">生成结果将显示在这里</div>
                        </div>
                    </div>`;
                result = document.getElementById('draw-result');
            }
            result.innerHTML = '生成中...';
            try {
                const fd = new FormData();
                fd.append('prompt', prompt);
                if (tools.length) fd.append('tools', tools.join(','));
                const res = await fetch('/api/draw/generate', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    result.innerHTML = data.html || '生成成功';
                } else {
                    result.innerHTML = (data.error || '生成失败') + (data.hint ? ('，' + data.hint) : '');
                }
            } catch (e) {
                result.innerHTML = '生成失败';
            }
        }
    </script>
</body>

</html>